---
title: 'Modelling Coffee Agroforestry in Central America with CAF2021'
subtitle: 'Progress report III for project SEACAF, sub-contract B0554x4'
author:
- Marcel van Oijen^[Independent researcher, Edinburgh, UK - VanOijenMarcel@gmail.com]
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
csl: environmental-modelling-and-software.csl
bibliography: [Avocado.bib,Banana.bib,SEACAF.bib]
---

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=F,results="asis",warning=FALSE,message=FALSE)
  library( readxl     )
  library( tidyverse  )
```

```{r}
  filesTM <- file.info(list.files(pattern="^BC_Turrialba_Masatepe.*\\.RData$"))
  filesTM <- filesTM[ with(filesTM,order(as.POSIXct(mtime))), ]
  fileTM  <- tail( rownames(filesTM[1]), 1 )
  load( fileTM )
  
  filesTM_MAP <- file.info(list.files(pattern="^CAF2021_parMAP.*\\.rds$"))
  filesTM_MAP <- filesTM_MAP[ with(filesTM_MAP,order(as.POSIXct(mtime))), ]
  fileTM_MAP  <- tail( rownames(filesTM_MAP[1]), 1 )
  # parMAP      <- readRDS( fileTM_MAP )
  parMAP.old  <- readRDS( fileTM_MAP ) ; np.old <- dim(parMAP.old)[1]
  
  # Construct the parMAP (with more parameters than stored in fileTM_MAP)
  source('initialisation/set_CAF2021_Turrialba.R')
  np               <- length( params )
  parMAP           <- matrix( params, nrow=np, ncol=nSites, byrow=F )
  rownames(parMAP) <- names_params
  colnames(parMAP) <- paste0( "s", 1:nSites )
  for(p in 1:np.old) {
    prow          <- which( startsWith( rownames(parMAP),
                                        rownames(parMAP.old)[p] ) )
    for(r in prow) { parMAP[r,] <- parMAP.old[p,] }
  }
```

```{r}
  add.lmleg <- function(){
    y.lm <- lm( y ~ x )
    r2   <- round( summary(y.lm)$r.squared, 2 )
    abline( y.lm$coefficients[1], y.lm$coefficients[2], col="blue" )
    legend( "bottomright",
            legend=paste("r2= ",as.character(r2)),
            col=c("blue"), lty=c(1), cex=0.7, bg="transparent" )
  }

  plotxylm <- function(maintxt="Obs. Costa Rica", xtxt="Sim.") {
    plot(x,y,xlab=xtxt,ylab="",main=maintxt) ; add.lmleg()
  }
```



\clearpage

# Preliminary data analysis

```{r}
  load( "df_C.f.rda" )
  load( "df_G.f.rda" )

  n_C.f <- dim(df_C.f)[1] ; n_G.f <- dim(df_G.f)[1]
```

```{r}
  iN500_C <- which(df_C.f$Nfert > 500 )
  iN500_G <- which(df_G.f$Nfert > 500 )
  
  cbind( df_C.f$code[iN500_C], df_C.f$Nfert[iN500_C] )
  cbind( df_G.f$code[iN500_G], df_G.f$Nfert[iN500_G] )
  
  df_C.f$Nfert[iN500_C] <- 500
  df_G.f$Nfert[iN500_G] <- 500
```



\clearpage

# Pedotransfer functions

```{r}
  dir.f           <- "data/Farms SEACAF/"
  file_soil.f     <- "Soil_general.xlsx"
```

```{r}
  df_soil1.f0 <- read_excel( paste0(dir.f,file_soil.f),
                             sheet="Apparent density", guess_max=3000 )

  df_soil1.f  <- df_soil1.f0 %>%
    mutate( code = ifelse(country=="Costa Rica", 1000,
                   ifelse(country=="Guatemala" , 2000,
                          NA )) ) %>%
    mutate( code = code + farm_number ) %>%
    arrange( code ) %>%
    rename( DM.soil.sample_C     = "weight 105"        ) %>%
    rename( FW.soil.sample_G     = "Fresh weight"      ) %>%
    rename( FW.soil.subsample1_G = "sub sample weight" ) %>%
    rename( AD.soil.subsample1_G = "airdry weight"     ) %>%
    rename( AD.soil.subsample2_G = "Gsubsample_105C"   ) %>%
    rename( DM.soil.subsample2_G = "Gweight_105C"      ) %>%
    mutate( DM.soil.subsample2_G =
              ifelse( DM.soil.subsample2_G < AD.soil.subsample2_G,
                      DM.soil.subsample2_G,
                      AD.soil.subsample2_G ) ) %>%
    mutate( DM.soil.sample =
              ifelse( country=="Costa Rica", DM.soil.sample_C,
              ifelse( country=="Guatemala" , FW.soil.sample_G *
                      (AD.soil.subsample1_G / FW.soil.subsample1_G) *
                      (DM.soil.subsample2_G / AD.soil.subsample2_G),
                      NA )) ) %>%
    group_by( code, Profundity ) %>%
    # summarise( DM.soil.layer = mean(DM.soil.sample,na.rm=T) * 
    summarise( DM.soil.layer = median(DM.soil.sample,na.rm=T) *
                               0.001 * (10000/78.54) ) %>% # kg DM m-2 per layer
    summarise( DM.soil.00_26 = sum(DM.soil.layer) ) %>% # kg DM m-2 in top 26 cm
    mutate( DM.soil = DM.soil.00_26 / (2.6 * 100) ) # DM in kg l-1 in top 26 cm
```

```{r}
  df_soil2.f0 <- read_excel( paste0(dir.f,file_soil.f),
                             sheet="physical_chemical" )

  df_soil2.f <- df_soil2.f0 %>%
    mutate( code = ifelse( startsWith(farm_code,"Costa Rica"), 1000,
                   ifelse( startsWith(farm_code,"Guatemala" ), 2000,
                           NA )) ) %>%
    mutate( code = code + farm_number ) %>%
    arrange( code ) %>%
    rename( Cperc.soil.00_13 = "0-13_%Carbon"    ) %>%
    rename( Cperc.soil.13_26 = "13-26_%Carbon"   ) %>%
    rename( Nperc.soil.00_13 = "0-13_%Nitrogen"  ) %>%
    rename( Nperc.soil.13_26 = "13-26_%Nitrogen" ) %>%
    rename( sand.00_13_C     = "0-13_Sand"       ) %>%
    rename( sand.13_26_C     = "13-26_Sand"      ) %>%
    rename( silt.00_13_C     = "0-13_Silt"       ) %>%
    rename( silt.13_26_C     = "13-26_Silt"      ) %>%
    rename( clay.00_13_C     = "0-13_Clay"       ) %>%
    rename( clay.13_26_C     = "13-26_Clay"      ) %>%
    mutate( sand_C           = 0.5 * (sand.00_13_C + sand.13_26_C) ) %>%
    mutate( silt_C           = 0.5 * (silt.00_13_C + silt.13_26_C) ) %>%
    mutate( clay_C           = 0.5 * (clay.00_13_C + clay.13_26_C) ) %>%
    rename( sand_G           = "General_sand"    ) %>%
    rename( silt_G           = "General_silt"    ) %>%
    rename( clay_G           = "General_clay"    ) %>%
    mutate( sand             = pmax( sand_C, sand_G, na.rm=T )) %>%
    mutate( silt             = pmax( silt_C, silt_G, na.rm=T )) %>%
    mutate( clay             = pmax( clay_C, clay_G, na.rm=T )) %>%
    mutate( Cperc.soil.00_26 = 0.5 * (Cperc.soil.00_13 + Cperc.soil.13_26) ) %>%
    mutate( Nperc.soil.00_26 = 0.5 * (Nperc.soil.00_13 + Nperc.soil.13_26) ) %>%
    mutate( CN.soil          = Cperc.soil.00_26 / Nperc.soil.00_26 ) %>%
    select( code, CN.soil, Cperc.soil.00_26, Nperc.soil.00_26,
            sand, silt, clay )
```

```{r}
  df_soil.f <- df_soil1.f %>%
    inner_join( df_soil2.f, by="code" ) %>%
    mutate( C.soil.00_26 = DM.soil.00_26 * Cperc.soil.00_26 / 100 ) %>%
    mutate( N.soil.00_26 = DM.soil.00_26 * Nperc.soil.00_26 / 100 ) %>%
    mutate( C.soil       = C.soil.00_26  * 1.5 ) %>% # Assuming 2/3 of SM is in top 26 cm
    mutate( N.soil       = N.soil.00_26  * 1.5 ) %>% # Assuming 2/3 of SM is in top 26 cm
    select( code, DM.soil, CN.soil, C.soil, N.soil, sand, silt, clay )
```

```{r}
  # Pedotransfer function derived by Tomasella et al. (2003)
  # as presented and evaluated by Tomasella et al. (2004)
  # We have no data for "Moisture equivalence (Me)" and set it at Me=0.4.
  # Me also add minimum bounds (WP>=0.05, FC>=WP+0.10)
  fTomasella2003 <- function(DM,SI,CL){
    Me  = 0.4
    x14 = -1.05501 + 0.0650857 * SI
    x15 = -2.07588 + 0.0423954 * CL
    x16 = -6.03402 + 4.80572   * DM
    x17 = -2.18409 + 8.84963   * Me
    z9  =  0.175202 + 1.18513 * x17 - 0.0996042 * x17^2 +
           0.327915 * x16 - 0.0758657 * x16^2
    z10 =  0.929344 * z9 + 0.132519 * x14
    z13 =  0.235084 + 0.33033 * x15 - 0.191838 * x15^2 + 0.0543679 * x15^3 +
           0.977685 * x17 + 0.304174 * x15 * x17 - 0.218857 * x17^2 -
           0.164373 * x15 * x17^2 + 0.0415057 * x17^3 +
           0.373361 * x16 + 0.0811861 * x17 * x16 - 0.0768087 * x15 * x17 * x16
    WP  =  pmax( 0.05  , 0.214008 + 0.0862945 * z13 )
    FC  =  pmax( WP+0.1, 0.339255 + 0.112526  * z10 )
    return( list(WP=WP,FC=FC) ) }

    df_water.f <- df_soil.f %>%
      mutate( WP = fTomasella2003(DM.soil,silt,clay)$WP ) %>%
      mutate( FC = fTomasella2003(DM.soil,silt,clay)$FC ) %>%
      select( code, WP, FC )

    summary( df_water.f$WP )
    summary( df_water.f$FC )
    summary( df_water.f$FC - df_water.f$WP )
```

```{r}
  df_water_C.f <- df_water.f %>% subset( df_water.f$code <  2000 )
  df_water_G.f <- df_water.f %>% subset( df_water.f$code >= 2000 )
```

```{r}
  df_C.f <- df_C.f %>% inner_join( df_water_C.f, by="code" )
  df_G.f <- df_G.f %>% inner_join( df_water_G.f, by="code" )
```

```{r, eval=F}
# Tropical Andosols (Hodnett & Tomasella 2002)
  VanGenuchten <- function(psi=-1600,a=0.53,n=1.502,thetaR=0.251,thetaS=0.633) {
    theta <- thetaR + (thetaS-thetaR) / (1 + (a*abs(psi))^n)^(1-1/n)
    return( theta ) }

  VanGenuchten( -Inf) # WCAD 0.25
  VanGenuchten(-1600) # WCWP 0.26
  VanGenuchten(  -10) # WCFC 0.41
  VanGenuchten(    0) # WCST 0.63
```


\clearpage

# Simulating farms in Costa Rica and Guatemala

We ran the model for each of 89 farm locations in Costa Rica and 90 in Guatemala, using a variety of parameterisations.

```{r}
  outputSummary <- function( output ) {
    idoy           <- which( outputNames=="doy" )
    names_vars     <- c(
      "harvDM_f_hay", "harvCPT_f", "harvCPT_2"  , "harvCST_f", "harvCST_3",
      "D_Nsoil"     , "D_Csoil"  , "D_C"        , "D_CT"     , "D_Csys"   ,
      "Shade_f"     , "NfixT_f"  , "Nleaching_f", "Crunoff_f",
      "Csoil_f",
      "doyminHarv1", "doyminHarv2", "doymaxHarv1", "doymaxHarv2" )
    
    fOut           <- matrix( NA, nrow=1, ncol=length(names_vars) )
    colnames(fOut) <- names_vars

    ih_f_hay   <- which( outputNames=="harvDM_f_hay" ) # kg C ha-1 y-1
    ihCPT_f    <- which( outputNames=="harvCPT_f"    ) # kg C m-2 d-1
    ihCPT_2    <- which( outputNames=="harvCPT_t(2)" ) # kg C m-2 d-1
    ihCST_f    <- which( outputNames=="harvCST_f"    ) # kg C m-2 d-1
    ihCST_3    <- which( outputNames=="harvCST_t(3)" ) # kg C m-2 d-1
    iNsoil_f   <- which( outputNames=="Nsoil_f"      ) # kg N m-2
    iCsoil_f   <- which( outputNames=="Csoil_f"      ) # kg C m-2 
    iC_f       <- which( outputNames=="C_f"          ) # kg C m-2
    iCT_f      <- which( outputNames=="CT_f"         ) # kg C m-2
    
    iShade_f   <- which( outputNames=="Shade_f"      ) # m2 m-2
    
    iNfixT     <- which( outputNames=="NfixT_f"      ) # kg N m-2 d-1
    iNleaching <- which( outputNames=="Nleaching_f"  ) # kg N m-2 d-1
    iCrunoff   <- which( outputNames=="Crunoff_f"    ) # kg C m-2 d-1
    
    idayH1     <- which( outputNames=="DayHarv(1)" )
    idayH2     <- which( outputNames=="DayHarv(2)" )

    c.DM  <- 1 / 0.47          # 'kg C' -> 'kg DM'
    c.hay <- 1e4 * 365 / NDAYS # 'm-2 over sim. period' -> 'ha-1 y-1'
    d181  <- which( output[,idoy]==181 )
    
    fOut[,"harvDM_f_hay"] <- mean( output[d181,ih_f_hay] )
    fOut[,"harvCPT_f"   ] <- sum ( output[    ,ihCPT_f ] ) * c.DM * c.hay
    fOut[,"harvCPT_2"   ] <- sum ( output[    ,ihCPT_2 ] ) * c.DM * c.hay
    fOut[,"harvCST_f"   ] <- sum ( output[    ,ihCST_f ] ) * c.DM * c.hay
    fOut[,"harvCST_3"   ] <- sum ( output[    ,ihCST_3 ] ) * c.DM * c.hay
    
    D_output         <- output[NDAYS,] - output[1,]
    fOut[,"D_Nsoil"] <- D_output[iNsoil_f] * c.hay
    fOut[,"D_Csoil"] <- D_output[iCsoil_f] * c.hay
    fOut[,"D_C"    ] <- D_output[iC_f    ] * c.hay
    fOut[,"D_CT"   ] <- D_output[iCT_f   ] * c.hay
    fOut[,"D_Csys" ] <- fOut[,"D_Csoil"] + fOut[,"D_C"] + fOut[,"D_CT"]

    fOut[,"Shade_f"    ] <- mean( output[,iShade_f  ] )
    
    outputFinalYearMean  <- colMeans( output[ (NDAYS-364):NDAYS, ] )
    fOut[,"NfixT_f"    ] <- outputFinalYearMean[iNfixT    ] * 1e4 * 365
    fOut[,"Nleaching_f"] <- outputFinalYearMean[iNleaching] * 1e4 * 365
    fOut[,"Crunoff_f"  ] <- outputFinalYearMean[iCrunoff  ] * 1e4 * 365
    
    fOut[,"Csoil_f"    ] <- output[1,iCsoil_f]

    dHarv1      <- which( output[,idayH1] == 1 )
    dHarv2      <- which( output[,idayH2] == 1 )
    doyHarv1    <- output[dHarv1,3]
    doyHarv2    <- output[dHarv2,3]
    doyminHarv1 <- min( doyHarv1, na.rm=T )
    doyminHarv2 <- min( doyHarv2, na.rm=T )
    doymaxHarv1 <- max( doyHarv1, na.rm=T )
    doymaxHarv2 <- max( doyHarv2, na.rm=T )
    fOut[,"doyminHarv1"] <- doyminHarv1
    fOut[,"doyminHarv2"] <- doyminHarv2
    fOut[,"doymaxHarv1"] <- doymaxHarv1
    fOut[,"doymaxHarv2"] <- doymaxHarv2

    return( fOut )
  }
```

```{r}
  varnames <- c(
    "harvDM_f_hay", "harvCPT_f", "harvCPT_2"  , "harvCST_f", "harvCST_3",
    "D_Nsoil"     , "D_Csoil"  , "D_C"        , "D_CT"     , "D_Csys"   ,
    "Shade_f"     , "NfixT_f"  , "Nleaching_f", "Crunoff_f",
    "Csoil_f",
    "doyminHarv1", "doyminHarv2", "doymaxHarv1", "doymaxHarv2" )

  ip_CNLITT0     <- which( names_params=="CNLITT0"     )
  ip_CNSOMF0     <- which( names_params=="CNSOMF0"     )
  ip_CNSOMS0     <- which( names_params=="CNSOMS0"     )
  ip_CSOM0       <- which( names_params=="CSOM0"       )
  ip_LAT         <- which( names_params=="LAT"         )
  ip_SHADETARGET <- which( names_params=="SHADETARGET" )
  ip_SLOPE       <- which( names_params=="SLOPE"       )
  
  ip_FWCAD  <- which( names_params=="FWCAD"  )
  ip_FWCFC  <- which( names_params=="FWCFC"  )
  ip_FWCWET <- which( names_params=="FWCWET" )
  ip_FWCWP  <- which( names_params=="FWCWP"  )
  ip_WCST   <- which( names_params== "WCST"  )
```

```{r}
  list_outF_C     <- vector( "list", n_C.f )
  for(fi in 1:n_C.f) {
    C_C     <- df_C.f$C.soil [ fi ]
    CN_C    <- df_C.f$CN.soil[ fi ]
    LAT_C   <- df_C.f$lat    [ fi ]
    SLOPE_C <- df_C.f$slope  [ fi ]
    Nfert_C <- df_C.f$Nfert  [ fi ]
    shade_C <- df_C.f$shade  [ fi ]
    
    WCWP_C  <- df_C.f$WP     [ fi ]
    WCFC_C  <- df_C.f$FC     [ fi ]
    WCAD_C  <- 0.01
    WCST_C  <- min( 1, WCFC_C+0.1 )
    WCWET_C <- 0.5 * (WCFC_C + WCST_C)
    
    source( sitesettings_filenames[1] )
    matrix_weather_fi <- read_listweather_CAF( df_C.f$weather.WC, fi )

    calendar_fert_fi <- matrix( -1, nrow=100, ncol=3 )
    calendar_fert_fi [ 1:48, 1 ] <- rep( 2002:2017, each=3 )
    calendar_fert_fi [ 1:48, 2 ] <- c( 135, 289, 350 )
    calendar_fert_fi [ 1:48, 3 ] <- rep( Nfert_C/3, 3 )

    mat_outF                 <- matrix( NA, 2, 1+length(varnames) )
    colnames( mat_outF )     <- c( "FarmSetting", varnames )
    mat_outF[,"FarmSetting"] <- 1:2
    # for(i in 1:2) {
    for(i in 2:2) {
      if(i==1) {
        if(df_C.f$nt[fi]==0) { source(sitesettings_filenames[19])
          params <- parMAP[,19]
        }
        if(df_C.f$nt[fi]==1) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
          params <- set_par("TREEDENS0(3)",0)
        }
        if(df_C.f$nt[fi]==2) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
        } 
        if(df_C.f$nt[fi] >2) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
          params <- set_par_speciesT(2,"Avocado")
        }
        params[ c(ip_CNLITT0,ip_CNSOMF0,ip_CNSOMS0) ] <- CN_C
        params[ ip_CSOM0                            ] <- C_C
        params[ ip_LAT                              ] <- LAT_C
        params[ ip_SLOPE                            ] <- SLOPE_C
        params[ ip_SHADETARGET                      ] <- shade_C
        
        params[ ip_FWCAD  ] <- WCAD_C  / WCST_C
        params[ ip_FWCWP  ] <- WCWP_C  / WCST_C
        params[ ip_FWCFC  ] <- WCFC_C  / WCST_C
        params[ ip_FWCWET ] <- WCWET_C / WCST_C
        params[ ip_WCST   ] <- WCST_C
      }
      if(i==2) {
        if(df_C.f$nt[fi]==0) { source(sitesettings_filenames[19])
          params <- parMAP[,19]
        }
        if(df_C.f$nt[fi]==1) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
          params <- set_par("TREEDENS0(3)",0)
        }
        if(df_C.f$nt[fi]==2) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
        } 
        if(df_C.f$nt[fi] >2) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
          params <- set_par_speciesT(2,"Banana")
        }
        params[ c(ip_CNLITT0,ip_CNSOMF0,ip_CNSOMS0) ] <- CN_C
        params[ ip_CSOM0                            ] <- C_C
        params[ ip_LAT                              ] <- LAT_C
        params[ ip_SLOPE                            ] <- SLOPE_C
        params[ ip_SHADETARGET                      ] <- shade_C
        
        params[ ip_FWCAD  ] <- WCAD_C  / WCST_C
        params[ ip_FWCWP  ] <- WCWP_C  / WCST_C
        params[ ip_FWCFC  ] <- WCFC_C  / WCST_C
        params[ ip_FWCWET ] <- WCWET_C / WCST_C
        params[ ip_WCST   ] <- WCST_C
      }
      outF <- run_model( params, matrix_weather_fi, calendar_fert_fi,
        calendar_prunC, calendar_prunT, calendar_thinT, NDAYS )
      mat_outF[i,1+(1:length(varnames))] <- outputSummary( outF )
    }
    list_outF_C[[fi]] <- mat_outF
  }
```

```{r}
  list_outF_G     <- vector( "list", n_G.f )
  for(fi in 1:n_G.f) {
    C_G     <- df_G.f$C.soil [ fi ]
    CN_G    <- df_G.f$CN.soil[ fi ]
    LAT_G   <- df_G.f$lat    [ fi ]
    SLOPE_G <- df_G.f$slope  [ fi ]
    Nfert_G <- df_G.f$Nfert  [ fi ]
    shade_G <- df_G.f$shade  [ fi ]
    
    WCWP_G  <- df_G.f$WP     [ fi ]
    WCFC_G  <- df_G.f$FC     [ fi ]
    WCAD_G  <- 0.01
    WCST_G  <- min( 1, WCFC_G+0.1 )
    WCWET_G <- 0.5 * (WCFC_G + WCST_G)
    
    source( sitesettings_filenames[1] )
    matrix_weather_fi <- read_listweather_CAF( df_G.f$weather.WC, fi )
    
    calendar_fert_fi <- matrix( -1, nrow=100, ncol=3 )
    calendar_fert_fi [ 1:48, 1 ] <- rep( 2002:2017, each=3 )
    calendar_fert_fi [ 1:48, 2 ] <- c( 135, 289, 350 )
    calendar_fert_fi [ 1:48, 3 ] <- rep( Nfert_G/3, 3 )

    mat_outF                 <- matrix( NA, 2, 1+length(varnames) )
    colnames( mat_outF )     <- c( "FarmSetting", varnames )
    mat_outF[,"FarmSetting"] <- 1:2
    # for(i in 1:2) {
    for(i in 2:2) {
      if(i==1) {
        if(df_G.f$nt[fi]==0) { source(sitesettings_filenames[19])
          params <- parMAP[,19]
        }
        if(df_G.f$nt[fi]==1) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
          params <- set_par("TREEDENS0(3)",0)
        }
        if(df_G.f$nt[fi]==2) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
        } 
        if(df_G.f$nt[fi] >2) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
          params <- set_par_speciesT(2,"Avocado")
        }
        params[ c(ip_CNLITT0,ip_CNSOMF0,ip_CNSOMS0) ] <- CN_G
        params[ ip_CSOM0                            ] <- C_G
        params[ ip_LAT                              ] <- LAT_G
        params[ ip_SLOPE                            ] <- SLOPE_G
        params[ ip_SHADETARGET                      ] <- shade_G
        
        params[ ip_FWCAD  ] <- WCAD_G  / WCST_G
        params[ ip_FWCWP  ] <- WCWP_G  / WCST_G
        params[ ip_FWCFC  ] <- WCFC_G  / WCST_G
        params[ ip_FWCWET ] <- WCWET_G / WCST_G
        params[ ip_WCST   ] <- WCST_G
      }
      if(i==2) {
        if(df_G.f$nt[fi]==0) { source(sitesettings_filenames[19])
          params <- parMAP[,19]
        }
        if(df_G.f$nt[fi]==1) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
          params <- set_par("TREEDENS0(3)",0)
        }
        if(df_G.f$nt[fi]==2) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
        } 
        if(df_G.f$nt[fi] >2) { source(sitesettings_filenames[31])
          params <- parMAP[,31]
          params <- set_par_speciesT(2,"Banana")
        }
        params[ c(ip_CNLITT0,ip_CNSOMF0,ip_CNSOMS0) ] <- CN_G
        params[ ip_CSOM0                            ] <- C_G
        params[ ip_LAT                              ] <- LAT_G
        params[ ip_SLOPE                            ] <- SLOPE_G
        params[ ip_SHADETARGET                      ] <- shade_G
        
        params[ ip_FWCAD  ] <- WCAD_G  / WCST_G
        params[ ip_FWCWP  ] <- WCWP_G  / WCST_G
        params[ ip_FWCFC  ] <- WCFC_G  / WCST_G
        params[ ip_FWCWET ] <- WCWET_G / WCST_G
        params[ ip_WCST   ] <- WCST_G
      }
      outF <- run_model( params, matrix_weather_fi, calendar_fert_fi,
        calendar_prunC, calendar_prunT, calendar_thinT, NDAYS )
      mat_outF[i,1+(1:length(varnames))] <- outputSummary( outF )
    }
    list_outF_G[[fi]] <- mat_outF
  }
```

```{r}
  df_C.f_sim <- df_C.f %>%
    select ( code ) %>%
    arrange( code ) %>%
    mutate ( outF  = list_outF_C )

  df_G.f_sim <- df_G.f %>%
    select ( code ) %>%
    arrange( code ) %>%
    mutate ( outF  = list_outF_G )
```

## Farm simulations

```{r}
  dfoutFSummary <- function( df=df_C.f_sim, Fi=1 ){
    nf     <- dim( df )[1]
    vnames <- colnames( df$outF[[1]] ) ; nv <- length(vnames)
    matres <- matrix( NA, nf, nv ) ; colnames( matres) <- vnames
    F.v    <- matres
    for(fi in 1:nf){
      F.v[fi,] <- df$outF[[fi]][Fi,]
    }
    return( F.v )
  }
```

```{r}
  par( mfrow=c(2,2), mar=c(3,3,1,1) )

  F2_C             <- dfoutFSummary( df_C.f_sim, Fi=2 )
  Csoil_F2_C.f_sim <- F2_C[,"Csoil_f"]
  plot( df_C.f$C.soil, Csoil_F2_C.f_sim )
  F2_G             <- dfoutFSummary( df_G.f_sim, Fi=2 )
  Csoil_F2_G.f_sim <- F2_G[,"Csoil_f"]
  plot( df_G.f$C.soil, Csoil_F2_G.f_sim )

  F2_C             <- dfoutFSummary( df_C.f_sim, Fi=2 )
  Shade_F2_C.f_sim <- F2_C[,"Shade_f"]
  plot( df_C.f$shade, Shade_F2_C.f_sim )
  F2_G             <- dfoutFSummary( df_G.f_sim, Fi=2 )
  Shade_F2_G.f_sim <- F2_G[,"Shade_f"]
  plot( df_G.f$shade, Shade_F2_G.f_sim )
```

Note that Costa Rica farm 1157 achieves a shade of 0.23 despite having nt=0 shade trees!

```{r}
  df <- df_C.f_sim
  F1_C <- dfoutFSummary( df, Fi=1 ) ; yF1_C.f_sim <- F1_C[,"harvDM_f_hay"]
  F2_C <- dfoutFSummary( df, Fi=2 ) ; yF2_C.f_sim <- F2_C[,"harvDM_f_hay"]

  df <- df_G.f_sim
  F1_G <- dfoutFSummary( df, Fi=1 ) ; yF1_G.f_sim <- F1_G[,"harvDM_f_hay"]
  F2_G <- dfoutFSummary( df, Fi=2 ) ; yF2_G.f_sim <- F2_G[,"harvDM_f_hay"]
```

We now finally come to the simulations for all farms that were intended to be more realistic, by using farm-specific information on weather, soil, nitrogen fertilisation rate, and number of shade tree species. In the absence of detailed information on shade tree species and shade management, we made the following assumptions:

- If the number of reported shade tree species was 1, we simulated a system shaded by Inga laurina (managed as in Masatepe experiment treatment 31)
- If there were 2 species, we added Simarouba glauca (conform Masatepe experiment treatment 31)
- If there were 3 or more species, we added banana.

Results of these simulations are shown in Figs \ref{fig:XX14}, \ref{fig:XX15}, and \ref{fig:XX16}. Fig. \ref{fig:XX14} shows how the long-term average annual coffee yields simulated by the model for the years 2000-2014 compares to the yield reported for the farms for the year 2019. The correlations are not very strong. Fig. \ref{fig:XX15} shows, for farms in Costa Rica, observations and simulations of multiple variables, all plotted against each farm's N-fertilisation rate. Farms are grouped by number of shade tree species but no clear differences between the groups are visible. Apart from shade, all variables show a positive or negative correlation with fertilisation. The negative correlation in the case of soil carbon loss in runoff is likely due to fertilisation enhancing vegetation LAI, which in the model reduces erosion. The same variables are shown in Fig. \ref{fig:XX16} for Guatemala, with similar results albeit more difficult to see because of the distorting influence of having farms with excessive N-fertilisation rate in the plots.

```{r XX14, fig.height=4, fig.cap="\\label{fig:XX14}Observed yields at the farms in Costa Rica (left) and Guatemala (right) plotted against long-term average simulated yields. The simulations used farm-specific information on weather, soil, N-fertilisation and number of shade tree species, but not site-specific shade management."}
  par( mfrow=c(1,2), mar=c(4,2,2,2), mgp=c(2,1,0) )

  # x=yF1_C.f_sim ; y=df_C.f$yield ; plotxylm("Obs. Costa Rica")
  x=yF2_C.f_sim ; y=df_C.f$yield ; plotxylm("Obs. Costa Rica")

  # x=yF1_G.f_sim ; y=df_G.f$yield ; plotxylm("Obs. Guatemala")
  x=yF2_G.f_sim ; y=df_G.f$yield ; plotxylm("Obs. Guatemala")
```

```{r}
  int1_C <- which(df_C.f$nt <2) ; int1_G <- which(df_G.f$nt <2)
  int2_C <- which(df_C.f$nt==2) ; int2_G <- which(df_G.f$nt==2)
  int3_C <- which(df_C.f$nt >2) ; int3_G <- which(df_G.f$nt >2)
  
  nnt1_C <- length(int1_C)      ; nnt1_G <- length(int1_G)
  nnt2_C <- length(int2_C)      ; nnt2_G <- length(int2_G)
  nnt3_C <- length(int3_C)      ; nnt3_G <- length(int3_G)
  
  listmat_nt_C <- listmat_nt_G <- vector( "list", 3 )
  varnames.listmat <- c( "code","slope","nt","Nfert","shade","y.obs",
    "y.sim","D_Csoil","Shade_f","Nleaching_f","Crunoff_f",
    "Csoil_f", "doyminHarv1", "doyminHarv2", "doymaxHarv1", "doymaxHarv2" )

  listmat_nt_C[[1]] <- t( sapply( 1:nnt1_C, function(i){ cbind(
    code    = df_C.f    [int1_C,]$code [[i]]                    ,
    slope   = df_C.f    [int1_C,]$slope[[i]]                    ,
    nt      = df_C.f    [int1_C,]$nt   [[i]]                    ,
    Nfert   = df_C.f    [int1_C,]$Nfert[[i]]                    ,
    shade   = df_C.f    [int1_C,]$shade[[i]]                    ,
    y.obs   = df_C.f    [int1_C,]$yield[[i]]                    ,
    y.sim   = df_C.f_sim[int1_C,]$outF [[i]][,"harvDM_f_hay"][2],
    D_Csoil = df_C.f_sim[int1_C,]$outF [[i]][,"D_Csoil"     ][2],
    shade   = df_C.f_sim[int1_C,]$outF [[i]][,"Shade_f"     ][2],
    Nleach  = df_C.f_sim[int1_C,]$outF [[i]][,"Nleaching_f" ][2],
    Crunoff = df_C.f_sim[int1_C,]$outF [[i]][,"Crunoff_f"   ][2],
    Csoil   = df_C.f_sim[int1_C,]$outF [[i]][,"Csoil_f"     ][2],
    doymnH1 = df_C.f_sim[int1_C,]$outF [[i]][,"doyminHarv1" ][2],
    doymnH2 = df_C.f_sim[int1_C,]$outF [[i]][,"doyminHarv2" ][2],
    doymxH1 = df_C.f_sim[int1_C,]$outF [[i]][,"doymaxHarv1" ][2],
    doymxH2 = df_C.f_sim[int1_C,]$outF [[i]][,"doymaxHarv2" ][2]
  ) } ) )
  colnames(listmat_nt_C[[1]]) <- varnames.listmat

  listmat_nt_C[[2]] <- t( sapply( 1:nnt2_C, function(i){ cbind(
    code    = df_C.f    [int2_C,]$code [[i]]                    ,
    slope   = df_C.f    [int2_C,]$slope[[i]]                    ,
    nt      = df_C.f    [int2_C,]$nt   [[i]]                    ,
    Nfert   = df_C.f    [int2_C,]$Nfert[[i]]                    ,
    shade   = df_C.f    [int2_C,]$shade[[i]]                    ,
    y.obs   = df_C.f    [int2_C,]$yield[[i]]                    ,
    y.sim   = df_C.f_sim[int2_C,]$outF [[i]][,"harvDM_f_hay"][2],
    D_Csoil = df_C.f_sim[int2_C,]$outF [[i]][,"D_Csoil"     ][2],
    shade   = df_C.f_sim[int2_C,]$outF [[i]][,"Shade_f"     ][2],
    Nleach  = df_C.f_sim[int2_C,]$outF [[i]][,"Nleaching_f" ][2],
    Crunoff = df_C.f_sim[int2_C,]$outF [[i]][,"Crunoff_f"   ][2],
    Csoil   = df_C.f_sim[int2_C,]$outF [[i]][,"Csoil_f"     ][2],
    doymnH1 = df_C.f_sim[int2_C,]$outF [[i]][,"doyminHarv1" ][2],
    doymnH2 = df_C.f_sim[int2_C,]$outF [[i]][,"doyminHarv2" ][2],
    doymxH1 = df_C.f_sim[int2_C,]$outF [[i]][,"doymaxHarv1" ][2],
    doymxH2 = df_C.f_sim[int2_C,]$outF [[i]][,"doymaxHarv2" ][2]
  ) } ) )
  colnames(listmat_nt_C[[2]]) <- varnames.listmat

  listmat_nt_C[[3]] <- t( sapply( 1:nnt3_C, function(i){ cbind(
    code    = df_C.f    [int3_C,]$code [[i]]                    ,
    slope   = df_C.f    [int3_C,]$slope[[i]]                    ,
    nt      = df_C.f    [int3_C,]$nt   [[i]]                    ,
    Nfert   = df_C.f    [int3_C,]$Nfert[[i]]                    ,
    shade   = df_C.f    [int3_C,]$shade[[i]]                    ,
    y.obs   = df_C.f    [int3_C,]$yield[[i]]                    ,
    y.sim   = df_C.f_sim[int3_C,]$outF [[i]][,"harvDM_f_hay"][2],
    D_Csoil = df_C.f_sim[int3_C,]$outF [[i]][,"D_Csoil"     ][2],
    shade   = df_C.f_sim[int3_C,]$outF [[i]][,"Shade_f"     ][2],
    Nleach  = df_C.f_sim[int3_C,]$outF [[i]][,"Nleaching_f" ][2],
    Crunoff = df_C.f_sim[int3_C,]$outF [[i]][,"Crunoff_f"   ][2],
    Csoil   = df_C.f_sim[int3_C,]$outF [[i]][,"Csoil_f"     ][2],
    doymnH1 = df_C.f_sim[int3_C,]$outF [[i]][,"doyminHarv1" ][2],
    doymnH2 = df_C.f_sim[int3_C,]$outF [[i]][,"doyminHarv2" ][2],
    doymxH1 = df_C.f_sim[int3_C,]$outF [[i]][,"doymaxHarv1" ][2],
    doymxH2 = df_C.f_sim[int3_C,]$outF [[i]][,"doymaxHarv2" ][2]
  ) } ) )
  colnames(listmat_nt_C[[3]]) <- varnames.listmat

  listmat_nt_G[[1]] <- t( sapply( 1:nnt1_G, function(i){ cbind(
    code    = df_G.f    [int1_G,]$code [[i]]                    ,
    slope   = df_G.f    [int1_G,]$slope[[i]]                    ,
    nt      = df_G.f    [int1_G,]$nt   [[i]]                    ,
    Nfert   = df_G.f    [int1_G,]$Nfert[[i]]                    ,
    shade   = df_G.f    [int1_G,]$shade[[i]]                    ,
    y.obs   = df_G.f    [int1_G,]$yield[[i]]                    ,
    y.sim   = df_G.f_sim[int1_G,]$outF [[i]][,"harvDM_f_hay"][2],
    D_Csoil = df_G.f_sim[int1_G,]$outF [[i]][,"D_Csoil"     ][2],
    shade   = df_G.f_sim[int1_G,]$outF [[i]][,"Shade_f"     ][2],
    Nleach  = df_G.f_sim[int1_G,]$outF [[i]][,"Nleaching_f" ][2],
    Crunoff = df_G.f_sim[int1_G,]$outF [[i]][,"Crunoff_f"   ][2],
    Csoil   = df_G.f_sim[int1_G,]$outF [[i]][,"Csoil_f"     ][2],
    doymnH1 = df_G.f_sim[int1_G,]$outF [[i]][,"doyminHarv1" ][2],
    doymnH2 = df_G.f_sim[int1_G,]$outF [[i]][,"doyminHarv2" ][2],
    doymxH1 = df_G.f_sim[int1_G,]$outF [[i]][,"doymaxHarv1" ][2],
    doymxH2 = df_G.f_sim[int1_G,]$outF [[i]][,"doymaxHarv2" ][2]
  ) } ) )
  colnames(listmat_nt_G[[1]]) <- varnames.listmat

  listmat_nt_G[[2]] <- t( sapply( 1:nnt2_G, function(i){ cbind(
    code    = df_G.f    [int2_G,]$code [[i]]                    ,
    slope   = df_G.f    [int2_G,]$slope[[i]]                    ,
    nt      = df_G.f    [int2_G,]$nt   [[i]]                    ,
    Nfert   = df_G.f    [int2_G,]$Nfert[[i]]                    ,
    shade   = df_G.f    [int2_G,]$shade[[i]]                    ,
    y.obs   = df_G.f    [int2_G,]$yield[[i]]                    ,
    y.sim   = df_G.f_sim[int2_G,]$outF [[i]][,"harvDM_f_hay"][2],
    D_Csoil = df_G.f_sim[int2_G,]$outF [[i]][,"D_Csoil"     ][2],
    shade   = df_G.f_sim[int2_G,]$outF [[i]][,"Shade_f"     ][2],
    Nleach  = df_G.f_sim[int2_G,]$outF [[i]][,"Nleaching_f" ][2],
    Crunoff = df_G.f_sim[int2_G,]$outF [[i]][,"Crunoff_f"   ][2],
    Csoil   = df_G.f_sim[int2_G,]$outF [[i]][,"Csoil_f"     ][2],
    doymnH1 = df_G.f_sim[int2_G,]$outF [[i]][,"doyminHarv1" ][2],
    doymnH2 = df_G.f_sim[int2_G,]$outF [[i]][,"doyminHarv2" ][2],
    doymxH1 = df_G.f_sim[int2_G,]$outF [[i]][,"doymaxHarv1" ][2],
    doymxH2 = df_G.f_sim[int2_G,]$outF [[i]][,"doymaxHarv2" ][2]
  ) } ) )
  colnames(listmat_nt_G[[2]]) <- varnames.listmat

  listmat_nt_G[[3]] <- t( sapply( 1:nnt3_G, function(i){ cbind(
    code    = df_G.f    [int3_G,]$code [[i]]                    ,
    slope   = df_G.f    [int3_G,]$slope[[i]]                    ,
    nt      = df_G.f    [int3_G,]$nt   [[i]]                    ,
    Nfert   = df_G.f    [int3_G,]$Nfert[[i]]                    ,
    shade   = df_G.f    [int3_G,]$shade[[i]]                    ,
    y.obs   = df_G.f    [int3_G,]$yield[[i]]                    ,
    y.sim   = df_G.f_sim[int3_G,]$outF [[i]][,"harvDM_f_hay"][2],
    D_Csoil = df_G.f_sim[int3_G,]$outF [[i]][,"D_Csoil"     ][2],
    shade   = df_G.f_sim[int3_G,]$outF [[i]][,"Shade_f"     ][2],
    Nleach  = df_G.f_sim[int3_G,]$outF [[i]][,"Nleaching_f" ][2],
    Crunoff = df_G.f_sim[int3_G,]$outF [[i]][,"Crunoff_f"   ][2],
    Csoil   = df_G.f_sim[int3_G,]$outF [[i]][,"Csoil_f"     ][2],
    doymnH1 = df_G.f_sim[int3_G,]$outF [[i]][,"doyminHarv1" ][2],
    doymnH2 = df_G.f_sim[int3_G,]$outF [[i]][,"doyminHarv2" ][2],
    doymxH1 = df_G.f_sim[int3_G,]$outF [[i]][,"doymaxHarv1" ][2],
    doymxH2 = df_G.f_sim[int3_G,]$outF [[i]][,"doymaxHarv2" ][2]
  ) } ) )
  colnames(listmat_nt_G[[3]]) <- varnames.listmat
```

```{r}
  plotimpacts_nt.Nfert <- function( listmat=listmat_nt_C, var="y.sim" ){
    plot  ( listmat[[1]][,"Nfert"], listmat[[1]][,var],
      xlab="Nfert", ylab="",main=var, pch=1,
      xlim=c(0,max(listmat[[1]][,"Nfert"],listmat[[2]][,"Nfert"],
                   listmat[[3]][,"Nfert"])),
      ylim=c(min(0,listmat[[1]][,var],listmat[[2]][,var],listmat[[3]][,var]),
             max(  listmat[[1]][,var],listmat[[2]][,var],listmat[[3]][,var])) )
    points( listmat[[2]][,"Nfert"], listmat[[2]][,var], pch=20, col="red"  )
    points( listmat[[3]][,"Nfert"], listmat[[3]][,var], pch=6, col="blue" )
    
    y.lm.nt1 <- lm( listmat[[1]][,var] ~ listmat[[1]][,"Nfert"] )
    y.lm.nt2 <- lm( listmat[[2]][,var] ~ listmat[[2]][,"Nfert"] )
    y.lm.nt3 <- lm( listmat[[3]][,var] ~ listmat[[3]][,"Nfert"] )
    r2.nt1   <- round( summary(y.lm.nt1)$r.squared, 2 )
    r2.nt2   <- round( summary(y.lm.nt2)$r.squared, 2 )
    r2.nt3   <- round( summary(y.lm.nt3)$r.squared, 2 )
    abline( y.lm.nt1$coefficients[1], y.lm.nt1$coefficients[2], col="black" )
    abline( y.lm.nt2$coefficients[1], y.lm.nt2$coefficients[2], col="red" )
    abline( y.lm.nt3$coefficients[1], y.lm.nt3$coefficients[2], col="blue" )
    legend( "bottomright", title="r2",
            legend=c( paste("n<2:",as.character(r2.nt1)),
              paste("n=2:",as.character(r2.nt2)),
              paste("n>2:",as.character(r2.nt3)) ),
            col=c("black","red","blue"), lty=c(1), cex=0.5 )
  }
```

```{r XX15, fig.height=7.5, fig.cap="\\label{fig:XX15}Yield-observations for farms in Costa Rica (y.obs; kg DM ha-1 y-1) plus simulations of five variables: Long-term average coffee yield (y.obs; kg DM ha-1 y-1), Change in soil carbon (D_Csoil; kg ha-1 y-1), Average shade level (-), Final year nitrogen leaching (kg N ha-1 y-1), Final year carbon loss in run-off (kg C ha-1 y-1)."}
  par(mfrow=c(3,3),mar=c(4,2,2,2), mgp=c(2,1,0))

  plotimpacts_nt.Nfert( listmat_nt_C, "shade" )
  plotimpacts_nt.Nfert( listmat_nt_C, "y.obs" )
  plotimpacts_nt.Nfert( listmat_nt_C, "y.sim" )
  plotimpacts_nt.Nfert( listmat_nt_C, "D_Csoil" )
  plotimpacts_nt.Nfert( listmat_nt_C, "Shade_f" )
  plotimpacts_nt.Nfert( listmat_nt_C, "Nleaching_f" )
  plotimpacts_nt.Nfert( listmat_nt_C, "Crunoff_f" )
  plotimpacts_nt.Nfert( listmat_nt_C, "Csoil_f" )
  plotimpacts_nt.Nfert( listmat_nt_C, "doymaxHarv2" )
```

```{r XX16, fig.height=7.5, fig.cap="\\label{fig:XX16}Yield-observations for farms in Guatemala plus simulations of five variables: see previous figure for explanation of variables."}
  par(mfrow=c(3,3),mar=c(4,2,2,2), mgp=c(2,1,0))

  plotimpacts_nt.Nfert( listmat_nt_G, "shade" )
  plotimpacts_nt.Nfert( listmat_nt_G, "y.obs" )
  plotimpacts_nt.Nfert( listmat_nt_G, "y.sim" )
  plotimpacts_nt.Nfert( listmat_nt_G, "D_Csoil" )
  plotimpacts_nt.Nfert( listmat_nt_G, "Shade_f" )
  plotimpacts_nt.Nfert( listmat_nt_G, "Nleaching_f" )
  plotimpacts_nt.Nfert( listmat_nt_G, "Crunoff_f" )
  plotimpacts_nt.Nfert( listmat_nt_G, "Csoil_f" )
  plotimpacts_nt.Nfert( listmat_nt_G, "doymaxHarv2" )
```



\clearpage

# Weather data 2019-2020

```{r}
  dir_weatherstations <- "weather/Climatic_Data/"
    dir_C_Icafe   <- "CostaRica/Icafe/"
    dir_C_IMN     <- "CostaRica/IMN/"
    dir_G_Anacafe <- "Guatemala/Anacafe/"

  dir_Icafe     <- paste0( dir_weatherstations, dir_C_Icafe   ) 
  dir_IMN       <- paste0( dir_weatherstations, dir_C_IMN     )
  dir_Anacafe   <- paste0( dir_weatherstations, dir_G_Anacafe ) 
  
  file_Icafe    <- "Datos confidenciales CLIMA-ICAFE- Convenio CATIE.xlsx"
  files_IMN.TMIN <- list.files( dir_IMN, pattern="*TMIN_TMAX_RAIN.xlsx" )
  files_IMN.TMAX <- list.files( dir_IMN, pattern="*TMIN_TMAX_RAIN.xlsx" )
  files_IMN.RAIN <- list.files( dir_IMN, pattern="*RAIN.xlsx" )
    n_IMN.TMIN   <- length( files_IMN.TMIN )
    n_IMN.TMAX   <- length( files_IMN.TMAX )
    n_IMN.RAIN   <- length( files_IMN.RAIN )
  files_Anacafe <- list.files( dir_Anacafe )
    n_Anacafe   <- length( files_Anacafe )
```

```{r}
  df_Icafe       <- read_excel( paste0(dir_Icafe,file_Icafe) )
  stations_Icafe <- unique(df_Icafe$Estacion) ; n_Icafe <- length(stations_Icafe)

  list_Icafe.a    <- list_Icafe    <- vector( "list", n_Icafe    )
  list_IMN.TMIN.a <- list_IMN.TMIN <- vector( "list", n_IMN.TMIN )
  list_IMN.TMAX.a <- list_IMN.TMAX <- vector( "list", n_IMN.TMAX )
  list_IMN.RAIN.a <- list_IMN.RAIN <- vector( "list", n_IMN.RAIN )
  list_Anacafe.a  <- list_Anacafe  <- vector( "list", n_Anacafe  )

  for( s in 1:n_Icafe ) {
    list_Icafe[[s]]   <- df_Icafe %>% filter( Estacion==stations_Icafe[s] ) }
  for( s in 1:n_IMN.TMIN ) {
    fs <- paste0(dir_IMN,files_IMN.TMIN[s])
    list_IMN.TMIN[[s]] <- read_excel( fs, sheet="TMIN", skip=1,
                                      col_type="numeric" ) }
  for( s in 1:n_IMN.TMAX ) {
    fs <- paste0(dir_IMN,files_IMN.TMAX[s])
    list_IMN.TMAX[[s]] <- read_excel( fs, sheet="TMAX", skip=1,
                                      col_type="numeric" ) }
  for( s in 1:n_IMN.RAIN ) {
    fs <- paste0(dir_IMN,files_IMN.RAIN[s])
    list_IMN.RAIN[[s]] <- read_excel( fs, sheet="RAIN", skip=1,
                                      col_type="numeric" ) }
  for( s in 1:n_Anacafe ) {
    list_Anacafe[[s]] <- read_csv( paste0(dir_Anacafe,files_Anacafe[s]) ) }
```

```{r}
  for( s in 1:n_Icafe ) {
    list_Icafe.a[[s]] <- list_Icafe[[s]] %>%
      rename( ST = Estacion ) %>%
      rename( TMAX    = "Temperatura máxima °C" ) %>%
      rename( TMIN    = "Temperatura mínima °C" ) %>%
      rename( RAIN    = "Lluvia mm" ) %>%
      select( ST, year, month, TMIN, TMAX, RAIN ) %>%
      group_by( ST, year, month ) %>%
      summarize( TMIN = mean(TMIN,na.rm=T),
                 TMAX = mean(TMAX,na.rm=T),
                 RAIN = sum (RAIN,na.rm=T) ) %>%
      group_by ( month ) %>%
      mutate( TMIN.m = mean(TMIN,na.rm=T) ) %>%
      mutate( TMAX.m = mean(TMAX,na.rm=T) ) %>%
      mutate( RAIN.m = mean(RAIN,na.rm=T) ) %>%
      filter( year>=2019 ) %>%
      mutate( TMIN.a = TMIN - TMIN.m ) %>%
      mutate( TMAX.a = TMAX - TMAX.m ) %>%
      mutate( RAIN.a = RAIN - RAIN.m ) %>%
      mutate( lat    = ifelse(ST=="Orosi"      ,  9.78529,
                       ifelse(ST=="Atirro"     ,  9.8612 ,
                       ifelse(ST=="Santa Rosa" ,  9.92852,
                       ifelse(ST=="San Ramón"  , 10.06455,
                       ifelse(ST=="Naranjo"    , 10.10778,
                       ifelse(ST=="Frailes"    ,  9.75   ,
                       ifelse(ST=="San Carlos" ,  9.62661,
                       ifelse(ST=="San Lorenzo",  9.6414 ,
                       ifelse(ST=="Dota"       ,  9.65056,
                              NA ))))))))) ) %>%
      mutate( lon    = ifelse(ST=="Orosi"      , -83.84652,
                       ifelse(ST=="Atirro"     , -83.6358 ,
                       ifelse(ST=="Santa Rosa" , -83.69964,
                       ifelse(ST=="San Ramón"  , -84.47379,
                       ifelse(ST=="Naranjo"    , -84.38361,
                       ifelse(ST=="Frailes"    , -84.05306,
                       ifelse(ST=="San Carlos" , -84.09163,
                       ifelse(ST=="San Lorenzo", -84.02354,
                       ifelse(ST=="Dota"       , -83.9575 ,
                              NA ))))))))) ) %>%
      dplyr::select( ST, lat, lon, year, month, TMIN.a, TMAX.a, RAIN.a )
  }
  for( s in 1:n_Icafe ) { list_Icafe.a[[s]] %>% print(n = 1) }
```

```{r}
  for(s in 1:n_IMN.TMIN) {
    list_IMN.TMIN.a[[s]] <- list_IMN.TMIN[[s]] %>%
      rename( month = Mes ) %>%
      rename( year = Año ) %>%
      mutate( TMIN = rowMeans( select(.,starts_with("D")), na.rm=T) ) %>%
      dplyr::select( year, month, TMIN ) %>%
      group_by ( month ) %>%
      mutate( TMIN.m = mean(TMIN,na.rm=T) ) %>%
      filter( year>=2019 ) %>%
      mutate( TMIN.a = TMIN - TMIN.m ) %>%
      mutate( ST = substr(files_IMN.TMAX[s],1,5) ) %>%
      dplyr::select( ST, year, month, TMIN.a ) %>%
      print ( n=Inf, width=Inf ) }

  for(s in 1:n_IMN.TMAX) {
    list_IMN.TMAX.a[[s]] <- list_IMN.TMAX[[s]] %>%
      rename( month = Mes ) %>%
      rename( year = Año ) %>%
      mutate( TMAX = rowMeans( select(.,starts_with("D")), na.rm=T) ) %>%
      dplyr::select( year, month, TMAX ) %>%
      group_by ( month ) %>%
      mutate( TMAX.m = mean(TMAX,na.rm=T) ) %>%
      filter( year>=2019 ) %>%
      mutate( TMAX.a = TMAX - TMAX.m ) %>%
      mutate( ST = substr(files_IMN.TMAX[s],1,5) ) %>%
      dplyr::select( ST, year, month, TMAX.a ) %>%
      print ( n=Inf, width=Inf ) }

  for(s in 1:n_IMN.RAIN) {
    list_IMN.RAIN.a[[s]] <- list_IMN.RAIN[[s]] %>%
      rename( month = Mes ) %>%
      rename( year = Año ) %>%
      mutate( RAIN = rowSums( select(.,starts_with("D")), na.rm=T) ) %>%
      dplyr::select( year, month, RAIN ) %>%
      group_by ( month ) %>%
      mutate( RAIN.m = mean(RAIN,na.rm=T) ) %>%
      filter( year>=2019 ) %>%
      mutate( RAIN.a = RAIN - RAIN.m ) %>%
      mutate( ST = substr(files_IMN.RAIN[s],1,5) ) %>%
      dplyr::select( ST, year, month, RAIN.a ) %>%
      print ( n=Inf, width=Inf ) }

  list_IMN.a <- list_IMN.RAIN.a
  for(s in 1:n_IMN.RAIN) {
    list_IMN.a[[s]] <- list_IMN.a[[s]] %>%
      mutate( lat = ifelse(ST==73048,  9.838611,
                    ifelse(ST==73123,  9.852222,
                    ifelse(ST==84187, 10.005   ,
                    ifelse(ST==84189, 10.13733 ,
                    ifelse(ST==88039,  9.766667,
                    ifelse(ST==88047,  9.736667,
                           NA )))))) ) %>%
      mutate( lon = ifelse(ST==73048, -83.90722,
                    ifelse(ST==73123, -83.90861,
                    ifelse(ST==84187, -84.26556,
                    ifelse(ST==84189, -84.1935 ,
                    ifelse(ST==88039, -84.09056,
                    ifelse(ST==88047, -84.00056,
                           NA )))))) ) %>%
      dplyr::select( ST, lat, lon, year, month, RAIN.a )
    }
  for(s in 1:n_IMN.RAIN) {
    sTMIN <- which( files_IMN.RAIN[s] == files_IMN.TMIN )
    if (length(sTMIN>0)) {
      list_IMN.a[[s]] <- list_IMN.a[[s]] %>%
        inner_join( list_IMN.TMIN.a[[sTMIN]], by=c("ST","year","month") ) %>%
        dplyr::select(ST,lat,lon,year,month,TMIN.a,RAIN.a)
    }
    sTMAX <- which( files_IMN.RAIN[s] == files_IMN.TMAX )
    if (length(sTMAX>0)) {
      list_IMN.a[[s]] <- list_IMN.a[[s]] %>%
        inner_join( list_IMN.TMAX.a[[sTMAX]], by=c("ST","year","month") ) %>%
        dplyr::select(ST,lat,lon,year,month,TMIN.a,TMAX.a,RAIN.a)
    }
  }
```

```{r}
  for( s in 1:n_Anacafe ) {
    list_Anacafe.a[[s]] <- list_Anacafe[[s]] %>%
      rename( ST    = ID_ESTACION ) %>%
      rename( lat   = LATITUD     ) %>%
      rename( lon   = LONGITUD    ) %>%
      rename( TMEAN = "TMP" ) %>%
      rename( RAIN  = "RNF" ) %>%
      select( ST, lat, lon, year, month, TMEAN, RAIN ) %>%
      group_by( ST, lat, lon, year, month ) %>%
      summarize( TMEAN = mean(TMEAN,na.rm=T),
                 RAIN  = sum (RAIN ,na.rm=T) ) %>%
      group_by ( month ) %>%
      mutate( TMEAN.m = mean(TMEAN,na.rm=T) ) %>%
      mutate( RAIN.m  = mean(RAIN ,na.rm=T) ) %>%
      filter( year>=2019 ) %>%
      mutate( TMEAN.a = TMEAN - TMEAN.m ) %>%
      mutate( RAIN.a  = RAIN  - RAIN.m  ) %>%
      dplyr::select( ST, lat, lon, year, month, TMEAN.a, RAIN.a )
  }
  # for( s in 1:n_Anacafe ) { list_Anacafe.a[[s]] %>% print(n = 20, width=Inf) }
```

```{r}
  Icafe.a <- list_Icafe.a[[1]]
  for(s in 2:n_Icafe   ) { Icafe.a <- rbind(Icafe.a,list_Icafe.a[[s]]) }
  IMN.a   <- list_IMN.a  [[1]]
  for(s in 2:n_IMN.RAIN) { IMN.a <- rbind( IMN.a, list_IMN.a[[s]] ) }

  C.a     <- rbind( Icafe.a, IMN.a )
  C.a %>% print(width=Inf,n=Inf)
  
  G.a     <- list_Anacafe.a[[1]]
  for(s in 2:n_Anacafe) { G.a <- rbind( G.a, list_Anacafe.a[[s]] ) }
  ioutlier.TMEAN_G <- which( abs(G.a$TMEAN.a)>5 )
  G.a$TMEAN.a[ioutlier.TMEAN_G] <- NA

  G.a %>% print(width=Inf,n=Inf)
```

```{r}
  df.ym <- function(df,y,m) {df %>% filter(year==y) %>% filter(month==m)}
```

```{r}
  par( mfrow=c(3,4), mar=c(2,2,1,1) )

  country="C" ; df=C.a ; xvar="lat"
  
  yvar="TMIN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
  
  yvar="TMAX.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
  
  yvar="RAIN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
```

```{r}
  par( mfrow=c(3,4), mar=c(2,2,1,1) )

  country="C" ; df=C.a ; xvar="lon"
  
  yvar="TMIN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
  
  yvar="TMAX.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
  
  yvar="RAIN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
```

```{r}
  par( mfrow=c(3,4), mar=c(2,2,1,1) )

  country="G" ; df=G.a ; xvar="lat"
  
  yvar="TMEAN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
  
  yvar="RAIN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
```

```{r}
  par( mfrow=c(3,4), mar=c(2,2,1,1) )

  country="G" ; df=G.a ; xvar="lon"
  
  yvar="TMEAN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
  
  yvar="RAIN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
```



\clearpage

# Yields from second harvest season (2019/2020)

```{r}
  dir.f         <- "data/Farms SEACAF/"

  file_yield2.f <- "Database SEACAF - Net income.xlsx"
```

```{r}
  df_yield2.f <- read_excel( paste0(dir.f,file_yield2.f) )

  df_yield2.f <- df_yield2.f %>%
    mutate( code      = ifelse(country=="Costa Rica", 1000,
                        ifelse(country=="Guatemala" , 2000,
                               NA )) ) %>%
    mutate( code_farm = as.numeric( substring(code_farm,first=3) ) ) %>%
    mutate( code      = code + code_farm ) %>%
    mutate( yield2    = prodcafe_ha / 3 ) %>%
    dplyr::select( code, yield2 )
```

```{r}
  df_yield2_C.f <- df_yield2.f %>% subset( df_yield2.f$code <  2000 )
  df_yield2_G.f <- df_yield2.f %>% subset( df_yield2.f$code >= 2000 )

  df_C12.f      <- df_C.f %>% inner_join( df_yield2_C.f, by=c("code") )
  df_G12.f      <- df_G.f %>% inner_join( df_yield2_G.f, by=c("code") )
```

```{r}
  par( mfrow=c(1,2) )

  x = df_C12.f$yield ; y = df_C12.f$yield2
  plotxylm( "Yields 19/20 vs. 18/19\nCosta Rica", ""  )

  x = df_G12.f$yield ; y = df_G12.f$yield2
  plotxylm( "Yields 19/20 vs. 18/19\nGuatemala", ""  )
```


---
title: 'Modelling Coffee Agroforestry in Central America with CAF2021'
subtitle: 'Progress report III for project SEACAF, sub-contract B0554x4'
author:
- Marcel van Oijen^[Independent researcher, Edinburgh, UK - VanOijenMarcel@gmail.com]
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
csl: environmental-modelling-and-software.csl
bibliography: [Avocado.bib,Banana.bib,SEACAF.bib]
---

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=F,results="asis",warning=FALSE,message=FALSE)
  library(rworldmap)
  library(rworldxtra)
  library(raster)
  library(tidyverse)
```

```{r}
  # fileTM     <- "BC_Turrialba_Masatepe_09_08.RData"
  filesTM <- file.info(list.files(pattern="^BC_Turrialba_Masatepe.*\\.RData$"))
  filesTM <- filesTM[ with(filesTM,order(as.POSIXct(mtime))), ]
  fileTM  <- tail( rownames(filesTM[1]), 1 )
  load( fileTM )
  
  # fileTM_MAP <- "CAF2021_parMAP_09_08.rds"
  filesTM_MAP <- file.info(list.files(pattern="^CAF2021_parMAP.*\\.rds$"))
  filesTM_MAP <- filesTM_MAP[ with(filesTM_MAP,order(as.POSIXct(mtime))), ]
  fileTM_MAP  <- tail( rownames(filesTM_MAP[1]), 1 )
  parMAP      <- readRDS( fileTM_MAP )

  # THE FOLLOWING LINES LOAD THE MAP FROM AN OLDER MODEL VERSION WITH
  # FEWER PARAMATERS, AND CONSTRUCT THE MAP FOR THE CURRENT VERSION.
  # parMAP.old       <- readRDS( fileTM_MAP )
  # np.old           <- dim(parMAP.old)[1]
  # source('initialisation/set_CAF2021_Turrialba.R')
  # np               <- length( params )
  # parMAP           <- matrix( NA, nrow=np, ncol=nSites )
  # rownames(parMAP) <- names_params
  # colnames(parMAP) <- paste0( "s", 1:nSites )
  # for(p in 1:np.old) {
  #   prow          <- which( startsWith( rownames(parMAP),
  #                                       rownames(parMAP.old)[p] ) )
  #   for(r in prow) { parMAP[r,] <- parMAP.old[p,] }
  # }
```

# WorldClim

```{r}
  dir.f           <- "data/Farms SEACAF/"
  file_coords_C.f <- "coordinates_CR.csv"
  file_coords_G.f <- "coordinates_G.csv"
  
  dir_WC      <- "weather/WorldClim/"
  
  # Monthly climatic means 1970-2000 (scale 30 seconds)
  dir_WC_prec <- paste0( dir_WC, "prec/" ) 
  dir_WC_srad <- paste0( dir_WC, "srad/" )
  dir_WC_tmax <- paste0( dir_WC, "tmax/" )
  dir_WC_tmin <- paste0( dir_WC, "tmin/" )
  dir_WC_vapr <- paste0( dir_WC, "vapr/" )
  dir_WC_wind <- paste0( dir_WC, "wind/" )
  
  # Monthly weather 2000-2018 (scale 2.5 minutes)
  dir_WC_prec.2000_2009 <- paste0( dir_WC, "prec_2000_2009/" )
  dir_WC_prec.2010_2018 <- paste0( dir_WC, "prec_2010_2018/" )
  dir_WC_tmax.2000_2009 <- paste0( dir_WC, "tmax_2000_2009/" )
  dir_WC_tmax.2010_2018 <- paste0( dir_WC, "tmax_2010_2018/" )
  dir_WC_tmin.2000_2009 <- paste0( dir_WC, "tmin_2000_2009/" )
  dir_WC_tmin.2010_2018 <- paste0( dir_WC, "tmin_2010_2018/" )
```

```{r}
  df_C.f  <- read.csv( paste0( dir.f, file_coords_C.f ) )
  df_G.f  <- read.csv( paste0( dir.f, file_coords_G.f ) )
  
  df_C.f  <- df_C.f %>%
    rename( code=code_farm_new, lat=Latitud    , lon=Longitud ) %>%
    mutate( code=code+1000 ) %>%
    dplyr::select( code, lat, lon )
  df_G.f  <- df_G.f %>%
    rename( code=CODIGO.SEACAF, lat=decimal_LAT, lon=decimal_LONG ) %>%
    mutate( code=code+2000 ) %>%
    dplyr::select( code, lat, lon )
  df_CG.f <- df_C.f %>% full_join( df_G.f )
  
  coords_C.f  <- cbind( lon=df_C.f$lon, lat=df_C.f$lat )
  coords_G.f  <- cbind( lon=df_G.f$lon, lat=df_G.f$lat )
  coords_CG.f <- rbind( coords_C.f, coords_G.f )

  n_CG.f <- dim(coords_CG.f)[1]
  n_C.f  <- dim(coords_C.f) [1] ; n_G.f <- dim(coords_G.f)[1]
  i_C.f  <- 1:n_C.f             ; i_G.f <- (n_C.f+1):n_CG.f
```

```{r}
  spdf_C   <- getData('GADM', country="CRI", level=0)
  spdf_C   <- crop(spdf_C, extent(-86,-82, 8, 12))
  spdf_C.f <- crop(spdf_C, extent(-84.6,-83.5, 9.5, 10.2))
  spdf_G   <- getData('GADM', country="GTM", level=0)
  spdf_G.f <- crop(spdf_G, extent(-92.1,-90.4,14.4, 15.1))
  
  ext_C <- extent( spdf_C ) ; ext_C.f <- extent( spdf_C.f )
  ext_G <- extent( spdf_G ) ; ext_G.f <- extent( spdf_G.f )
```

```{r}
  r_worldclim_alt_SE <- getData( 'worldclim', var='alt',
                                 res=0.5, lon=-83.51, lat= 9.58 )
  r_worldclim_alt_NW <- getData( 'worldclim', var='alt',
                                 res=0.5, lon=-92.07, lat=15.09 )
  alt_C    <- crop( r_worldclim_alt_SE, ext_C )
  alt_G    <- crop( r_worldclim_alt_NW, ext_G )
  # alt_C.f  <- raster::extract( r_worldclim_alt_SE, coords_C.f )
  # alt_G.f  <- raster::extract( r_worldclim_alt_NW, coords_G.f )
  alt_C.f  <- raster::extract( alt_C, coords_C.f )
  alt_G.f  <- raster::extract( alt_G, coords_G.f )
  alt_CG.f <- c( alt_C.f, alt_G.f )
```
    
```{r}
  code_C.f <- df_C.f$code - 1000
  code_G.f <- df_G.f$code - 2000
  x_C.f <- coords_C.f[,"lon"] ; y_C.f <- coords_C.f[,"lat"] 
  x_G.f <- coords_G.f[,"lon"] ; y_G.f <- coords_G.f[,"lat"] 

  plot_C.f <- function() {
    plot  ( spdf_C, add=T )
    points( x_C.f, y_C.f, pch=1, cex=0.5)
    # text  ( x_C.f, y_C.f, labels=code_C.f, pos=2, cex=0.5)
  }

  plot_G.f <- function() {
    plot  ( spdf_G, add=T )
    points( x_G.f, y_G.f, pch=1, cex=0.5)
    # text  ( x_G.f, y_G.f, labels=code_C.f, pos=2, cex=0.5)
  }
```

## Climate data 1970-2000

We import the files in RasterStacks (see https://www.benjaminbell.co.uk/2018/02/rasterstacks-and-rasterplot.html ).

```{r}
  # prec <- stack( list.files( dir_WC_prec, ".tif", full.names=T ) )
  # srad <- stack( list.files( dir_WC_srad, ".tif", full.names=T ) )
  # tmax <- stack( list.files( dir_WC_tmax, ".tif", full.names=T ) )
  # tmin <- stack( list.files( dir_WC_tmin, ".tif", full.names=T ) )
  # vapr <- stack( list.files( dir_WC_vapr, ".tif", full.names=T ) )
  # wind <- stack( list.files( dir_WC_wind, ".tif", full.names=T ) )

  month <- c( "Jan", "Feb", "Mar", "Apr", "May", "Jun",
              "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" )
  # names(prec) <- names(srad) <- names(tmax) <-
  # names(tmin) <- names(vapr) <- names(wind) <- month
  
  # prec_C <- crop(prec, ext_C) ; prec_G <- crop(prec, ext_G) ; rm(prec)
  # srad_C <- crop(srad, ext_C) ; srad_G <- crop(srad, ext_G) ; rm(srad)
  # tmax_C <- crop(tmax, ext_C) ; tmax_G <- crop(tmax, ext_G) ; rm(tmax)
  # tmin_C <- crop(tmin, ext_C) ; tmin_G <- crop(tmin, ext_G) ; rm(tmin)
  # vapr_C <- crop(vapr, ext_C) ; vapr_G <- crop(vapr, ext_G) ; rm(vapr)
  # wind_C <- crop(wind, ext_C) ; wind_G <- crop(wind, ext_G) ; rm(wind)
  # 
  # save( prec_C, srad_C, tmax_C, tmin_C, vapr_C, wind_C,
  #       file=paste0( dir_WC, "WC_climate_C.RData" ) )
  # save( prec_G, srad_G, tmax_G, tmin_G, vapr_G, wind_G,
  #       file=paste0( dir_WC, "WC_climate_G.RData" ) )

  load( paste0( dir_WC, "WC_climate_C.RData" ) )
  load( paste0( dir_WC, "WC_climate_G.RData" ) )
```

```{r}
  tempcol <- colorRampPalette( c("purple", "blue", "skyblue", "green" ,
                   "lightgreen", "yellow", "orange", "red", "darkred") )
  plot( prec_C, main=month, col=rainbow(100,end=0.7),
        zlim=c(0,800), nc=3, nr=4 )
```

```{r}
  monl    <- c( 31, 28.25, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 )

  GR_C.f   <- round( raster::extract(srad_C, coords_C.f) / 1000, 1 )
  TMIN_C.f <-        raster::extract(tmin_C, coords_C.f)
  TMAX_C.f <-        raster::extract(tmax_C, coords_C.f)
  VP_C.f   <-        raster::extract(vapr_C, coords_C.f)
  WN_C.f   <-        raster::extract(wind_C, coords_C.f)
  RAIN_C.f <-        raster::extract(prec_C, coords_C.f)
    for(m in 1:12) RAIN_C.f[,m] <- RAIN_C.f[,m] / monl[m]
  
  GR_G.f   <- round( raster::extract(srad_G, coords_G.f) / 1000, 1 )
  TMIN_G.f <-        raster::extract(tmin_G, coords_G.f)
  TMAX_G.f <-        raster::extract(tmax_G, coords_G.f)
  VP_G.f   <-        raster::extract(vapr_G, coords_G.f)
  WN_G.f   <-        raster::extract(wind_G, coords_G.f)
  RAIN_G.f <-        raster::extract(prec_G, coords_G.f)
    for(m in 1:12) RAIN_G.f[,m] <- RAIN_G.f[,m] / monl[m]
  
  GR_CG.f   <- rbind( GR_C.f  , GR_G.f   )
  TMIN_CG.f <- rbind( TMIN_C.f, TMIN_G.f )
  TMAX_CG.f <- rbind( TMAX_C.f, TMAX_G.f )
  VP_CG.f   <- rbind( VP_C.f  , VP_G.f   )
  WN_CG.f   <- rbind( WN_C.f  , WN_G.f   )
  RAIN_CG.f <- rbind( RAIN_C.f, RAIN_G.f )
```

The locations of the farms are depicted in Fig. \ref{fig:Maps_CG}.

```{r Maps_CG, out.width="400px", fig.align="center", fig.cap="\\label{Maps_CG}Locations of the farms in Costa Rica and Guatemala."}
  # par( mfrow=c(1,2), mar=c(3,3,3,5) )
  # plot( alt_C, main="alt_C", addfun=plot_C.f, zlim=c(0,4000) )
  # plot( alt_G, main="alt_G", addfun=plot_G.f, zlim=c(0,4000) )

  knitr::include_graphics("images/Maps_CG.png")

  # Alternative way of producing a map with the farm locations
  # worldmap <- getMap(resolution = "high")
  # plot( worldmap,
  #       col="lightgrey", border="darkgray",
  #       xlim=c(-93,-83), ylim=c(8,18),
  #       bg="aliceblue", asp=1 )
  # points( coords_C.f, col="red" , pch=1, cex=0.2 )
  # points( coords_G.f, col="blue", pch=1, cex=0.2 )
```

```{r}
  par( mfrow=c(2,6), mar=c(2,2,2,1) )

  plot  ( alt_C.f, GR_C.f  [,7], ylim=range(GR_CG.f)  , main="GR_C.f" )
  points( alt_C.f, GR_C.f  [,1], col="red" )
  plot  ( alt_C.f, TMIN_C.f[,7], ylim=range(TMIN_CG.f), main="TMIN_C.f" )
  points( alt_C.f, TMIN_C.f[,1], col="red" )
  plot  ( alt_C.f, TMAX_C.f[,7], ylim=range(TMAX_CG.f), main="TMAX_C.f" )
  points( alt_C.f, TMAX_C.f[,1], col="red" )
  plot  ( alt_C.f, VP_C.f  [,7], ylim=range(VP_CG.f)  , main="VP_C.f" )
  points( alt_C.f, VP_C.f  [,1], col="red" )
  plot  ( alt_C.f, WN_C.f  [,7], ylim=range(WN_CG.f)  , main="WN_C.f" )
  points( alt_C.f, WN_C.f  [,1], col="red" )
  plot  ( alt_C.f, RAIN_C.f[,7], ylim=range(RAIN_CG.f), main="RAIN_C.f" )
  points( alt_C.f, RAIN_C.f[,1], col="red" )
  
  plot  ( alt_G.f, GR_G.f  [,7], ylim=range(GR_CG.f)  , main="GR_G.f" )
  points( alt_G.f, GR_G.f  [,1], col="red" )
  plot  ( alt_G.f, TMIN_G.f[,7], ylim=range(TMIN_CG.f), main="TMIN_G.f" )
  points( alt_G.f, TMIN_G.f[,1], col="red" )
  plot  ( alt_G.f, TMAX_G.f[,7], ylim=range(TMAX_CG.f), main="TMAX_G.f" )
  points( alt_G.f, TMAX_G.f[,1], col="red" )
  plot  ( alt_G.f, VP_G.f  [,7], ylim=range(VP_CG.f)  , main="VP_G.f" )
  points( alt_G.f, VP_G.f  [,1], col="red" )
  plot  ( alt_G.f, WN_G.f  [,7], ylim=range(WN_CG.f)  , main="WN_G.f" )
  points( alt_G.f, WN_G.f  [,1], col="red" )
  plot  ( alt_G.f, RAIN_G.f[,7], ylim=range(RAIN_CG.f), main="RAIN_G.f" )
  points( alt_G.f, RAIN_G.f[,1], col="red" )
```

## Weather 2000-2018

```{r}
  # prec.00_18 <- stack( c(
  #   list.files( dir_WC_prec.2000_2009, ".tif", full.names=T ),
  #   list.files( dir_WC_prec.2010_2018, ".tif", full.names=T ) ) )
  #   prec.00_18 <- prec.00_18[[1:228]] # Only keep years 2000-2018
  # tmax.00_18 <- stack( c(
  #   list.files( dir_WC_tmax.2000_2009, ".tif", full.names=T ),
  #   list.files( dir_WC_tmax.2010_2018, ".tif", full.names=T ) ) )
  #   tmax.00_18 <- tmax.00_18[[1:228]] # Only keep years 2000-2018
  # tmin.00_18 <- stack( c(
  #   list.files( dir_WC_tmin.2000_2009, ".tif", full.names=T ),
  #   list.files( dir_WC_tmin.2010_2018, ".tif", full.names=T ) ) )

  # names(prec.00_18) <- str_sub( names(prec.00_18), -7, -1 )
  # names(tmax.00_18) <- str_sub( names(tmax.00_18), -7, -1 )
  # names(tmin.00_18) <- str_sub( names(tmin.00_18), -7, -1 )

  # prec_C.00_18 <- crop(prec.00_18, ext_C)
  # prec_G.00_18 <- crop(prec.00_18, ext_G) ; rm(prec.00_18)
  # tmax_C.00_18 <- crop(tmax.00_18, ext_C)
  # tmax_G.00_18 <- crop(tmax.00_18, ext_G) ; rm(tmax.00_18)
  # tmin_C.00_18 <- crop(tmin.00_18, ext_C)
  # tmin_G.00_18 <- crop(tmin.00_18, ext_G) ; rm(tmin.00_18)

  # save( prec_C.00_18, tmax_C.00_18, tmin_C.00_18,
  #       file=paste0( dir_WC, "WC_weather_C.RData" ) )
  # save( prec_G.00_18, tmax_G.00_18, tmin_G.00_18,
  #       file=paste0( dir_WC, "WC_weather_G.RData" ) )

  load( paste0( dir_WC, "WC_weather_C.RData" ) )
  load( paste0( dir_WC, "WC_weather_G.RData" ) )
```

Monthly total rainfall (mm) in 2000 and 2001 is shown in Fig. \ref{fig:precC.00.01}.

```{r precC.00.01, fig.height=8, fig.align="center", fig.cap="\\label{precC.00.01}Rainfall in Costa Rica in 2000 and 2001."}
  plot( prec_C.00_18[[ 1:24]],
        main=c( sapply(2000:2001, function(i){paste0(month," ",i)}) ),
        col=rainbow(100,end=0.7), zlim=c(0,800), maxnl=24, nc=4 )
```

```{r}
  i.00_18.month <- vector( "list", 12 )
  m.end         <- c( paste0(".0",1:9), paste0(".",10:12) )
  for(m in 1:12) {
    i.00_18.month[[m]] <- which( endsWith( names(tmin_C.00_18), m.end[m] ) )
  }

  TMIN_C.00_18.f <-        raster::extract(tmin_C.00_18, coords_C.f)
  TMAX_C.00_18.f <-        raster::extract(tmax_C.00_18, coords_C.f)
  RAIN_C.00_18.f <-        raster::extract(prec_C.00_18, coords_C.f)
  for(m in 1:12) { RAIN_C.00_18.f[ , i.00_18.month[[m]] ] <-
    RAIN_C.00_18.f[ , i.00_18.month[[m]] ] / monl[m] }
  
  TMIN_G.00_18.f <-        raster::extract(tmin_G.00_18, coords_G.f)
  TMAX_G.00_18.f <-        raster::extract(tmax_G.00_18, coords_G.f)
  RAIN_G.00_18.f <-        raster::extract(prec_G.00_18, coords_G.f)
  for(m in 1:12) { RAIN_G.00_18.f[ , i.00_18.month[[m]] ] <-
    RAIN_G.00_18.f[ , i.00_18.month[[m]] ] / monl[m] }

  # TMIN_CG.00_18.f <- rbind( TMIN_C.00_18.f, TMIN_G.00_18.f )
  # TMAX_CG.00_18.f <- rbind( TMAX_C.00_18.f, TMAX_G.00_18.f )
  # RAIN_CG.00_18.f <- rbind( RAIN_C.00_18.f, RAIN_G.00_18.f )
```

```{r}
  # Averages by calendar month for 2000-2018
  TMIN_C.00_18.ma.f <- TMAX_C.00_18.ma.f <- RAIN_C.00_18.ma.f <-
    matrix( NA, nrow=n_C.f, ncol=12 )
  TMIN_G.00_18.ma.f <- TMAX_G.00_18.ma.f <- RAIN_G.00_18.ma.f <-
    matrix( NA, nrow=n_G.f, ncol=12 )

  for(m in 1:12) {
    TMIN_C.00_18.ma.f[,m] <- rowMeans( TMIN_C.00_18.f[ , i.00_18.month[[m]] ] )
    TMAX_C.00_18.ma.f[,m] <- rowMeans( TMAX_C.00_18.f[ , i.00_18.month[[m]] ] )
    RAIN_C.00_18.ma.f[,m] <- rowMeans( RAIN_C.00_18.f[ , i.00_18.month[[m]] ] )
    TMIN_G.00_18.ma.f[,m] <- rowMeans( TMIN_G.00_18.f[ , i.00_18.month[[m]] ] )
    TMAX_G.00_18.ma.f[,m] <- rowMeans( TMAX_G.00_18.f[ , i.00_18.month[[m]] ] )
    RAIN_G.00_18.ma.f[,m] <- rowMeans( RAIN_G.00_18.f[ , i.00_18.month[[m]] ] )
  }
  
  # Anomalies by calendar month for 2000-2018
  TMIN_C.00_18.anom.f <- TMAX_C.00_18.anom.f <- RAIN_C.00_18.anom.f <-
    matrix( NA, nrow=n_C.f, ncol=228 )
  TMIN_G.00_18.anom.f <- TMAX_G.00_18.anom.f <- RAIN_G.00_18.anom.f <-
    matrix( NA, nrow=n_G.f, ncol=228 )
  
  for(m in 1:12) {
    TMIN_C.00_18.anom.f[ , i.00_18.month[[m]] ] <-
         TMIN_C.00_18.f[ , i.00_18.month[[m]] ] - TMIN_C.00_18.ma.f[,m]
    TMAX_C.00_18.anom.f[ , i.00_18.month[[m]] ] <-
         TMAX_C.00_18.f[ , i.00_18.month[[m]] ] - TMAX_C.00_18.ma.f[,m]
    RAIN_C.00_18.anom.f[ , i.00_18.month[[m]] ] <-
         RAIN_C.00_18.f[ , i.00_18.month[[m]] ] - RAIN_C.00_18.ma.f[,m]
    
    TMIN_G.00_18.anom.f[ , i.00_18.month[[m]] ] <-
         TMIN_G.00_18.f[ , i.00_18.month[[m]] ] - TMIN_G.00_18.ma.f[,m]
    TMAX_G.00_18.anom.f[ , i.00_18.month[[m]] ] <-
         TMAX_G.00_18.f[ , i.00_18.month[[m]] ] - TMAX_G.00_18.ma.f[,m]
    RAIN_G.00_18.anom.f[ , i.00_18.month[[m]] ] <-
         RAIN_G.00_18.f[ , i.00_18.month[[m]] ] - RAIN_G.00_18.ma.f[,m]
  }
```

Comparing anomalies between two farms in Costa Rica:

```{r}
  par( mfrow=c(3,2) )

  iSite1 <- 1 ; iSite2 <- 2
  plot  ( 1:228, TMIN_C.00_18.anom.f[iSite1,], main="Anomalies TMIN" )
  points( 1:228, TMIN_C.00_18.anom.f[iSite2,], col="red" )
  plot(TMIN_C.00_18.anom.f[iSite1,], TMIN_C.00_18.anom.f[iSite2,] )
  
  plot  ( 1:228, TMAX_C.00_18.anom.f[iSite1,], main="Anomalies TMAX" )
  points( 1:228, TMAX_C.00_18.anom.f[iSite2,], col="red" )
  plot(TMAX_C.00_18.anom.f[iSite1,], TMAX_C.00_18.anom.f[iSite2,] )
  
  plot  ( 1:228, RAIN_C.00_18.anom.f[iSite1,], main="Anomalies RAIN" )
  points( 1:228, RAIN_C.00_18.anom.f[iSite2,], col="red" )
  plot(RAIN_C.00_18.anom.f[iSite1,], RAIN_C.00_18.anom.f[iSite2,] )
```

Comparing anomalies between the countries:

```{r}
  par( mfrow=c(3,2) )

  iSiteC <- 1 ; iSiteG <- 1
  plot  ( 1:228, TMIN_C.00_18.anom.f[iSiteC,], main="Anomalies TMIN" )
  points( 1:228, TMIN_G.00_18.anom.f[iSiteG,], col="red" )
  plot(TMIN_C.00_18.anom.f[iSiteC,], TMIN_G.00_18.anom.f[iSiteG,] )
  
  plot  ( 1:228, TMAX_C.00_18.anom.f[iSiteC,], main="Anomalies TMAX" )
  points( 1:228, TMAX_G.00_18.anom.f[iSiteG,], col="red" )
  plot(TMAX_C.00_18.anom.f[iSiteC,], TMAX_G.00_18.anom.f[iSiteG,] )
  
  plot  ( 1:228, RAIN_C.00_18.anom.f[iSiteC,], main="Anomalies RAIN" )
  points( 1:228, RAIN_G.00_18.anom.f[iSiteG,], col="red" )
  plot(RAIN_C.00_18.anom.f[iSiteC,], RAIN_G.00_18.anom.f[iSiteG,] )
```

## Combining climate and weather

```{r, eval=F}
  # Expand climatic values to 2000-2018
  matrix_GR_C.00_18.f <- matrix_TMIN_C.00_18.f <- matrix_TMAX_C.00_18.f <-
  matrix_VP_C.00_18.f <- matrix_WN_C.00_18.f   <- matrix_RAIN_C.00_18.f <-
    matrix( NA, nrow=n_C.f, ncol=228 )
  matrix_GR_G.00_18.f <- matrix_TMIN_G.00_18.f <- matrix_TMAX_G.00_18.f <-
  matrix_VP_G.00_18.f <- matrix_WN_G.00_18.f   <- matrix_RAIN_G.00_18.f <-
    matrix( NA, nrow=n_G.f, ncol=228 )

  for(y in 2000:2018) {
    m <- (y-2000)*12 + (1:12)

    matrix_GR_C.00_18.f  [ , m ] <- GR_C.f
    matrix_TMIN_C.00_18.f[ , m ] <- TMIN_C.f
    matrix_TMAX_C.00_18.f[ , m ] <- TMAX_C.f
    matrix_VP_C.00_18.f  [ , m ] <- VP_C.f
    matrix_WN_C.00_18.f  [ , m ] <- WN_C.f
    matrix_RAIN_C.00_18.f[ , m ] <- RAIN_C.f

    matrix_GR_G.00_18.f  [ , m ] <- GR_G.f
    matrix_TMIN_G.00_18.f[ , m ] <- TMIN_G.f
    matrix_TMAX_G.00_18.f[ , m ] <- TMAX_G.f
    matrix_VP_G.00_18.f  [ , m ] <- VP_G.f
    matrix_WN_G.00_18.f  [ , m ] <- WN_G.f
    matrix_RAIN_G.00_18.f[ , m ] <- RAIN_G.f
  }
  matrix_TMIN_C.00_18.f  <- round( matrix_TMIN_C.00_18.f + TMIN_C.00_18.anom.f, 1 )
  matrix_TMAX_C.00_18.f  <- round( matrix_TMAX_C.00_18.f + TMAX_C.00_18.anom.f, 1 )
  matrix_RAIN_C.00_18.f0 <- round( matrix_RAIN_C.00_18.f + RAIN_C.00_18.anom.f, 2 )
  matrix_RAIN_C.00_18.f  <- pmax(matrix_RAIN_C.00_18.f0, 0)

  matrix_TMIN_G.00_18.f  <- round( matrix_TMIN_G.00_18.f + TMIN_G.00_18.anom.f, 1 )
  matrix_TMAX_G.00_18.f  <- round( matrix_TMAX_G.00_18.f + TMAX_G.00_18.anom.f, 1 )
  matrix_RAIN_G.00_18.f0 <- round( matrix_RAIN_G.00_18.f + RAIN_G.00_18.anom.f, 2 )
  matrix_RAIN_G.00_18.f  <- pmax(matrix_RAIN_G.00_18.f0, 0)
```

## Creating CAF2021 daily weather files 2000-2018

```{r, eval=F}
  weather_C.f  <- vector( "list", n_C.f )
  weather_G.f  <- vector( "list", n_G.f )
  
  NYEAR        <- 19
  NDAY         <- NYEAR * 365
  wf           <- matrix( NA, nrow=NDAY, ncol=9 )
  colnames(wf) <- c( "ST", "year", "doy",
                     "GR", "TMIN", "TMAX", "VP", "WN", "RAIN" )
  wf[,"year"]  <- rep( 2000:2018, each=365 )
  wf[,"doy" ]  <- rep(    1: 365, NYEAR    )
  
  for( i in 1:n_C.f ) { weather_C.f[[i]] <- wf }
  for( i in 1:n_G.f ) { weather_G.f[[i]] <- wf }
```

```{r}
  # monl.00_18 <- rep( as.integer(monl), 19 )
  # NMON       <- length( monl.00_18 )

  # for( f in 1:n_C.f)  {
  #   weather_C.f[[f]][,"ST"] <- df_C.f$code[f] - 1000
  #   lastday <- 0
  #   for( m in 1:NMON ) {
  #     ml   <- monl.00_18[m]
  #     iday <- lastday + (1:ml)
  #     weather_C.f[[f]] [iday,"GR"  ] <- rep( matrix_GR_C.00_18.f  [f,m], ml )
  #     weather_C.f[[f]] [iday,"TMIN"] <- rep( matrix_TMIN_C.00_18.f[f,m], ml )
  #     weather_C.f[[f]] [iday,"TMAX"] <- rep( matrix_TMAX_C.00_18.f[f,m], ml )
  #     weather_C.f[[f]] [iday,"VP"  ] <- rep( matrix_VP_C.00_18.f  [f,m], ml )
  #     weather_C.f[[f]] [iday,"WN"  ] <- rep( matrix_WN_C.00_18.f  [f,m], ml )
  #     weather_C.f[[f]] [iday,"RAIN"] <- rep( matrix_RAIN_C.00_18.f[f,m], ml )
  #     lastday <- lastday + ml
  #   }
  # }
  
  # for( f in 1:n_G.f)  {
  #   weather_G.f[[f]][,"ST"] <- df_G.f$code[f] - 2000
  #   lastday <- 0
  #   for( m in 1:NMON ) {
  #     ml   <- monl.00_18[m]
  #     iday <- lastday + (1:ml)
  #     weather_G.f[[f]] [iday,"GR"  ] <- rep( matrix_GR_G.00_18.f  [f,m], ml )
  #     weather_G.f[[f]] [iday,"TMIN"] <- rep( matrix_TMIN_G.00_18.f[f,m], ml )
  #     weather_G.f[[f]] [iday,"TMAX"] <- rep( matrix_TMAX_G.00_18.f[f,m], ml )
  #     weather_G.f[[f]] [iday,"VP"  ] <- rep( matrix_VP_G.00_18.f  [f,m], ml )
  #     weather_G.f[[f]] [iday,"WN"  ] <- rep( matrix_WN_G.00_18.f  [f,m], ml )
  #     weather_G.f[[f]] [iday,"RAIN"] <- rep( matrix_RAIN_G.00_18.f[f,m], ml )
  #     lastday <- lastday + ml
  #   }
  # }
  
  # save( weather_C.f, file=paste0( dir_WC, "WC_weather_C.f.RData" ) )
  # save( weather_G.f, file=paste0( dir_WC, "WC_weather_G.f.RData" ) )
  
  load( paste0( dir_WC, "WC_weather_C.f.RData" ) )
  load( paste0( dir_WC, "WC_weather_G.f.RData" ) )
```

```{r}
  par( mfrow=c(2,2) )

  f <- 1
  plot  ( weather_C.f[[f]] [,"GR"  ], main="GR" )
  plot  ( weather_C.f[[f]] [,"TMAX"], main="TMAX, TMIN (red)",
          ylim=range(weather_C.f[[f]] [,c("TMAX", "TMIN")]) )
  points( weather_C.f[[f]] [,"TMIN"], col="red" )
  plot  ( weather_C.f[[f]] [,"VP"  ], main="VP, WN (blue)",
          ylim=range(weather_C.f[[f]] [,c("VP", "WN")]) )
  points( weather_C.f[[f]] [,"WN"  ], col="blue" )
  plot  ( weather_C.f[[f]] [,"RAIN"], main="RAIN" )
```

```{r}
  par( mfrow=c(2,2) )

  f <- 1
  plot  ( weather_G.f[[f]] [,"GR"  ], main="GR" )
  plot  ( weather_G.f[[f]] [,"TMAX"], main="TMAX, TMIN (red)",
          ylim=range(weather_G.f[[f]] [,c("TMAX", "TMIN")]) )
  points( weather_G.f[[f]] [,"TMIN"], col="red" )
  plot  ( weather_G.f[[f]] [,"VP"  ], main="VP, WN (blue)",
          ylim=range(weather_G.f[[f]] [,c("VP", "WN")]) )
  points( weather_G.f[[f]] [,"WN"  ], col="blue" )
  plot  ( weather_G.f[[f]] [,"RAIN"], main="RAIN" )
```



\clearpage

# Introduction

This is the third progress report for project SEACAF on the process-based modelling of coffee agroforestry systems in Central America by means of the model CAF2021. The first progress report [dated 30 April 2021; @VanOijen_2021_Modelling] provided details and references on the model. The second report [dated 16 June 2021; @VanOijen_2021_Modellinga] presented changes to model structure and discussed the setup and results of a Bayesian model calibration using data from long-term experiments in Turrialba (Costa Rica) and Masatepe (Nicaragua).

Here we report on simulation of fruit production and on simulating the SEACAF farms.



\clearpage

# Reference simulations for Turrialba and Masatepe

```{r, fig.cap="\\label{fig:YieldsObsSimTM}Yields for the 32 treatments in Turrialba (black numbers) and Masatepe (red). Left: Observed yields against N-fertilisation level. Right: Observed yield vs. MAP-simulated yield."}
  source('initialisation/initialise_CAF2021_general.R')
  par( mfrow=c(1,2) )

  y <- fYieldsTM( parMatrix=parMAP, sfiles=sitesettings_filenames )
  par( pty="s" ) ; plotYieldsTM( y )
  
  # # Temporary check of setting initial tree pool values all to 0.1 kg C m-2
  # # source('initialisation/initialise_CAF2021_general.R')
  # # 
  # parMAPmod <- parMAP
  # iCtree0   <- which( startsWith( rownames(parMAPmod), "CBtree0") |
  #                     startsWith( rownames(parMAPmod), "CLtree0") |
  #                     startsWith( rownames(parMAPmod), "CRtree0") |
  #                     startsWith( rownames(parMAPmod), "CStree0") ) 
  # for(s in 1:nSites) { parMAPmod[iCtree0,] <- 0.1 }
  # ymod <- fYieldsTM( parMatrix=parMAPmod, sfiles=sitesettings_filenames )
  # par( pty="s" ) ; plotYieldsTM( ymod )

  # Temporary check of setting FWCWP to 0.2 (default is 0.4)
  # source('initialisation/initialise_CAF2021_general.R')
  # 
  parMAPmod <- parMAP
  ip   <- which( rownames(parMAPmod) == "FWCWP" ) 
  for(s in 1:nSites) { parMAPmod[ip,] <- 0.2 }
  ymod <- fYieldsTM( parMatrix=parMAPmod, sfiles=sitesettings_filenames )
  par( pty="s" ) ; plotYieldsTM( ymod )
```

We show observed vs. simulated average annual coffee dry matter yields for all 32 treatments in Fig. \ref{fig:YieldsObsSimTM}.

```{r TM, fig.height=8, fig.cap="\\label{fig:TM}Simulations for Turrialba (grey bars) and Masatepe (red)."}
  fOutTM <- fOutputTM( parMatrix=parMAP, sfiles=sitesettings_filenames )

  par( mfrow=c(6,1), mar=c(3,2,2,0) )
  
  barplotTM( fOutTM[,"harvDM_f_hay"], name="Coffee (kg DM ha-1 y-1)" )
  barplotTM( fOutTM[,"harvCPT_2"   ], name="Fruit[2] (kg DM ha-1 y-1)" )
  barplotTM( fOutTM[,"harvCST_3"   ], name="Timber[3] (kg DM ha-1 y-1)" )

  barplotTM( fOutTM[,"D_Csys" ], name="System C (kg ha-1 y-1)" )
  barplotTM( fOutTM[,"D_Csoil"], name="Soil C (kg ha-1 y-1)"   )
  barplotTM( fOutTM[,"D_Nsoil"], name="Soil N (kg ha-1 y-1)"  )
```

Below, we study the impact of adding fruit trees on various outputs from the model. The reference simulations are those that we looked at before, i.e. those for the long-term experiments in Turrialba (Costa Rica) and Masatepe (Nicaragua), which did not include any fruit trees. Model outputs for the 32 experimental treatments are shown in Fig. \ref{fig:TM}. We shall later virtually add either banana or avocado trees to the experiments and see how that changes the figure. 



\clearpage

# Banana

## Exploring parameter values for Banana

Data for coffee agroforestry farms in the Turrialba region with fruit trees were provided by Rolando Cerda (CATIE). Annual N-fertilisation levels were quantified for plots on 51 farms and ranged from 33 to 285 kg N ha-1 y-1, averaging $99 \pm 63$. On the nine plots where the only fruit trees were Musaceae, annual banana yields varied from 20 to 400 bunches ha-1 ($138 \pm 153$). These yields were not correlated with fertilisation rate, nor with the density of the trees which ranged from 30 to 1410 ha-1 ($386 \pm 424$), with the average production per tree ranging from 0.08 to 3.33 ($0.79 \pm 1.09$) bunches. The variation in these numbers is so high that we decided to calibrate banana production in CAF2021 on literature data instead, collected during the literature review reported before [@VanOijen_2021_Modelling].

- @Damour_2012_Simulation: SLA of 0.018 $m^2 g^{-1}$, light extinction coefficient = 0.7, leaf N-content 3-4% of dry matter.
- @ChavesC._2009_Modeling: plantain (Musa AAB).
  - Latin American mean yield is 7.3 t ha-1 y-1 (DM?)
  - DMP fruits ~ 25%.
  - LUE (1.63 g MJ-1)
  - critical temperatures of $T_{min}$ = 12.5 $^{\circ}$C, $T_{opt}$ = 25 $^{\circ}$C, $T_{max}$ = 40 $^{\circ}$C []
  - Allocation about equally to leaves, pseudostem and corm with during later development most going to bunches that ultimately reach up to 45% of aboveground biomass.
- @VanDenBergh_2012_Climate: critical monthly temperatures: $T_{kill}$ = 0 $^{\circ}$C, $T_{min}$ = 12 $^{\circ}$C, $T_{opt}$ = 17.5 to 26.3 $^{\circ}$C, $T_{max}$ = 33 $^{\circ}$C.
- @Dold_2007_Musa: Most common coffee agroforestry systems in the Turrialba region were coffee + *Erythrina poeppigiana* + banana/plantain + laurel (*Cordia alliodora*). Typical tree densities were 162 *E.p.* $ha^{-1}$, 179 banana/plantain $ha^{-1}$, 37 laurel $ha^{-1}$. They cite literature where poro density is 130-208 $ha^{-1}$ and banana 149-343 $ha^{-1}$ and state that banana above 120 $ha^{-1}$ would reduce coffee yield too much.
- @Dold_2010_Improving: mean tree density in central Costa Rican coffee agroforestry systems was 341 $ha^{-1}$ with 579 bananas $ha^{-1}$. In northern Nicaragua the mean tree density was 185 $ha^{-1}$ with 358 bananas $ha^{-1}$.
- @Ripoche_2012_Modeling:
  - Up to 10 kg aboveground DM per plant.
- @Jullien_2001_Withinbunch reported that pulp DMP reaches asymptotically to values of about 30%. 
- @Mustaffa_2012_Banana: leaf N content about 3% of DM.
- @MartinezAcosta_2011_Dinamica, final DM per tree, bunch / leaves / pseudostem + corm = 3000 / 1200 / 1800 g DM.
- @Schaffer_1999_Atmospheric DM of 6-month old vegetative banana (cv. 'Gros Michel'): leaves:pseudostem+rhizome:roots =  19:64:19%.
- DM-partitioning of cv. 'Williams' in Colombia not affected strongly by level of N-fertilization (0 to 483 kg N $ha^{-1}$), but fruit yields increased from 9 to 12 kg DM [@TorresB._2014_Accumulation]. At harvest after 161 kg N $ha^{-1}$ fertilization: corm+pseudostem/leaves/fruits = 6/1.5/3.5 kg DM per plant. Total plant N-concentration was 1-1.5% of DM.
- @Turner_2007_Environmental: LAI ranges from 2 to 5 m2 m-2.

## Banana simulation in CAF2021

To make CAF2021 simulate banana in a coffee plantation, we set the initial density of fruit trees (TREEDENS0(2)) to a positive value, and choose parameter settings that are appropriate for banana. We show some results in Fig. \ref{fig:SimBanana}.

```{r SimBanana, fig.height=3.5, fig.cap="\\label{fig:SimBanana}Simulating banana with CAF2021."}
  source("initialisation/initialise_CAF2021_Turrialba_19_PS_AC.R")
  pBanana <- set_par_speciesT( 2, "Banana" )
  outputB <- run_model( p=pBanana )

  par( mfrow=c(2,3), mar=c(3,3,3,3) )
  
  plot_CdistributionTrees( sim=outputB, it=2 )
  
  Time <- outputB[,1]
    i.ht2    <- which( outputNames=="h_t(2)"      ) ; h_t2      <- outputB[,i.ht2]
    i.Shade  <- which( outputNames=="Shade_f"     ) ; Shade_f   <- outputB[,i.Shade]
    i.CAt2   <- which( outputNames=="CAtree_t(2)" ) ; CAtree2   <- outputB[,i.CAt2]
    i.CPT    <- which( outputNames=="harvCPT_f"   ) ; harvCPT_f <- outputB[,i.CPT]
    YtreesDM <- harvCPT_f * 1e4 * 365 / 0.45
  plot( Time, h_t2     , type="l", ylab="", main="Height (m)" )
  plot( Time, CAtree2  , type="l", ylab="", main="Crown area (m2 tree-1)" )
  plot( Time, Shade_f  , type="l", ylab="", main="Shade (-)" )
  plot( Time, YtreesDM , type="l", ylab="", main="Fruit yield (kg DM ha-1)" )
```

We now virtually add 100 banana plants per hectare to each of the experimental treatments in Turrialba and Masatepe that we investigated above (Fig. \ref{fig:TM}). We show the *differences* from those earlier results in Fig. \ref{fig:TM.B}. 

```{r TM.B, fig.height=8, fig.cap="\\label{fig:TM.B}Differences between simulations for Turrialba (grey bars) and Masatepe (red) with 100 banana plants per hectare added and default simulations without fruit plants."}
  parMAP.B  <- parMAP
  for (s in 1:nSites) {
    parMAP.B[,s] <- set_par_speciesT( 2, species="Banana", p.old=parMAP[,s] )
  }
  fOutTM.B  <- fOutputTM( parMatrix=parMAP.B, sfiles=sitesettings_filenames )
  dfOutTM.B <- fOutTM.B - fOutTM

  par( mfrow=c(6,1), mar=c(3,2,2,0) )

  barplotTM( dfOutTM.B[,"harvDM_f_hay"], name="Coffee (kg DM ha-1 y-1)" )
  barplotTM( dfOutTM.B[,"harvCPT_2"   ], name="Fruit[2] (kg DM ha-1 y-1)" )
  barplotTM( dfOutTM.B[,"harvCST_3"   ], name="Timber[3] (kg DM ha-1 y-1)" )

  barplotTM( dfOutTM.B[,"D_Csys" ], name="System C (kg ha-1 y-1)" )
  barplotTM( dfOutTM.B[,"D_Csoil"], name="Soil C (kg ha-1 y-1)"   )
  barplotTM( dfOutTM.B[,"D_Nsoil"], name="Soil N (kg ha-1 y-1)"  )
```



\clearpage

# Avocado

## Exploring parameter values for Avocado

- Avocado production in Mexico is year round [@CIRAD_2019_Country]. Yield ramps up from 0.3-1.6 t ha-1 at age 4 to 12-15 t ha-1 at age 7-8 and older.
- **Elzebroek & Wind (2008)**:
  - optimal T (three races): day 20-35C, night 10-25C. [MvO: cv. Hass is on the cold side, so maybe day 25C, night 15C, 24-h optimum 20C?]
  - First harvests after 4 years (vegetatively propagated) to 5-6 yrs (seedlings)
- **http://postgrado.fausac.gt/wp-content/uploads/2019/03/Zoila-Monz%C3%B3n.pdf** (Guatemala):
  - Epocas de cosecha de aguacate (variedad Hass) en Guatemala: July-Sep & Nov-April (so 9 months in total, i.e. all months except May-June & Oct).
  - Yields in different departments from 4-11.5 t ha-1 y-1, mean 7 t ha-1 y-1.

## Avocado simulation in CAF2021

See Fig. \ref{fig:SimAvocado}.

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_19_PS_AC.R")
  pAvocado <- set_par_speciesT( 2, "Avocado" )
  outputA  <- run_model( p=pAvocado )
```

```{r SimAvocado, fig.height=3.5, fig.cap="\\label{fig:SimAvocado}Simulating avocado with CAF2021."}
  par( mfrow=c(2,3), mar=c(3,3,3,3) )
  
  plot_CdistributionTrees( sim=outputA, it=2 )
  
  Time <- outputA[,1]
    i.ht2    <- which( outputNames=="h_t(2)"      ) ; h_t2      <- outputA[,i.ht2]
    i.Shade  <- which( outputNames=="Shade_f"     ) ; Shade_f   <- outputA[,i.Shade]
    i.CAt2   <- which( outputNames=="CAtree_t(2)" ) ; CAtree2   <- outputA[,i.CAt2]
    i.CPT    <- which( outputNames=="harvCPT_f"   ) ; harvCPT_f <- outputA[,i.CPT]
    YtreesDM <- harvCPT_f * 1e4 * 365 / 0.45
  plot( Time, h_t2     , type="l", ylab="", main="Height (m)" )
  plot( Time, CAtree2  , type="l", ylab="", main="Crown area (m2 tree-1)" )
  plot( Time, Shade_f  , type="l", ylab="", main="Shade (-)" )
  plot( Time, YtreesDM , type="l", ylab="", main="Fruit yield (kg DM ha-1)" )
```

We now virtually add 100 avocado trees per hectare to each of the experimental treatments in Turrialba and Masatepe. The new results are shown in Fig. \ref{fig:TM.A}, and we can compare these with the results for the simulations for the experimental conditions without fruit trees (Fig. \ref{fig:TM}).

```{r TM.A, fig.height=8, fig.cap="\\label{fig:TM.A}Differences between simulations for Turrialba (grey bars) and Masatepe (red) with 100 avocado trees per hectare added and default simulations without fruit trees."}
  parMAP.A  <- parMAP
  for (s in 1:nSites) {
    parMAP.A[,s] <- set_par_speciesT( 2, species="Avocado", p.old=parMAP[,s] )
  }
  fOutTM.A  <- fOutputTM( parMatrix=parMAP.A, sfiles=sitesettings_filenames )
  dfOutTM.A <- fOutTM.A - fOutTM

  par( mfrow=c(6,1), mar=c(3,2,2,0) )

  barplotTM( dfOutTM.A[,"harvDM_f_hay"], name="Coffee (kg DM ha-1 y-1)" )
  barplotTM( dfOutTM.A[,"harvCPT_2"   ], name="Fruit[2] (kg DM ha-1 y-1)" )
  barplotTM( dfOutTM.A[,"harvCST_3"   ], name="Timber[3] (kg DM ha-1 y-1)" )

  barplotTM( dfOutTM.A[,"D_Csys" ], name="System C (kg ha-1 y-1)" )
  barplotTM( dfOutTM.A[,"D_Csoil"], name="Soil C (kg ha-1 y-1)"   )
  barplotTM( dfOutTM.A[,"D_Nsoil"], name="Soil N (kg ha-1 y-1)"  )
```



\clearpage

# APPENDIX

```{r, eval=F}
  sA <- 11 ; sB <- 17 ; sC <- 31 ; sD <- 19
  source(sitesettings_filenames[sA]) ; output.MAP.A <- run_model( p=parMAP[,sA] )
  source(sitesettings_filenames[sB]) ; output.MAP.B <- run_model( p=parMAP[,sB] )
  source(sitesettings_filenames[sC]) ; output.MAP.C <- run_model( p=parMAP[,sC] )
  source(sitesettings_filenames[sD]) ; output.MAP.D <- run_model( p=parMAP[,sD] )
```

```{r, eval=F, out.width="100%", fig.cap="\\label{fig:NBalancesSoil}Soil N-balances for 4 treatments, averaged over the whole simulated period. Top row: Turrialba; bottom row: Masatepe. Simulations using the MAP parameter vector from Bayesian calibration."}
  par( mfrow=c(2,4) )

  par(mar=c(3,3,3,0))
  plot_NbalanceSoil(output.MAP.A, title1="", title2="11 TE-CM  ", ymax=800)
  par(mar=c(3,3,3,0))
  plot_NbalanceSoil(output.MAP.B, title1="", title2="17 -CI    ", ymax=800)
  par(mar=c(3,3,3,0))
  plot_NbalanceSoil(output.MAP.C, title1="", title2="31 ILSG-CM", ymax=800)
  par(mar=c(3,3,3,0))
  plot_NbalanceSoil(output.MAP.D, title1="", title2="19 -CI    ", ymax=800)
```

```{r, eval=F}
## Exploring deciduousness
  sA            <- 23 # Masatepe_05_SGTR_CI
  source(sitesettings_filenames[sA])
  params        <- parMAP[ , sA ]
  params.MAP.A  <- params
  params.MAP.A1 <- set_par( c("FTCLMINT(3)","TCLMAXT(3)"),
                            c( 0.2         , 650        ) )
  params.MAP.A2 <- set_par( c("FTCLMINT(3)","TCLMAXT(3)"),
                            c( 0.05        , 650        ) )
  params.MAP.A3 <- set_par( c("FTCLMINT(3)","TCLMAXT(3)"),
                            c( 0.2         , 365        ) )
  output.MAP.A  <- run_model( p=params.MAP.A  )
  output.MAP.A1 <- run_model( p=params.MAP.A1 )
  output.MAP.A2 <- run_model( p=params.MAP.A2 )
  output.MAP.A3 <- run_model( p=params.MAP.A3 )
  plot_output( list_output=list( output.MAP.A,
                                 output.MAP.A1, output.MAP.A2 ,output.MAP.A3),
               vars=c( "fTranT_t(3)", "LAIT_t(3)" ) )
```

```{r Balances2, eval=F, fig.height=6, fig.cap="\\label{fig:Balances2}Soil N- and C-balances at Masatepe in the ILSS_CI system. Top row: tree branches harvested and removed after pruning and thinning. Bottom row: branches left on the field as litter."}
## Comparison of leaving tree branches on the field after thinning and pruning (default) vs. removing them as harvest
  sA <- 27 # Masatepe_09_ILSS_CI
  source(sitesettings_filenames[sA])
  params        <- parMAP[ , sA ]
  params.MAP.A  <- params
  params.MAP.A1 <- set_par( c("FHARVBT(1)","FHARVBT(2)","FHARVBT(3)"),
                            c( 0          , 0          , 0          ) )
  output.MAP.A  <- run_model( p=params.MAP.A  )
  output.MAP.A1 <- run_model( p=params.MAP.A1 )
  par( mar=c(3,3,3,0), mfrow=c(2,4) )
  plot_NbalanceSoil( output.MAP.A , title1="Soil N-balance MAP", title2="" )
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil( output.MAP.A , title1="Soil C-balance MAP", title2="" )
  par( mar=c(3,3,3,0) )
  plot_NbalanceSoil( output.MAP.A1, title1="Soil N-balance 1", title2="" )
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil( output.MAP.A1, title1="Soil C-balance 1", title2="" )
```



\clearpage

# Acknowledgements {-}

I thank the Natural Resources Institute of the University of Greenwich for funding, and my colleagues in project SEACAF and earlier projects for support.



# References {-}

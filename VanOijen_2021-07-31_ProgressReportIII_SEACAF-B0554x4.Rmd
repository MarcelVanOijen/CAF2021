---
title: 'Modelling Coffee Agroforestry in Central America with CAF2021'
subtitle: 'Progress report III for project SEACAF, sub-contract B0554x4'
author:
- Marcel van Oijen^[Independent researcher, Edinburgh, UK - VanOijenMarcel@gmail.com]
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
csl: environmental-modelling-and-software.csl
bibliography: [Avocado.bib,Banana.bib,SEACAF.bib]
---

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=F,results="asis",warning=FALSE,message=FALSE)
```

```{r}
  # filesTM <- file.info(list.files(pattern="^BC_Turrialba_Masatepe.*\\.RData$"))
  # filesTM <- filesTM[ with(filesTM,order(as.POSIXct(mtime))), ]
  # fileTM  <- tail( rownames(filesTM[1]), 1 )
  fileTM     <- "BC_Turrialba_Masatepe_09_08.RData"
  load( fileTM )
  # source('BC/BC_export_parModes.R') # To write only the MAPs to rds-file
  fileTM_MAP <- "CAF2021_parMAP_09_08.rds"
  
  # FOLLOWING LINES LOAD THE MAP FROM AN OLDER MODEL VERSION WITH
  # FEWER PARAMATERES, AND CONSTRUCT THE MAP FOR THE CURRENT VERSION.
  # SIMPLIFY THE CODE WHEN THE LOADED MAP IS FROM THE CURRENT VERSION.
  # parMAP         <- readRDS( fileTM_MAP )
  parMAP.old     <- readRDS( fileTM_MAP )
  np.old         <- dim(parMAP.old)[1]
  iCBtree0.old   <- which( rownames(parMAP.old)=="CBtree0"    )
  iCLtree0.old   <- which( rownames(parMAP.old)=="CLtree0"    )
  iCRtree0.old   <- which( rownames(parMAP.old)=="CRtree0"    )
  iCStree0.old   <- which( rownames(parMAP.old)=="CStree0"    )
  iKSINKPMAX.old <- which( rownames(parMAP.old)=="KSINKPMAX"  )
  parMAP <- rbind( parMAP.old[ 1:(iCBtree0.old-1)             , ],
                   parMAP.old[ (iCStree0.old+1):iKSINKPMAX.old, ],
                   parMAP.old[ iCBtree0.old                   , ],
                   parMAP.old[ iCBtree0.old                   , ],
                   parMAP.old[ iCBtree0.old                   , ],
                   parMAP.old[ iCLtree0.old                   , ],
                   parMAP.old[ iCLtree0.old                   , ],
                   parMAP.old[ iCLtree0.old                   , ],
                   parMAP.old[ iCRtree0.old                   , ],
                   parMAP.old[ iCRtree0.old                   , ],
                   parMAP.old[ iCRtree0.old                   , ],
                   parMAP.old[ iCStree0.old                   , ],
                   parMAP.old[ iCStree0.old                   , ],
                   parMAP.old[ iCStree0.old                   , ],
                   parMAP.old[ (iKSINKPMAX.old+1):np.old      , ] )
  source('initialisation/set_CAF2021_Turrialba.R')
  rownames(parMAP) <- names_params   
```

\clearpage



# Introduction

This is the third progress report for project SEACAF on the process-based modelling of coffee agroforestry systems in Central America by means of the model CAF2021. The first progress report [dated 30 April 2021; @VanOijen_2021_Modelling] provided details and references on the model. The second report [dated 16 June 2021; @VanOijen_2021_Modellinga] presented changes to model structure and discussed the setup and results of a Bayesian model calibration using data from long-term experiments in Turrialba (Costa Rica) and Masatepe (Nicaragua).



# Banana

## Exploring parameter values for Banana

Data for coffee agroforestry farms in the Turrialba region with fruit trees were provided by Rolando Cerda (CATIE). Annual N-fertilisation levels were quantified for plots on 51 farms and ranged from 33 to 285 kg N ha-1 y-1, averaging $99 \pm 63$. On the nine plots where the only fruit trees were Musaceae, annual banana yields varied from 20 to 400 bunches ha-1 ($138 \pm 153$). These yields were not correlated with fertilisation rate, nor with the density of the trees which ranged from 30 to 1410 ha-1 ($386 \pm 424$), with the average production per tree ranging from 0.08 to 3.33 ($0.79 \pm 1.09$) bunches. The variation in these numbers is so high that we decided to calibrate banana production in CAF2021 on literature data instead, collected during the literature review reported before [@VanOijen_2021_Modelling].

- @Damour_2012_Simulation: SLA of 0.018 $m^2 g^{-1}$, light extinction coefficient = 0.7, leaf N-content 3-4% of dry matter.
- @ChavesC._2009_Modeling:
  - LUE (1.63 g MJ-1)
  - critical temperatures of $T_{min}$ = 12.5 $^{\circ}$C, $T_{opt}$ = 25 $^{\circ}$C, $T_{max}$ = 40 $^{\circ}$C []
  - Allocation about equally to leaves, pseudostem and corm with during later development most going to bunches that ultimately reach up to 45% of aboveground biomass.
- @VanDenBergh_2012_Climate: critical monthly temperatures: $T_{kill}$ = 0 $^{\circ}$C, $T_{min}$ = 12 $^{\circ}$C, $T_{opt}$ = 17.5 to 26.3 $^{\circ}$C, $T_{max}$ = 33 $^{\circ}$C.
- @Dold_2007_Musa: Most common coffee agroforestry systems in the Turrialba region were coffee + *Erythrina peoppigiana* + banana/plantain + laurel (*Cordia alliodora*). Typical tree densities were 162 *E.p.* $ha^{-1}$, 179 banana/plantain $ha^{-1}$, 37 laurel $ha^{-1}$. They cite literature where poro density is 130-208 $ha^{-1}$ and banana 149-343 $ha^{-1}$ and state that banana above 120 $ha^{-1}$ would reduce coffee yield too much.
- @Dold_2010_Improving: mean tree density in central Costa Rican coffee agroforestry systems was 341 $ha^{-1}$ with 579 bananas $ha^{-1}$. In northern Nicaragua the mean tree density was 185 $ha^{-1}$ with 358 bananas $ha^{-1}$.
- @Ripoche_2012_Modeling:
  - Up to 10 kg aboveground DM per plant.
- @ChavesC._2009_Modeling: plantain (Musa AAB).
  - Latin American mean yield is 7.3 t ha-1 y-1 (DM?)
  - DMP fruits ~ 25%.
  - Tb = 12.5 degC, Topt = 25 degC, Tmax = 40 degC. Growth stages simulated as GDD. 

- @Jullien_2001_Withinbunch reported that pulp DMP reaches asymptotically to values of about 30%. 
- @Mustaffa_2012_Banana: leaf N content was about 3% of DM.
- @MartinezAcosta_2011_Dinamica reported for the final DM per tree, bunch:leaves:pseudostem+corm: 3000:1200:1800 g DM.
- @Schaffer_1999_Atmospheric give DM-partitioning of 6-month old vegetative banana (cv. 'Gros Michel'): leaves:pseudostem+rhizome:roots =  19:64:19%.
- DM-partitioning of cv. 'Williams' in Colombia was not affected strongly by the level of N-fertilization (0 to 483 kg N $ha^{-1}$), but fruit yields increased from 9 to 12 kg DM [@TorresB._2014_Accumulation]. At harvest after 161 kg N $ha^{-1}$ fertilization: corm+pseudostem/leaves/fruits = 6/1.5/3.5 kg DM per plant. Total plant N-concentration was 1-1.5% of DM.
- @Turner_2007_Environmental: LAI ranges from 2 to 5 m2 m-2.

## Banana simulation in CAF2021

To make CAF2021 simulate banana in a coffee plantation, we start by initialising for a full-sun coffee system, then set the initial density of fruit trees (TREEDENS0(2)) to a positive value, and choose parameter settings that are appropriate for banana. We show some preliminary results in Fig. \ref{fig:SimBanana}.

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_19_PS_AC.R")
  pBanana <- set_par_speciesT( 2, "Banana" )
  outputB <- run_model( p=pBanana )
```

```{r SimBanana, fig.height=3.5, fig.cap="\\label{fig:SimBanana}Simulating banana with CAF2021."}
  par( mfrow=c(2,3), mar=c(3,3,3,3) )
  
  plot_CdistributionTrees( sim=outputB, it=2 )
  
  Time <- outputB[,1]
    i.ht2    <- which( outputNames=="h_t(2)"      ) ; h_t2      <- outputB[,i.ht2]
    i.Shade  <- which( outputNames=="Shade_f"     ) ; Shade_f   <- outputB[,i.Shade]
    i.CAt2   <- which( outputNames=="CAtree_t(2)" ) ; CAtree2   <- outputB[,i.CAt2]
    i.CPT    <- which( outputNames=="harvCPT_f"   ) ; harvCPT_f <- outputB[,i.CPT]
    YtreesDM <- harvCPT_f * 1e4 * 365 / 0.45
  plot( Time, h_t2     , type="l", ylab="", main="Height (m)" )
  plot( Time, CAtree2  , type="l", ylab="", main="Crown area (m2 tree-1)" )
  plot( Time, Shade_f  , type="l", ylab="", main="Shade (-)" )
  plot( Time, YtreesDM , type="l", ylab="", main="Fruit yield (kg DM ha-1)" )
```

```{r}
  tmp <- fOutputTM()

  par( mfrow=c(5,1), mar=c(3,2,2,0) )
  barplotTM( tmp$Harvests[,"harvDM_f_hay" ], name="Annual Coffee (kg DM ha-1)" )
  barplotTM( tmp$Harvests[,"harvCPT_f" ], name="Total harvCPT_f (kg C m-2)" )
  barplotTM( tmp$Harvests[,"harvCPT_2" ], name="Total harvCPT_2 (kg C m-2)" )
  barplotTM( tmp$Harvests[,"harvCST_f" ], name="Total harvCST_f (kg C m-2)" )
  barplotTM( tmp$Harvests[,"harvCST_3" ], name="Total harvCST_3 (kg C m-2)" )

  par( mfrow=c(3,1), mar=c(3,2,2,0) )
  barplotTM( tmp$Balances[,"D_Csys" ], name="System C (kg ha-1 y-1)" )
  barplotTM( tmp$Balances[,"D_Csoil"], name="Soil C (kg ha-1 y-1)"   )
  barplotTM( tmp$Balances[,"D_Nsoil" ], name="Soil N (kg ha-1 y-1)"  )
```


# Avocado

## Exploring parameter values for Avocado

## Avocado simulation in CAF2021

See Fig. \ref{fig:SimAvocado}.

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_19_PS_AC.R")
  pAvocado <- set_par_speciesT( 2, "Avocado" )
  outputA  <- run_model( p=pAvocado )
```

```{r SimAvocado, fig.height=3.5, fig.cap="\\label{fig:SimAvocado}Simulating avocado with CAF2021."}
  par( mfrow=c(2,3), mar=c(3,3,3,3) )
  
  plot_CdistributionTrees( sim=outputA, it=2 )
  
  Time <- outputA[,1]
    i.ht2    <- which( outputNames=="h_t(2)"      ) ; h_t2      <- outputA[,i.ht2]
    i.Shade  <- which( outputNames=="Shade_f"     ) ; Shade_f   <- outputA[,i.Shade]
    i.CAt2   <- which( outputNames=="CAtree_t(2)" ) ; CAtree2   <- outputA[,i.CAt2]
    i.CPT    <- which( outputNames=="harvCPT_f"   ) ; harvCPT_f <- outputA[,i.CPT]
    YtreesDM <- harvCPT_f * 1e4 * 365 / 0.45
  plot( Time, h_t2     , type="l", ylab="", main="Height (m)" )
  plot( Time, CAtree2  , type="l", ylab="", main="Crown area (m2 tree-1)" )
  plot( Time, Shade_f  , type="l", ylab="", main="Shade (-)" )
  plot( Time, YtreesDM , type="l", ylab="", main="Fruit yield (kg DM ha-1)" )
```



# APPENDIX

```{r}
  sA <- 11 ; sB <- 17 ; sC <- 31 ; sD <- 19
  source(sitesettings_filenames[sA]) ; output.MAP.A <- run_model( p=parMAP[,sA] )
  source(sitesettings_filenames[sB]) ; output.MAP.B <- run_model( p=parMAP[,sB] )
  source(sitesettings_filenames[sC]) ; output.MAP.C <- run_model( p=parMAP[,sC] )
  source(sitesettings_filenames[sD]) ; output.MAP.D <- run_model( p=parMAP[,sD] )
```

```{r, out.width="100%", fig.cap="\\label{fig:NBalancesSoil}Soil N-balances for 4 treatments, averaged over the whole simulated period. Top row: Turrialba; bottom row: Masatepe. Simulations using the MAP parameter vector from Bayesian calibration."}
  par( mfrow=c(2,4) )

  par(mar=c(3,3,3,0))
  plot_NbalanceSoil(output.MAP.A, title1="", title2="11 TE-CM  ", ymax=800)
  par(mar=c(3,3,3,0))
  plot_NbalanceSoil(output.MAP.B, title1="", title2="17 -CI    ", ymax=800)
  par(mar=c(3,3,3,0))
  plot_NbalanceSoil(output.MAP.C, title1="", title2="31 ILSG-CM", ymax=800)
  par(mar=c(3,3,3,0))
  plot_NbalanceSoil(output.MAP.D, title1="", title2="19 -CI    ", ymax=800)
```

```{r}
## Exploring deciduousness
  sA            <- 23 # Masatepe_05_SGTR_CI
  source(sitesettings_filenames[sA])
  params        <- parMAP[ , sA ]
  params.MAP.A  <- params
  params.MAP.A1 <- set_par( c("FTCLMINT(3)","TCLMAXT(3)"),
                            c( 0.2         , 650        ) )
  params.MAP.A2 <- set_par( c("FTCLMINT(3)","TCLMAXT(3)"),
                            c( 0.05        , 650        ) )
  params.MAP.A3 <- set_par( c("FTCLMINT(3)","TCLMAXT(3)"),
                            c( 0.2         , 365        ) )
  output.MAP.A  <- run_model( p=params.MAP.A  )
  output.MAP.A1 <- run_model( p=params.MAP.A1 )
  output.MAP.A2 <- run_model( p=params.MAP.A2 )
  output.MAP.A3 <- run_model( p=params.MAP.A3 )
  plot_output( list_output=list( output.MAP.A,
                                 output.MAP.A1, output.MAP.A2 ,output.MAP.A3),
               vars=c( "fTranT_t(3)", "LAIT_t(3)" ) )
```

```{r Balances2, fig.height=6, fig.cap="\\label{fig:Balances2}Soil N- and C-balances at Masatepe in the ILSS_CI system. Top row: tree branches harvested and removed after pruning and thinning. Bottom row: branches left on the field as litter."}
## Comparison of leaving tree branches on the field after thinning and pruning (default) vs. removing them as harvest
  sA <- 27 # Masatepe_09_ILSS_CI
  source(sitesettings_filenames[sA])
  params        <- parMAP[ , sA ]
  params.MAP.A  <- params
  params.MAP.A1 <- set_par( c("FHARVBT(1)","FHARVBT(2)","FHARVBT(3)"),
                            c( 0          , 0          , 0          ) )
  output.MAP.A  <- run_model( p=params.MAP.A  )
  output.MAP.A1 <- run_model( p=params.MAP.A1 )
  par( mar=c(3,3,3,0), mfrow=c(2,4) )
  plot_NbalanceSoil( output.MAP.A , title1="Soil N-balance MAP", title2="" )
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil( output.MAP.A , title1="Soil C-balance MAP", title2="" )
  par( mar=c(3,3,3,0) )
  plot_NbalanceSoil( output.MAP.A1, title1="Soil N-balance 1", title2="" )
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil( output.MAP.A1, title1="Soil C-balance 1", title2="" )
```

\clearpage



# Acknowledgements {-}

I thank the Natural Resources Institute of the University of Greenwich for funding, and my colleagues in project SEACAF and earlier projects for support.



# References {-}

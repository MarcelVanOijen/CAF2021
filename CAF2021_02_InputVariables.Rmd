---
title: 'CAF2021: Input variables'
author:
- Marcel van Oijen; VanOijenMarcel@gmail.com
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
---

```{r, include=FALSE}
  library(geoR)
```



# Turrialba (Costa Rica): Long-term coffee agroforestry experiment

## Weather

```{r, echo=FALSE, out.width="100%", fig.cap="\\label{FigWeather}Weather at CATIE 2000-2017."}
  file_weather <- 'weather/weather_Turrialba_2000_2017.txt'
  df_weather   <- read.table( file_weather, header=TRUE )
  Time         <- with( df_weather, year + (doy-0.5)/366 )

  par( mfrow=c(2,3), mar=c(2,4,0,1) )
  plot( Time, df_weather$GR  , ylab="GR (MJ m-2 d-1)", cex=0.1, xlab="", xaxt="n" )
  plot( Time, df_weather$TMIN, ylab="TMIN (degC)"    , cex=0.1, xlab="", xaxt="n" )
  plot( Time, df_weather$TMAX, ylab="TMAX (degC)"    , cex=0.1, xlab="", xaxt="n" )
  plot( Time, df_weather$VP  , ylab="VP (kPa)"       , cex=0.1, xlab="" )
  plot( Time, df_weather$WN  , ylab="WN (m s-1)"     , cex=0.1, xlab="" )
  plot( Time, df_weather$RAIN, ylab="RAIN (mm d-1)"  , cex=0.1, xlab="" )
```

- We created a file with daily weather data 2000-2017 for five variables: radiation, temperature, atmospheric vapour pressure, wind speed, rainfall.
- For the period Jan 2000 - April 2014, we used a daily weather data file created by Oriana Ovalle.
- For the period May 2014 - May 2017, we used data downloaded from the CATIE website: daily data for rain, mostly monthly data for the other four variables.
- For the period June to Dec 2017, we used the median values of the same-day values from all preceding years.
- The wind speed data are clearly unreliable. There is evidence of sensor drift over time toward unrealistically low values.
- The absence of daily data for most variables May 2014-Dec 2016 is a problem.
- The absence of any data from June 2017 is a problem.
- Data from the weather station 73103 differed too much from CATIE data (in time periods and for variables where both had data) to be useful for gap-filling.

## Soil and management

- There was large spatial variation on the CATIE site, as we can see from very large differences between the three blocks of the experiment. We ignored this variation and used the same soil property values for all treatments.
- For the fertilization levels of the AC and MC treatments, we used the values in the Ovalle model initialisation files (AC: 90+90+100 kg N ha-1 y-1; MC: 45+45+60 kg N ha-1 y-1). We assumed that the annual N-additions in the MO treatment were 20% of MC, and were zero in BO.



# Goestatistical interpolation Costa Rica by Stefania

This section uses R-code originally developed in folder '/Documents/SEACAF/MODELLING/InterpolationMarcel_StefaniaCerretelli'. That code was written to test the geostatistical approach chosen by Stefania for interpolating weather data in Costa Rica.

## Preparing data and setting up the geostatistical model

Data:

```{r}
  mdata = read.csv("weather/clim_Icafe&IMN_red_train2.csv", header = TRUE)
  x1 <- (mdata$long - min(mdata$long)) / (max(mdata$long)  - min(mdata$long))
  x2 <- (mdata$lat  - min(mdata$lat )) / (max(mdata$long)  - min(mdata$long))
  y  <- (mdata$X10  - min(mdata$X10 )) / (max(mdata$X10 )  - min(mdata$X10 ))

  Vy <- 1
  x  <- cbind(x1,x2)
```

No need for a covariate 'altitude':

```{r}
  alt <- mdata$alt ; plot(alt,y)
```

Setting up geostatistical model:

```{r}
  mb   <- c(0,0,0) ; Sb <- diag(1,3) ; X <- cbind(1,x)
  domain_phi <- seq(0.1,1,0.3)

  xy      <- as.geodata( cbind( x, y ) )

  xpred.1 <- expand.grid( seq(-0.1,1.1,l=49), seq(-0.1,0.7,l=33) )
  model.1 <- model.control( cov.m="exponential", trend.d=~coords, trend.l=~coords )
  prior.1 <- prior.control( beta.prior="normal", beta=mb, beta.var.std=Sb/Vy,
    sigmasq.prior="sc.inv.chisq", sigmasq=Vy, df.sigmasq=2,
    phi.prior="uniform", phi.discrete=domain_phi,
    tausq.rel.prior="fixed", tausq.rel=0 )
  out.1   <- output.control(messages=F)
```

## Kriging and plotting

```{r}
  geoR.1  <- krige.bayes( xy, loc=xpred.1, mod=model.1, pr=prior.1, out=out.1 )
```
   
```{r, echo=F, message=F, fig.height=3.5} 
  par( mfrow=c(1,2) )

  image( geoR.1, val=geoR.1$predictive$mean, xlim=c(-0.1,1.1), ylim=c(-0.3,0.7),
        col=terrain.colors(21), main="\n\nMean", xlab="lon", ylab="lat" )
  points( xy, cex.max = 1, col = "black", add=T, pt.divide="equal", pch="x" )
  contour( geoR.1, add=T, nlev=11 )
  image( geoR.1, val=sqrt(geoR.1$predictive$variance), xlim=c(-0.1,1.1), ylim=c(-0.3,0.7),
          col=terrain.colors(21), main="\n\nStandard Deviation", xlab="lon", ylab="lat" )
  points( xy, cex.max = 1, col = "black", add=T, pt.divide="equal", pch="x" )
  legend.krige( val=sqrt(geoR.1$predictive$variance),
                col=terrain.colors(21), x.leg=c(0,1), y.leg=c(-0.3,-0.2) )
```

## Trend (regression)

```{r}
  bpost <- geoR.1$posterior$beta$summary[,"mean"]
  print( bpost )
  lm.y <- lm(y ~ X %*% bpost) ; summary(lm.y)
```

```{r, echo=F, fig.height=3.5}
  plot(X %*% bpost,y) ; abline(lm.y)
```

```{r, echo=F, eval=F}
  print( c( xpred.1[   1,], geoR.1$predictive$mean[   1], geoR.1$predictive$variance[   1] ) )
  print( c( xpred.1[1617,], geoR.1$predictive$mean[1617], geoR.1$predictive$variance[1617] ) )
```

```{r, echo=F, eval=F, fig.height=3.5}
  print(geoR.1$posterior$beta)    # Posterior(b)
  print(geoR.1$posterior$sigmasq) # Posterior(sigmasq)
  print(geoR.1$posterior$phi)     # Posterior(phi)
  print(geoR.1$predictive)        # Prediction
  print( sum( geoR.1$posterior$phi$phi.marginal$phi *
    geoR.1$posterior$phi$phi.marginal$expected ) ) # E[phi]
  plot( domain_phi, geoR.1$posterior$phi$phi.marginal$expected )
```

## Adding a nugget

```{r, eval=T}
  prior.2 <- prior.control( beta.prior="normal", beta=mb, beta.var.std=Sb/Vy,
    sigmasq.prior="sc.inv.chisq", sigmasq=Vy, df.sigmasq=2,
    phi.prior="uniform", phi.discrete=domain_phi,
    tausq.rel.prior="fixed", tausq.rel=0.5 )
  geoR.2  <- krige.bayes( xy, loc=xpred.1, mod=model.1, pr=prior.2, out=out.1 )
```
  
```{r, echo=F, fig.height=3.5}  
  par( mfrow=c(1,2) )

  image( geoR.2, val=geoR.2$predictive$mean, xlim=c(-0.1,1.1), ylim=c(-0.3,0.7),
        col=terrain.colors(21), main="\n\nMean", xlab="lon", ylab="lat" )
  points( xy, cex.max = 1, col = "black", add=T, pt.divide="equal", pch="x" )
  contour( geoR.2, add=T, nlev=11 )
  image( geoR.2, val=sqrt(geoR.2$predictive$variance), xlim=c(-0.1,1.1), ylim=c(-0.3,0.7),
          col=terrain.colors(21), main="\n\nStandard Deviation", xlab="lon", ylab="lat" )
  points( xy, cex.max = 1, col = "black", add=T, pt.divide="equal", pch="x" )
  legend.krige( val=sqrt(geoR.2$predictive$variance),
                col=terrain.colors(21), x.leg=c(0,1), y.leg=c(-0.3,-0.2) )
```


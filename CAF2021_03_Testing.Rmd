---
title: 'CAF2021: Testing'
author:
- Marcel van Oijen; VanOijenMarcel@gmail.com
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
csl: environmental-modelling-and-software.csl
bibliography: [Avocado.bib,Banana.bib,MvO.bib]
---

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=F,results="asis",warning=FALSE,message=FALSE)
```

# Notes on CAF2021

Height not used in calculating overshadowing. Note that in banana the height of the top leaf exceeds that of the top of the pseudostem.

# Test with 2 tree spp.

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")

  params[names_params=="TREEDENS0(1)"] <- 0.04
  params[names_params=="TREEDENS0(2)"] <- 0.02
  params[names_params=="KNFIX(2)"    ] <- params[names_params=="KNFIX(1)"] <- 0.1

  # We prune tree species 2 half as frequently as species 1
  # (only the even-numbered times)
  even <- seq(2,100,2)
  calendar_prunT[ 2, even , ] <- calendar_prunT[ 1, even , ]
  
  # We thin tree species 2 one week after species 1, and add one extra thinning day:
  calendar_thinT[ 2,    ,   ] <- calendar_thinT[ 1, ,   ]
  calendar_thinT[ 2,    , 2 ] <- calendar_thinT[ 1, , 2 ] + 7
  calendar_thinT[ 2, 100,   ] <- c( 2004, 131, 0.9 )

  output <- run_model()
```

## Tabular outputs

```{r}
  output_short <- signif( output, 5 )
  icols        <- 2:12
  knitr::kable( rbind( head(output_short[,icols],n=2),
                       rep("...",length(icols)),
                       tail(output_short[,icols],n=2,keepnums=F) ),
                col.names=outputNames[icols] )
```

```{r, eval=F}
  initvalues  <- signif( head( output, 1 ), 4 )
  finalvalues <- signif( tail( output, 1 ), 4 )
  knitr::kable( cbind( outputNames, outputUnits, t(initvalues), t(finalvalues) ),
                col.names=c("Variable","Unit","Initial value","Final value") )
```

## Graphical outputs

```{r, fig.height=4}
  par( mfrow=c(2,1), mar=c(2,2,2,0) )

  Time <- output[,1]
  i.Ac <- sapply( 1:6, function(i) {
    which( outputNames==paste0("Ac(",i,")") ) } )
  plot  ( Time, output[,i.Ac[1]], type="l", ylim=c(0,1),
          main="Cumulative ground cover of six LCC (-)",
          xlab="", ylab="" )
  points( Time, rowSums( output[,i.Ac[1:2]] ), type="l", col="yellow" )
  points( Time, rowSums( output[,i.Ac[1:3]] ), type="l", col="green" )
  points( Time, rowSums( output[,i.Ac[1:4]] ), type="l", col="red" )
  points( Time, rowSums( output[,i.Ac[1:5]] ), type="l", col="blue" )
  points( Time, rowSums( output[,i.Ac[1:6]] ), type="l", col="black" )

  Time <- output[,1]
  i.At <- sapply( 1:3, function(i) {
    which( outputNames==paste0("At(",i,")") ) } )
  plot  ( Time, output[,i.At[1]], type="l", ylim=c(0,1),
          main="Ground cover by 3 tree spp.",
          xlab="", ylab="" )
  points( Time, output[,i.At[2]], type="l", col="red" )
  points( Time, output[,i.At[3]], type="l", col="blue" )
  legend( "bottomright", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )
```

```{r, fig.height=4}
  par( mfrow=c(2,1), mar=c(2,2,2,0) )

  Time <- output[,1]
  i.trd <- sapply( 1:3, function(i) {
    which( outputNames==paste0("treedens_t(",i,")") ) } )
  yrange <- range(0,output[,i.trd[1:3]])
  plot  ( Time, output[,i.trd[1]], type="l",
          main="Tree density (ha-1)", xlab="", ylab="", ylim=yrange )
  points( Time, output[,i.trd[2]], type="l", col="red" )
  points( Time, output[,i.trd[3]], type="l", col="blue" )
  legend( "topright", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )

  Time <- output[,1]
  i.h <- sapply( 1:3, function(i) {
    which( outputNames==paste0("h_t(",i,")") ) } )
  yrange <- range(output[,i.h[1:3]])
  plot  ( Time, output[,i.h[1]], type="l",
          main="Tree height (m)", xlab="", ylab="", ylim=yrange )
  points( Time, output[,i.h[2]], type="l", col="red"  )
  points( Time, output[,i.h[3]], type="l", col="blue" )
  legend( "topleft", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )
```

```{r, fig.height=4}
  par( mfrow=c(2,1), mar=c(2,2,2,0) )

  Time <- output[,1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )
  plot  ( Time, cumsum(output[,i.harvCP[1]]), type="p", ylim=c(0,0.6),
          main="Cumulative yield (kg C m-2)",
          xlab="", ylab="" )
  points( Time, cumsum(output[,i.harvCP[2]]), type="p", col="yellow" )
  points( Time, cumsum(output[,i.harvCP[3]]), type="p", col="green" )
  points( Time, cumsum(output[,i.harvCP[4]]), type="p", col="red" )
  points( Time, cumsum(output[,i.harvCP[5]]), type="p", col="blue" )
  points( Time, cumsum(output[,i.harvCP[6]]), type="p", col="black" )
  legend( "topleft", col=c("black","yellow","green","red","blue","black"),
          lty=1, lwd=5,
          legend=c("LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )

  Time <- output[,1] ; TimeFrom0 <- Time - Time[1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )
  CCONC <- 0.47
  Y1_kgDMm2 <- output[,i.harvCP[1]] / CCONC ; it1 <- which(Y1_kgDMm2>0)
  Time1     <- Time[it1] ; Y1_kgDMm2 <- Y1_kgDMm2[it1]
  Y2_kgDMm2 <- output[,i.harvCP[2]] / CCONC ; it2 <- which(Y2_kgDMm2>0)
  Time2     <- Time[it2] ; Y2_kgDMm2 <- Y2_kgDMm2[it2]
  Y3_kgDMm2 <- output[,i.harvCP[3]] / CCONC ; it3 <- which(Y3_kgDMm2>0)
  Time3     <- Time[it3] ; Y3_kgDMm2 <- Y3_kgDMm2[it3]
  Y4_kgDMm2 <- output[,i.harvCP[4]] / CCONC ; it4 <- which(Y4_kgDMm2>0)
  Time4     <- Time[it4] ; Y4_kgDMm2 <- Y4_kgDMm2[it4]
  Y5_kgDMm2 <- output[,i.harvCP[5]] / CCONC ; it5 <- which(Y5_kgDMm2>0)
  Time5     <- Time[it5] ; Y5_kgDMm2 <- Y5_kgDMm2[it5]
  Y6_kgDMm2 <- output[,i.harvCP[6]] / CCONC ; it6 <- which(Y6_kgDMm2>0)
  Time6     <- Time[it6] ; Y6_kgDMm2 <- Y6_kgDMm2[it6]
  
  Y_kgDMm2 <- Y1_kgDMm2 * output[,i.Ac[1]][it1] +
              Y2_kgDMm2 * output[,i.Ac[2]][it2] +
              Y3_kgDMm2 * output[,i.Ac[3]][it3] +
              Y4_kgDMm2 * output[,i.Ac[4]][it4] +
              Y5_kgDMm2 * output[,i.Ac[5]][it5] +
              Y6_kgDMm2 * output[,i.Ac[6]][it6]
  
  plot  ( Time1, Y1_kgDMm2, type="b", pch="1", ylim=c(0,0.25),
          main="Yield (kg DM m-2)", xlab="", ylab="" )
  points( Time2, Y2_kgDMm2, type="b", pch="2", col="yellow" )
  points( Time3, Y3_kgDMm2, type="b", pch="3", col="green"  )
  points( Time4, Y4_kgDMm2, type="b", pch="4", col="red"    )
  points( Time5, Y5_kgDMm2, type="b", pch="5", col="blue"   )
  points( Time6, Y6_kgDMm2, type="b", pch="6", col="black"  )
  points( Time6, Y_kgDMm2 , type="l", lty=1  , col="black", lwd=3 )
  legend( "topright",
          col=c("black","black","yellow","green","red","blue","black"),
          lty=1, pch=c("",paste(1:6)),
          lwd=c(3,rep(1,6)),
          legend=c("Field","LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )
```

## N-balance soil

```{r}
  plot_NbalanceSoil <- function( sim=output, title1="", title2=title1,
                                 ymax=NULL, verify=F ) {
    NinNames  <- c("Nfert_f", "NfixT_f", "NsenprunT_f", "Nsenprun_f")
    NoutNames <- c("Nleaching_f", "Nemission_f", "Nrunoff_f", "Nupt_f", "NuptT_f")
    nNin      <- length(NinNames) ; nNout  <- length(NoutNames)
    i.Nin     <- rep(NA,nNin)     ; i.Nout <- rep(NA,nNout)
    for(i in 1:nNin ) {i.Nin [i] <- which( outputNames==NinNames [i] ) }
    for(i in 1:nNout) {i.Nout[i] <- which( outputNames==NoutNames[i] ) }
    NinMean   <- colMeans(sim[,i.Nin])  * 1.e4 * 365 # kgN ha-1 y-1
    NoutMean  <- colMeans(sim[,i.Nout]) * 1.e4 * 365 # kgN ha-1 y-1
    if(is.null(ymax)) {
      y.max <- max( sum(NinMean), sum(NoutMean) )
    } else {
      y.max = ymax
    }
    leg <- NinNames
    barplot( as.matrix(NinMean),
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Inputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title1,adj=1)
    par(mar=c(3,0,3,3))
    leg <- NoutNames
    barplot( as.matrix(NoutMean),
             yaxt="n",
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Outputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title2,adj=0)
    if(verify) {
      Nsoil_f      <- sim[ , which( outputNames=="Nsoil_f") ] # kgN m-2
      D_Nsoil_f    <- Nsoil_f[NDAYS] - Nsoil_f[1]                # kgN m-2
      NinSum       <- colSums(sim[2:NDAYS,i.Nin ])            # kgN m-2
      NoutSum      <- colSums(sim[2:NDAYS,i.Nout])            # kgN m-2
      NinMinusNout <- sum(NinSum) - sum(NoutSum)
      cat( "VERIFYING THE N-BALANCE FOR THE SOIL (kgN m-2):",
           "\nState variable change: ", D_Nsoil_f,
           "\nInputs minus outputs : ", NinMinusNout )
    }
  }
```

```{r}
  par( mfrow=c(2,4) )
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
  output <- run_model()
  plot_NbalanceSoil(output, title1="Soil N-balance: ", title2="Treatment 1",
                    verify=T, ymax=800)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_02_E_MC.R")
  output <- run_model()
  plot_NbalanceSoil(output, title1="Soil N-balance: ", title2="Treatment 2",
                    verify=T, ymax=800)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_03_E_MO.R")
  output <- run_model()
  plot_NbalanceSoil(output, title1="Soil N-balance: ", title2="Treatment 3",
                    verify=T, ymax=800)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_04_E_BO.R")
  output <- run_model()
  plot_NbalanceSoil(output, title1="Soil N-balance: ", title2="Treatment 4",
                    verify=T, ymax=800)
```

## C-balance soil

```{r}
  plot_CbalanceSoil <- function( sim=output, title1="", title2=title1,
                                 ymax=NULL, verify=F ) {
    CinNames  <- c("CsenprunT_f", "Csenprun_f")
    CoutNames <- c("Rsoil_f", "Crunoff_f")
    nCin      <- length(CinNames) ; nCout  <- length(CoutNames)
    i.Cin     <- rep(NA,nCin)     ; i.Cout <- rep(NA,nCout)
    for(i in 1:nCin ) {i.Cin [i] <- which( outputNames==CinNames [i] ) }
    for(i in 1:nCout) {i.Cout[i] <- which( outputNames==CoutNames[i] ) }
    CinMean   <- colMeans(sim[,i.Cin])  * 1.e4 * 365 # kgC ha-1 y-1
    CoutMean  <- colMeans(sim[,i.Cout]) * 1.e4 * 365 # kgC ha-1 y-1
    if(is.null(ymax)) {
      y.max <- max( sum(CinMean), sum(CoutMean) )
    } else {
      y.max = ymax
    }
    leg <- CinNames
    barplot( as.matrix(CinMean),
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Inputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title1,adj=1)
    par(mar=c(3,0,3,3))
    leg <- CoutNames
    barplot( as.matrix(CoutMean),
             yaxt="n",
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Outputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title2,adj=0)
    if(verify) {
      Csoil_f   <- sim[ , which( outputNames=="Csoil_f") ] # kgC m-2 
      D_Csoil_f <- Csoil_f[NDAYS] - Csoil_f[1]                # kgC m-2
      CinSum        <- colSums(sim[2:NDAYS,i.Cin ])        # kgC m-2
      CoutSum       <- colSums(sim[2:NDAYS,i.Cout])        # kgC m-2
      CinMinusCout  <- sum(CinSum) - sum(CoutSum)
      cat( "VERIFYING THE C-BALANCE FOR THE SOIL (kgC m-2):",
           "\nState variable change: ", D_Csoil_f,
           "\nInputs minus outputs : ", CinMinusCout )
    }
  }
```

```{r}
  par( mfrow=c(2,4) )
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
  output <- run_model()
  plot_CbalanceSoil(output, title1="Soil C-balance: ", title2="Treatment 1",
                    verify=T, ymax=7500)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_02_E_MC.R")
  output <- run_model()
  plot_CbalanceSoil(output, title1="Soil C-balance: ", title2="Treatment 2",
                    verify=T, ymax=7500)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_03_E_MO.R")
  output <- run_model()
  plot_CbalanceSoil(output, title1="Soil C-balance: ", title2="Treatment 3",
                    verify=T, ymax=7500)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_04_E_BO.R")
  output <- run_model()
  plot_CbalanceSoil(output, title1="Soil C-balance: ", title2="Treatment 4",
                    verify=T, ymax=7500)
```

## H2O-balance soil ("W-balance")

```{r}
  plot_H2ObalanceSoil <- function( sim=output, title1="", title2=title1,
                                   ymax=NULL, verify=F ) {
    WinNames  <- c("Rain_f")
    WoutNames <- c("Drain_f", "Runoff_f" , "Evap_f"    ,"Tran_f" , 
                   "TranT_f", "Rainint_f", "RainintT_f")
    nWin      <- length(WinNames) ; nWout  <- length(WoutNames)
    i.Win     <- rep(NA,nWin)     ; i.Wout <- rep(NA,nWout)
    for(i in 1:nWin ) {i.Win [i] <- which( outputNames==WinNames [i] ) }
    for(i in 1:nWout) {i.Wout[i] <- which( outputNames==WoutNames[i] ) }
    WinMean   <-    mean (sim[,i.Win])  # mm d-1
    WoutMean  <- colMeans(sim[,i.Wout]) # mm d-1
    if(is.null(ymax)) {
      y.max <- max( sum(WinMean), sum(WoutMean) )
    } else {
      y.max = ymax
    }
    leg <- WinNames
    barplot( as.matrix(WinMean),
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Inputs (mm d-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title1,adj=1)
    par(mar=c(3,0,3,3))
    leg <- WoutNames
    barplot( as.matrix(WoutMean),
             yaxt="n",
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Outputs (mm d-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title2,adj=0)
    if(verify) {
      WA_f   <- sim[ , which( outputNames=="WA_f") ] # mm
      D_WA_f <- WA_f[NDAYS] - WA_f[1]                   # mm
      WinSum        <-    sum (sim[2:NDAYS,i.Win ])  # mm
      WoutSum       <- colSums(sim[2:NDAYS,i.Wout])  # mm
      WinMinusWout  <- sum(WinSum) - sum(WoutSum)
      cat( "VERIFYING THE H2O-BALANCE FOR THE SOIL (mm):",
           "\nState variable change: ", D_WA_f,
           "\nInputs minus outputs : ", WinMinusWout )
    }
  }
```

```{r}
  par( mfrow=c(2,4) )
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
  output <- run_model()
  plot_H2ObalanceSoil(output, title1="Soil H2O-balance: ", title2="Treatment 1",
                      verify=T, ymax=8)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_02_E_MC.R")
  output <- run_model()
  plot_H2ObalanceSoil(output, title1="Soil H2O-balance: ", title2="Treatment 2",
                      verify=T, ymax=8)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_03_E_MO.R")
  output <- run_model()
  plot_H2ObalanceSoil(output, title1="Soil H2O-balance: ", title2="Treatment 3",
                      verify=T, ymax=8)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_04_E_BO.R")
  output <- run_model()
  plot_H2ObalanceSoil(output, title1="Soil H2O-balance: ", title2="Treatment 4",
                      verify=T, ymax=8)
```

## C-balance coffee

```{r}
  plot_CbalanceCoffee <- function( sim=output, title1="", title2=title1,
                                   ymax=NULL, verify=F ) {
    CinNames  <- "gC_f"
    CoutNames <- c("dC_f", "prunC_f", "harvCP_f")
    nCin      <- length(CinNames) ; nCout  <- length(CoutNames)
    i.Cin     <- rep(NA,nCin)     ; i.Cout <- rep(NA,nCout)
    for(i in 1:nCin ) {i.Cin [i] <- which( outputNames==CinNames [i] ) }
    for(i in 1:nCout) {i.Cout[i] <- which( outputNames==CoutNames[i] ) }
    CinMean   <-    mean (sim[,i.Cin])  * 1.e4 * 365 # kgC ha-1 y-1
    CoutMean  <- colMeans(sim[,i.Cout]) * 1.e4 * 365 # kgC ha-1 y-1
    if(is.null(ymax)) {
      y.max <- max( sum(CinMean), sum(CoutMean) )
    } else {
      y.max = ymax
    }
    leg <- CinNames
    barplot( CinMean,
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Inputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title1,adj=1)
    par(mar=c(3,0,3,3))
    leg <- CoutNames
    barplot( as.matrix(CoutMean),
             yaxt="n",
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Outputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title2,adj=0)
    if(verify) {
      C_f          <- sim[ , which( outputNames=="C_f" ) ] # kgC m-2
      D_C_f        <- C_f[NDAYS] - C_f[1]                     # kgC m-2
      CinSum       <-    sum (sim[2:NDAYS,i.Cin ])         # kgC m-2
      CoutSum      <- colSums(sim[2:NDAYS,i.Cout])         # kgC m-2
      CinMinusCout <- sum(CinSum) - sum(CoutSum)
      cat( "VERIFYING THE C-BALANCE OF COFFEE (kgC m-2):",
           "\nState variable change: ", D_C_f,
           "\nInputs minus outputs : ", CinMinusCout )
    }
  }
```

```{r}
  par( mfrow=c(2,4) )
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
  output <- run_model()
  plot_CbalanceCoffee( output, title1="Coffee C-balance: ", title2="Treatment 1",
                       verify=T, ymax=6000)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_02_E_MC.R")
  output <- run_model()
  plot_CbalanceCoffee( output, title1="Coffee C-balance: ", title2="Treatment 2",
                       verify=T, ymax=6000)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_03_E_MO.R")
  output <- run_model()
  plot_CbalanceCoffee( output, title1="Coffee C-balance: ", title2="Treatment 3",
                       verify=T, ymax=6000)
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Turrialba_04_E_BO.R")
  output <- run_model()
  plot_CbalanceCoffee( output, title1="Coffee C-balance: ", title2="Treatment 4",
                       verify=T, ymax=6000)
```

## C-balance system (soil + coffee + trees)

```{r}
  plot_CbalanceSystem <- function( sim=output, title1="", title2=title1,
                                   ymax=NULL, verify=F ) {
    CinNames  <- c("gC_f"   , "gCT_f")
    CoutNames <- c("Rsoil_f", "Crunoff_f", "harvCP_f", "harvCPT_f", "harvCST_f")
    nCin      <- length(CinNames) ; nCout  <- length(CoutNames)
    i.Cin     <- rep(NA,nCin)     ; i.Cout <- rep(NA,nCout)
    for(i in 1:nCin ) {i.Cin [i] <- which( outputNames==CinNames [i] ) }
    for(i in 1:nCout) {i.Cout[i] <- which( outputNames==CoutNames[i] ) }
    CinMean   <- colMeans(sim[,i.Cin])  * 1.e4 * 365 # kgC ha-1 y-1
    CoutMean  <- colMeans(sim[,i.Cout]) * 1.e4 * 365 # kgC ha-1 y-1
    if(is.null(ymax)) {
      y.max <- max( sum(CinMean), sum(CoutMean) )
    } else {
      y.max = ymax
    }
    leg <- CinNames
    barplot( as.matrix(CinMean),
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Inputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title1,adj=1)
    par(mar=c(3,0,3,3))
    leg <- CoutNames
    barplot( as.matrix(CoutMean),
             yaxt="n",
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Outputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title2,adj=0)
    if(verify) {
      C_f      <- sim[ , which( outputNames=="C_f" )    ] # kgC m-2
      CT_f     <- sim[ , which( outputNames=="CT_f")    ] # kgC m-2
      Csoil_f  <- sim[ , which( outputNames=="Csoil_f") ] # kgC m-2 
      Csys_f   <- C_f + CT_f + Csoil_f                       # kgC m-2
      D_Csys_f <- Csys_f[NDAYS] - Csys_f[1]                  # kgC m-2
      CinSum       <- colSums(sim[2:NDAYS,i.Cin ])        # kgC m-2
      CoutSum      <- colSums(sim[2:NDAYS,i.Cout])        # kgC m-2
      CinMinusCout <- sum(CinSum) - sum(CoutSum)
      cat( "VERIFYING THE C-BALANCE FOR THE SYSTEM (kgC m-2):",
           "\nState variable change: ", D_Csys_f,
           "\nInputs minus outputs : ", CinMinusCout )
    }
  }
```

```{r}
  par( mfrow=c(2,4) )
  par( mar=c(3,3,3,0) )
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
  output <- run_model()
  plot_CbalanceSystem(output, title1="System C-balance: ", title2="Treatment 1",
                      verify=T, ymax=11000)
  par( mar=c(3,3,3,0) )
  source("initialisation/initialise_CAF2021_Turrialba_02_E_MC.R")
  output <- run_model()
  plot_CbalanceSystem(output, title1="System C-balance: ", title2="Treatment 2",
                      verify=T, ymax=11000)
  par( mar=c(3,3,3,0) )
  source("initialisation/initialise_CAF2021_Turrialba_03_E_MO.R")
  output <- run_model()
  plot_CbalanceSystem(output, title1="System C-balance: ", title2="Treatment 3",
                      verify=T, ymax=11000)
  par( mar=c(3,3,3,0) )
  source("initialisation/initialise_CAF2021_Turrialba_04_E_BO.R")
  output <- run_model()
  plot_CbalanceSystem(output, title1="System C-balance: ", title2="Treatment 4",
                      verify=T, ymax=11000)
```

## One figure with N, C- and H2O-balances

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
  output <- run_model()
  par( mar=c(3,3,3,0), mfrow=c(2,4) )
  plot_NbalanceSoil  (output, title1="Soil N-balance"  , title2="")
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil  (output, title1="Soil C-balance"  , title2="")
  par( mar=c(3,3,3,0) )
  plot_H2ObalanceSoil(output, title1="Soil H2O-balance", title2="")
  par( mar=c(3,3,3,0) )
  plot_CbalanceSystem(output, title1="System C-balance", title2="")
```

## C-distribution within coffee and within each tree species

The carbon in coffee plants is distributed between roots (CR), woody plant parts (CW), leaves (CL) and beans (CP). Their progression over time is shown in Fig. \ref{fig:OutputsCarbonCoffee}.

```{r}
  plot_CdistributionCoffee <- function( sim=output ) {
    Time <- sim[,1]
    i.CP <- which( outputNames=="CP_f" ) ; CP <- sim[,i.CP]
    i.CL <- which( outputNames=="CL_f" ) ; CL <- sim[,i.CL]
    i.CW <- which( outputNames=="CW_f" ) ; CW <- sim[,i.CW]
    i.CR <- which( outputNames=="CR_f" ) ; CR <- sim[,i.CR]
    plot( Time, CR+CW+CL+CP,
          main="Carbon in coffee (kg C m-2)",
          xlab="", ylab="", type="l", ylim=c(0,max(CR+CW+CL+CP)) )
    points( Time, CR+CW+CL, type="l", col="yellow" )
    points( Time, CR+CW   , type="l", col="green" )
    points( Time, CR      , type="l", col="red" )
    legend( "topleft", col=c("black","yellow","green","red"), cex=0.7, lty=1,
            legend=c("+ CP: Beans",
                     "+ CL: Leaves",
                     "+ CW: Wood",
                     "   CR: Roots" ) )
  }

  plot_CdistributionTrees <- function( sim=output, it=1:3 ) {
    Time <- sim[,1]
    i.CPT <- sapply( 1:3, function(i){which( outputNames==paste0("CPT_t(",i,")"))} )
    i.CLT <- sapply( 1:3, function(i){which( outputNames==paste0("CLT_t(",i,")"))} )
    i.CBT <- sapply( 1:3, function(i){which( outputNames==paste0("CBT_t(",i,")"))} )
    i.CST <- sapply( 1:3, function(i){which( outputNames==paste0("CST_t(",i,")"))} )
    i.CRT <- sapply( 1:3, function(i){which( outputNames==paste0("CRT_t(",i,")"))} )
    for(t in it) {
      CPT   <- sim[,i.CPT[t]] ; CLT <- sim[,i.CLT[t]] ; CBT <- sim[,i.CBT[t]]
      CST   <- sim[,i.CST[t]] ; CRT <- sim[,i.CRT[t]]
      y.max <- max(CRT+CST+CBT+CLT+CPT)
      plot( Time, CRT+CST+CBT+CLT+CPT, ylim=c(0,y.max),
            main=paste0("Carbon in tree sp. ",it," (kg C m-2)"),
            xlab="", ylab="", type="l" )
      points( Time, CRT+CST+CBT+CLT, type="l", col="yellow" )
      points( Time, CRT+CST+CBT    , type="l", col="green"  )
      points( Time, CRT+CST        , type="l", col="red"    )
      points( Time, CRT            , type="l", col="blue"   )
      legend( "topleft", col=c("black","yellow","green","red","blue"), cex=0.7, lty=1,
              legend=c("+ CPT: Fruits",
                       "+ CLT: Leaves",
                       "+ CBT: Branches",
                       "+ CST: Stems",
                       "   CRT: Roots" ) )
    }
  }
```

```{r OutputsCarbonCoffee, echo=F, fig.height=5, fig.cap="\\label{fig:OutputsCarbonCoffee}Cumulative time series for the carbon in coffee"}
  # source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
  # source("initialisation/initialise_CAF2021_Turrialba_04_E_BO.R")
  source("initialisation/initialise_CAF2021_Turrialba_15_CE_AC.R")
  output <- run_model()

  par( mfrow=c(2,2) )
  plot_CdistributionCoffee()
  plot_CdistributionTrees()
```

# Modelling fruit trees

Banana (not really trees but we keep model structure) and avocado. Separate management calendars. 

## Banana modelling

- Simba: complex model for banana:
  - @Blazy_2010_BANAD 
  - @Damour_2012_Simulation: Tbase = 14 degC, SLA = 0.018 m2 g-1 (corresponds well to our 40 m2 kg-1 leaf C), KEXTT = 0.7 (more realistic than Chaves' value!), LAI up to 3.5. Leaf N-content 3-4% of DM (so NC ratio 0.07-0.09. In CAF2021 it can vary 0.05-0.12 with FNCLMINT=0.4 and NCLTMAX=12).
  - @Ripoche_2012_Modeling.
  - @Tixier_2008_SIMBA.

- Modelling plantain in Colombia: @ChavesC._2009_Modeling. Very low light extinction coefficient of 0.2817. LUE 1.63 g MJ-1. Plantain typically less then 10 t ha-1 y-1 when grown in coffee. Tbase = 12.5 degC, Topt = 25 degC, Tmax = 40 degC. Implausibly high LAI of 12.9 (with observations even going up to 15), presumably because of an uncommon definition of LAI, as the given unit of 'm' makes no sense. Aboveground allocation during the vegetative stage about equally to leaves, pseudostem and corm (all about 1/3). During the reproductive stage leaves did nor grow anymore, the colm lost mass, pseudostem kept growing somewhat, but majority of allocation went to the fruits. At the end of their experiment, bunch dry matter was 45% of the aboveground total.

- @VanDenBergh_2012_Climate. Empirical temperature- and rainfall-dependent banana model based on EcoCrop. Critical monthly tempreatures: Tkill = 0 degC, Tmin = 12 degC, Tmax = 33 degC, Topt = 17.5 to 26.3 degC.

- @Landry_2017_foliar simulate growth of banana and expansion of Black leaf streak disease caused by *Mycosphaerella fijiensis*. The banana submodel focuses on leaf number and position.

## Banana literature

- @Bellamy_2013_Banana: 400 banana-plants per hectare in coffee plantation in Costa Rica.

- @Cerda_2020_Coffee "identified six coffee agroforestry systems (CAFs) as the most promising ones for reducing losses [by pests and diseases] while simultaneously providing other ecosystem services [e.g. C-sequestration]" in which the density of Musaceae ranged from 0-1400 ha-1 (mean 216 ha-1). Total shade from all tree spp. (service, fruit, timber) did not surpass 35%.

- @Dold_2007_Musa Musa in Shaded Coffee in Costa Rica. Interviews with farmers in Turrialba region: most common AFS: Coffee + Poro (E.p.) + Banana/plantain (most common at 30% banana 'Gros Michel') + Laurel (Cordia alliodora). Typical tree densities: Poro 162 ha-1, Banana/plantain 179 ha-1, Laurel 37 ha-1. Cites literature where poro is 130-208 ha-1, banana 149-343 ha-1. Banana from 120 ha-1 too much coffee yield reducing.

- @Dold_2010_Improving. "In [Central] Costa Rica mean plant density is 4244 coffee ha-1, 341 trees ha-1, and 579 bananas ha-1. In [Northern] Nicaragua mean plant density is 4852 coffee plants ha-1, 185 trees ha-1, and 358 bananas ha-1. Thirteen different banana cultivars were identified, of which 91% are from subgroup AAA Gros Michel and AAA Cavendish in Costa Rica, and 97% are from AAA Gros Michel and AAA Red Subgroup in Nicaragua.

- @GalvisR._2013_Effect. SLA from initially high values of 150 decreasing to 100 m2 g-1 (unit must be wrong).

- @Jullien_2001_Withinbunch: Pulp DMP reaches asymptotically about 30%. 

- @MartinezAcosta_2011_Dinamica. Final DM per tree, bunch:leaves:pseudostem+corm: 3000:1200:1800 g DM. With 0.45 gC g-1 DM this becomes 1350:540:810 g C per tree.

- @Mustaffa_2012_Banana: leaf N content about 3% of DM.

- @Rice_2011_Fruits: Guatemalan coffee farmers most often mentioned banana as their primary fruit tree in coffee fields (36% of respondents), followed by avocado (26%).

- @Schaffer_1999_Atmospheric give DM-partitioning of 6-month old vegetative banana (cv. 'Gros Michel'): leaves:pseudostem+rhizome:roots =  19:64:19%.

- @Staver_2013_Intercropping inventoried the presence of banana in coffee agroforestry systems in Central America and Peru. 'Gros Michel' was the most-used banana cv. Banana planting density ranged from 300 to 600 ha-1, and trees (mainly poro and Inga) 150-550 ha-1.

- @TorresB._2014_Accumulation found that DM-partitioning of cv. 'Williams' in Colombia was not affected strongly by the level of N-fertilization (0 to 483 kg N ha-1), but fruit yields increased from 9 to 12 kg DM. At harvest after 161 kg N ha-1 fertilization: corm+pseudostem/leaves/fruits = 6/1.5/3.5 kg DM per plant. Total plant N-concentration was 1-1.5% of DM.

- @Turner_2007_Environmental: LAI ranges from 2 to 5 m2 m-2.

## Banana simulation in CAF2021

To make CAF2021 simulate banana in a coffee plantation, we start by initialising for a full-sun system, then set the density of fruit trees (TREEDENS(2)) to a positive value, and choose parameter settings that are appropriate for banana.

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_19_PS_AC.R")
  params <- set_par( "TREEDENS0(2)"                            , 0.04       )
  params <- set_par( c("CBtree0","CLtree0","CRtree0","CStree0"), rep(1,4)   )
  params <- set_par( c("FWT(2)","FST(2)","FPT(2)")             , rep(0.5,3) )
  params <- set_par( "TBEFOREPT(2)"                            , 100        )
  params <- set_par( c("TCBT(2)","TCRT(2)","TCST(2)")          , rep(365,3) )
  params <- set_par( c("KH(2)","KAC(2)")                       , c(4,6)     )
  output <- run_model()

  par( mfrow=c(3,3), mar=c(3,3,3,3) )
  
  plot_CdistributionCoffee() ; plot_CdistributionTrees(it=2)
  
  Time <- output[,1]
    i.ht2    <- which( outputNames=="h_t(2)" )       ; h_t2      <- output[,i.ht2]
    i.Ac1    <- which( outputNames=="Ac(1)" )        ; Ac1       <- output[,i.Ac1]
    i.CAt2   <- which( outputNames=="CAtree_t(2)" )  ; CAtree2   <- output[,i.CAt2]
    i.Ycf    <- which( outputNames=="harvDM_f_hay" ) ; YcoffeeDM <- output[,i.Ycf]
    i.CPT    <- which( outputNames=="harvCPT_f" )    ; harvCPT_f <- output[,i.CPT]
    YtreesDM <- harvCPT_f * 1e4 * 365 / 0.45
  plot( Time, h_t2     , type="l", ylab="", main="Banana height (m)" )
  plot( Time, CAtree2  , type="l", ylab="", main="Crown area (m2 tree-1)" )
  plot( Time, 1-Ac1    , type="l", ylab="", main="Banana shade (-)" )
  plot( Time, YcoffeeDM, type="l", ylab="", main="Coffee yield (kg DM ha-1)" )
  plot( Time, YtreesDM , type="l", ylab="", main="Banana yield (kg DM ha-1)" )
```

## Avocado modelling

## Avocado literature

## Avocado simulation in CAF2021

To make CAF2021 simulate avocado in a coffee plantation, we proceed as for banana. So we start by initialising for a full-sun system, then set the density of fruit trees (TREEDENS(2)) to a positive value, and choose parameter settings that are appropriate for avocado.

Compared with banana:

- Lower planting density of 200 ha-1. CAF2021-parameter TREEDENS0(2) = 0.02.
- Considerable delay (4-7 years) to first fruit production. CAF2021-parameter TBEFOREPT = 1825.
- Similarly small trees. CAF2021-parameters KH(2) = 4, KAC(2) = 6.
- True tree with woody plant parts and roots that senesce much more slowly than the pseudostem and roots of banana. Some stem senescence is still simulated to mimic the common practice of pruning avocado to keep its height within convenient levels for harvesting. CAF2021-parameters TCRT(2) = TCST(2) = TCBT(2) = 1000.
- Similar allocation pattern (but with true stems and branches instead of rhizomes and pseudostems). CAF2021-parameters FWT(2) = 0.5, FST(2) = 0.5, FPT(2) = 0.5.
- More seasonal than banana (but much less than coffee). Often two to three vegetative flushes and long harvest periods. But the harvesting occurs throughout the year which we simulate as for banana as a constant low-intensity harvesting. This allows us to keep CAF2021 simple without the need for simulateing flowering and fruit set phenology for any trees.

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_19_PS_AC.R")
  params <- set_par( "TREEDENS0(2)"                            , 0.02       )
  params <- set_par( c("FWT(2)","FST(2)","FPT(2)")             , rep(0.5,3) )
  params <- set_par( "TBEFOREPT(2)"                            , 1825       )
  params <- set_par( c("TCBT(2)","TCRT(2)","TCST(2)")          , c(1000,1000,1000) )
  params <- set_par( c("KH(2)","KAC(2)")                       , c(4,6)     )
  output <- run_model()

  par( mfrow=c(3,3), mar=c(3,3,3,3) )
  
  plot_CdistributionCoffee() ; plot_CdistributionTrees(it=2)
  
  Time <- output[,1]
    i.ht2    <- which( outputNames=="h_t(2)" )       ; h_t2      <- output[,i.ht2]
    i.Ac1    <- which( outputNames=="Ac(1)" )        ; Ac1       <- output[,i.Ac1]
    i.CAt2   <- which( outputNames=="CAtree_t(2)" )  ; CAtree2   <- output[,i.CAt2]
    i.Ycf    <- which( outputNames=="harvDM_f_hay" ) ; YcoffeeDM <- output[,i.Ycf]
    i.CPT    <- which( outputNames=="harvCPT_f" )    ; harvCPT_f <- output[,i.CPT]
    YtreesDM <- harvCPT_f * 1e4 * 365 / 0.45
  plot( Time, h_t2     , type="l", ylab="", main="Avocado height (m)" )
  plot( Time, CAtree2  , type="l", ylab="", main="Crown area (m2 tree-1)" )
  plot( Time, 1-Ac1    , type="l", ylab="", main="Avocado shade (-)" )
  plot( Time, YcoffeeDM, type="l", ylab="", main="Coffee yield (kg DM ha-1)" )
  plot( Time, YtreesDM , type="l", ylab="", main="Avocado yield (kg DM ha-1)" )
```

# Checking bienniality and tree production of fruit (CPT, NPT)

```{r}
  plot_output(vars=c( "fTran(1)", "fNgrowth(1)",
                      "DVS(1)"  , "SINKP(1)" , "SINKPMAXnew(1)",
                      "DayFl(1)", "PARMA(1)") )
  plot_output(vars=c( "fTran(2)", "fNgrowth(2)",
                      "DVS(2)"  , "SINKP(2)" , "SINKPMAXnew(2)",
                      "DayFl(2)", "PARMA(2)") )

  # plot_output( vars=c("Ac(1)","Ac(2)","Ac(3)","Ac(4)","Ac(5)","Ac(6)") )
```

```{r}
  plot_output(vars=c( "CPT_t(1)", "CPT_t(2)", "CPT_t(3)" ))
  plot_output(vars=c( "harvCPT_t(1)", "harvCPT_t(2)", "harvCPT_t(3)",
                      "harvNPT_t(1)", "harvNPT_t(2)", "harvNPT_t(3)" ))
```

# Output of a MAP generated by BC

Run this code immediately after carrying a BC

```{r, eval=F}
  # After running a BC
  load('BC_Turrialba_2021.RData')
  
  s <- 1 # Choose a site from those for which the BC was carried out
  
  params_BC_MAP   <- scparMAP_BC  * sc
  params          <- list_params        [[s]] ; matrix_weather <- list_matrix_weather[[s]]
  calendar_fert   <- list_calendar_fert [[s]] ; calendar_prunC <- list_calendar_prunC[[s]] 
  calendar_prunT  <- list_calendar_prunT[[s]] ; calendar_thinT <- list_calendar_thinT[[s]]  
  NDAYS           <- list_NDAYS         [[s]]       
  ip_BC_s         <- ip_BC_site         [[s]]
  icol_pChain_s   <- icol_pChain_site   [[s]]
# Calculate model output for the MAP parameter vector
  params[ip_BC_s] <- params_BC_MAP      [icol_pChain_s]
  params.MAP         <- params
  matrix_weather.MAP <- matrix_weather
  calendar_fert.MAP  <- calendar_fert
  calendar_prunC.MAP <- calendar_prunC
  calendar_prunT.MAP <- calendar_prunT
  calendar_thinT.MAP <- calendar_thinT
  NDAYS.MAP          <- NDAYS
  
  source('initialisation/initialise_CAF2021_Turrialba_20_PS_MC.R')
  output <- run_model( params, matrix_weather, calendar_fert, calendar_prunC,
                     calendar_prunT, calendar_thinT, NDAYS )

  output.MAP <- run_model( params.MAP, matrix_weather.MAP,
                           calendar_fert.MAP, calendar_prunC.MAP,
                           calendar_prunT.MAP, calendar_thinT.MAP, NDAYS.MAP )
  plot_output( list_output=list(output.MAP),
               vars       =c( "fTran(1)"    , "fNgrowth(1)", "DVS(1)"  ,
                              "SINKP(1)"    , "DayFl(1)"   , "PARMA(1)" ,
                              "harvDM_f_hay", "CT_f" ) )
  plot_output( list_output=list(output.MAP),
               vars       =c( "fTran(2)"    , "fNgrowth(2)", "DVS(2)"  ,
                              "SINKP(2)"    , "DayFl(2)"   , "PARMA(1)" ,
                              "harvDM_f_hay", "CT_f" ) )
```

```{r, eval=F}  
  source('BC/BC_averageYields.R')
```




\clearpage



# APPENDIX: Basic code for testing

## Initialisation and running

```{r, eval=F}
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
  output <- run_model()
```

## Tables and Figures

```{r, eval=F}
  # Table of selected parameters, with values:

  NPAR <- length(params) ; names_params <- row.names(df_params)
  knitr::kable( cbind( c(1:(NPAR-2),"...",NPAR-1,NPAR),
                       rbind( head(cbind(names_params,params),n=(NPAR-2)),
                              c("...","..."),
                              tail(cbind(names_params,params),n= 2,keepnums=F) ) ),
                col.names=c("","Parameter","Value") )
```

```{r, eval=F}
  # Table of all output variables, with units and final values:

  finalvalues <- tail( output, 1 )
  knitr::kable( cbind( 1:NOUT, outputNames, outputUnits, t(finalvalues) ),
                col.names=c("","Variable","unit","Final value") )
```

```{r, eval=F}
  # Table of selected output variables with values near beginning and end of run:

  output_short <- signif( output, 5 )
  icols        <- c(1:9,NOUT+(-1:0))
  knitr::kable( rbind( head(output_short[,icols]),
                       rep("...",length(icols)),
                       tail(output_short[,icols],n= 2,keepnums=F) ),
                col.names=outputNames[icols] )
```

```{r OutputsDefault, eval=F, fig.height=3, fig.cap="\\label{fig:OutputsDefault}Outputs from CAF2021 using default settings for Turrialba."}
  # Figure of selected output variables:

  plot_output( vars=c("Ac(1)","Ac(2)","Ac(3)","Ac(4)","Ac(5)","Ac(6)") )
```

## Cumulative ground cover by LCC and by tree species

```{r, eval=F}
  # GROUND COVER by LCC

  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.Ac <- sapply( 1:6, function(i) {
    which( outputNames==paste0("Ac(",i,")") ) } )
  plot  ( Time, output[,i.Ac[1]], type="l", ylim=c(0,1),
          main="Cumulative ground cover of six LCC (-)",
          xlab="", ylab="" )
  points( Time, rowSums( output[,i.Ac[1:2]] ), type="l", col="yellow" )
  points( Time, rowSums( output[,i.Ac[1:3]] ), type="l", col="green" )
  points( Time, rowSums( output[,i.Ac[1:4]] ), type="l", col="red" )
  points( Time, rowSums( output[,i.Ac[1:5]] ), type="l", col="blue" )
  points( Time, rowSums( output[,i.Ac[1:6]] ), type="l", col="black" )
```

```{r, eval=F}
  # GROUND COVER by TREE SPECIES

  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.At <- sapply( 1:3, function(i) {
    which( outputNames==paste0("At(",i,")") ) } )
  plot  ( Time, output[,i.At[1]], type="l", ylim=c(0,1),
          main="Ground cover by 3 tree spp.",
          xlab="", ylab="" )
  points( Time, output[,i.At[2]], type="l", col="red" )
  points( Time, output[,i.At[3]], type="l", col="blue" )
  legend( "right", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )
```

## Other variables

```{r, eval=F}
  # TREE DENSITY

  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.trd <- sapply( 1:3, function(i) {
    which( outputNames==paste0("treedens_t(",i,")") ) } )
  yrange <- range(0,output[,i.trd[1:3]])
  plot  ( Time, output[,i.trd[1]], type="l",
          main="Tree density (ha-1)", xlab="", ylab="", ylim=yrange )
  points( Time, output[,i.trd[2]], type="l", col="red" )
  points( Time, output[,i.trd[3]], type="l", col="blue" )
  legend( "topright", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )
```

```{r, eval=F}
  # TREE HEIGHT

  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.h <- sapply( 1:3, function(i) {
    which( outputNames==paste0("h_t(",i,")") ) } )
  yrange <- range(output[,i.h[1:3]])
  plot  ( Time, output[,i.h[1]], type="l",
          main="Tree height (m)", xlab="", ylab="", ylim=yrange )
  points( Time, output[,i.h[2]], type="l", col="red"  )
  points( Time, output[,i.h[3]], type="l", col="blue" )
  legend( "topleft", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )
```

```{r, eval=F}
  # YIELD

  par( mfrow=c(1,1) )
  Time <- output[,1] ; TimeFrom0 <- Time - Time[1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )
  CCONC <- 0.47
  Y1_kgDMm2 <- output[,i.harvCP[1]] / CCONC ; it1 <- which(Y1_kgDMm2>0)
  Time1     <- Time[it1] ; Y1_kgDMm2 <- Y1_kgDMm2[it1]
  Y2_kgDMm2 <- output[,i.harvCP[2]] / CCONC ; it2 <- which(Y2_kgDMm2>0)
  Time2     <- Time[it2] ; Y2_kgDMm2 <- Y2_kgDMm2[it2]
  Y3_kgDMm2 <- output[,i.harvCP[3]] / CCONC ; it3 <- which(Y3_kgDMm2>0)
  Time3     <- Time[it3] ; Y3_kgDMm2 <- Y3_kgDMm2[it3]
  Y4_kgDMm2 <- output[,i.harvCP[4]] / CCONC ; it4 <- which(Y4_kgDMm2>0)
  Time4     <- Time[it4] ; Y4_kgDMm2 <- Y4_kgDMm2[it4]
  Y5_kgDMm2 <- output[,i.harvCP[5]] / CCONC ; it5 <- which(Y5_kgDMm2>0)
  Time5     <- Time[it5] ; Y5_kgDMm2 <- Y5_kgDMm2[it5]
  Y6_kgDMm2 <- output[,i.harvCP[6]] / CCONC ; it6 <- which(Y6_kgDMm2>0)
  Time6     <- Time[it6] ; Y6_kgDMm2 <- Y6_kgDMm2[it6]
  
  Y_kgDMm2 <- Y1_kgDMm2 * output[,i.Ac[1]][it1] +
              Y2_kgDMm2 * output[,i.Ac[2]][it2] +
              Y3_kgDMm2 * output[,i.Ac[3]][it3] +
              Y4_kgDMm2 * output[,i.Ac[4]][it4] +
              Y5_kgDMm2 * output[,i.Ac[5]][it5] +
              Y6_kgDMm2 * output[,i.Ac[6]][it6]
  
  plot  ( Time1, Y1_kgDMm2, type="b", pch="1", ylim=c(0,0.25),
          main="Yield (kg DM m-2)", xlab="", ylab="" )
  points( Time2, Y2_kgDMm2, type="b", pch="2", col="yellow" )
  points( Time3, Y3_kgDMm2, type="b", pch="3", col="green"  )
  points( Time4, Y4_kgDMm2, type="b", pch="4", col="red"    )
  points( Time5, Y5_kgDMm2, type="b", pch="5", col="blue"   )
  points( Time6, Y6_kgDMm2, type="b", pch="6", col="black"  )
  points( Time6, Y_kgDMm2 , type="l", lty=1  , col="black", lwd=3 )
  legend( "topright",
          col=c("black","black","yellow","green","red","blue","black"),
          lty=1, pch=c("",paste(1:6)),
          lwd=c(3,rep(1,6)),
          legend=c("Field","LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )
```

```{r, eval=F}
  # CUMULATIVE YIELD

  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )
  plot  ( Time, cumsum(output[,i.harvCP[1]]), type="p", ylim=c(0,0.6),
          main="Cumulative yield (kg C m-2)",
          xlab="", ylab="" )
  points( Time, cumsum(output[,i.harvCP[2]]), type="p", col="yellow" )
  points( Time, cumsum(output[,i.harvCP[3]]), type="p", col="green" )
  points( Time, cumsum(output[,i.harvCP[4]]), type="p", col="red" )
  points( Time, cumsum(output[,i.harvCP[5]]), type="p", col="blue" )
  points( Time, cumsum(output[,i.harvCP[6]]), type="p", col="black" )
  legend( "topleft", col=c("black","yellow","green","red","blue","black"),
          lty=1, lwd=5,
          legend=c("LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )
```

# References

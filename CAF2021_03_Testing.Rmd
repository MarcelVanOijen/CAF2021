---
title: 'CAF2021: Testing'
author:
- Marcel van Oijen; VanOijenMarcel@gmail.com
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
---

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=TRUE,results="asis",warning=FALSE,message=FALSE)
```

# Test with 2 tree spp.

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")

  # params[names_params=="TREEDENS0(1)"] <- 0.04
  # params[names_params=="TREEDENS0(2)"] <- 0.02
  # params[names_params=="KNFIX(2)"    ] <- params[names_params=="KNFIX(1)"] <- 0.1

  # We prune tree species 2 half as frequently as species 1
  # (only the even-numbered times)
  even <- seq(2,100,2)
  calendar_prunT[ 2, even , ] <- calendar_prunT[ 1, even , ]
  
  # We thin tree species 2 one week after species 1, and add one extra thinning day:
  calendar_thinT[ 2,    ,   ] <- calendar_thinT[ 1, ,   ]
  calendar_thinT[ 2,    , 2 ] <- calendar_thinT[ 1, , 2 ] + 7
  calendar_thinT[ 2, 100,   ] <- c( 2004, 131, 0.9 )

  output <- run_model()
```

## Tabular outputs

```{r}
  output_short <- signif( output, 5 )
  icols        <- 2:12
  knitr::kable( rbind( head(output_short[,icols],n=2),
                       rep("...",length(icols)),
                       tail(output_short[,icols],n=2,keepnums=F) ),
                col.names=outputNames[icols] )
```

```{r, eval=F}
  initvalues  <- signif( head( output, 1 ), 4 )
  finalvalues <- signif( tail( output, 1 ), 4 )
  knitr::kable( cbind( outputNames, outputUnits, t(initvalues), t(finalvalues) ),
                col.names=c("Variable","Unit","Initial value","Final value") )
```

## Graphical outputs

```{r, fig.height=4}
  par( mfrow=c(2,1), mar=c(2,2,2,0) )

  Time <- output[,1]
  i.Ac <- sapply( 1:6, function(i) {
    which( outputNames==paste0("Ac(",i,")") ) } )
  plot  ( Time, output[,i.Ac[1]], type="l", ylim=c(0,1),
          main="Cumulative ground cover of six LCC (-)",
          xlab="", ylab="" )
  points( Time, rowSums( output[,i.Ac[1:2]] ), type="l", col="yellow" )
  points( Time, rowSums( output[,i.Ac[1:3]] ), type="l", col="green" )
  points( Time, rowSums( output[,i.Ac[1:4]] ), type="l", col="red" )
  points( Time, rowSums( output[,i.Ac[1:5]] ), type="l", col="blue" )
  points( Time, rowSums( output[,i.Ac[1:6]] ), type="l", col="black" )

  Time <- output[,1]
  i.At <- sapply( 1:3, function(i) {
    which( outputNames==paste0("At(",i,")") ) } )
  plot  ( Time, output[,i.At[1]], type="l", ylim=c(0,1),
          main="Ground cover by 3 tree spp.",
          xlab="", ylab="" )
  points( Time, output[,i.At[2]], type="l", col="red" )
  points( Time, output[,i.At[3]], type="l", col="blue" )
  legend( "bottomright", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )
```

```{r, fig.height=4}
  par( mfrow=c(2,1), mar=c(2,2,2,0) )

  Time <- output[,1]
  i.trd <- sapply( 1:3, function(i) {
    which( outputNames==paste0("treedens_t(",i,")") ) } )
  yrange <- range(0,output[,i.trd[1:3]])
  plot  ( Time, output[,i.trd[1]], type="l",
          main="Tree density (ha-1)", xlab="", ylab="", ylim=yrange )
  points( Time, output[,i.trd[2]], type="l", col="red" )
  points( Time, output[,i.trd[3]], type="l", col="blue" )
  legend( "topright", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )

  Time <- output[,1]
  i.h <- sapply( 1:3, function(i) {
    which( outputNames==paste0("h_t(",i,")") ) } )
  yrange <- range(output[,i.h[1:3]])
  plot  ( Time, output[,i.h[1]], type="l",
          main="Tree height (m)", xlab="", ylab="", ylim=yrange )
  points( Time, output[,i.h[2]], type="l", col="red"  )
  points( Time, output[,i.h[3]], type="l", col="blue" )
  legend( "topleft", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )
```

```{r, fig.height=4}
  par( mfrow=c(2,1), mar=c(2,2,2,0) )

  Time <- output[,1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )
  plot  ( Time, cumsum(output[,i.harvCP[1]]), type="p", ylim=c(0,0.6),
          main="Cumulative yield (kg C m-2)",
          xlab="", ylab="" )
  points( Time, cumsum(output[,i.harvCP[2]]), type="p", col="yellow" )
  points( Time, cumsum(output[,i.harvCP[3]]), type="p", col="green" )
  points( Time, cumsum(output[,i.harvCP[4]]), type="p", col="red" )
  points( Time, cumsum(output[,i.harvCP[5]]), type="p", col="blue" )
  points( Time, cumsum(output[,i.harvCP[6]]), type="p", col="black" )
  legend( "topleft", col=c("black","yellow","green","red","blue","black"),
          lty=1, lwd=5,
          legend=c("LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )

  Time <- output[,1] ; TimeFrom0 <- Time - Time[1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )
  CCONC <- 0.47
  Y1_kgDMm2 <- output[,i.harvCP[1]] / CCONC ; it1 <- which(Y1_kgDMm2>0)
  Time1     <- Time[it1] ; Y1_kgDMm2 <- Y1_kgDMm2[it1]
  Y2_kgDMm2 <- output[,i.harvCP[2]] / CCONC ; it2 <- which(Y2_kgDMm2>0)
  Time2     <- Time[it2] ; Y2_kgDMm2 <- Y2_kgDMm2[it2]
  Y3_kgDMm2 <- output[,i.harvCP[3]] / CCONC ; it3 <- which(Y3_kgDMm2>0)
  Time3     <- Time[it3] ; Y3_kgDMm2 <- Y3_kgDMm2[it3]
  Y4_kgDMm2 <- output[,i.harvCP[4]] / CCONC ; it4 <- which(Y4_kgDMm2>0)
  Time4     <- Time[it4] ; Y4_kgDMm2 <- Y4_kgDMm2[it4]
  Y5_kgDMm2 <- output[,i.harvCP[5]] / CCONC ; it5 <- which(Y5_kgDMm2>0)
  Time5     <- Time[it5] ; Y5_kgDMm2 <- Y5_kgDMm2[it5]
  Y6_kgDMm2 <- output[,i.harvCP[6]] / CCONC ; it6 <- which(Y6_kgDMm2>0)
  Time6     <- Time[it6] ; Y6_kgDMm2 <- Y6_kgDMm2[it6]
  
  Y_kgDMm2 <- Y1_kgDMm2 * output[,i.Ac[1]][it1] +
              Y2_kgDMm2 * output[,i.Ac[2]][it2] +
              Y3_kgDMm2 * output[,i.Ac[3]][it3] +
              Y4_kgDMm2 * output[,i.Ac[4]][it4] +
              Y5_kgDMm2 * output[,i.Ac[5]][it5] +
              Y6_kgDMm2 * output[,i.Ac[6]][it6]
  
  plot  ( Time1, Y1_kgDMm2, type="b", pch="1", ylim=c(0,0.25),
          main="Yield (kg DM m-2)", xlab="", ylab="" )
  points( Time2, Y2_kgDMm2, type="b", pch="2", col="yellow" )
  points( Time3, Y3_kgDMm2, type="b", pch="3", col="green"  )
  points( Time4, Y4_kgDMm2, type="b", pch="4", col="red"    )
  points( Time5, Y5_kgDMm2, type="b", pch="5", col="blue"   )
  points( Time6, Y6_kgDMm2, type="b", pch="6", col="black"  )
  points( Time6, Y_kgDMm2 , type="l", lty=1  , col="black", lwd=3 )
  legend( "topright",
          col=c("black","black","yellow","green","red","blue","black"),
          lty=1, pch=c("",paste(1:6)),
          lwd=c(3,rep(1,6)),
          legend=c("Field","LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )
```

## N-balance soil

```{r}
  NinNames  <- c("Nfert_f", "NfixT_f", "NsenprunT_f", "Nsenprun_f")
  NoutNames <- c("Nleaching_f", "Nemission_f", "Nrunoff_f", "Nupt_f", "NuptT_f")
  nNin      <- length(NinNames) ; nNout  <- length(NoutNames)
  i.Nin     <- rep(NA,nNin)     ; i.Nout <- rep(NA,nNout)
  for(i in 1:nNin ) {i.Nin [i] <- which( outputNames==NinNames [i] ) }
  for(i in 1:nNout) {i.Nout[i] <- which( outputNames==NoutNames[i] ) }
  
  NinMean   <- colMeans(output[,i.Nin])  * 1.e4 * 365 # kgN ha-1 y-1
  NoutMean  <- colMeans(output[,i.Nout]) * 1.e4 * 365 # kgN ha-1 y-1
  
  par( mfrow=c(1,2), mar=c(5,3,3,5) )
  y.max <- max( sum(NinMean), sum(NoutMean) )

  leg <- NinNames
  barplot( as.matrix(NinMean),
         main="N-inputs soil\n(kg N ha-1 y-1)",
         beside=F, ylim=c(0,y.max), col=1:length(leg),
         legend.text=leg,
         args.legend=list( x="right", bg="white", inset=c(-0.3,0) ) )

  leg <- NoutNames
  barplot( as.matrix(NoutMean),
         main="N-outputs soil\n(kg N ha-1 y-1)",
         beside=F, ylim=c(0,y.max), col=1:length(leg),
         legend.text=leg,
         args.legend=list( x="right", bg="white", inset=c(-0.3,0) ) )
```

Verify the soil N-balance:

```{r}
  Nsoil_f      <- output[ , which( outputNames=="Nsoil_f") ] # kgN m-2
  D_Nsoil_f    <- Nsoil_f[NDAYS] - Nsoil_f[1]                # kgN m-2
  
  NinSum       <- colSums(output[2:NDAYS,i.Nin ])            # kgN m-2
  NoutSum      <- colSums(output[2:NDAYS,i.Nout])            # kgN m-2
  NinMinusNout <- sum(NinSum) - sum(NoutSum)
  
  cat( "VERIFYING THE N-BALANCE FOR THE SOIL (kgN m-2):",
       "\nState variable change: ", D_Nsoil_f,
       "\nInputs minus outputs : ", NinMinusNout )
```

## C-balance soil

```{r}
  CinNames  <- c("CsenprunT_f", "Csenprun_f")
  CoutNames <- c("Rsoil_f", "Crunoff_f")
  nCin      <- length(CinNames) ; nCout  <- length(CoutNames)
  i.Cin     <- rep(NA,nCin)     ; i.Cout <- rep(NA,nCout)
  for(i in 1:nCin ) {i.Cin [i] <- which( outputNames==CinNames [i] ) }
  for(i in 1:nCout) {i.Cout[i] <- which( outputNames==CoutNames[i] ) }
  
  CinMean   <- colMeans(output[,i.Cin])  * 1.e4 * 365 # kgC ha-1 y-1
  CoutMean  <- colMeans(output[,i.Cout]) * 1.e4 * 365 # kgC ha-1 y-1
  
  par( mfrow=c(1,2), mar=c(5,3,3,5) )
  y.max <- max( sum(CinMean), sum(CoutMean) )

  leg <- CinNames
  barplot( as.matrix(CinMean),
         main="C-inputs soil\n(kg C ha-1 y-1)",
         beside=F, ylim=c(0,y.max), col=1:length(leg),
         legend.text=leg,
         args.legend=list( x="right", bg="white", inset=c(-0.3,0) ) )

  leg <- CoutNames
  barplot( as.matrix(CoutMean),
         main="C-outputs soil\n(kg C ha-1 y-1)",
         beside=F, ylim=c(0,y.max), col=1:length(leg),
         legend.text=leg,
         args.legend=list( x="right", bg="white", inset=c(-0.3,0) ) )
```

Verify the soil C-balance:

```{r}
  Csoil_f   <- output[ , which( outputNames=="Csoil_f") ] # kgC m-2 
  D_Csoil_f <- Csoil_f[NDAYS] - Csoil_f[1]                # kgC m-2
  
  CinSum        <- colSums(output[2:NDAYS,i.Cin ])        # kgC m-2
  CoutSum       <- colSums(output[2:NDAYS,i.Cout])        # kgC m-2
  CinMinusCout  <- sum(CinSum) - sum(CoutSum)
  
  cat( "VERIFYING THE C-BALANCE FOR THE SOIL (kgC m-2):",
       "\nState variable change: ", D_Csoil_f,
       "\nInputs minus outputs : ", CinMinusCout )
```

## H2O-balance soil ("W-balance")

```{r}
  WinNames  <- c("Rain_f")
  WoutNames <- c("Drain_f", "Runoff_f" , "Evap_f"    ,"Tran_f" , 
                 "TranT_f", "Rainint_f", "RainintT_f")
  nWin      <- length(WinNames) ; nWout  <- length(WoutNames)
  i.Win     <- rep(NA,nWin)     ; i.Wout <- rep(NA,nWout)
  for(i in 1:nWin ) {i.Win [i] <- which( outputNames==WinNames [i] ) }
  for(i in 1:nWout) {i.Wout[i] <- which( outputNames==WoutNames[i] ) }
  
  WinMean   <-    mean (output[,i.Win])  # mm d-1
  WoutMean  <- colMeans(output[,i.Wout]) # mm d-1
  
  par( mfrow=c(1,2), mar=c(5,3,3,5) )
  y.max <- max( sum(WinMean), sum(WoutMean) )

  leg <- WinNames
  barplot( as.matrix(WinMean),
         main="H2O-inputs\n(mm d-1)",
         beside=F, ylim=c(0,y.max), col=1:length(leg),
         legend.text=leg,
         args.legend=list( x="right", bg="white", inset=c(-0.3,0) ) )

  leg <- WoutNames
  barplot( as.matrix(WoutMean),
         main="H2O-outputs\n(mm d-1)",
         beside=F, ylim=c(0,y.max), col=1:length(leg),
         legend.text=leg,
         args.legend=list( x="right", bg="white", inset=c(-0.3,0) ) )
```

Verify the H2O-balance.

```{r}
  WA_f   <- output[ , which( outputNames=="WA_f") ] # mm
  D_WA_f <- WA_f[NDAYS] - WA_f[1]                   # mm
  
  WinSum        <-    sum (output[2:NDAYS,i.Win ])  # mm
  WoutSum       <- colSums(output[2:NDAYS,i.Wout])  # mm
  WinMinusWout  <- sum(WinSum) - sum(WoutSum)
  
  cat( "VERIFYING THE H2O-BALANCE FOR THE SOIL (mm):",
       "\nState variable change: ", D_WA_f,
       "\nInputs minus outputs : ", WinMinusWout )
```

## C-balance coffee

```{r}
  CinNames  <- "gC_f"
  CoutNames <- c("dC_f", "prunC_f", "harvCP_f")
  nCin      <- length(CinNames) ; nCout  <- length(CoutNames)
  i.Cin     <- rep(NA,nCin)     ; i.Cout <- rep(NA,nCout)
  for(i in 1:nCin ) {i.Cin [i] <- which( outputNames==CinNames [i] ) }
  for(i in 1:nCout) {i.Cout[i] <- which( outputNames==CoutNames[i] ) }
  
  CinMean   <-    mean (output[,i.Cin])  * 1.e4 * 365 # kgC ha-1 y-1
  CoutMean  <- colMeans(output[,i.Cout]) * 1.e4 * 365 # kgC ha-1 y-1
  
  par( mfrow=c(1,2), mar=c(5,3,3,5) )
  y.max <- max( CinMean, sum(CoutMean) )

  leg <- CinNames
  barplot( CinMean,
         main="C-inputs coffee\n(kg C ha-1 y-1)",
         beside=F, ylim=c(0,y.max), col=1:length(leg),
         legend.text=leg,
         args.legend=list( x="right", bg="white", inset=c(-0.3,0) ) )

  leg <- CoutNames
  barplot( as.matrix(CoutMean),
         main="C-outputs coffee\n(kg C ha-1 y-1)",
         beside=F, ylim=c(0,y.max), col=1:length(leg),
         legend.text=leg,
         args.legend=list( x="right", bg="white", inset=c(-0.3,0) ) )
```

Verify the C-balance of coffee:

```{r}
  C_f          <- output[ , which( outputNames=="C_f" ) ] # kgC m-2
  D_C_f        <- C_f[NDAYS] - C_f[1]                     # kgC m-2

  CinSum       <-    sum (output[2:NDAYS,i.Cin ])         # kgC m-2
  CoutSum      <- colSums(output[2:NDAYS,i.Cout])         # kgC m-2
  CinMinusCout <- sum(CinSum) - sum(CoutSum)
  
  cat( "VERIFYING THE C-BALANCE OF COFFEE (kgC m-2):",
       "\nState variable change: ", D_C_f,
       "\nInputs minus outputs : ", CinMinusCout )
```

## C-balance system (soil + coffee + trees)

```{r}
  CinNames  <- c("gC_f"   , "gCT_f")
  CoutNames <- c("Rsoil_f", "Crunoff_f", "harvCP_f", "harvCPT_f", "harvCST_f")
  nCin      <- length(CinNames) ; nCout  <- length(CoutNames)
  i.Cin     <- rep(NA,nCin)     ; i.Cout <- rep(NA,nCout)
  for(i in 1:nCin ) {i.Cin [i] <- which( outputNames==CinNames [i] ) }
  for(i in 1:nCout) {i.Cout[i] <- which( outputNames==CoutNames[i] ) }
  
  CinMean   <- colMeans(output[,i.Cin])  * 1.e4 * 365 # kgC ha-1 y-1
  CoutMean  <- colMeans(output[,i.Cout]) * 1.e4 * 365 # kgC ha-1 y-1
  
  par( mfrow=c(1,2), mar=c(5,3,3,5) )
  y.max <- max( sum(CinMean), sum(CoutMean) )

  leg <- CinNames
  barplot( as.matrix(CinMean),
         main="C-inputs system\n(kg C ha-1 y-1)",
         beside=F, ylim=c(0,y.max), col=1:length(leg),
         legend.text=leg,
         args.legend=list( x="right", bg="white", inset=c(-0.3,0) ) )

  leg <- CoutNames
  barplot( as.matrix(CoutMean),
         main="C-outputs system\n(kg C ha-1 y-1)",
         beside=F, ylim=c(0,y.max), col=1:length(leg),
         legend.text=leg,
         args.legend=list( x="right", bg="white", inset=c(-0.3,0) ) )
```

Verify the C-balance of the system (coffee + trees + soil):

```{r}
  C_f      <- output[ , which( outputNames=="C_f" ) ] # kgC m-2
  CT_f     <- output[ , which( outputNames=="CT_f") ] # kgC m-2
  Csys_f   <- C_f + CT_f + Csoil_f                    # kgC m-2
  D_Csys_f <- Csys_f[NDAYS] - Csys_f[1]               # kgC m-2

  CinSum       <- colSums(output[2:NDAYS,i.Cin ])     # kgC m-2
  CoutSum      <- colSums(output[2:NDAYS,i.Cout])     # kgC m-2
  CinMinusCout <- sum(CinSum) - sum(CoutSum)
  
  cat( "VERIFYING THE C-BALANCE FOR THE SYSTEM (kgC m-2):",
       "\nState variable change: ", D_Csys_f,
       "\nInputs minus outputs : ", CinMinusCout )
```

```{r}
  plot_output(vars=c( "fTran(1)", "fNgrowth(1)",
                      "DVS(1)"  , "SINKP(1)" , "SINKPMAXnew(1)",
                      "DayFl(1)", "PARMA(1)") )
  plot_output(vars=c( "fTran(2)", "fNgrowth(2)",
                      "DVS(2)"  , "SINKP(2)" , "SINKPMAXnew(2)",
                      "DayFl(2)", "PARMA(2)") )

  # plot_output( vars=c("Ac(1)","Ac(2)","Ac(3)","Ac(4)","Ac(5)","Ac(6)") )
```

```{r}
  plot_output(vars=c( "CPT_t(1)", "CPT_t(2)", "CPT_t(3)" ))
  plot_output(vars=c( "harvCPT_t(1)", "harvCPT_t(2)", "harvCPT_t(3)",
                      "harvNPT_t(1)", "harvNPT_t(2)", "harvNPT_t(3)" ))
```

<<<<<<< HEAD
Adding a stress period in 2010 to see whether that retriggers bienniality.

```{r}
  vars <- c( "Time"  , "year"     , "doy",
             "DVS(1)", "harvCP(1)", "DayFl(1)", "fTran(1)", "fNgrowth(1)",
             "SINKPMAXnew(1)" , "SINKP(1)",
             "gSINKPMAXnew(1)", "dSINKPMAXnew(1)" )
  nout <- length(vars)
  iout <- rep(NA,nout)
  for(i in 1:nout) iout[i] <- which( outputNames==vars[i] )

  par(mfrow=c(3,4),mar=c(2,2,2,2))
  # days <- 3300:3490
  days <- 3000:3490
  for(i in 4:nout) plot( output[days,iout[1]], output[days,iout[i]],
                         main=vars[i], xlab="", ylab="" )
  
  # Verify day of flowering
  iDayFl1  <- which(vars=="DayFl(1)")
  idaysFl1 <- which( output[days,iout[iDayFl1]]>0)
  dayFl1   <- days[idaysFl1]
```

```{r}
  vars <- c( "Time"  , "year"     , "doy",
             "DVS(2)", "harvCP(2)", "DayFl(2)", "fTran(2)", "fNgrowth(2)",
             "SINKPMAXnew(2)" , "SINKP(2)",
             "gSINKPMAXnew(2)", "dSINKPMAXnew(2)" )
  nout <- length(vars)
  iout <- rep(NA,nout)
  for(i in 1:nout) iout[i] <- which( outputNames==vars[i] )

  par(mfrow=c(3,4),mar=c(2,2,2,2))
  # days <- 3300:3490
  days <- 3000:3490
  for(i in 4:nout) plot( output[days,iout[1]], output[days,iout[i]],
                         main=vars[i], xlab="", ylab="" )
```

## Output of a MAP generated by BC

Run this code immediately after carrying a BC

```{r}
  # After running, for example, "CAF2021_04_BC.Rmd"
  # source('BC/BC_averageYields.R')

  s <- 1 # Choose a site from those for which the BC was carried out
  params_BC_MAP   <- scparMAP_BC  * sc
  params          <- list_params        [[s]] ; matrix_weather <- list_matrix_weather[[s]]
  calendar_fert   <- list_calendar_fert [[s]] ; calendar_prunC <- list_calendar_prunC[[s]] 
  calendar_prunT  <- list_calendar_prunT[[s]] ; calendar_thinT <- list_calendar_thinT[[s]]  
  NDAYS           <- list_NDAYS         [[s]]       
  ip_BC_s         <- ip_BC_site         [[s]]
  icol_pChain_s   <- icol_pChain_site   [[s]]
# Calculate model output for the MAP parameter vector
  params[ip_BC_s] <- params_BC_MAP      [icol_pChain_s]
  
  # params    <- set_par( c("CNLITT0","CNSOMF0","CNSOMS0"), c(30,30,30) )
  outputMAP <- run_model( params, matrix_weather, calendar_fert, calendar_prunC,
                                calendar_prunT, calendar_thinT, NDAYS )
  plot_output( list_output=list(outputMAP),
               vars       =c( "fTran(1)", "fNgrowth(1)",
                              "DVS(1)"  , "SINKP(1)" , "SINKPMAXnew(1)",
                              "DayFl(1)", "PARMA(1)" , "harvDM_f_hay" ) )
  plot_output( list_output=list(outputMAP),
               vars       =c( "fTran(2)", "fNgrowth(2)",
                              "DVS(2)"  , "SINKP(2)" , "SINKPMAXnew(2)",
                              "DayFl(2)", "PARMA(2)" , "harvDM_f_hay" ) )
```



\clearpage



# APPENDIX: Basic code for testing

## Initialisation and running

```{r, eval=F}
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
  output <- run_model()
```

## Tables and Figures

```{r, eval=F}
  # Table of selected parameters, with values:

  NPAR <- length(params) ; names_params <- row.names(df_params)
  knitr::kable( cbind( c(1:(NPAR-2),"...",NPAR-1,NPAR),
                       rbind( head(cbind(names_params,params),n=(NPAR-2)),
                              c("...","..."),
                              tail(cbind(names_params,params),n= 2,keepnums=F) ) ),
                col.names=c("","Parameter","Value") )
```

```{r, eval=F}
  # Table of all output variables, with units and final values:

  finalvalues <- tail( output, 1 )
  knitr::kable( cbind( 1:NOUT, outputNames, outputUnits, t(finalvalues) ),
                col.names=c("","Variable","unit","Final value") )
```

```{r, eval=F}
  # Table of selected output variables with values near beginning and end of run:

  output_short <- signif( output, 5 )
  icols        <- c(1:9,NOUT+(-1:0))
  knitr::kable( rbind( head(output_short[,icols]),
                       rep("...",length(icols)),
                       tail(output_short[,icols],n= 2,keepnums=F) ),
                col.names=outputNames[icols] )
```

```{r OutputsDefault, eval=F, fig.height=3, fig.cap="\\label{fig:OutputsDefault}Outputs from CAF2021 using default settings for Turrialba."}
  # Figure of selected output variables:

  plot_output( vars=c("Ac(1)","Ac(2)","Ac(3)","Ac(4)","Ac(5)","Ac(6)") )
```

## Cumulative ground cover by LCC and by tree species

```{r, eval=F}
  # GROUND COVER by LCC

  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.Ac <- sapply( 1:6, function(i) {
    which( outputNames==paste0("Ac(",i,")") ) } )
  plot  ( Time, output[,i.Ac[1]], type="l", ylim=c(0,1),
          main="Cumulative ground cover of six LCC (-)",
          xlab="", ylab="" )
  points( Time, rowSums( output[,i.Ac[1:2]] ), type="l", col="yellow" )
  points( Time, rowSums( output[,i.Ac[1:3]] ), type="l", col="green" )
  points( Time, rowSums( output[,i.Ac[1:4]] ), type="l", col="red" )
  points( Time, rowSums( output[,i.Ac[1:5]] ), type="l", col="blue" )
  points( Time, rowSums( output[,i.Ac[1:6]] ), type="l", col="black" )
```

```{r, eval=F}
  # GROUND COVER by TREE SPECIES

  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.At <- sapply( 1:3, function(i) {
    which( outputNames==paste0("At(",i,")") ) } )
  plot  ( Time, output[,i.At[1]], type="l", ylim=c(0,1),
          main="Ground cover by 3 tree spp.",
          xlab="", ylab="" )
  points( Time, output[,i.At[2]], type="l", col="red" )
  points( Time, output[,i.At[3]], type="l", col="blue" )
  legend( "right", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )
```

## Other variables

```{r, eval=F}
  # TREE DENSITY

  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.trd <- sapply( 1:3, function(i) {
    which( outputNames==paste0("treedens_t(",i,")") ) } )
  yrange <- range(0,output[,i.trd[1:3]])
  plot  ( Time, output[,i.trd[1]], type="l",
          main="Tree density (ha-1)", xlab="", ylab="", ylim=yrange )
  points( Time, output[,i.trd[2]], type="l", col="red" )
  points( Time, output[,i.trd[3]], type="l", col="blue" )
  legend( "topright", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )
```

```{r, eval=F}
  # TREE HEIGHT

  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.h <- sapply( 1:3, function(i) {
    which( outputNames==paste0("h_t(",i,")") ) } )
  yrange <- range(output[,i.h[1:3]])
  plot  ( Time, output[,i.h[1]], type="l",
          main="Tree height (m)", xlab="", ylab="", ylim=yrange )
  points( Time, output[,i.h[2]], type="l", col="red"  )
  points( Time, output[,i.h[3]], type="l", col="blue" )
  legend( "topleft", col=c("black","red","blue"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)") )
```

```{r, eval=F}
  # YIELD

  par( mfrow=c(1,1) )
  Time <- output[,1] ; TimeFrom0 <- Time - Time[1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )
  CCONC <- 0.47
  Y1_kgDMm2 <- output[,i.harvCP[1]] / CCONC ; it1 <- which(Y1_kgDMm2>0)
  Time1     <- Time[it1] ; Y1_kgDMm2 <- Y1_kgDMm2[it1]
  Y2_kgDMm2 <- output[,i.harvCP[2]] / CCONC ; it2 <- which(Y2_kgDMm2>0)
  Time2     <- Time[it2] ; Y2_kgDMm2 <- Y2_kgDMm2[it2]
  Y3_kgDMm2 <- output[,i.harvCP[3]] / CCONC ; it3 <- which(Y3_kgDMm2>0)
  Time3     <- Time[it3] ; Y3_kgDMm2 <- Y3_kgDMm2[it3]
  Y4_kgDMm2 <- output[,i.harvCP[4]] / CCONC ; it4 <- which(Y4_kgDMm2>0)
  Time4     <- Time[it4] ; Y4_kgDMm2 <- Y4_kgDMm2[it4]
  Y5_kgDMm2 <- output[,i.harvCP[5]] / CCONC ; it5 <- which(Y5_kgDMm2>0)
  Time5     <- Time[it5] ; Y5_kgDMm2 <- Y5_kgDMm2[it5]
  Y6_kgDMm2 <- output[,i.harvCP[6]] / CCONC ; it6 <- which(Y6_kgDMm2>0)
  Time6     <- Time[it6] ; Y6_kgDMm2 <- Y6_kgDMm2[it6]
  
  Y_kgDMm2 <- Y1_kgDMm2 * output[,i.Ac[1]][it1] +
              Y2_kgDMm2 * output[,i.Ac[2]][it2] +
              Y3_kgDMm2 * output[,i.Ac[3]][it3] +
              Y4_kgDMm2 * output[,i.Ac[4]][it4] +
              Y5_kgDMm2 * output[,i.Ac[5]][it5] +
              Y6_kgDMm2 * output[,i.Ac[6]][it6]
  
  plot  ( Time1, Y1_kgDMm2, type="b", pch="1", ylim=c(0,0.25),
          main="Yield (kg DM m-2)", xlab="", ylab="" )
  points( Time2, Y2_kgDMm2, type="b", pch="2", col="yellow" )
  points( Time3, Y3_kgDMm2, type="b", pch="3", col="green"  )
  points( Time4, Y4_kgDMm2, type="b", pch="4", col="red"    )
  points( Time5, Y5_kgDMm2, type="b", pch="5", col="blue"   )
  points( Time6, Y6_kgDMm2, type="b", pch="6", col="black"  )
  points( Time6, Y_kgDMm2 , type="l", lty=1  , col="black", lwd=3 )
  legend( "topright",
          col=c("black","black","yellow","green","red","blue","black"),
          lty=1, pch=c("",paste(1:6)),
          lwd=c(3,rep(1,6)),
          legend=c("Field","LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )
```

```{r, eval=F}
  # CUMULATIVE YIELD

  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )
  plot  ( Time, cumsum(output[,i.harvCP[1]]), type="p", ylim=c(0,0.6),
          main="Cumulative yield (kg C m-2)",
          xlab="", ylab="" )
  points( Time, cumsum(output[,i.harvCP[2]]), type="p", col="yellow" )
  points( Time, cumsum(output[,i.harvCP[3]]), type="p", col="green" )
  points( Time, cumsum(output[,i.harvCP[4]]), type="p", col="red" )
  points( Time, cumsum(output[,i.harvCP[5]]), type="p", col="blue" )
  points( Time, cumsum(output[,i.harvCP[6]]), type="p", col="black" )
  legend( "topleft", col=c("black","yellow","green","red","blue","black"),
          lty=1, lwd=5,
          legend=c("LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )
```

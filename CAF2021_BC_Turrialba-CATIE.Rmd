---
title: Bayesian calibration of CAF2021 on data from the CATIE long-term experiment in Turrialba, Costa Rica
author: MvO
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
---

# Introduction

We report here on progress with calibration of CAF2021. The model was calibrated on data from 18 out of the 20 treatments at the long-term coffee agroforestry experiment in Turrialba. Two of the treatments had two upper-stratum timber tree species (Casha and Terminalia), and that combination cannot be simulated with the current version of the model: the model can simulate at most one "upper" tree species (and at most two lower ones).

The calibration consisted of the following activities:
1. Create, from various sources, a file with daily weather from 2000 to 2017.
2. Assemble, from various sources, data on soil properties and management (including tree planting densities and pruning and thinning regimes).
3. Assemble, from various sources, calibration data on coffee and tree growth.
4. Identify CAF2021 parameters that we wanted to calibrate, and assign to them a prior probability distribution to represent our uncertainty about the values of the parameters.
5. Carry out Bayesian calibration (BC) using Markov Chain Monte Carlo sampling (MCMC), to derive a posterior distribution for the parameters. We used an MCMC chain length of 36,000 iterations, which means that the model was run with 36,000 different parameter vectors. Each parameter vector was applied to each of the 18 treatments, so the total number of CAF2021 runs for this calibration was 18 $\times$ 36,000 = 648,000 model runs.
6. Analyse the results from the BC to identify any remaining problems with data and model.

We briefly discuss the 6 steps now.

# Results & Discussion

## Data: weather

```{r, echo=FALSE, out.width="100%", fig.cap="\\label{FigWeather}Weather at CATIE 2000-2017."}
knitr::include_graphics("Weather_Turrialba_2000-2017.png")
```

- We created a file with daily weather data 2000-2017 for five variables: radiation, temperature, atmospheric vapour pressure, wind speed, rainfall.
- For the period Jan 2000 - April 2014, we used a daily weather data file created by Oriana Ovalle.
- For the period May 2014 - May 2017, we used data downloaded from the CATIE website: daily data for rain, mostly monthly data for the other four variables.
- For the period June to Dec 2017, we used the median values of the same-day values from all preceding years.
- The wind speed data are clearly unreliable. There is evidence of sensor drift over time toward unrealistically low values.
- The absence of daily data for most variables May 2014-Dec 2016 is a problem.
- The absence of any data from June 2017 is a problem.
- Data from the weather station 73103 differed too much from CATIE data (in time periods and for variables where both had data) to be useful for gap-filling.

## Data: soil and management

- There was large spatial variation on the CATIE site, as we can see from very large differences between the three blocks of the experiment. We ignored this variation and used the same soil property values for all treatments.
- CAF2021 has simplistic equations for thinning and pruning, which may need to be improved sometime.
- For the fertilization levels of the AC and MC treatments, we used the values in the Ovalle model initialisation files (AC: 90+90+100 kg N ha-1 y-1; MC: 45+45+60 kg N ha-1 y-1). We assumed that the annual N-additions in the MO treatment were 20% of MC, and were zero in BO.

## Data: coffee and tree growth

- We used the most recent files received from Elias (18 June 2020). Annual coffee yields in fanegas/ha were converted to dry matter yields by multiplying with 86 kg/fanega.
- For coffee yields, the values were mostly closely correlated with the data sets used earlier by Oriana Ovalle.
- It would be good to have data on tree biomass.
- For most variables we quantified the uncertainty of each measurement as a coefficient of variation of 30%, with slightly lower values for coffee yield.

## Prior probability distribution

- In the calibration, we included parameters for coffee, soil and the three tree species (Erythrina, Terminalia, Chloroleucon).
- We only used a subset of the model's parameters for the calibration, and used a fairly uninformative (not too constraining) prior.

## Posterior probability distribution

- For the marginal posterior parameter distributions, see the pdf-file
  - 'BC_parameters_priorbeta_histograms[].pdf'.
- For the posterior fit to all the data at each site, see the pdf-file
  - 'BC_outputs_data[].pdf'.

## Analysis

- Coffee production in the experiment had a biennial pattern the first ten years, then stable production during four years, and then the bienniality started again. CAF2021 does not simulate the interannual variability well. It is able to simulate some initial bienniality, but it does not simulate the late resumption of biennial growth.
- The average coffee production levels across the 18 treatments are simulated quite well, albeit with some underestimation (see following figure).

```{r, echo=FALSE, out.width="100%", fig.cap="\\label{FigYields}Simulated vs. observed coffee yields over the period 2003-2017. The simulations were carried out using the Maximum A Posteriori (i.e. most probable) parameter vector. Every point represents a different treatment."}
source('BC/BC_averageYields.R')
```


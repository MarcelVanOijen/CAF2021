---
title: 'CAF2021: Model structure'
subtitle: 'Modelling coffee agroforestry systems with up to three shade tree spp.'
author:
- Marcel van Oijen; VanOijenMarcel@gmail.com
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
---

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=TRUE,results="asis",warning=FALSE,message=FALSE)
```

# Model structure

CAF2021 simulates a coffee agroforestry system where the coffee plants are shaded by 0, 1, 2 or 3 tree species. The model allows up to two 'lower-layer' tree species, but no more than one 'upper-layer' tree species. The simulated tree species can have different initial planting density and thinning regime.

Many so-called 'model initialisation files' have already been prepared which set up the model for different tree species combinations and environmental conditions. The following single line of code runs a file that prepares the model for a one-tree-species system (coffee plus *Erythrina peoppigiana*) in Turrialba.

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
```

The following code shows how to set the model up as a two-tree-species system, with both species being in the same lower layer. We could have done that by running a two-tree-species initialisation file, but show another way in the code. We continue from the initialisation that we already carried out (with only *E. poeppigiana*) and simply increase the initial planting density of tree species 2 from zero to a positive value.

The code also shows how to copy the value of a parameter (here 'KNFIX') from one species to another.

```{r}
  params[names_params=="TREEDENS0(1)"] <- 0.04
  params[names_params=="TREEDENS0(2)"] <- 0.02
  params[names_params=="KNFIX(2)"    ] <- params[names_params=="KNFIX(1)"]
```

The following table shows all model output variables with their units.

```{r, echo=FALSE}
  knitr::kable( cbind(1:NOUT,outputNames,outputUnits),
                col.names=c("","Output variable","Unit"),
                row.names=FALSE )
```

And here is a table with parameters and their values.

```{r, echo=FALSE}
  NPAR <- length(params) ; names_params <- row.names(df_params)
  knitr::kable( cbind( c(1:10,"...",NPAR-1,NPAR),
                       rbind( head(cbind(names_params,params),n=10),
                              c("...","..."),
                              tail(cbind(names_params,params),n= 2,keepnums=F) ) ),
                col.names=c("","Parameter","Value") )
```

# Model running

We run the model and show selected output variables in Fig. \ref{fig:OutputsDefault}.

```{r OutputsDefault, fig.height=3.5, fig.cap="\\label{fig:OutputsDefault}Outputs from CAF2021 using default settings for Turrialba."}
  output <- run_model()
  plot_output( vars=c("Ac(1)","Ac(2)","Ac(3)","Ac(4)","Ac(5)","Ac(6)") )
```

## Tabular outputs

We also show some of the default outputs in tabular form.

```{r, echo=FALSE}
  output_short <- signif( output, 5 )
  icols        <- c(1:9,NOUT+(-1:0))
  knitr::kable( rbind( head(output_short[,icols]),
                       rep("...",length(icols)),
                       tail(output_short[,icols],n= 2,keepnums=F) ),
                col.names=outputNames[icols] )
```

We make a table with the final output values produced by this model run.

```{r, echo=FALSE}
  finalvalues <- tail( output, 1 )
  knitr::kable( cbind( outputNames, outputUnits, t(finalvalues) ),
                col.names=c("Variable","unit","Final value") )
```

# Outputs demonstrating impacts of management and competition

We now run the most complex system, with three species.

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_15_CE_AC.R")
  params[names_params=="TREEDENS0(1)"] <- 0.04
  params[names_params=="TREEDENS0(2)"] <- 0.02
  params[names_params=="TREEDENS0(3)"] <- 0.01
  params[names_params=="LUEMAX(1)"]    <- 0.0004
  params[names_params=="LUEMAX(2)"]    <- 0.0004
  params[names_params=="LUEMAX(3)"]    <- 0.0012
  params[names_params=="SLAT(1)"]      <- 20
  params[names_params=="SLAT(2)"]      <- 20
  params[names_params=="SLAT(3)"]      <- 20

  output <- run_model()
```

Ground cover, density and height for the three species are shown in Fig. \ref{fig:OutputsSpecies}.

ERROR FOR SPECIES 3: thinning leads to a jump in height!

```{r OutputsSpecies, echo=F, fig.height=5, fig.cap="\\label{fig:OutputsSpecies}Outputs for the three tree species"}
  par( mfrow=c(3,1), mar=c(2,5,0,5) )

  Time <- output[,1]
  i.At <- sapply( 1:3, function(i) {
    which( outputNames==paste0("At(",i,")") ) } )
  plot  ( Time, output[,i.At[1]], type="l", ylim=c(0,1),
          ylab="Ground cover (-)",
          xlab="", xaxt="n" )
  points( Time, output[,i.At[2]], type="l", col="blue" )
  points( Time, output[,i.At[3]], type="l", col="red" )
  legend( "topleft", col=c("black","blue","red"), lty=1,
          legend=c("sp. 1 (lower layer)",
                   "sp. 2 (lower layer)",
                   "sp. 3 (upper layer)" ) )
  
  i.trd <- sapply( 1:3, function(i) {
    which( outputNames==paste0("treedens_t(",i,")") ) } )
  yrange <- range( 1.e4 * output[,i.trd] )
  plot  ( Time, 1.e4 * output[,i.trd[1]], type="l",
          ylab="Tree density (ha-1)", xlab="", xaxt="n", ylim=yrange )
  points( Time, 1.e4 * output[,i.trd[2]], type="l", col="blue" )
  points( Time, 1.e4 * output[,i.trd[3]], type="l", col="red" )

  i.h <- sapply( 1:3, function(i) {
    which( outputNames==paste0("h_t(",i,")") ) } )
  yrange <- range( output[,i.h] )
  plot  ( Time, output[,i.h[3]], type="l", col="red",
          ylab="Tree height (m)", xlab="", ylim=yrange )
  points( Time, output[,i.h[1]], type="l" )
  points( Time, output[,i.h[2]], type="l", col="blue" )
```

The model distinguishes six different 'land cover classes' and their progression over time is shown in Fig. \ref{fig:OutputsLCC}.

```{r OutputsLCC, echo=F, fig.height=5, fig.cap="\\label{fig:OutputsLCC}Cumulative time series for the six land cover classes (LCC)."}
  par( mfrow=c(1,1) )
  Time <- output[,1]
  
  i.Ac <- sapply( 1:6, function(i) {
    which( outputNames==paste0("Ac(",i,")") ) } )
  plot  ( Time, output[,i.Ac[1]], type="l", ylim=c(0,1),
          main="Cumulative ground cover of six LCC (-)",
          xlab="", ylab="" )
  points( Time, rowSums( output[,i.Ac[1:2]] ), type="l", col="yellow" )
  points( Time, rowSums( output[,i.Ac[1:3]] ), type="l", col="green" )
  points( Time, rowSums( output[,i.Ac[1:4]] ), type="l", col="red" )
  points( Time, rowSums( output[,i.Ac[1:5]] ), type="l", col="blue" )
  points( Time, rowSums( output[,i.Ac[1:6]] ), type="l", col="black" )
  legend( "bottomleft", col=c("black","blue","red","green","yellow","black"), cex=0.7, lty=1,
          legend=c("+ LCC 6: Tree sp. 2+3",
                   "+ LCC 5: Tree sp. 1+3",
                   "+ LCC 4: Tree sp. 3",
                   "+ LCC 3: Tree sp. 2",
                   "+ LCC 2: Tree sp. 1",
                   "   LCC 1: Coffee full sun" ) )
```

The coffee yields under those 6 land cover classes are shown in Fig. \ref{fig:OutputsYield}. The top panel shows annual yields and the bottom panel cumulative yields.

```{r}
  Time <- output[,1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )

  CCONC <- 0.47
  Y1_kgDMm2 <- output[,i.harvCP[1]] / CCONC ; it1 <- which(Y1_kgDMm2>0)
  Time1     <- Time[it1] ; Y1_kgDMm2 <- Y1_kgDMm2[it1]
  Y2_kgDMm2 <- output[,i.harvCP[2]] / CCONC ; it2 <- which(Y2_kgDMm2>0)
  Time2     <- Time[it2] ; Y2_kgDMm2 <- Y2_kgDMm2[it2]
  Y3_kgDMm2 <- output[,i.harvCP[3]] / CCONC ; it3 <- which(Y3_kgDMm2>0)
  Time3     <- Time[it3] ; Y3_kgDMm2 <- Y3_kgDMm2[it3]
  Y4_kgDMm2 <- output[,i.harvCP[4]] / CCONC ; it4 <- which(Y4_kgDMm2>0)
  Time4     <- Time[it4] ; Y4_kgDMm2 <- Y4_kgDMm2[it4]
  Y5_kgDMm2 <- output[,i.harvCP[5]] / CCONC ; it5 <- which(Y5_kgDMm2>0)
  Time5     <- Time[it5] ; Y5_kgDMm2 <- Y5_kgDMm2[it5]
  Y6_kgDMm2 <- output[,i.harvCP[6]] / CCONC ; it6 <- which(Y6_kgDMm2>0)
  Time6     <- Time[it6] ; Y6_kgDMm2 <- Y6_kgDMm2[it6]
  Y_kgDMm2 <- Y1_kgDMm2 * output[,i.Ac[1]][it1] +
              Y2_kgDMm2 * output[,i.Ac[2]][it2] +
              Y3_kgDMm2 * output[,i.Ac[3]][it3] +
              Y4_kgDMm2 * output[,i.Ac[4]][it4] +
              Y5_kgDMm2 * output[,i.Ac[5]][it5] +
              Y6_kgDMm2 * output[,i.Ac[6]][it6]
```

```{r OutputsYield, echo=F, fig.height=5, fig.cap="\\label{fig:OutputsYield}Coffee yield under the six land cover classes in the same field of a three-tree-species agroforestry system."}
  par( mfrow=c(2,1), mar=c(2,5,0,5) )
  plot  ( Time1, Y1_kgDMm2, type="b", pch="1", ylim=c(0,0.25),
          ylab="Yield (kg DM m-2)", xlab="", xaxt="n" )
  points( Time2, Y2_kgDMm2, type="b", pch="2", col="yellow" )
  points( Time3, Y3_kgDMm2, type="b", pch="3", col="green"  )
  points( Time4, Y4_kgDMm2, type="b", pch="4", col="red"    )
  points( Time5, Y5_kgDMm2, type="b", pch="5", col="blue"   )
  points( Time6, Y6_kgDMm2, type="b", pch="6", col="black"  )
  points( Time6, Y_kgDMm2 , type="l", lty=1  , col="black", lwd=3 )
  legend( "topright",
          col=c("black","black","yellow","green","red","blue","black"),
          lty=1, pch=c("",paste(1:6)),
          lwd=c(3,rep(1,6)),
          legend=c("Field","LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )
  
  plot  ( Time, cumsum(output[,i.harvCP[1]]), type="p", ylim=c(0,0.6),
          ylab="Cumulative yield (kg C m-2)", xlab="" )
  points( Time, cumsum(output[,i.harvCP[2]]), type="p", col="yellow" )
  points( Time, cumsum(output[,i.harvCP[3]]), type="p", col="green" )
  points( Time, cumsum(output[,i.harvCP[4]]), type="p", col="red" )
  points( Time, cumsum(output[,i.harvCP[5]]), type="p", col="blue" )
  points( Time, cumsum(output[,i.harvCP[6]]), type="p", col="black" )
  legend( "topleft", col=c("black","yellow","green","red","blue","black"),
          lty=1, lwd=5,
          legend=c("LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )
```


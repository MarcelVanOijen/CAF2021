---
title: 'CAF2021: User Guide'
author:
- Marcel van Oijen; vanoijenmarcel@gmail.com
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
---

```{r, include=FALSE}
# rmarkdown::render(rstudioapi::getSourceEditorContext()$path,"pdf_document")
# rmarkdown::render(rstudioapi::getSourceEditorContext()$path,"html_document")
# rmarkdown::render(rstudioapi::getSourceEditorContext()$path,"word_document")
```

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=TRUE,results="asis",warning=FALSE,message=FALSE)
```

# Model initialisation

We simulate a system with two identical lower-layer tree species, which only differ in their initial planting density:

```{r}
  source("initialisation/initialise_CAF2021_Turrialba_01_E_AC.R")
  params[names_params=="TREEDENS0(1)"] <- 0.04
  params[names_params=="TREEDENS0(2)"] <- 0.02
  params[names_params=="TREEDENS0(3)"] <- 0

  params[names_params=="KNFIX(2)"    ] <- params[names_params=="KNFIX(1)"]
  params[names_params=="THINMULT(3)" ] <- 0.5
```

```{r, echo=FALSE}
  knitr::kable( cbind(1:NOUT,outputNames,outputUnits),
                col.names=c("","Output variable","Unit"),
                row.names=FALSE )
```

```{r, echo=FALSE}
  NPAR <- length(params) ; names_params <- row.names(df_params)
  knitr::kable( cbind( c(1:10,"...",NPAR-1,NPAR),
                       rbind( head(cbind(names_params,params),n=10),
                              c("...","..."),
                              tail(cbind(names_params,params),n= 2,keepnums=F) ) ),
                col.names=c("","Parameter","Value") )
```

# Model running

Fig. \ref{fig:OutputsDefault} shows selected output variables.

```{r OutputsDefault, fig.height=3.5, fig.cap="\\label{fig:OutputsDefault}Outputs from CAF2021 using default settings for Turrialba."}
  output <- run_model()
  plot_output( vars=c("Ac(1)","Ac(2)","Ac(3)","Ac(4)","Ac(5)","Ac(6)") )
```

## Tabular outputs

We also show some of the default outputs in tabular form.

```{r, echo=FALSE}
  output_short <- signif( output, 5 )
  icols        <- c(1:9,NOUT+(-1:0))
  knitr::kable( rbind( head(output_short[,icols]),
                       rep("...",length(icols)),
                       tail(output_short[,icols],n= 2,keepnums=F) ),
                col.names=outputNames[icols] )
```

We make a table with the final output values produced by this model run.

```{r, echo=FALSE}
  finalvalues <- tail( output, 1 )
  knitr::kable( cbind( outputNames, outputUnits, t(finalvalues) ),
                col.names=c("Variable","unit","Final value") )
```

# Outputs demonstrating impacts of management and competition

With our default parameter settings, after about ... years, we see increasing domination of Land Cover Class (LCC) ..., which is coffee shaded by ....

Note that the thinning intensity of the upper-layer trees was set at half that of the two lower-layer tree species.

```{r}
  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.Ac <- sapply( 1:6, function(i) {
    which( outputNames==paste0("Ac(",i,")") ) } )
  plot  ( Time, output[,i.Ac[1]], type="l", ylim=c(0,1),
          main="Cumulative ground cover of six LCC (-)",
          xlab="", ylab="" )
  points( Time, rowSums( output[,i.Ac[1:2]] ), type="l", col="yellow" )
  points( Time, rowSums( output[,i.Ac[1:3]] ), type="l", col="green" )
  points( Time, rowSums( output[,i.Ac[1:4]] ), type="l", col="red" )
  points( Time, rowSums( output[,i.Ac[1:5]] ), type="l", col="blue" )
  points( Time, rowSums( output[,i.Ac[1:6]] ), type="l", col="black" )
```

```{r}
  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.At <- sapply( 1:3, function(i) {
    which( outputNames==paste0("At(",i,")") ) } )
  plot  ( Time, output[,i.At[1]], type="l", ylim=c(0,1),
          main="Ground cover by 3 tree spp.",
          xlab="", ylab="" )
  points( Time, output[,i.At[2]], type="l", col="blue" )
  points( Time, output[,i.At[3]], type="l", col="red" )
  legend( "topleft", col=c("red","black","blue"), lty=1,
          legend=c("sp. 3 (upper layer)",
                   "sp. 1 (lower layer)",
                   "sp. 2 (lower layer)") )
```

```{r}
  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.trd <- sapply( 1:3, function(i) {
    which( outputNames==paste0("treedens_t(",i,")") ) } )
  plot  ( Time, 1e4 * output[,i.trd[1]], type="l",
          main="Tree density (ha-1)", xlab="", ylab="" )
  points( Time+0.1, 1e4 * output[,i.trd[2]]+1, type="l", col="blue" )
  points( Time, 1e4 * output[,i.trd[3]], type="l", col="red" )
  legend( "bottomleft", col=c("red","black","blue"), lty=1,
          legend=c("sp. 3 (upper layer)",
                   "sp. 1 (lower layer)",
                   "sp. 2 (lower layer)") )
```

```{r}
  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.h <- sapply( 1:3, function(i) {
    which( outputNames==paste0("h_t(",i,")") ) } )
  plot  ( Time, output[,i.h[3]], type="l", col="red",
          main="Tree height (m)", xlab="", ylab="" )
  points( Time, output[,i.h[1]], type="l" )
  points( Time, output[,i.h[2]], type="l", col="blue" )
  legend( "topleft", col=c("red","blue","black"), lty=1,
          legend=c("sp. 3 (upper layer)",
                   "sp. 2 (lower layer)",
                   "sp. 1 (lower layer)") )
```

```{r}
  par( mfrow=c(1,1) )
  Time <- output[,1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )
  plot  ( Time, cumsum(output[,i.harvCP[1]]), type="p", ylim=c(0,0.6),
          main="Cumulative yield (kg C m-2)",
          xlab="", ylab="" )
  points( Time, cumsum(output[,i.harvCP[2]]), type="p", col="yellow" )
  points( Time, cumsum(output[,i.harvCP[3]]), type="p", col="green" )
  points( Time, cumsum(output[,i.harvCP[4]]), type="p", col="red" )
  points( Time, cumsum(output[,i.harvCP[5]]), type="p", col="blue" )
  points( Time, cumsum(output[,i.harvCP[6]]), type="p", col="black" )
  legend( "topleft", col=c("black","yellow","green","red","blue","black"),
          lty=1, lwd=5,
          legend=c("LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )
```

```{r}
  par( mfrow=c(1,1) )
  Time <- output[,1] ; TimeFrom0 <- Time - Time[1]
  i.harvCP <- sapply( 1:6, function(i) {
    which( outputNames==paste0("harvCP(",i,")") ) } )
  CCONC <- 0.47
  Y1_kgDMm2 <- output[,i.harvCP[1]] / CCONC ; it1 <- which(Y1_kgDMm2>0)
  Time1     <- Time[it1] ; Y1_kgDMm2 <- Y1_kgDMm2[it1]
  Y2_kgDMm2 <- output[,i.harvCP[2]] / CCONC ; it2 <- which(Y2_kgDMm2>0)
  Time2     <- Time[it2] ; Y2_kgDMm2 <- Y2_kgDMm2[it2]
  Y3_kgDMm2 <- output[,i.harvCP[3]] / CCONC ; it3 <- which(Y3_kgDMm2>0)
  Time3     <- Time[it3] ; Y3_kgDMm2 <- Y3_kgDMm2[it3]
  Y4_kgDMm2 <- output[,i.harvCP[4]] / CCONC ; it4 <- which(Y4_kgDMm2>0)
  Time4     <- Time[it4] ; Y4_kgDMm2 <- Y4_kgDMm2[it4]
  Y5_kgDMm2 <- output[,i.harvCP[5]] / CCONC ; it5 <- which(Y5_kgDMm2>0)
  Time5     <- Time[it5] ; Y5_kgDMm2 <- Y5_kgDMm2[it5]
  Y6_kgDMm2 <- output[,i.harvCP[6]] / CCONC ; it6 <- which(Y6_kgDMm2>0)
  Time6     <- Time[it6] ; Y6_kgDMm2 <- Y6_kgDMm2[it6]
  
  Y_kgDMm2 <- Y1_kgDMm2 * output[,i.Ac[1]][it1] +
              Y2_kgDMm2 * output[,i.Ac[2]][it2] +
              Y3_kgDMm2 * output[,i.Ac[3]][it3] +
              Y4_kgDMm2 * output[,i.Ac[4]][it4] +
              Y5_kgDMm2 * output[,i.Ac[5]][it5] +
              Y6_kgDMm2 * output[,i.Ac[6]][it6]
  
  plot  ( Time1, Y1_kgDMm2, type="b", pch="1", ylim=c(0,0.25),
          main="Yield (kg DM m-2)", xlab="", ylab="" )
  points( Time2, Y2_kgDMm2, type="b", pch="2", col="yellow" )
  points( Time3, Y3_kgDMm2, type="b", pch="3", col="green"  )
  points( Time4, Y4_kgDMm2, type="b", pch="4", col="red"    )
  points( Time5, Y5_kgDMm2, type="b", pch="5", col="blue"   )
  points( Time6, Y6_kgDMm2, type="b", pch="6", col="black"  )
  points( Time6, Y_kgDMm2 , type="l", lty=1  , col="black", lwd=3 )
  legend( "topright",
          col=c("black","black","yellow","green","red","blue","black"),
          lty=1, pch=c("",paste(1:6)),
          lwd=c(3,rep(1,6)),
          legend=c("Field","LCC 1","LCC 2","LCC 3","LCC 4","LCC 5","LCC 6") )
```


---
title: 'Ecosystem services at coffee agroforestry farms in Central America: Estimation using CAF2021'
subtitle: 'ALTERNATIVE TITLE: Impact of fertilisation and shading on ecosystem services and disservices at coffee agroforestry farms in Costa Rica and Guatemala: A modelling study using CAF2021'
author:
- Marcel van Oijen$^{1*}$
- Jeremy Haggar$^{2}$
- Mirna Barrios$^{3}$
- Lucie Büchi$^{2}$
- Rolando Cerda$^{4}$
- Stefania Cerretelli$^{2}$
- Erick López$^{5}$
- Elias de Melo$^{4}$
- Alejandra Ospina$^{4}$
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: no
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
csl: agroforestry-systems.csl
bibliography: SEACAF.bib
---

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=F,results="asis",warning=FALSE,message=FALSE)
  library( tidyverse )
```

$^1$ Independent researcher, Edinburgh, United Kingdom  
$^2$ Natural Resources Institute, University of Greenwich, Chatham Maritime, Medway, United Kingdom  
$^3$ CATIE, Centro Agronómico Tropical de Investigación y Enseñanza, Managua, Nicaragua  
$^4$ CATIE, Centro Agronómico Tropical de Investigación y Enseñanza, Turrialba 30501, Costa Rica  
$^5$ Centro Estudios Ambientales y Biodiversidad, Universidad del Valle de Guatemala, Ciudad de Guatemala, Guatemala
\

**Abstract:** Coffee ...
\

**Key words:** Agroforestry systems, *Coffea arabica*, Process-based modelling
\

$^*$ Corresponding author: ORCID 0000-0003-4028-3626, VanOijenMarcel@gmail.com



\clearpage

# Declarations {-}

**Acknowledgments:** We acknowledge support by the Institute for Coffee in Costa Rica (ICAFE) and the National Coffee Association of Guatemala (ANACAFE), as well as the coffee farmers in both countries who enabled this research.
\

**Funding:** This research was funded by UK Research and Innovation Biotechnology and Biological Sciences Research Council (UKRI/BBSRC), from the Global Challenges Research Fund (GCRF) under the Agri-systems Research to Enhance Rural Livelihoods in Developing Countries programme, Grant No. BB/S01490X/1.
\

**Conflicts of interest/Competing interests:** None.
\

**Ethics approval:** Not applicable.
\

**Consent to participate:** Not applicable.
\

**Consent for publication:** Not applicable.
\

**Availability of data and material:** Requests for data should be addressed to JH.
\

**Code availability:** The coffee agroforestry model CAF2021 can be downloaded from https://doi.org/10.5281/zenodo. ...


```{r}
  dirTM      <- "BC/BC_RESULTS_Turrialba-Masatepe/BC_2021-09-17_6e4/"
  fileTM     <- paste0( dirTM, "BC_Turrialba_Masatepe_06_45.RData" )
  load( fileTM )
  fileTM_MAP <- paste0( dirTM, "CAF2021_parMAP_06_45.rds" )
  parMAP     <- readRDS( fileTM_MAP )

  iT         <- 1:18 ; iM <- 19:32
  source('initialisation/initialise_CAF2021_general.R')
  y_TM       <- fYieldsTM( parMatrix=parMAP, sfiles=sitesettings_filenames )
  y_T        <- y_TM[iT,]    ; y_M <- y_TM[iM,]
```

```{r}  
  load( "df_C.f_2021-09-24.rda" )
  load( "df_G.f_2021-09-24.rda" )
  n_C.f <- dim(df_C.f)[1] ; n_G.f <- dim(df_G.f)[1]
```

```{r}
  vars_Summary <- c(
    "harvDM_f_hay"   , "sd.harvDM_f_hay", 
    "harvDMST_3_hay" , "harvCPT_f_hay"  , "harvCST_f"   , "harvCST_3",
    "D_Nsoil"        ,
    "D_Csoil"        , "D_C"            , "D_CT"        , "D_Csys"     ,
    "Shade_f"        , "Shade_fa"       , "Shade_fb"    ,
    "Nemission_fb"   , "NfixT_fb"       , "Nleaching_fb", "Crunoff_fb" ,
    "Csoil_fa"       , "Csoil_fb"       ,
    "harvDM_f_ha1819", "harvDM_f_ha1920",
    "fTranT_1a"      , "fTranT_1b"      , "fTranT_2a"   , "fTranT_2b"  ,
    "fTranT_3a"      , "fTranT_3b"      , "fNgrowth_1a" , "fNgrowth_1b",
    "fNgrowth_2a"    , "fNgrowth_2b"    , "fNgrowth_3a" , "fNgrowth_3b",
    "H_1a"           , "H_1b"           , "H_2a"        , "H_2b"       ,
    "H_3a"           , "H_3b"           , "CAtree_1a"   , "CAtree_1b"  ,
    "CAtree_2a"      , "CAtree_2b"      , "CAtree_3a"   , "CAtree_3b"  ,
    "treedens_1"     , "treedens_2"     , "treedens_3"  ,
    "CST_3"
  )
```

```{r}
  outputSummary <- function( output ) {
    idoy           <- which( outputNames=="doy" )

    fOut           <- matrix( NA, nrow=1, ncol=length(vars_Summary) )
    colnames(fOut) <- vars_Summary

    iyear       <- which( outputNames=="year" )
    idoy        <- which( outputNames=="doy" )
    
    ih_f_hay    <- which( outputNames=="harvDM_f_hay" ) # kg C ha-1 y-1
    ihCPT_f     <- which( outputNames=="harvCPT_f"    ) # kg C m-2 d-1
    ihCPT_2     <- which( outputNames=="harvCPT_t(2)" ) # kg C m-2 d-1
    ihCST_f     <- which( outputNames=="harvCST_f"    ) # kg C m-2 d-1
    ihCST_3     <- which( outputNames=="harvCST_t(3)" ) # kg C m-2 d-1
    iNsoil_f    <- which( outputNames=="Nsoil_f"      ) # kg N m-2
    iCsoil_f    <- which( outputNames=="Csoil_f"      ) # kg C m-2 
    iC_f        <- which( outputNames=="C_f"          ) # kg C m-2
    iCT_f       <- which( outputNames=="CT_f"         ) # kg C m-2

    iShade_f    <- which( outputNames=="Shade_f"      ) # m2 m-2
    
    iNemission  <- which( outputNames=="Nemission_f"  ) # kg N m-2 d-1
    iNfixT      <- which( outputNames=="NfixT_f"      ) # kg N m-2 d-1
    iNleaching  <- which( outputNames=="Nleaching_f"  ) # kg N m-2 d-1
    iCrunoff    <- which( outputNames=="Crunoff_f"    ) # kg C m-2 d-1
    
    idayH1      <- which( outputNames=="DayHarv(1)" )
    idayH2      <- which( outputNames=="DayHarv(2)" )
    ifTranT_1   <- which( outputNames=="fTranT_t(1)")
    ifTranT_2   <- which( outputNames=="fTranT_t(2)")
    ifTranT_3   <- which( outputNames=="fTranT_t(3)")
    ifNgrwT_1   <- which( outputNames=="fNgrowth_t(1)")
    ifNgrwT_2   <- which( outputNames=="fNgrowth_t(2)")
    ifNgrwT_3   <- which( outputNames=="fNgrowth_t(3)")
    ihT_1       <- which( outputNames=="h_t(1)")
    ihT_2       <- which( outputNames=="h_t(2)")
    ihT_3       <- which( outputNames=="h_t(3)")
    iCAtreeT_1  <- which( outputNames=="CAtree_t(1)")
    iCAtreeT_2  <- which( outputNames=="CAtree_t(2)")
    iCAtreeT_3  <- which( outputNames=="CAtree_t(3)")
    itreedens_1 <- which( outputNames=="treedens_t(1)")
    itreedens_2 <- which( outputNames=="treedens_t(2)")
    itreedens_3 <- which( outputNames=="treedens_t(3)")
    iCST_3      <- which( outputNames=="CST_t(3)" )

    c.DM  <- 1 / 0.47          # 'kg C'               -> 'kg DM'
    NDAYS <- dim(output)[1]
    c.ha  <- 1e4               # 'm-2'                -> 'ha-1'
    c.hay <- 1e4 * 365 / NDAYS # 'm-2 in sim. period' -> 'ha-1 y-1'
    d181  <- which( output[,idoy]==181 )
    
    T1 <- 0 ; if(output[1,itreedens_1]>0) T1 <- 1
    T2 <- 0 ; if(output[1,itreedens_2]>0) T2 <- 1
    T3 <- 0 ; if(output[1,itreedens_3]>0) T3 <- 1
    
           fOut[,"sd.harvDM_f_hay"] <- sd(output[d181 ,ih_f_hay] )
           fOut[,"harvDM_f_hay"] <- mean( output[d181 ,ih_f_hay] )
           fOut[,"harvCPT_f_hay"]<- sum ( output[     ,ihCPT_f ] ) * c.DM * c.hay
           fOut[,"harvCST_f"]    <- sum ( output[     ,ihCST_f ] ) * c.DM * c.hay
    if(T3) fOut[,"harvCST_3"]    <- sum ( output[     ,ihCST_3 ] ) * c.DM * c.hay
    if(T3) fOut[,"CST_3"]        <-       output[NDAYS,iCST_3  ]   * c.DM * c.hay
           
           fOut[,"harvDMST_3_hay"] <- sum( fOut[,c("harvCST_3","CST_3")],na.rm=T )
           
           fOut[,"treedens_1"]   <-       output[NDAYS,itreedens_1]       * c.ha
           fOut[,"treedens_2"]   <-       output[NDAYS,itreedens_2]       * c.ha
           fOut[,"treedens_3"]   <-       output[NDAYS,itreedens_3]       * c.ha
           
    D_output         <- output[NDAYS,] - output[1,]
    fOut[,"D_Nsoil"] <- D_output[iNsoil_f] * c.hay
    fOut[,"D_Csoil"] <- D_output[iCsoil_f] * c.hay
    fOut[,"D_C"    ] <- D_output[iC_f    ] * c.hay
    fOut[,"D_CT"   ] <- D_output[iCT_f   ] * c.hay
    fOut[,"D_Csys" ] <- fOut[,"D_Csoil"] + fOut[,"D_C"] + fOut[,"D_CT"]

    outputFirstYears <- colMeans( output[ 1          :730  , ] )
    outputFinalYears <- colMeans( output[ (NDAYS-730):NDAYS, ] )
    
    fOut[,"Shade_f"     ] <- mean( output          [,iShade_f] )
    fOut[,"Shade_fa"    ] <- mean( outputFirstYears[ iShade_f] )
    fOut[,"Shade_fb"    ] <- mean( outputFinalYears[ iShade_f] )
    
    fOut[,"Nemission_fb"] <- outputFinalYears[iNemission] * 1e4 * 365
    fOut[,"NfixT_fb"    ] <- outputFinalYears[iNfixT    ] * 1e4 * 365
    fOut[,"Nleaching_fb"] <- outputFinalYears[iNleaching] * 1e4 * 365
    
    fOut[,"Crunoff_fb"  ] <- outputFinalYears[iCrunoff  ] * 1e4 * 365
    fOut[,"Csoil_fa"    ] <- outputFirstYears[iCsoil_f  ]
    fOut[,"Csoil_fb"    ] <- outputFinalYears[iCsoil_f  ]

    dHarv1819 <- which( (output[,iyear]==2019) & (output[,idoy]==181) )
    dHarv1920 <- which( (output[,iyear]==2020) & (output[,idoy]==181) )
    
    fOut[,"harvDM_f_ha1819"] <- output[dHarv1819,ih_f_hay]
    fOut[,"harvDM_f_ha1920"] <- output[dHarv1920,ih_f_hay]

    if(T1) { fOut[,"fTranT_1a"  ] <- mean( outputFirstYears[ifTranT_1] )
             fOut[,"fTranT_1b"  ] <- mean( outputFinalYears[ifTranT_1] )
             fOut[,"fNgrowth_1a"] <- mean( outputFirstYears[ifNgrwT_1] )
             fOut[,"fNgrowth_1b"] <- mean( outputFinalYears[ifNgrwT_1] )
             fOut[,"H_1a"       ] <- mean( outputFirstYears[ihT_1] )
             fOut[,"H_1b"       ] <- mean( outputFinalYears[ihT_1] )
             fOut[,"CAtree_1a"  ] <- mean( outputFirstYears[iCAtreeT_1] )
             fOut[,"CAtree_1b"  ] <- mean( outputFinalYears[iCAtreeT_1] )
           }
    if(T2) { fOut[,"fTranT_2a"  ] <- mean( outputFirstYears[ifTranT_2] )
             fOut[,"fTranT_2b"  ] <- mean( outputFinalYears[ifTranT_2] )
             fOut[,"fNgrowth_2a"] <- mean( outputFirstYears[ifNgrwT_2] )
             fOut[,"fNgrowth_2b"] <- mean( outputFinalYears[ifNgrwT_2] )
             fOut[,"H_2a"       ] <- mean( outputFirstYears[ihT_2] )
             fOut[,"H_2b"       ] <- mean( outputFinalYears[ihT_2] )
             fOut[,"CAtree_2a"  ] <- mean( outputFirstYears[iCAtreeT_2] )
             fOut[,"CAtree_2b"  ] <- mean( outputFinalYears[iCAtreeT_2] )
           }
    if(T3) { fOut[,"fTranT_3a"  ] <- mean( outputFirstYears[ifTranT_3] )
             fOut[,"fTranT_3b"  ] <- mean( outputFinalYears[ifTranT_3] )
             fOut[,"fNgrowth_3a"] <- mean( outputFirstYears[ifNgrwT_3] )
             fOut[,"fNgrowth_3b"] <- mean( outputFinalYears[ifNgrwT_3] )
             fOut[,"H_3a"       ] <- mean( outputFirstYears[ihT_3] )
             fOut[,"H_3b"       ] <- mean( outputFinalYears[ihT_3] )
             fOut[,"CAtree_3a"  ] <- mean( outputFirstYears[iCAtreeT_3] )
             fOut[,"CAtree_3b"  ] <- mean( outputFinalYears[iCAtreeT_3] )
           }

    return( fOut )
  }
```

```{r list_outF_C, cache=T}
  list_outF_C <- list_parF_C <- vector( "list", n_C.f )

  for(fi in 1:n_C.f) {
    file_init <- paste0( "initialisation/CG/inititialise_CAF2021_C_f", fi, ".R" )
    source( file_init )
    
    nF_C                     <- 4
    mat_parF                 <- matrix( NA, nF_C, 1+length(names_params) )
    mat_outF                 <- matrix( NA, nF_C, 1+length(vars_Summary) )
    colnames( mat_parF )     <- c( "FarmSetting", names_params )
    colnames( mat_outF )     <- c( "FarmSetting", vars_Summary )
    mat_parF[,"FarmSetting"] <- 1:nF_C
    mat_outF[,"FarmSetting"] <- 1:nF_C
    
    for(iF in 1:nF_C) {
      params.2     <- set_par("RAINMULT"       ,0.5)
      params.3     <- set_par("NFERTMULT"      ,0.5)
      params.4     <- set_par("SHADETARGETMULT",0.25)
        iTREEDENS0 <- which( startsWith( names_params, "TREEDENS0(" ) )
      params.4[ iTREEDENS0 ]  <- params.4[ iTREEDENS0 ] * 0.5
      if(iF==1){ outF <- run_model( params        , matrix_weather,
                                    calendar_fert , calendar_prunC,
                                    calendar_prunT, calendar_thinT, NDAYS ) }
      if(iF==2){ outF <- run_model( params.2      , matrix_weather,
                                    calendar_fert , calendar_prunC,
                                    calendar_prunT, calendar_thinT, NDAYS ) }
      if(iF==3){ outF <- run_model( params.3      , matrix_weather,
                                    calendar_fert , calendar_prunC,
                                    calendar_prunT, calendar_thinT, NDAYS ) }
      if(iF==4){ outF <- run_model( params.4      , matrix_weather,
                                    calendar_fert , calendar_prunC,
                                    calendar_prunT, calendar_thinT, NDAYS ) }
      paramsUsed <- params
      ipT1       <- which( endsWith(names_params,"(1)") ) 
      ipT2       <- which( endsWith(names_params,"(2)") ) 
      ipT3       <- which( endsWith(names_params,"(3)") )
      dT1        <- params[ which(names_params=="TREEDENS0(1)") ]
      dT2        <- params[ which(names_params=="TREEDENS0(2)") ]
      dT3        <- params[ which(names_params=="TREEDENS0(3)") ]
      if( dT1==0 ) paramsUsed[ipT1] <- NA
      if( dT2==0 ) paramsUsed[ipT2] <- NA
      if( dT3==0 ) paramsUsed[ipT3] <- NA
      mat_parF[iF,1+(1:length(names_params))] <- paramsUsed
      mat_outF[iF,1+(1:length(vars_Summary))] <- outputSummary( outF )
    }
    list_parF_C[[fi]] <- mat_parF
    list_outF_C[[fi]] <- mat_outF
  }
```

```{r list_outF_G, cache=T}
  list_outF_G <- list_parF_G <- vector( "list", n_G.f )

  for(fi in 1:n_G.f) {
    file_init <- paste0( "initialisation/CG/inititialise_CAF2021_G_f", fi, ".R" )
    source( file_init )
    
    nF_G                     <- 4
    mat_parF                 <- matrix( NA, nF_G, 1+length(names_params) )
    mat_outF                 <- matrix( NA, nF_G, 1+length(vars_Summary) )
    colnames( mat_parF )     <- c( "FarmSetting", names_params )
    colnames( mat_outF )     <- c( "FarmSetting", vars_Summary )
    mat_parF[,"FarmSetting"] <- 1:nF_G
    mat_outF[,"FarmSetting"] <- 1:nF_G
     
    for(iF in 1:nF_G) {
      params.2     <- set_par("RAINMULT"       ,0.5)
      params.3     <- set_par("NFERTMULT"      ,0.5)
      params.4     <- set_par("SHADETARGETMULT",0.25)
        iTREEDENS0 <- which( startsWith( names_params, "TREEDENS0(" ) )
      params.4[ iTREEDENS0 ]  <- params.4[ iTREEDENS0 ] * 0.5
      if(iF==1){ outF <- run_model( params        , matrix_weather,
                                    calendar_fert , calendar_prunC,
                                    calendar_prunT, calendar_thinT, NDAYS ) }
      if(iF==2){ outF <- run_model( params.2      , matrix_weather,
                                    calendar_fert , calendar_prunC,
                                    calendar_prunT, calendar_thinT, NDAYS ) }
      if(iF==3){ outF <- run_model( params.3      , matrix_weather,
                                    calendar_fert , calendar_prunC,
                                    calendar_prunT, calendar_thinT, NDAYS ) }
      if(iF==4){ outF <- run_model( params.4      , matrix_weather,
                                    calendar_fert , calendar_prunC,
                                    calendar_prunT, calendar_thinT, NDAYS ) }
      paramsUsed <- params
      ipT1       <- which( endsWith(names_params,"(1)") ) 
      ipT2       <- which( endsWith(names_params,"(2)") ) 
      ipT3       <- which( endsWith(names_params,"(3)") )
      dT1        <- params[ which(names_params=="TREEDENS0(1)") ]
      dT2        <- params[ which(names_params=="TREEDENS0(2)") ]
      dT3        <- params[ which(names_params=="TREEDENS0(3)") ]
      if( dT1==0 ) paramsUsed[ipT1] <- NA
      if( dT2==0 ) paramsUsed[ipT2] <- NA
      if( dT3==0 ) paramsUsed[ipT3] <- NA
      mat_parF[iF,1+(1:length(names_params))] <- paramsUsed
      mat_outF[iF,1+(1:length(vars_Summary))] <- outputSummary( outF )
    }
    list_parF_G[[fi]] <- mat_parF
    list_outF_G[[fi]] <- mat_outF
  }
```

```{r}
  df_C.f_sim <- df_C.f %>%
    dplyr::select ( code ) %>%
    arrange( code ) %>%
    mutate ( parF = list_parF_C ) %>%
    mutate ( outF = list_outF_C )

  df_G.f_sim <- df_G.f %>%
    dplyr::select ( code ) %>%
    arrange( code ) %>%
    mutate ( parF = list_parF_G ) %>%
    mutate ( outF = list_outF_G )
```

```{r}
  dfoutFSummary <- function( df=df_C.f_sim, Fi=1 ){
    nf     <- dim( df )[1]
    vnames <- colnames( df$outF[[1]] ) ; nv <- length(vnames)
    matres <- matrix( NA, nf, nv ) ; colnames( matres) <- vnames
    F.v    <- matres
    for(fi in 1:nf){
      F.v[fi,] <- df$outF[[fi]][Fi,]
    }
    return( F.v )
  }

  dfparFSummary <- function( df=df_C.f_sim, Fi=1 ){
    nf     <- dim( df )[1]
    vnames <- colnames( df$parF[[1]] ) ; nv <- length(vnames)
    matres <- matrix( NA, nf, nv ) ; colnames( matres) <- vnames
    F.v    <- matres
    for(fi in 1:nf){
      F.v[fi,] <- df$parF[[fi]][Fi,]
    }
    return( F.v )
  }
```

```{r}
  oF1_C <- dfoutFSummary( df_C.f_sim, Fi=1 )
  oF2_C <- dfoutFSummary( df_C.f_sim, Fi=2 )
  oF3_C <- dfoutFSummary( df_C.f_sim, Fi=3 )
  oF4_C <- dfoutFSummary( df_C.f_sim, Fi=4 )
  pF1_C <- dfparFSummary( df_C.f_sim, Fi=1 )

  oF1_G <- dfoutFSummary( df_G.f_sim, Fi=1 )
  oF2_G <- dfoutFSummary( df_G.f_sim, Fi=2 )
  oF3_G <- dfoutFSummary( df_G.f_sim, Fi=3 )
  oF4_G <- dfoutFSummary( df_G.f_sim, Fi=4 )
  pF1_G <- dfparFSummary( df_G.f_sim, Fi=1 )
```

```{r}
  if_C.type12 <- which(df_C.f$type=="P1_S2")
  if_C.type24 <- which(df_C.f$type=="P2_S4")
  if_C.type32 <- which(df_C.f$type=="P3_S2")
  if_C.type43 <- which(df_C.f$type=="P4_S3")
  
  if_G.type13 <- which(df_G.f$type=="P1_S3")
  if_G.type24 <- which(df_G.f$type=="P2_S4")
  if_G.type33 <- which(df_G.f$type=="P3_S3")
  if_G.type43 <- which(df_G.f$type=="P4_S3")
```

```{r}
  f.env <- function( df=df_C.f, country="Costa Rica",
                     type="1.2", ifarms=if_C.type12 ) {
    n.f  <- dim(df)[1] ; n.type <- length(df[ifarms,1])
    RAIN <- sapply(1:n.f, function(i){mean(df$weather.WC[[i]][,"RAIN"])*365})
    TMIN <- sapply(1:n.f, function(i){mean(df$weather.WC[[i]][,"TMIN"])    })
    TMAX <- sapply(1:n.f, function(i){mean(df$weather.WC[[i]][,"TMAX"])    })
    TEMP <- 0.5 * (TMIN + TMAX)
    Wcap <- df$FC - df$WP
    farm.env <- rbind(
      c( country, type, n.type,
         round( mean( df  [ifarms,"altitude"] ), 0),
         round( mean( df  [ifarms,"slope"   ] ), 1),
         round( mean( RAIN[ifarms]            ), 0),
         round( mean( TEMP[ifarms]            ), 1),
         round( mean( Wcap[ifarms]            ), 2),
         round( mean( df  [ifarms,"C.soil"  ] ), 1),
         round( mean( df  [ifarms,"N.soil"  ] ), 1) ),
      c( "", "", "",
         paste0( "(", round( sd  ( df  [ifarms,"altitude"] ), 0), ")" ),
         paste0( "(", round( sd  ( df  [ifarms,"slope"   ] ), 1), ")" ),
         paste0( "(", round( sd  ( RAIN[ifarms]            ), 0), ")" ),
         paste0( "(", round( sd  ( TEMP[ifarms]            ), 1), ")" ),
         paste0( "(", round( sd  ( Wcap[ifarms]            ), 2), ")" ),
         paste0( "(", round( sd  ( df  [ifarms,"C.soil"  ] ), 1), ")" ),
         paste0( "(", round( sd  ( df  [ifarms,"N.soil"  ] ), 1), ")" ) ) )
    return( farm.env )
  }

  table_CG.env <- rbind(
    f.env( df_C.f, "Costa Rica", "1.2", if_C.type12 ),
    f.env( df_C.f, ""          , "2.4", if_C.type24 ),
    f.env( df_C.f, ""          , "3.2", if_C.type32 ),
    f.env( df_C.f, ""          , "4.3", if_C.type43 ),
    f.env( df_G.f, "Guatemala" , "1.3", if_G.type13 ),
    f.env( df_G.f, ""          , "2.4", if_G.type24 ),
    f.env( df_G.f, ""          , "3.3", if_G.type33 ),
    f.env( df_G.f, ""          , "4.3", if_G.type43 )
  )
  colnames(table_CG.env) <- c("Country","Farms","n","Altitude","Slope",
                              "Rain","Temp","WaterCap","Csoil","Nsoil")
```

```{r}
  f.man <- function( df=df_C.f, country="Costa Rica",
                      type="1.2", ifarms=if_C.type12 ) {
    n.f   <- dim(df)[1]
    yield <- sapply( 1:n.f, function(i){
      mean( df[i,"yield1819"],df[i,"yield1819"], na.rm=T ) } )
    farm.man <- rbind(
      c( country, type,
         round( mean( df   [ifarms,"Nfert"         ] ), 0),
         round( mean( df   [ifarms,"dens_Erythrina"] ), 0),
         round( mean( df   [ifarms,"dens_Inga"     ] ), 0),
         round( mean( df   [ifarms,"dens_Banana"   ] ), 0),
         round( mean( df   [ifarms,"dens_Avocado"  ] ), 0),
         round( mean( df   [ifarms,"dens_Grevillea"] ), 0),
         round( mean( df   [ifarms,"dens_Cordia"   ] ), 0),
         round( mean( df   [ifarms,"shade"         ] ), 2),
         round( mean( yield[ifarms]                  ), 0) ),
      c( "", "",
         paste0( "(", round( sd  ( df   [ifarms,"Nfert"         ] ), 0), ")" ),
         paste0( "(", round( sd  ( df   [ifarms,"dens_Erythrina"] ), 0), ")" ),
         paste0( "(", round( sd  ( df   [ifarms,"dens_Inga"     ] ), 0), ")" ),
         paste0( "(", round( sd  ( df   [ifarms,"dens_Banana"   ] ), 0), ")" ),
         paste0( "(", round( sd  ( df   [ifarms,"dens_Avocado"  ] ), 0), ")" ),
         paste0( "(", round( sd  ( df   [ifarms,"dens_Grevillea"] ), 0), ")" ),
         paste0( "(", round( sd  ( df   [ifarms,"dens_Cordia"   ] ), 0), ")" ),
         paste0( "(", round( sd  ( df   [ifarms,"shade"         ] ), 2), ")" ),
         paste0( "(", round( sd  ( yield[ifarms]                  ), 0), ")" ) ) )
    return( farm.man )
  }

  table_CG.man <- rbind(
    f.man( df_C.f, "Costa Rica", "1.2", if_C.type12 ),
    f.man( df_C.f, ""          , "2.4", if_C.type24 ),
    f.man( df_C.f, ""          , "3.2", if_C.type32 ),
    f.man( df_C.f, ""          , "4.3", if_C.type43 ),
    f.man( df_G.f, "Guatemala" , "1.3", if_G.type13 ),
    f.man( df_G.f, ""          , "2.4", if_G.type24 ),
    f.man( df_G.f, ""          , "3.3", if_G.type33 ),
    f.man( df_G.f, ""          , "4.3", if_G.type43 )
  )
  colnames(table_CG.man) <- c("Country","Farms","N-fert","E","I",
                              "B","A","G","C","Shade","Yield")
```

```{r}
  f.sim <- function( oF=oF1_C, country="Costa Rica",
                     type="1.2", ifarms=if_C.type12 ) {
    n.f  <- dim(oF)[1] ; n.type <- length(oF[ifarms,1])
    yield <- sapply( 1:n.f, function(i){
      mean( oF[i,"harvDM_f_ha1819"],oF[i,"harvDM_f_ha1920"], na.rm=T ) } )
    farm.sim <- rbind(
      c( country, type,
         round( mean( oF   [ifarms,"Shade_fb"      ] ), 2),
         round( mean( yield[ifarms]                  ), 0),
         round( mean( oF   [ifarms,"harvDMST_3_hay"] ), 0),
         round( mean( oF   [ifarms,"harvCPT_f_hay" ] ), 0),
         round( mean( oF   [ifarms,"D_Csoil"       ] ), 0),
         round( mean( oF   [ifarms,"Crunoff_fb"    ] ), 0),
         round( mean( oF   [ifarms,"NfixT_fb"      ] ), 0),
         round( mean( oF   [ifarms,"Nleaching_fb"  ] ), 0),
         round( mean( oF   [ifarms,"Nemission_fb"  ] ), 0) ),
      c( "", "",
         paste0( "(", round( sd( oF   [ifarms,"Shade_fb"      ] ), 2), ")" ),
         paste0( "(", round( sd( yield[ifarms]                  ), 0), ")" ),
         paste0( "(", round( sd( oF   [ifarms,"harvDMST_3_hay"] ), 0), ")" ),
         paste0( "(", round( sd( oF   [ifarms,"harvCPT_f_hay" ] ), 0), ")" ),
         paste0( "(", round( sd( oF   [ifarms,"D_Csoil"       ] ), 0), ")" ),
         paste0( "(", round( sd( oF   [ifarms,"Crunoff_fb"    ] ), 0), ")" ),
         paste0( "(", round( sd( oF   [ifarms,"NfixT_fb"      ] ), 0), ")" ),
         paste0( "(", round( sd( oF   [ifarms,"Nleaching_fb"  ] ), 0), ")" ),
         paste0( "(", round( sd( oF   [ifarms,"Nemission_fb"  ] ), 0), ")" ) ) )
    return( farm.sim )
  }

  tableCG.sim <- rbind(
    f.sim( oF1_C, "Costa Rica", "1.2", if_C.type12 ),
    f.sim( oF1_C, ""          , "2.4", if_C.type24 ),
    f.sim( oF1_C, ""          , "3.2", if_C.type32 ),
    f.sim( oF1_C, ""          , "4.3", if_C.type43 ),
    f.sim( oF1_G, "Guatemala" , "1.3", if_G.type13 ),
    f.sim( oF1_G, ""          , "2.4", if_G.type24 ),
    f.sim( oF1_G, ""          , "3.3", if_G.type33 ),
    f.sim( oF1_G, ""          , "4.3", if_G.type43 )
  )
  colnames(tableCG.sim) <- c("Country","Farms","Shade","Yield","Timber",
                              "Fruit","dC","Crun","Nfix","Nlch","Nem")
```

```{r}
  doF2_C   <- oF2_C - oF1_C ; doF2_C[ oF1_C==0 ] <- NA
  doF2_C.m <- doF2_C.s <- rep(NA,8)
  yv <- "harvDM_f_ha1819" ; yv2 <- "harvDM_f_ha1920"
  ipos        <- which( c( oF2_C[,c(yv,yv2)]) > 0 )
  doF2_C.m[1] <- mean ( c(doF2_C[,c(yv,yv2)])[ipos] ) /
                 mean ( c( oF1_C[,c(yv,yv2)])[ipos] )
  doF2_C.s[1] <- sd   ( c(doF2_C[,c(yv,yv2)])[ipos] ) /
            abs( mean ( c( oF1_C[,c(yv,yv2)])[ipos] ) )
  yv <- "harvDMST_3_hay" ; ipos <- which(  oF2_C[,yv] > 0 )
  doF2_C.m[2] <- mean ( doF2_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF2_C.s[2] <- sd   ( doF2_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "harvCPT_f_hay"  ; ipos <- which(  oF2_C[,yv] > 0 )
  doF2_C.m[3] <- mean ( doF2_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF2_C.s[3] <- sd   ( doF2_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "D_Csoil"        ; ipos <- which(  oF2_C[,yv] > 0 )
  doF2_C.m[4] <- mean ( doF2_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF2_C.s[4] <- sd   ( doF2_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "Crunoff_fb"     ; ipos <- which(  oF2_C[,yv] > 0 )
  doF2_C.m[5] <- mean ( doF2_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF2_C.s[5] <- sd   ( doF2_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "NfixT_fb"       ; ipos <- which(  oF2_C[,yv] > 0 )
  doF2_C.m[6] <- mean ( doF2_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF2_C.s[6] <- sd   ( doF2_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "Nleaching_fb"   ; ipos <- which(  oF2_C[,yv] > 0 )
  doF2_C.m[7] <- mean ( doF2_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF2_C.s[7] <- sd   ( doF2_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "Nemission_fb"   ; ipos <- which(  oF2_C[,yv] > 0 )
  doF2_C.m[8] <- mean ( doF2_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF2_C.s[8] <- sd   ( doF2_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )

  doF3_C   <- oF3_C - oF1_C ; doF3_C[ oF1_C==0 ] <- NA
  doF3_C.m <- doF3_C.s <- rep(NA,8)
  yv <- "harvDM_f_ha1819" ; yv2 <- "harvDM_f_ha1920"
  ipos        <- which( c( oF3_C[,c(yv,yv2)]) > 0 )
  doF3_C.m[1] <- mean ( c(doF3_C[,c(yv,yv2)])[ipos] ) /
                 mean ( c( oF1_C[,c(yv,yv2)])[ipos] )
  doF3_C.s[1] <- sd   ( c(doF3_C[,c(yv,yv2)])[ipos] ) /
            abs( mean ( c( oF1_C[,c(yv,yv2)])[ipos] ) )
  yv <- "harvDMST_3_hay" ; ipos <- which(  oF3_C[,yv] > 0 )
  doF3_C.m[2] <- mean ( doF3_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF3_C.s[2] <- sd   ( doF3_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "harvCPT_f_hay"  ; ipos <- which(  oF3_C[,yv] > 0 )
  doF3_C.m[3] <- mean ( doF3_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF3_C.s[3] <- sd   ( doF3_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "D_Csoil"        ; ipos <- which(  oF3_C[,yv] > 0 )
  doF3_C.m[4] <- mean ( doF3_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF3_C.s[4] <- sd   ( doF3_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "Crunoff_fb"     ; ipos <- which(  oF3_C[,yv] > 0 )
  doF3_C.m[5] <- mean ( doF3_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF3_C.s[5] <- sd   ( doF3_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "NfixT_fb"       ; ipos <- which(  oF3_C[,yv] > 0 )
  doF3_C.m[6] <- mean ( doF3_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF3_C.s[6] <- sd   ( doF3_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "Nleaching_fb"   ; ipos <- which(  oF3_C[,yv] > 0 )
  doF3_C.m[7] <- mean ( doF3_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF3_C.s[7] <- sd   ( doF3_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "Nemission_fb"   ; ipos <- which(  oF3_C[,yv] > 0 )
  doF3_C.m[8] <- mean ( doF3_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF3_C.s[8] <- sd   ( doF3_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )

  doF4_C   <- oF4_C - oF1_C ; doF4_C[ oF1_C==0 ] <- NA
  doF4_C.m <- doF4_C.s <- rep(NA,8)
  yv <- "harvDM_f_ha1819" ; yv2 <- "harvDM_f_ha1920"
  ipos        <- which( c( oF4_C[,c(yv,yv2)]) > 0 )
  doF4_C.m[1] <- mean ( c(doF4_C[,c(yv,yv2)])[ipos] ) /
                 mean ( c( oF1_C[,c(yv,yv2)])[ipos] )
  doF4_C.s[1] <- sd   ( c(doF4_C[,c(yv,yv2)])[ipos] ) /
            abs( mean ( c( oF1_C[,c(yv,yv2)])[ipos] ) )
  yv <- "harvDMST_3_hay" ; ipos <- which(  oF4_C[,yv] > 0 )
  doF4_C.m[2] <- mean ( doF4_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF4_C.s[2] <- sd   ( doF4_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "harvCPT_f_hay"  ; ipos <- which(  oF4_C[,yv] > 0 )
  doF4_C.m[3] <- mean ( doF4_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF4_C.s[3] <- sd   ( doF4_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "D_Csoil"        ; ipos <- which(  oF4_C[,yv] > 0 )
  doF4_C.m[4] <- mean ( doF4_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF4_C.s[4] <- sd   ( doF4_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "Crunoff_fb"     ; ipos <- which(  oF4_C[,yv] > 0 )
  doF4_C.m[5] <- mean ( doF4_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF4_C.s[5] <- sd   ( doF4_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "NfixT_fb"       ; ipos <- which(  oF4_C[,yv] > 0 )
  doF4_C.m[6] <- mean ( doF4_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF4_C.s[6] <- sd   ( doF4_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "Nleaching_fb"   ; ipos <- which(  oF4_C[,yv] > 0 )
  doF4_C.m[7] <- mean ( doF4_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF4_C.s[7] <- sd   ( doF4_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
  yv <- "Nemission_fb"   ; ipos <- which(  oF4_C[,yv] > 0 )
  doF4_C.m[8] <- mean ( doF4_C[,yv][ipos] ) /      mean( oF1_C[,yv][ipos] )
  doF4_C.s[8] <- sd   ( doF4_C[,yv][ipos] ) / abs( mean( oF1_C[,yv][ipos] ) )
```

```{r}
  doF2_G   <- oF2_G - oF1_G ; doF2_G[ oF1_G==0 ] <- NA
  doF2_G.m <- doF2_G.s <- rep(NA,8)
  yv <- "harvDM_f_ha1819" ; yv2 <- "harvDM_f_ha1920"
  ipos        <- which( c( oF2_G[,c(yv,yv2)]) > 0 )
  doF2_G.m[1] <- mean ( c(doF2_G[,c(yv,yv2)])[ipos] ) /
                 mean ( c( oF1_G[,c(yv,yv2)])[ipos] )
  doF2_G.s[1] <- sd   ( c(doF2_G[,c(yv,yv2)])[ipos] ) /
            abs( mean ( c( oF1_G[,c(yv,yv2)])[ipos] ) )
  yv <- "harvDMST_3_hay" ; ipos <- which(  oF2_G[,yv] > 0 )
  doF2_G.m[2] <- mean ( doF2_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF2_G.s[2] <- sd   ( doF2_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "harvCPT_f_hay"  ; ipos <- which(  oF2_G[,yv] > 0 )
  doF2_G.m[3] <- mean ( doF2_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF2_G.s[3] <- sd   ( doF2_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "D_Csoil"        ; ipos <- which(  oF2_G[,yv] > 0 )
  doF2_G.m[4] <- mean ( doF2_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF2_G.s[4] <- sd   ( doF2_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "Crunoff_fb"     ; ipos <- which(  oF2_G[,yv] > 0 )
  doF2_G.m[5] <- mean ( doF2_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF2_G.s[5] <- sd   ( doF2_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "NfixT_fb"       ; ipos <- which(  oF2_G[,yv] > 0 )
  doF2_G.m[6] <- mean ( doF2_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF2_G.s[6] <- sd   ( doF2_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "Nleaching_fb"   ; ipos <- which(  oF2_G[,yv] > 0 )
  doF2_G.m[7] <- mean ( doF2_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF2_G.s[7] <- sd   ( doF2_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "Nemission_fb"   ; ipos <- which(  oF2_G[,yv] > 0 )
  doF2_G.m[8] <- mean ( doF2_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF2_G.s[8] <- sd   ( doF2_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )

  doF3_G   <- oF3_G - oF1_G ; doF3_G[ oF1_G==0 ] <- NA
  doF3_G.m <- doF3_G.s <- rep(NA,8)
  yv <- "harvDM_f_ha1819" ; yv2 <- "harvDM_f_ha1920"
  ipos        <- which( c( oF3_G[,c(yv,yv2)]) > 0 )
  doF3_G.m[1] <- mean ( c(doF3_G[,c(yv,yv2)])[ipos] ) /
                 mean ( c( oF1_G[,c(yv,yv2)])[ipos] )
  doF3_G.s[1] <- sd   ( c(doF3_G[,c(yv,yv2)])[ipos] ) /
            abs( mean ( c( oF1_G[,c(yv,yv2)])[ipos] ) )
  yv <- "harvDMST_3_hay" ; ipos <- which(  oF3_G[,yv] > 0 )
  doF3_G.m[2] <- mean ( doF3_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF3_G.s[2] <- sd   ( doF3_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "harvCPT_f_hay"  ; ipos <- which(  oF3_G[,yv] > 0 )
  doF3_G.m[3] <- mean ( doF3_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF3_G.s[3] <- sd   ( doF3_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "D_Csoil"        ; ipos <- which(  oF3_G[,yv] > 0 )
  doF3_G.m[4] <- mean ( doF3_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF3_G.s[4] <- sd   ( doF3_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "Crunoff_fb"     ; ipos <- which(  oF3_G[,yv] > 0 )
  doF3_G.m[5] <- mean ( doF3_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF3_G.s[5] <- sd   ( doF3_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "NfixT_fb"       ; ipos <- which(  oF3_G[,yv] > 0 )
  doF3_G.m[6] <- mean ( doF3_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF3_G.s[6] <- sd   ( doF3_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "Nleaching_fb"   ; ipos <- which(  oF3_G[,yv] > 0 )
  doF3_G.m[7] <- mean ( doF3_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF3_G.s[7] <- sd   ( doF3_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "Nemission_fb"   ; ipos <- which(  oF3_G[,yv] > 0 )
  doF3_G.m[8] <- mean ( doF3_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF3_G.s[8] <- sd   ( doF3_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )

  doF4_G   <- oF4_G - oF1_G ; doF4_G[ oF1_G==0 ] <- NA
  doF4_G.m <- doF4_G.s <- rep(NA,8)
  yv <- "harvDM_f_ha1819" ; yv2 <- "harvDM_f_ha1920"
  ipos        <- which( c( oF4_G[,c(yv,yv2)]) > 0 )
  doF4_G.m[1] <- mean ( c(doF4_G[,c(yv,yv2)])[ipos] ) /
                 mean ( c( oF1_G[,c(yv,yv2)])[ipos] )
  doF4_G.s[1] <- sd   ( c(doF4_G[,c(yv,yv2)])[ipos] ) /
            abs( mean ( c( oF1_G[,c(yv,yv2)])[ipos] ) )
  yv <- "harvDMST_3_hay" ; ipos <- which(  oF4_G[,yv] > 0 )
  doF4_G.m[2] <- mean ( doF4_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF4_G.s[2] <- sd   ( doF4_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "harvCPT_f_hay"  ; ipos <- which(  oF4_G[,yv] > 0 )
  doF4_G.m[3] <- mean ( doF4_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF4_G.s[3] <- sd   ( doF4_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "D_Csoil"        ; ipos <- which(  oF4_G[,yv] > 0 )
  doF4_G.m[4] <- mean ( doF4_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF4_G.s[4] <- sd   ( doF4_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "Crunoff_fb"     ; ipos <- which(  oF4_G[,yv] > 0 )
  doF4_G.m[5] <- mean ( doF4_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF4_G.s[5] <- sd   ( doF4_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "NfixT_fb"       ; ipos <- which(  oF4_G[,yv] > 0 )
  doF4_G.m[6] <- mean ( doF4_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF4_G.s[6] <- sd   ( doF4_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "Nleaching_fb"   ; ipos <- which(  oF4_G[,yv] > 0 )
  doF4_G.m[7] <- mean ( doF4_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF4_G.s[7] <- sd   ( doF4_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
  yv <- "Nemission_fb"   ; ipos <- which(  oF4_G[,yv] > 0 )
  doF4_G.m[8] <- mean ( doF4_G[,yv][ipos] ) /      mean( oF1_G[,yv][ipos] )
  doF4_G.s[8] <- sd   ( doF4_G[,yv][ipos] ) / abs( mean( oF1_G[,yv][ipos] ) )
```



\clearpage

# Introduction

```{r Maps_CG, out.width="400px", fig.align="center", fig.cap="\\label{Maps_CG}Altitude maps for Costa Rica and Guatemala with locations of the coffee farms."}
  knitr::include_graphics("images/Maps_CG.png")
```

The goal of sustainable agriculture puts multiple demands on coffee agroforestry systems. The productivity of coffee plants and shade trees must be high while minimising negative impacts on the environment. We refer to each form of productivity or environmental impact as an *ecosystem service* (ES). An important issue in the evaluation of coffee agroforestry systems is that many ES are difficult to quantify, which hampers the choice of shade tree species and farm management. This is a particular problem in Central America, where mountainous topography with young volcanic soils leads to strong spatial variation in weather patterns and soil fertility. Together with a wide variation in management choices, this has led to strong variability in productivity. It likely also caused strong variation in environmental ES, but not many data are available for these.\
    Here we used a combination of data analysis and process-based modelling to quantify ES at 89 coffee agroforestry farms in Costa Rica and 79 in Guatemala (Fig. \ref{fig:Maps_CG}). The same farms were studied previously by @Haggar_2021_Shade who found that coffee productivity has no simple relationship with shade. Low-productivity farms tended to have either low or high shade. The measurements at these farms did not include ES related to carbon and nitrogen biogeochemistry. Here we estimated these ES using the new coffee agroforestry model CAF2021, which we introduce in this paper. The model differs from its predecessors CAF2007 [@VanOijen_2010_Coffee] and CAF2014 [@Rahn_2018_Exploring; @Ovalle-Rivera_2020_Assessing] mainly in that it allows for more complex agroforestry systems with up to three different shade tree species. The model simulates a wide range of ES: coffee yield, timber and fruit production by shade trees, soil loss by erosion, soil carbon sequestration, nitrogen fixation, loss of nitrogen in atmospheric emission and leaching. Other process-based models of coffee agroforestry have been developed in recent years [@Charbonnier_2017_Increased; @Vezy_2019_DynACof]. These models focus on plant physiology, and they simulate agronomy and biogeochemistry in less detail than CAF2021, which makes them less suitable to assess a wide range of ES. Details of the structure of CAF2021 are provided in the Materials and Methods section and online.\
    To calibrate CAF2021, we used multivariate data from 32 different treatments applied in long-term field experiments in Costa Rica and Nicaragua. A subset of these data (10 treatments) was used earlier in the Bayesian calibration of CAF2014, a model that could not simulate experimental treatments with multiple shade tree species. Bayesian calibration has become a common method for model calibration and uncertainty quantification of process-based models [@VanOijen_2020_Bayesian]. Here we use the same method of Bayesian model calibration by means of Markov chain Monte Carlo sampling that was used by @Ovalle-Rivera_2020_Assessing.\
    The goals of this study were threefold:

- 1: Identifying the drivers of observed differences in productivity between farms and farm types.
- 2: Assessing the implications of aiming for any particular farm type for biogeochemistry-related ecosystem services and sustainability.
- 3: Assessing CAF2021 as a tool for studying coffee agroforestry systems.



\clearpage

# Materials and methods


## Data from experiments at Turrialba and Masatepe
For model calibration, we used data from two long-term coffee agroforestry experiments at Turrialba in Costa Rica and Masatepe in Nicaragua. The experiments differed in various respects: choice of coffee cultivar and shade tree species, shade management, fertiliser types and amounts, weather conditions and soil properties. In both experiments, four fertilisation regimes were combined with different choices of one or two shade tree species, selected from *Erythrina poeppigiana*, *Terminalia amazonia*, *Chloroleucon eurycyclum*, *Samanea saman*, *Tabebuia rosea*, *Simarouba glauca*, *Inga laurina*. Both experiments provided data on coffee, shade trees and soil, as reported by @Haggar_2011_Coffee, @Noponen_2012_Carbon, @Noponen_2013_Sink, @Sepulveda_2016_Efecto and @Ovalle-Rivera_2020_Assessing. We refer to these publications and to the Supplementary Information (S2) for further details.


## Data from farms in Costa Rica and Guatemala
We used data from 89 coffee agroforestry farms in Costa Rica and from 79 farms in Guatemala. The data had been collected within project SEACAF [@Haggar_2021_Shade]. In the present study, these data are used for independent testing of CAF2021 without any farm-specific model calibration. The farm locations are shown in Fig. \ref{fig:Maps_CG}. 

```{r}
  knitr::kable( table_CG.env, caption="Environmental conditions at four farm types in Costa Rica and Guatemala. First digit of farm type indicates productivity, the second shading level, both from 1=low to 4=high. Variables: altitude (m), slope (degrees), rain (mm y-1), temperature (degrees C), soil water holding capcity (-), soil carbon and nitrogen (kg m-2). Within brackets: standard deviation across farms." )
```

The table above summarises the environmental conditions at the farms grouped according to the typology of @Haggar_2021_Shade. The table includes average temperature and precipitation, but for running CAF2021 full time series of daily weather from 2005 to 2020 were derived from the WorldClim database with additional information for recent years from weather stations run by Icafe and IMN in Costa Rica and by Anacafe in Guatemala. Soil water holding capacity was derived from soil texture information (bulk density, silt, clay) using a pedotransfer function tested for tropical soils [@Tomasella_2003_Comparison; @Tomasella_2004_Pedotransfer]. To calculate soil stocks of carbon and nitrogen from the SEACAF database values, we assumed that soil layers below 28 cm depth contained soil organic matter equivalent to 20% of the farm's top soil.

```{r}
  knitr::kable( table_CG.man, caption="Management and coffee yield at four farm types in Costa Rica and Guatemala. Variables: N-fertilisation rate (kg ha-1 y-1), density of shade trees (ha-1; E=Erythrina, I=Inga, B=Banana, A=Avocado, G=Grevillea, C=Cordia), overall shade level (-) and coffee yield 2018-2020 (kg DM ha-1 y-1). Within brackets: standard deviation." )
```

The second table with farm properties shows management choices for fertilisation and shading, and coffee yield. Some farms had reported implausibly high fertilisation rates which we capped at 500 kg N ha-1 y-1. We allocated farm-specific tree density data to the six type-species listed in the table. Tree pruning and thinning regimes were not reported but had to be specified for running CAF2021. Trees were assumed to be pruned once per year, targeting each farm's reported shade level, except for Erythrina which in Central America tends to follow a prescribed twice-yearly 90% pruning regime. Tree thinning was only applied to Cordia following a prescribed calendar. Pruned leaves and branches were removed from the field in Guatemala while remaining on the field in Costa Rica. Dry coffee bean yield was calculated as one third of reported fresh yield [@Sepulveda_2016_Efecto].


## CAF2021 structure
CAF2021 is a process-based model for the biogeochemistry of coffee agroforestry systems. We give a short description here, focusing on how the model differs from its predecessor models. The model and a user guide are freely available online (https...).

CAF2021 simulates a coffee agroforestry system where the coffee plants are shaded by up to 3 tree species. The model allows for two lower-layer tree species, but no more than one upper-layer tree species. In typical use of the model the upper layer would be occupied by timber trees and the lower layer by service and fruit trees. The simulated tree species can have different initial planting densities and thinning regimes. The model simulates the biogeochemistry - flows of carbon, nitrogen and water - of the soil-coffee-trees system. State variables are pools of carbon, nitrogen and water as well as coffee developmental stage. Height and crown area growth are simulated for each of the tree species. The model uses a daily time step and therefore requires daily weather data (light, temperature, rain, wind, humidity) as input. Further required inputs are atmospheric [$CO_2$], soil properties (slope, water retention parameters, initial contents of C and N) and management calendars for fertilisation, pruning and thinning. The pruning and thinning calendars can be specified separately for each plant species.

The outputs from the model are time series with daily values of state variables and processes including ecosystem services such as productivity of coffee and trees, N-leaching, N-emission, erosion in the form of soil organic matter loss (C & N) in run-off, C-sequestration in the soil.

The model is implemented in FORTRAN but called from a user-interface written in R.

CAF2021 differs from its predecessor models in the following respects:

- There can be three tree species present rather than just one. All tree variables are implemented as dynamic arrays whose length equals the number of tree species. Users with experience in programming can therefore relatively easily extend the number of shade tree species beyond three.
- Fruit production can be simulated.
- Lower-layer trees do not overlap, so the number of ground-cover conditions (vertical vegetation profiles) in any simulated field is at most six: coffee shaded by (1) no trees, (2) service trees, (3) fruit trees, (4) timber trees, (5) service + timber trees, (6) fruit + timber trees. The model keeps track of the fractional ground area covered by each of these six categories (see Supplementary Information S1 for an example).
- The relative heights, LAI values and light extinction coefficients of the two tree species within ground cover categories (5) and (6) determine their access to light.
- Morphology is simulated using allometric equations but for each species a genetic or management-induced maximum height can be specified.
- Shade management can be fully specified using calendars for dates and intensities of pruning and thinning. Alternatively, it may be simulated as being goal-directed toward a specified shade level.

Time series for selected output variables from CAF2021 are shown in the Supplementary Information (S1 and S3).


## Bayesian calibration of CAF2021
We calibrated the parameters of CAF2021 using a Bayesian approach to allow for uncertainty quantification. Data from the two long-term experiments in Turrialba and Masatepe that we described above were used for this purpose. These measurements were suitable for calibration of a complex model such as CAF2021 because they comprised a wide range of coffee, tree and soil variables. This reduced the risk of tuning the model to one variable such as coffee yield production at the cost of poor simulation of other system processes.\
    For the calibration of CAF2021, we used data from 18 Turrialba treatments and 14 Nicaragua treatments. Some of these data had been used for Bayesian calibration of the predecessor model CAF2014 by @Ovalle-Rivera_2020_Assessing, but that model was limited to treatments with no more than one tree species, so only six of the treatments from Turrialba and four from Masatepe could be used by them. In other respects we followed their implementation of Bayesian calibration.\
    We carried out a single multi-site, multi-treatment Bayesian calibration of CAF2021, using Markov Chain Monte Carlo sampling (MCMC) with a chain length of 60,000. At each iteration of the chain the model was run for all 32 treatments, so a total of 1.92 million runs was carried out during the MCMC. The calibration provided samples from the posterior distribution for 65 of the model's parameters:

- *universal* parameters (n=45) that were not allowed to vary between the treatments,
- *site-specific* parameters (n=5) that were allowed to differ between Turrialba and Masatepe,
- *tree-species specific* parameters (n=15).

The universal parameters included all 23 calibrated coffee parameters, thus ignoring any differences between cultivars in Turrialba and Masatepe. Also treated as universal were 15 tree parameters and 7 soil parameters. The motivation for treating so many parameters as universal (which in reality may show variation) was to maintain a degree of universal applicability of the model, and to constrain the need for site- or tree-specific information in future applications of the model. The 5 site-specific parameters were soil parameters governing nitrogen leaching, organic matter composition and turnover. Making these parameters site-specific allowed simulation of the greater capacity of soils in Masatepe to stabilise organic matter and minerals [@Noponen_2012_Carbon]. The 15 tree-species specific parameters were predominantly parameters for carbon allocation and morphology. All parameters were a priori assigned wide beta probability distributions, reflecting large prior uncertainty about plausible parameter values for the largely new model CAF2021.


## CAF2021 application to farms Costa Rica and Guatemala
We used CAF2021 to simulate measured and unmeasured ecosystem services for each of the 168 farms in Costa Rica and Guatemala, using their environmental conditions (Table 1) and management choices (Table 2) as model inputs. All parameters for coffee and for Erythrina and Inga trees were left at the values determined by Bayesian calibration using data from the long-term experiments at Turrialba and Masatepe. Parameter values for tree species not present in the experiments were taken from the literature on banana [@Damour_2012_Simulation; @ChavesC._2009_Modeling; @VanDenBergh_2012_Climate; @Mustaffa_2012_Banana; @MartinezAcosta_2011_Dinamica; @Schaffer_1999_Atmospheric], avocado [@CIRAD_2019_Country; @Elzebroek_2008_Guide; @Monzon-Martinez_2019_Perfil], Grevillea [@Castellanos_2010_Estudio] and Cordia [@VanOijen_2010_Coffeea; @Castellanos_2010_Estudio].\
    Planting dates were not recorded in the farms database but coffee stands were generally mature and we simulated the years 2005-2020 for each farm. The only differences between Costa Rica and Guatemala in our model set-up were conform local practice: (1) pruned branches were removed in Guatemala but left on the field in Costa Rica, (2) the height of some tree species was differently managed.


### Analysis of sensitivity to management
Besides the regular simulations for each farm, which used the observed and reported local conditions, we made two additional model runs to test farm sensitivity to management choices. In the first of these, we halved each farm's fertilisation rate. In the second, we halved tree densities and shade target.  


  
\clearpage

# Results


## Bayesian calibration on data from experiments in Turrialba and Masatepe

```{r, fig.height=3, fig.cap="\\label{fig:yObsSim}Observed vs. simulated coffee yields. Left: calibration experiments in Turrialba (n=18) and Masatepe (n=14). Middle: farms in Costa Rica (n=89). Right: farms in Guatemala (n=79)."}
  par( mfrow=c(1,3), mar=c(2,2,2,2), pty="s" )

  sim_T.min  <- min( y_T[,"Y.sim"] ) ; sim_M.min  <- min( y_M[,"Y.sim"] ) 
  sim_T.max  <- max( y_T[,"Y.sim"] ) ; sim_M.max  <- max( y_M[,"Y.sim"] )
  obs_T.max  <- max( y_T[,"Y.obs"] ) ; obs_M.max  <- max( y_M[,"Y.obs"] )
  simobs.max <- max( sim_T.max, sim_M.max, obs_T.max, obs_M.max )
  plot( y_T[,"Y.sim"], y_T[,"Y.obs"],
        main="Coffee (kg DM ha-1 y-1)\nTurrialba, Masatepe",
        xlab="Sim. yield (kg ha-1)", ylab="",
        xlim=c(0,simobs.max), ylim=c(0,simobs.max),
        cex.main=1, type="n", asp=1 )
  text( y_T[,"Y.sim"], y_T[,"Y.obs"], labels=y_T[,"Site"], cex=0.8 )
  y_T.lm <- lm(y_T[,"Y.obs"]~y_T[,"Y.sim"])
  r2_T   <- signif( summary(y_T.lm)$r.squared, 2 )
  clip( sim_T.min,sim_T.max,0,simobs.max )
  abline( y_T.lm$coefficients[1], y_T.lm$coefficients[2] )
  
  points( y_M[,"Y.sim"], y_M[,"Y.obs"],
          cex.main=1, type="n", asp=1 )
  text( y_M[,"Y.sim"], y_M[,"Y.obs"], labels=y_M[,"Site"], cex=0.8, col="red" )
  y_M.lm <- lm(y_M[,"Y.obs"]~y_M[,"Y.sim"])
  r2_M   <- signif( summary(y_M.lm)$r.squared, 2 )
  clip  ( sim_M.min,sim_M.max,0,simobs.max )
  abline( y_M.lm$coefficients[1], y_M.lm$coefficients[2], col="red" )
  
  # abline(0,1,lty=2)
  clip  ( -1e9,1e9,-1e9,1e9 )
  legend( "bottomright",
          legend=c(paste("T: r2= ",as.character(r2_T)),
                   paste("M: r2= ",as.character(r2_M)) ),
          col=c("black","red"), lty=c(1,1), cex=0.7 )

  sim_C <- c( oF1_C[,"harvDM_f_ha1819"], oF1_C[,"harvDM_f_ha1920"] )
  sim_G <- c( oF1_G[,"harvDM_f_ha1819"], oF1_G[,"harvDM_f_ha1920"] )
  obs_C <- c( df_C.f$yield1819         , df_C.f$yield1920          )
  obs_G <- c( df_G.f$yield1819         , df_G.f$yield1920          )
  
  sim_C.min  <- min( sim_C )          ; sim_G.min  <- min( sim_G ) 
  sim_C.max  <- max( sim_C )          ; sim_G.max  <- max( sim_G )
  obs_C.max  <- max( obs_C, na.rm=T ) ; obs_G.max  <- max( obs_G, na.rm=T )
  simobs_C.max <- max( sim_C.max, obs_C.max )
  simobs_G.max <- max( sim_G.max, obs_G.max )
  
  plot( sim_C, obs_C,
        main="Coffee (kg DM ha-1 y-1)\nCosta Rica",
        xlab="Sim. yield (kg ha-1)", ylab="",
        xlim=c(0,simobs_C.max), ylim=c(0,simobs_C.max),
        cex.main=1, asp=1 )
  y_C.lm <- lm( obs_C ~ sim_C )
  r2_C   <- signif( summary(y_C.lm)$r.squared, 2 )
  clip( sim_C.min,sim_C.max,0,simobs_C.max )
  abline( y_C.lm$coefficients[1], y_C.lm$coefficients[2] )
  # abline(0,1,lty=2)
  clip  ( -1e9,1e9,-1e9,1e9 )
  legend( "topleft",
          legend=paste("C: r2= ",as.character(r2_C)),
          lty=1, cex=0.7 )

  plot( sim_G, obs_G,
        main="Coffee (kg DM ha-1 y-1)\nGuatemala",
        xlab="Sim. yield (kg ha-1)", ylab="",
        xlim=c(0,simobs_G.max), ylim=c(0,simobs_G.max),
        cex.main=1, asp=1 )
  y_G.lm <- lm( obs_G ~ sim_G )
  r2_G   <- signif( summary(y_G.lm)$r.squared, 2 )
  clip( sim_G.min,sim_G.max,0,simobs_G.max )
  abline( y_G.lm$coefficients[1], y_G.lm$coefficients[2] )
  # abline(0,1,lty=2)
  clip  ( -1e9,1e9,-1e9,1e9 )
  legend( "topleft",
          legend=paste("G: r2= ",as.character(r2_G)),
          lty=1, cex=0.7 )
```

Bayesian calibration generates a sample from the joint posterior probability distribution for all calibrated parameters. The MAP is the '*Maximum A Posteriori*' parameter vector, i.e. the model parameterisation that achieves the highest value for the product of prior (beta distributions for parameters) and likelihood (fit to data) [@Ovalle-Rivera_2020_Assessing; @VanOijen_2020_Bayesian]. The left panel of Fig. \ref{fig:yObsSim} shows observed coffee productivity in the 32 treatments against MAP-simulated yield. The yield values are averages over the years 2002-2017 for Turrialba and 2004-2013 for Masatepe. The model run with the MAP parameter vector accounts for 34% of observed variation in yield across the Turrialba treatments, and 66% of variation at Masatepe. Other measured variables were simulated with similar accuracy (see Supplementary Information).

Posterior parameter uncertainty was small, with an average coefficient of variation of 5%. However, each model output depends on multiple parameters, and output uncertainty for individual variables (coffee yield, soil carbon sequestration, nitrogen leaching) was 30-36%. These are predictive uncertainties for model application to a single set of conditions and do not apply to trends across treatments.


## CAF2021 outputs for farm types in Costa Rica and Guatemala
CAF2021 accounted for 36% of observed variation in coffee yields for the farms in Costa Rica (middle panel of Fig. \ref{fig:yObsSim}), which compares well with the variation accounted for in the Costa Rican long-term experiment at Turrialba (left panel), especially given the fact that the farm simulations were not calibrated. The results for the Guatemalan farms were less good, with only 15% of yield variation accounted for (right panel). 

```{r table.sim}  
  knitr::kable( tableCG.sim, caption="Farms in Costa Rica and Guatemala: Simulations of shade (-), yield of coffee, timber and fruit (kg DM ha-1 y-1), soil carbon change and carbon run-off (kg C ha-1 y-1), N-fixation, leaching and emission (kg N ha-1 y-1)." )
```

Table 3 summarises the farm simulations for coffee yield and seven other ecosystem services grouped by farm type conform @Haggar_2021_Shade. The model correctly identified farm types 1.2/3 and 2.4 as much lower-yielding in both countries than farm types 3.2/3 and 4.3 (Table 2). However, the model was unable to explain the very high yield difference that was observed between the two highest-yielding types in Guatemala, which were 2334 and 5433 kg ha-1 y-1 of bean dry matter for 3.3 and 4.3 respectively, whereas the simulations were 2963 and 2785 kg ha-1 y-1. The very similar yields in these simulations are consistent with these farm types having similar environmental conditions (Table 1), shading and fertilisation (Table 2).

The CAF2021 simulations of Table 3 suggest that there were trade-offs between coffee yield and other ecosystem services. In Costa Rica, farm types with high coffee yield also had high fruit yields but produced less timber and had higher levels of nitrogen leaching and emission. In Guatemala, the trade-offs were less marked apart from high N-emission rates in high-yielding farm types. 

To determine whether the trade-offs were driven by management choices we plotted the simulated ecosystem services at each farm against its level of N-fertilisation (Fig. \ref{fig:FarmSimNfert}) and shading (Fig. \ref{fig:FarmSimShade}). The results suggest that ecosystem services other than timber production were more strongly determined by level of fertilisation than by level of shading. Fertilisation had the expected effects of increasing leaching and emission but it also led to less erosion as measured by soil carbon loss in run-off. Coffee yields were more related to fertilisation level in Costa Rica than in Guatemala. This reflects the wider range and twice as high average level of fertilisation in Costa Rica (Table 2).

```{r}
  plotimpacts_CG <- function( FC=oF1_C, FG=oF1_G, xvar="Nfert",
                              yvar="y.sim", yvar2=NULL,
                              title="Yield", legpos="topleft", ... ){
    xC <- df_C.f[,xvar] ; xG <- df_G.f[,xvar]
    yC <- FC    [,yvar] ; yG <- FG    [,yvar]
    nC <- dim(FC)[1]    ; nG <- dim(FG)[1]
    if(!is.null(yvar2)) {
      yC <- sapply(1:nC, function(i){
        mean( FC[i,"harvDM_f_ha1819"], FC[i,"harvDM_f_ha1920"], na.rm=T ) } )
      yG <- sapply(1:nG, function(i){
        mean( FC[i,"harvDM_f_ha1819"], FC[i,"harvDM_f_ha1920"], na.rm=T ) } ) 
    }
    plot  ( xC, yC,
      ylab="",
      main=title,
      pch=1,
      xlim=c( min(xC,xG        ), max(xC,xG        )),
      ylim=c( min(yC,yG,na.rm=T), max(yC,yG,na.rm=T)), ... )
    points( xG, yG, pch=20, col="red"  )
    
    y.lm_C <- lm( yC ~ xC ) ; y.lm_G <- lm( yG ~ xG )
    r2_C   <- round( summary(y.lm_C)$r.squared, 2 )
    r2_G   <- round( summary(y.lm_G)$r.squared, 2 )
    abline( y.lm_C$coefficients[1], y.lm_C$coefficients[2], col="black" )
    abline( y.lm_G$coefficients[1], y.lm_G$coefficients[2], col="red" )
    legend( legpos, title="r2",
            legend=c( paste("C:",as.character(r2_C)),
                      paste("G:",as.character(r2_G)) ),
            col=c("black","red"), lty=c(1), cex=0.5, bg="transparent" )
  }
```

```{r FarmSimNfert, fig.height=3.5, fig.cap="\\label{fig:FarmSimNfert}Simulations of ecosystem services at farms in Costa Rica (black) and Guatemala (red). All plots are against N-fertilisation level (kg N ha-1 y-1)."}
  par( mfrow=c(2,4), mar=c(2,2,2,1), mgp=c(2,1,0) )

  yv <- "harvDM_f_ha1819" ; yv2 <- "harvDM_f_ha1920"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="Nfert", yvar=yv, yvar2=yv2,
                   xlab="", xaxt="n", legpos="bottomright", title="Yield" )
  yv <- "harvDMST_3_hay"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="Nfert", yvar=yv,
                   xlab="", xaxt="n", legpos="topright"   , title="Timber" )
  yv <- "harvCPT_f_hay"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="Nfert", yvar=yv,
                   xlab="", xaxt="n", legpos="topleft"    , title="Fruit" )
  yv <- "D_Csoil"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="Nfert", yvar=yv,
                   xlab="", xaxt="n", legpos="bottomright",title="C-change" )
  yv <- "Crunoff_fb"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="Nfert", yvar=yv,
                   xlab="N-fert."   , legpos="topright"   , title="C-runoff" )
  yv <- "NfixT_fb"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="Nfert", yvar=yv,
                   xlab="N-fert."   , legpos="topleft"    , title="N-fixation" )
  yv <- "Nleaching_fb"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="Nfert", yvar=yv,
                   xlab="N-fert."   , legpos="topleft"    , title="N-leaching" )
  yv <- "Nemission_fb"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="Nfert", yvar=yv,
                   xlab="N-fert."   , legpos="topleft"    , title="N-emission" )
```

```{r FarmSimShade, fig.height=3.5, fig.cap="\\label{fig:FarmSimShade}Simulations of ecosystem services at farms in Costa Rica (black) and Guatemala (red). All plots are against level of shading (-)."}
  par( mfrow=c(2,4), mar=c(2,2,2,1), mgp=c(2,1,0) )

  yv <- "harvDM_f_ha1819" ; yv2 <- "harvDM_f_ha1920"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="shade", yvar=yv, yvar2=yv2,
                   xlab="", xaxt="n", legpos="topleft", title="Yield" )
  yv <- "harvDMST_3_hay"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="shade", yvar=yv,
                   xlab="", xaxt="n", legpos="topleft"    , title="Timber" )
  yv <- "harvCPT_f_hay"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="shade", yvar=yv,
                   xlab="", xaxt="n", legpos="topright"   , title="Fruit" )
  yv <- "D_Csoil"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="shade", yvar=yv,
                   xlab="", xaxt="n", legpos="bottomright",title="C-change" )
  yv <- "Crunoff_fb"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="shade", yvar=yv,
                   xlab="N-fert."   , legpos="topleft"    , title="C-runoff" )
  yv <- "NfixT_fb"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="shade", yvar=yv,
                   xlab="N-fert."   , legpos="topleft"    , title="N-fixation" )
  yv <- "Nleaching_fb"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="shade", yvar=yv,
                   xlab="N-fert."   , legpos="topright"   , title="N-leaching" )
  yv <- "Nemission_fb"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="shade", yvar=yv,
                   xlab="N-fert."   , legpos="topright"   , title="N-emission" )
```


## Sensitivity to management
The analyses of Figures \ref{fig:FarmSimNfert} and \ref{fig:FarmSimShade} show generally fairly weak correlations of the driving variables with the ecosystem variables. This was partly because of confounding of the many environmental and management differences between the farms. To highlight the effects of fertilisation and shading, we therefore carried out a sensitivity analysis where for each farm all conditions were kept the same apart from halving either fertilisation or shading. The results of this analysis are shown in Fig. \ref{fig:dES}. This shows that halving fertilisation is expected to reduce coffee yields, carbon sequestration, N-leaching and emission, while increasing (in Costa Rica) erosion through run-off. Halving shading also increases run-off but otherwise has very different effects: it increases coffee yield and reduces ES closely associated with trees (production of timber and fruit, N-fixation).

```{r dES, fig.height=5, fig.align="center", out.width="80%", fig.cap="\\label{fig:dES}Changes in ecosystem services when fertilisation or shading is halved. 1:3 = yield of coffee, timber, fruit; 4 = soil carbon sequestration; 5 = erosive soil carbon loss in run-off; 6 = N-fixation; 7:8 = loss of N in leaching and emission. All changes are normalised to the country average."}
  par( mfrow=c(2,1), mar=c(4,2,4,2) )
  names.dES <- c( 1:8, "", "", 1:8  )

  nsp <- 10
  barplot( as.matrix( c( doF3_C.m, 0, 0, doF4_C.m) ),
           main=paste0("COSTA RICA\n",
             "Fertilisation 50%                             Shading 50%"),
           col= c( rep("grey30",10), rep("grey90",8) ),
           beside=T,
           names.arg=names.dES, cex.names=0.8 )

  barplot( as.matrix( c( doF3_G.m, 0, 0, doF4_G.m) ),
           main=paste0("GUATEMALA\n",
             "Fertilisation 50%                             Shading 50%"),
           col= c( rep("grey30",10), rep("grey90",8) ),
           beside=T,
           names.arg=names.dES, cex.names=0.8 )
```



\clearpage

# Discussion


## Bayesian calibration on data from experiments
We carried out a single Bayesian calibration - for all treatments in Turrialba and  Masatepe simultaneously - to derive parameter estimates. All coffee parameters were treated as being universally applicable, and common tree species were also assumed to have the same properties in both experiments. The only experiment- and thus country-specific parameters in the calibration were five soil properties. Variation within experiments was ignored altogether. In reality, there may have been genetic and environmental variation in and between the experiments. Disregarding such plot and block effects may have hampered model fit but ensured that the model was not overfit to noise. Moreover, the calibration was simultaneously to measurements of multiple variables, so model outputs were not optimised for any single variable such as coffee yield. Despite all these restrictions, the calibrated model accounted for 34% of observed coffee yield variation between treatments at Turrialba and 66% at Masatepe. This compares favourably with linear regression of yield on fertilisation level in the experiments for which the $r^2$ was only 0.23.\
    These results suggest that the model can be a useful tool for analysing differences in system performance between different environmental conditions. However, this does not imply that the model is a good tool for forecasting the benefits of agroforestry at any individual site, as posterior output uncertainty (driven by posterior parameter uncertainty) was high at 30-36%. 


## Farm simulations
After the Bayesian calibration on the data from the two experiments, no further calibration of CAF2021 was carried out. The application to farms in Costa Rica and Guatemala thus constituted an independent test of the predictive capacity of the model. This test was restricted to coffee yield as data from other ecosystem services were not available. Coffee yields on Costa Rican farms were simulated reasonably well ($r^2 = 0.36$), but yields on Guatemalan farms were not ($r^2 = 0.15$).\
    One possible explanation for the mixed performance of the model is the use of parameter values calibrated on data from just two experiments. The experiments may have been more representative of plant properties and environmental conditions in Costa Rica than in Guatemala. It would have been possible to calibrate the model on a subset of reported yields but the model would then be tuned as a coffee yield prediction tool to the possible detriment of predictive capacity for other ecosystem services. It is therefore of importance to find rich local data sets, with measurements of a variety of coffee, tree and soil variables, before adding a second Bayesian calibration.\
    A second possible explanation for uneven model performance is the greater variation in environmental conditions in Guatemala compared to Costa Rica, as measured by the larger standard deviations for temperature, precipitation and altitude (Table 1). In the simulations, all parameters for coffee and tree morphology and physiology were kept at the same values for all 168 farms (89 in Costa Rica and 79 in Guatemala). Any genetic differences between coffee- and tree-varieties were thus ignored. The only tree-parameter differences accounted for were the farm-specific initial densities of shade trees. Disregarding inter-farm variability in this way may have affected simulations in Guatemala the most because of its greater variation in growing conditions.\
    A third possible explanation for poor predictive capacity of the model is errors in data. In particular, the observation that coffee yields in Guatemala were on average 2.3 times higher on farms of type 4.3 than on those of type 3.3, despite similar environmental conditions and levels of fertilisation, was surprising. This observation could not be reproduced by the model without reparameterisation and warrants empirical confirmation. The farms of type 4.3 had low densities of Inga trees (Table 2), so it is unlikely that nitrogen fixation explained their yield advantage. The soils of these farms also did not have higher nitrogen contents (Table 1), nor did they have higher mineralisation rates (L. Büchi, pers. comm.).


## Analysis of ecosystem services
Except for farm type 4.3, the observed and simulated coffee yields were higher in Costa Rica than in Guatemala, which matches the about twice as high fertilisation rates in Costa Rica (Tables 2 and 3). The simulations suggest that the higher fertilisation in Costa Rica also stimulated carbon sequestration, nitrogen leaching and emission (Fig. \ref{fig:FarmSimShade}). Other differences between the countries, such as production of more fruit but less timber in Costa Rica, were the result of different choices of shade tree species and planting density rather than differential impacts of fertilisation on tree species (Tables 2 and 3).\
    The model points to inevitable trade-offs between productivity of coffee, productivity of trees and environmental ecosystem services. Changing the level of fertilisation or shading can benefit some ecosystem services but always to the detriment of others. This was apparent from the farm simulations shown in Figures \ref{fig:FarmSimNfert} and \ref{fig:FarmSimShade}, but was highlighted most clearly in the sensitivity analysis presented in Fig. \ref{fig:dES}. The benefits from fertilisation for yield and carbon sequestration must be balanced against the costs associated with increased nitrogen leaching and emission. Likewise the benefits for coffee yield of removing shading must be balanced against the associated losses in tree production (fruit, timber) and carbon sequestration as well as the reduced protection against erosion.\
    The focus of CAF2021 is on biogeochemistry, and the effects of fertilisation on processes in soils, coffee plants and trees are simulated in considerable detail. However, the effects of shading on the coffee agroforestry system are manifold and complex, and are not simulated fully by CAF2021. The model does account for shade trees lowering temperature below them (impacting coffee plant physiology) as well as competing with the coffee plants for light, water, and nitrogen. But the model does not represent other organisms and thus does not simulate how shade supports biodiversity and constrains pests and diseases. Decision support for such non-biogeochemical ecosystem services would thus require a different model.



\clearpage

# Conclusions

Returning to the three goals of this paper, we conclude:

- Variation in fertilisation and shading drives differences in productivity between farms and farm types.
- Inevitable trade-offs between ecosystem services imply that no single farm type can be considered as generally optimal.
- CAF2021 is a useful a tool for studying biogeochemistry-related ecosystem services in complex coffee agroforestry systems.



\clearpage

# Supplementary information {-}


## S1. Output variables simulated by CAF2021 {-}

In standard use, CAF2021 simulates 169 output variables to quantify the dynamics of coffee plants, trees and soil. Fig. \ref{fig:exG} shows time series for a small selection.

```{r exG, fig.height=5.5, fig.cap="\\label{fig:exG}Selected output variables simulated by a single run of CAF2021 for Guatemala farm 79. Top row: field average soil content of C, N, water. Rows 2-3: area of coffee shaded by (1) no trees, (2) service trees, (3) fruit trees, (4) timber trees, (5) service + timber trees, (6) fruit + timber trees. Row 4-5: crown area and height of service, fruit and timber trees. Row 6: overall shade and coffee yield."}
  plot_output_mod <- function(
    list_output = list(output),
    vars        = outputNames[-(1:3)],
    leg         = paste( "Run", 1:length(list_output) ),
    leg_title   = "LEGEND",
    nrow_plot   = ceiling( sqrt((length(vars)+1) * 8/11) ),
    ncol_plot   = ceiling( (length(vars)+1)/nrow_plot ),
    lty         = rep(1,length(list_output)),
    lwd         = rep(3,length(list_output)) ) {
    if (!is.list(list_output)) list_output <- list(list_output)
      nlist    <- length(list_output)
      col_vars <- match(vars,outputNames)
      nvars    <- length(vars)
      for (iv in 1:nvars) {
        c       <- col_vars[iv]
        g_range <- range( sapply( 1:nlist, function(il){range(list_output[[il]][,c])} ) )
        plot( list_output[[1]][,1], list_output[[1]][,c],
              xlab="", ylab="", cex.main=1,
              main=paste(outputNames[c]," ",outputUnits[c],sep=""),
              type='l', col=1, lty=lty[1], lwd=lwd[1], ylim=g_range )
        if (nlist >= 2) {
          for (il in 2:nlist) {
            points( list_output[[il]][,1], list_output[[il]][,c],
                    col=il, type='l', lty=lty[il], lwd=lwd[il] )
          }
        }
      }
    }

  par( mfrow=c(6,3), mar=c(2, 2, 2, 1) )

  plot_output_mod( outF, vars= c( "Csoil_f", "Nsoil_f", "WA_f",
                                  paste0("Ac(",1:6,")"),
                                  paste0("CAtree_t(",1:3,")"),
                                  paste0("h_t(",1:3,")"),
                                  "Shade_f", "harvDM_f_hay" ) )
```


\clearpage

## S2. Experimental treatments at Turrialba and Masatepe {-}

CAF2021 was calibrated on data from 32 treatments applied in long-term experiments at Turrialba (Costa Rica) and Masatepe (Nicaragua). The following table shows the combinations of shading and fertilisation that were applied. For more details on the experiments, see @Haggar_2011_Coffee, @Noponen_2012_Carbon, @Noponen_2013_Sink, @Sepulveda_2016_Efecto and @Ovalle-Rivera_2020_Assessing.

```{r}
  Turrialba_trees <- c( rep("E" ,4), rep("T" ,4), rep("C" ,2),
                        rep("TE",2), rep("CE",4), rep("-" ,2) )
  fert4 <- c("CI","CM","OI","OM") ; fert2a <- c("CI","CM") ; fert2b <- c("CM","OI")
  Turrialba_fert  <- c( rep(fert4,2), rep(fert2b,2), fert4, fert2a )
                        
  Masatepe_trees <- c( rep("-"    ,2), rep("SSTR" ,2), rep("SGTR" ,4),
                       rep("ILSS" ,4), rep("ILSG" ,2), rep(NA,4)  )
  Masatepe_fert  <- c( fert2a, fert2b, rep(fert4,2), fert2b, rep(NA,4) )

  options(knitr.kable.NA = '')
  knitr::kable( cbind( 1:18, Turrialba_trees, Turrialba_fert,
                       rep(NA,18), 
                       c(19:32,rep(NA,4)), Masatepe_trees, Masatepe_fert ),
                col.names=c("TURRIALBA","Shade","Fertil.","",
                            "MASATEPE","Shade","Fertil."),
                caption="Long-term experiments in Turrialba (treatments 1:18)
                and Masatepe (treatments 19:32).
                  Shade trees: E = \\textit{Erythrina poeppigiana},
                               T = \\textit{Terminalia amazonia},
                               C = \\textit{Chloroleucon eurycyclum},
                              SS = \\textit{Samanea saman},
                              TR = \\textit{Tabebuia rosea},
                              SG = \\textit{Simarouba glauca},
                              IL = \\textit{Inga laurina}.
                  Fertilisation regime: C = conventional, O = organic,
                                        I = intensive, M = moderate." )
```


\clearpage

## S3. Data and output variables simulated in calibration of CAF2021 {-}

CAF2021 was calibrated on data from 32 treatments applied in long-term experiments at Turrialba (Costa Rica) and Masatepe (Nicaragua). Fig. \ref{fig:BC_T1} shows the data from treatment 1 at Turrialba together with output from the calibrated model.

```{r BC_T1, out.width="90%", fig.align="center", fig.cap="\\label{BC_T1}Calibration results for treatment 1 of the Turrialba experiment. Blue points with error bars: data. Black lines: CAF2021 simulation using the MAP parameter vector. Green lines: simulation using the maximum likelihood parameter vector. For this treatment of highly fertilised coffee shaded by Erythrina poeppigiana trees, seven variables were measured. From top-left and row by row: coffee yield, shade, tree crown area and height, aboveground carbon in coffee and trees, soil carbon gain."}
  file_T1.png <-
    "BC/BC_RESULTS_Turrialba-Masatepe/png 2021-06-16/BC_outputs_data_01.png"

  knitr::include_graphics(file_T1.png)
```



\clearpage

# References {-}

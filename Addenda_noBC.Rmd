---
title: 'Modelling Coffee Agroforestry in Central America with CAF2021'
subtitle: 'Analysis of simulations Aug-Sep 2021'
author:
- Marcel van Oijen^[Independent researcher, Edinburgh, UK - VanOijenMarcel@gmail.com]
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
csl: environmental-modelling-and-software.csl
bibliography: [Avocado.bib,Banana.bib,SEACAF.bib]
---

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=F,results="asis",warning=FALSE,message=FALSE)
  library( geosphere )
  library( readxl    )
  library( tidyverse )
```



\clearpage

# Recent changes to data and modelling

- We capped the reported farm fertilisation at 500 kg N ha-1 y-1.
- We used revised soil farm data (file 'Soil_general_final.xlsx')
- We used a pedotransfer function [@Tomasella_2003_Comparison; @Tomasella_2004_Pedotransfer] to calculate each farm's soil water holding capacity from its bulk density and its silt and clay contents.
- We extended the weather data files by two years (2019 and 2020). For 2019, we used the country-average monthly anomalies from the weather stations of Icafe, IMN and Anacafe. For 2020, we used the WorldClim climatic average.
- We calculated dry coffee bean yield (the CAF2021 variable) as reported fresh yield divided by 3.87. This was based on results from the Nicaragua experiment, where the "factor de conversión de café cereza a café oro" was on average 7.74 [@Sepulveda_2016_Efecto], and further assuming that 'oro' is half the value of dry yield.
- We used farm-specific tree density data, but simplified to six 'type'-species as described in file 'Copy of class_marcel JH.xlsx'.
- Tree pruning is once per year (doy 140) and follows each farm's shade-target, except for Erythrina which follows a prescribed twice-yearly 90% pruning regime.
- Tree thinning is only applied to Cordia and follows a prescribed calendar.
- Pruned leaves and branches are removed from the field in Guatemala (except for Erythrina), but remain on the field in Costa Rica.

## Parameterisation

For most parameters, we kept the values that had been derived earlier by Bayesian calibration on the Turrialba and Masatepe experiments. Bayesian calibration on data from the farms did not improve the farm simulations much and was ultimately discarded. Parameter values for tree species not included in those experiments were estimated from the literature.

This means that all parameter values for coffee and tree morphology and physiology were identical for all 168 farms (89 in Costa Rica and 79 in Guatemala). Any genetic differences between coffee- and tree-varieties were thus ignored. The only tree-parameter differences were the farm-specific initial densities of shade trees. Soil composition and water holding capacity did differ between farms based on the SEACAF farm inventory.



\clearpage

# Simulating results for farms in Costa Rica and Guatemala

```{r}
  add.lmleg <- function(orig=FALSE){
    if(orig) { y.lm <- lm( y ~ 0 + x ) }
    else     { y.lm <- lm( y ~ x ) }
    r2   <- round( summary(y.lm)$r.squared, 2 )
    if(orig) {
      abline( 0, y.lm$coefficients[1], col="blue" )
    } else {
      abline( y.lm$coefficients[1], y.lm$coefficients[2], col="blue" )
    }
    legend( "bottomright",
            legend=paste("r2= ",as.character(r2)),
            col=c("blue"), lty=c(1), cex=0.7, bg="transparent" )
  }

  plotxylm <- function(maintxt="Obs. Costa Rica", xtxt="Sim.", orig=FALSE) {
    plot(x,y,xlab=xtxt,ylab="",main=maintxt) ; add.lmleg(orig)
  }
```

```{r}
  load( "df_C.f_final.rda" )
  load( "df_G.f_final.rda" )

  n_C.f <- dim(df_C.f)[1] ; n_G.f <- dim(df_G.f)[1]
```

```{r}
  vars_Summary <- c(
    "harvDM_f_hay", "harvCPT_f", "harvCPT_2", "harvCST_f", "harvCST_3",
    "D_Nsoil"     , "D_Csoil"  , "D_C"      , "D_CT"     , "D_Csys"   ,
    "Shade_f"        , "Shade_fa"       , "Shade_fb"     ,
    "NfixT_fb"       , "Nleaching_fb"   , "Crunoff_fb"   ,
    "Csoil_fa"       , "Csoil_fb"       ,
    "harvDM_f_ha1819", "harvDM_f_ha1920",
    "fTranT_t_1a"    , "fTranT_t_1b"    , "fTranT_t_2a"  , "fTranT_t_2b"  ,
    "fTranT_t_3a"    , "fTranT_t_3b"    , "fNgrowth_t_1a", "fNgrowth_t_1b",
    "fNgrowth_t_2a"  , "fNgrowth_t_2b"  , "fNgrowth_t_3a", "fNgrowth_t_3b",
    "H_t_1a"         , "H_t_1b"         , "H_t_2a"       , "H_t_2b"       ,
    "H_t_3a"         , "H_t_3b"         , "CAtree_t_1a"  , "CAtree_t_1b"  ,
    "CAtree_t_2a"    , "CAtree_t_2b"    , "CAtree_t_3a"  , "CAtree_t_3b"
  )
```

```{r}
  outputSummary <- function( output ) {
    idoy           <- which( outputNames=="doy" )

    fOut           <- matrix( NA, nrow=1, ncol=length(vars_Summary) )
    colnames(fOut) <- vars_Summary

    iyear      <- which( outputNames=="year" )
    idoy       <- which( outputNames=="doy" )
    
    ih_f_hay   <- which( outputNames=="harvDM_f_hay" ) # kg C ha-1 y-1
    ihCPT_f    <- which( outputNames=="harvCPT_f"    ) # kg C m-2 d-1
    ihCPT_2    <- which( outputNames=="harvCPT_t(2)" ) # kg C m-2 d-1
    ihCST_f    <- which( outputNames=="harvCST_f"    ) # kg C m-2 d-1
    ihCST_3    <- which( outputNames=="harvCST_t(3)" ) # kg C m-2 d-1
    iNsoil_f   <- which( outputNames=="Nsoil_f"      ) # kg N m-2
    iCsoil_f   <- which( outputNames=="Csoil_f"      ) # kg C m-2 
    iC_f       <- which( outputNames=="C_f"          ) # kg C m-2
    iCT_f      <- which( outputNames=="CT_f"         ) # kg C m-2
    
    iShade_f   <- which( outputNames=="Shade_f"      ) # m2 m-2
    
    iNfixT     <- which( outputNames=="NfixT_f"      ) # kg N m-2 d-1
    iNleaching <- which( outputNames=="Nleaching_f"  ) # kg N m-2 d-1
    iCrunoff   <- which( outputNames=="Crunoff_f"    ) # kg C m-2 d-1
    
    idayH1     <- which( outputNames=="DayHarv(1)" )
    idayH2     <- which( outputNames=="DayHarv(2)" )
    
    ifTranT1   <- which( outputNames=="fTranT_t(1)")
    ifTranT2   <- which( outputNames=="fTranT_t(2)")
    ifTranT3   <- which( outputNames=="fTranT_t(3)")
    ifNgrwT1   <- which( outputNames=="fNgrowth_t(1)")
    ifNgrwT2   <- which( outputNames=="fNgrowth_t(2)")
    ifNgrwT3   <- which( outputNames=="fNgrowth_t(3)")
    ihT1       <- which( outputNames=="h_t(1)")
    ihT2       <- which( outputNames=="h_t(2)")
    ihT3       <- which( outputNames=="h_t(3)")
    iCAtreeT1  <- which( outputNames=="CAtree_t(1)")
    iCAtreeT2  <- which( outputNames=="CAtree_t(2)")
    iCAtreeT3  <- which( outputNames=="CAtree_t(3)")

    c.DM  <- 1 / 0.47          # 'kg C' -> 'kg DM'
    NDAYS <- dim(output)[1]
    c.hay <- 1e4 * 365 / NDAYS # 'm-2 in sim. period' -> 'ha-1 y-1'
    d181  <- which( output[,idoy]==181 )
    
    T1 <- 0 ; if(output[1,which(outputNames=="treedens_t(1)")]>0) T1 <- 1
    T2 <- 0 ; if(output[1,which(outputNames=="treedens_t(2)")]>0) T2 <- 1
    T3 <- 0 ; if(output[1,which(outputNames=="treedens_t(3)")]>0) T3 <- 1
    
           fOut[,"harvDM_f_hay"] <- mean( output[d181,ih_f_hay] )
           fOut[,"harvCPT_f"]    <- sum ( output[    ,ihCPT_f ] ) * c.DM * c.hay
    if(T2) fOut[,"harvCPT_2"]    <- sum ( output[    ,ihCPT_2 ] ) * c.DM * c.hay
           fOut[,"harvCST_f"]    <- sum ( output[    ,ihCST_f ] ) * c.DM * c.hay
    if(T3) fOut[,"harvCST_3"]    <- sum ( output[    ,ihCST_3 ] ) * c.DM * c.hay
    
    D_output         <- output[NDAYS,] - output[1,]
    fOut[,"D_Nsoil"] <- D_output[iNsoil_f] * c.hay
    fOut[,"D_Csoil"] <- D_output[iCsoil_f] * c.hay
    fOut[,"D_C"    ] <- D_output[iC_f    ] * c.hay
    fOut[,"D_CT"   ] <- D_output[iCT_f   ] * c.hay
    fOut[,"D_Csys" ] <- fOut[,"D_Csoil"] + fOut[,"D_C"] + fOut[,"D_CT"]

    outputFirstYears <- colMeans( output[ 1          :730  , ] )
    outputFinalYears <- colMeans( output[ (NDAYS-730):NDAYS, ] )
    
    fOut[,"Shade_f"     ] <- mean( output          [,iShade_f] )
    fOut[,"Shade_fa"    ] <- mean( outputFirstYears[ iShade_f] )
    fOut[,"Shade_fb"    ] <- mean( outputFinalYears[ iShade_f] )
    
    fOut[,"NfixT_fb"    ] <- outputFinalYears[iNfixT    ] * 1e4 * 365
    fOut[,"Nleaching_fb"] <- outputFinalYears[iNleaching] * 1e4 * 365
    fOut[,"Crunoff_fb"  ] <- outputFinalYears[iCrunoff  ] * 1e4 * 365
    
    fOut[,"Csoil_fa"    ] <- outputFirstYears[iCsoil_f]
    fOut[,"Csoil_fb"    ] <- outputFinalYears[iCsoil_f]

    dHarv1819 <- which( (output[,iyear]==2019) & (output[,idoy]==181) )
    dHarv1920 <- which( (output[,iyear]==2020) & (output[,idoy]==181) )
    
    fOut[,"harvDM_f_ha1819"] <- output[dHarv1819,ih_f_hay]
    fOut[,"harvDM_f_ha1920"] <- output[dHarv1920,ih_f_hay]

    if(T1) { fOut[,"fTranT_t_1a"  ] <- mean( outputFirstYears[ifTranT1] )
             fOut[,"fTranT_t_1b"  ] <- mean( outputFinalYears[ifTranT1] )
             fOut[,"fNgrowth_t_1a"] <- mean( outputFirstYears[ifNgrwT1] )
             fOut[,"fNgrowth_t_1b"] <- mean( outputFinalYears[ifNgrwT1] )
             fOut[,"H_t_1a"       ] <- mean( outputFirstYears[ihT1] )
             fOut[,"H_t_1b"       ] <- mean( outputFinalYears[ihT1] )
             fOut[,"CAtree_t_1a"  ] <- mean( outputFirstYears[iCAtreeT1] )
             fOut[,"CAtree_t_1b"  ] <- mean( outputFinalYears[iCAtreeT1] )
           }
    if(T2) { fOut[,"fTranT_t_2a"  ] <- mean( outputFirstYears[ifTranT2] )
             fOut[,"fTranT_t_2b"  ] <- mean( outputFinalYears[ifTranT2] )
             fOut[,"fNgrowth_t_2a"] <- mean( outputFirstYears[ifNgrwT2] )
             fOut[,"fNgrowth_t_2b"] <- mean( outputFinalYears[ifNgrwT2] )
             fOut[,"H_t_2a"       ] <- mean( outputFirstYears[ihT2] )
             fOut[,"H_t_2b"       ] <- mean( outputFinalYears[ihT2] )
             fOut[,"CAtree_t_2a"  ] <- mean( outputFirstYears[iCAtreeT2] )
             fOut[,"CAtree_t_2b"  ] <- mean( outputFinalYears[iCAtreeT2] )
           }
    if(T3) { fOut[,"fTranT_t_3a"  ] <- mean( outputFirstYears[ifTranT3] )
             fOut[,"fTranT_t_3b"  ] <- mean( outputFinalYears[ifTranT3] )
             fOut[,"fNgrowth_t_3a"] <- mean( outputFirstYears[ifNgrwT3] )
             fOut[,"fNgrowth_t_3b"] <- mean( outputFinalYears[ifNgrwT3] )
             fOut[,"H_t_3a"       ] <- mean( outputFirstYears[ihT3] )
             fOut[,"H_t_3b"       ] <- mean( outputFinalYears[ihT3] )
             fOut[,"CAtree_t_3a"  ] <- mean( outputFirstYears[iCAtreeT3] )
             fOut[,"CAtree_t_3b"  ] <- mean( outputFinalYears[iCAtreeT3] )
           }

    return( fOut )
  }
```

```{r}
  dir.init <- "initialisation/CG/"
```

```{r}
  source('initialisation/initialise_CAF2021_general.R')

  Tnames_C <- Tdens_C <- NULL
  for(fi in 1:n_C.f) {
    densE    <- df_C.f$dens_Erythrina[fi]
    densI    <- df_C.f$dens_Inga     [fi]
    densB    <- df_C.f$dens_Banana   [fi]
    densA    <- df_C.f$dens_Avocado  [fi]
    densG    <- df_C.f$dens_Grevillea[fi]
    densC    <- df_C.f$dens_Cordia   [fi]
    T_fi     <- Tinventory_CG( densE, densI, densB, densA, densG, densC )
    Tnames_C <- rbind( Tnames_C, T_fi$Tnames )
    Tdens_C  <- rbind( Tdens_C , T_fi$Tdens  )
  }

  Tnames_G <- Tdens_G <- NULL
  for(fi in 1:n_G.f) {
    densE    <- df_G.f$dens_Erythrina[fi]
    densI    <- df_G.f$dens_Inga     [fi]
    densB    <- df_G.f$dens_Banana   [fi]
    densA    <- df_G.f$dens_Avocado  [fi]
    densG    <- df_G.f$dens_Grevillea[fi]
    densC    <- df_G.f$dens_Cordia   [fi]
    T_fi     <- Tinventory_CG( densE, densI, densB, densA, densG, densC )
    Tnames_G <- rbind( Tnames_G, T_fi$Tnames )
    Tdens_G  <- rbind( Tdens_G , T_fi$Tdens  )
  }
```

```{r}
  knitr::kable( cbind( 1:n_C.f, Tnames_C ),
                col.names=c("Costa Rica",paste0("T",1:3)) )
  knitr::kable( cbind( 1:n_G.f, Tnames_G ),
                col.names=c("Guatemala",paste0("T",1:3)) )
```

```{r}
  dir.init <- "initialisation/CG/"
  dir.par  <- "parameters/"
```

```{r}
  if_C.1E <- which(Tnames_C[,1]=="E") ; if_C.1I <- which(Tnames_C[,1]=="I")
  if_C.2B <- which(Tnames_C[,2]=="B") ; if_C.2A <- which(Tnames_C[,2]=="A")
  if_C.3G <- which(Tnames_C[,3]=="G") ; if_C.3C <- which(Tnames_C[,3]=="C")

  if_G.1I <- which(Tnames_G[,1]=="I")
  if_G.2B <- which(Tnames_G[,2]=="B") ; if_G.2A <- which(Tnames_G[,2]=="A")
  if_G.3G <- which(Tnames_G[,3]=="G") ; if_G.3C <- which(Tnames_G[,3]=="C")
```

```{r list_outF_C}
  list_outF_C <- list_parF_C <- vector( "list", n_C.f )

  for(fi in 1:n_C.f) {
    file_init <- paste0( "initialisation/CG/inititialise_CAF2021_C_f", fi, ".R" )
    source( file_init )
    
    nF_C                     <- 1
    mat_parF                 <- matrix( NA, nF_C, 1+length(names_params) )
    mat_outF                 <- matrix( NA, nF_C, 1+length(vars_Summary) )
    colnames( mat_parF )     <- c( "FarmSetting", names_params )
    colnames( mat_outF )     <- c( "FarmSetting", vars_Summary )
    mat_parF[,"FarmSetting"] <- 1:nF_C
    mat_outF[,"FarmSetting"] <- 1:nF_C
    
    for(iF in 1:nF_C) {
      outF <- run_model( params, matrix_weather, calendar_fert,
        calendar_prunC, calendar_prunT, calendar_thinT, NDAYS )
      
      paramsUsed <- params
      ipT1       <- which( endsWith(names_params,"(1)") ) 
      ipT2       <- which( endsWith(names_params,"(2)") ) 
      ipT3       <- which( endsWith(names_params,"(3)") )
      dT1        <- params[ which(names_params=="TREEDENS0(1)") ]
      dT2        <- params[ which(names_params=="TREEDENS0(2)") ]
      dT3        <- params[ which(names_params=="TREEDENS0(3)") ]
      if( dT1==0 ) paramsUsed[ipT1] <- NA
      if( dT2==0 ) paramsUsed[ipT2] <- NA
      if( dT3==0 ) paramsUsed[ipT3] <- NA
      
      mat_parF[iF,1+(1:length(names_params))] <- paramsUsed
      mat_outF[iF,1+(1:length(vars_Summary))] <- outputSummary( outF )
    }
    list_parF_C[[fi]] <- mat_parF
    list_outF_C[[fi]] <- mat_outF
  }
```

```{r exC, fig.height=3, fig.cap="\\label{fig:exC}Example simulation: Costa Rica farm 89."}
  plot_output( outF, vars= c( paste0("At(",1:3,")"),
                              "harvDM_f_hay",
                              paste0("h_t(",1:3,")"),
                              "Shade_f",
                              paste0("CAtree_t(",1:3,")")) )
```

```{r}
  df_C.f_sim <- df_C.f %>%
    dplyr::select ( code ) %>%
    arrange( code ) %>%
    mutate ( parF = list_parF_C ) %>%
    mutate ( outF = list_outF_C )
```

```{r}
  dfoutFSummary <- function( df=df_C.f_sim, Fi=1 ){
    nf     <- dim( df )[1]
    vnames <- colnames( df$outF[[1]] ) ; nv <- length(vnames)
    matres <- matrix( NA, nf, nv ) ; colnames( matres) <- vnames
    F.v    <- matres
    for(fi in 1:nf){
      F.v[fi,] <- df$outF[[fi]][Fi,]
    }
    return( F.v )
  }
```

```{r}
  dfparFSummary <- function( df=df_C.f_sim, Fi=1 ){
    nf     <- dim( df )[1]
    vnames <- colnames( df$parF[[1]] ) ; nv <- length(vnames)
    matres <- matrix( NA, nf, nv ) ; colnames( matres) <- vnames
    F.v    <- matres
    for(fi in 1:nf){
      F.v[fi,] <- df$parF[[fi]][Fi,]
    }
    return( F.v )
  }
```

```{r}
  oF1_C <- dfoutFSummary( df_C.f_sim, Fi=1 )
  pF1_C <- dfparFSummary( df_C.f_sim, Fi=1 )
```

```{r}
  tableY_C <- ( rbind(
    c( "Obs.", "18/19", summary( df_C.f$yield1819         , digits=3 ) ),
    c( ""    , "19/20", summary( df_C.f$yield1920         , digits=3 ) ),
    rep( "", 8 ),
    c( "Sim.", "18/19", summary( oF1_C[,"harvDM_f_ha1819"], digits=3 ) ),
    c( ""    , "19/20", summary( oF1_C[,"harvDM_f_ha1920"], digits=3 ) ) ) )
  colnames(tableY_C)[1] <- "C: Yield (kg ha-1)"
  knitr::kable( tableY_C )
```

```{r}
  tableCA_C1 <- ( rbind(
    c( "Erythina" , summary( oF1_C[if_C.1E,"CAtree_t_1b"], digits=3 ) ),
    c( "Inga"     , summary( oF1_C[if_C.1I,"CAtree_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF1_C[if_C.2B,"CAtree_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF1_C[if_C.2A,"CAtree_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF1_C[if_C.3G,"CAtree_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF1_C[if_C.3C,"CAtree_t_3b"], digits=3 ) ) ) )
  colnames(tableCA_C1)[1] <- "C1: CAtree (m2)"
  knitr::kable( tableCA_C1 )

  tableH_C1 <- ( rbind(
    c( "Erythina" , summary( oF1_C[if_C.1E,"H_t_1b"], digits=3 ) ),
    c( "Inga"     , summary( oF1_C[if_C.1I,"H_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF1_C[if_C.2B,"H_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF1_C[if_C.2A,"H_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF1_C[if_C.3G,"H_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF1_C[if_C.3C,"H_t_3b"], digits=3 ) ) ) )
  colnames(tableH_C1)[1] <- "C1: H (m)"
  knitr::kable( tableH_C1 )
```

\clearpage

```{r soilC, fig.height=3, fig.cap="\\label{fig:soilC}Soil carbon observations vs. simulations in Costa Rica."}
  par( mfrow=c(1,2), mar=c(4,4,3,1) )

  plot( oF1_C[,"Csoil_fa"], df_C.f$C.soil, main="C_soil Costa Rica\n(kg m-2)",
        xlab="Initial Csoil (sim.)", ylab="Csoil (obs.)" )
    abline(a=0,b=1,lty=2)
  plot( oF1_C[,"Csoil_fb"], df_C.f$C.soil, main="C_soil Costa Rica\n(kg m-2)",
        xlab="Final Csoil (sim.)", ylab="Csoil (obs.)" )
    abline(a=0,b=1,lty=2)
```

```{r shadeC, fig.height=3, fig.cap="\\label{fig:shadeC}Soil carbon observations vs. simulations in Costa Rica."}
  par( mfrow=c(1,3), mar=c(4,4,4,1) )

  plot( oF1_C[,"Shade_fa"], df_C.f$shade, main="Shade Costa Rica\n(-)",
        xlab="Initial shade (sim.)", ylab="Shade (obs.)" )
    abline(a=0,b=1,lty=2)
  plot( oF1_C[,"Shade_f"], df_C.f$shade, main="Shade Costa Rica\n(-)",
        xlab="Average shade (sim.)", ylab="Shade (obs.)" )
    abline(a=0,b=1,lty=2)
  plot( oF1_C[,"Shade_fb"], df_C.f$shade, main="Shade Costa Rica\n(-)",
        xlab="Final shade (sim.)", ylab="Shade (obs.)" )
    abline(a=0,b=1,lty=2)
```

```{r XX14C, fig.height=3, fig.cap="\\label{fig:XX14C}Observed vs. simulated yields in 2018-19 and 2019-20 at the farms in Costa Rica."}
  par( mfrow=c(1,3), mar=c(4,3,2,2), mgp=c(2,1,0) )

  x=oF1_C[,"harvDM_f_ha1819"] ; y=df_C.f$yield1819
    plotxylm("Yields Costa Rica 18/19", orig=F)

  x=oF1_C[,"harvDM_f_ha1920"] ; y=df_C.f$yield1920
    plotxylm("Yields Costa Rica 19/20", orig=F)

  x=c( oF1_C[,"harvDM_f_ha1819"], oF1_C[,"harvDM_f_ha1920"] )
  y=c( df_C.f$yield1819         , df_C.f$yield1920          )
    plotxylm("Yields Costa Rica 2 yrs", orig=F)
```

```{r list_outF_G}
  list_outF_G <- list_parF_G <- vector( "list", n_G.f )
  for(fi in 1:n_G.f) {
    file_init <- paste0( "initialisation/CG/inititialise_CAF2021_G_f", fi, ".R" )
    source( file_init )

    nF_G                     <- 1
    mat_parF                 <- matrix( NA, nF_G, 1+length(names_params) )
    mat_outF                 <- matrix( NA, nF_G, 1+length(vars_Summary) )
    colnames( mat_parF )     <- c( "FarmSetting", names_params )
    colnames( mat_outF )     <- c( "FarmSetting", vars_Summary )
    mat_parF[,"FarmSetting"] <- 1:nF_G
    mat_outF[,"FarmSetting"] <- 1:nF_G
    
    for(iF in 1:nF_G) {
      outF <- run_model( params, matrix_weather, calendar_fert,
        calendar_prunC, calendar_prunT, calendar_thinT, NDAYS )
      
      paramsUsed <- params
      ipT1       <- which( endsWith(names_params,"(1)") ) 
      ipT2       <- which( endsWith(names_params,"(2)") ) 
      ipT3       <- which( endsWith(names_params,"(3)") )
      dT1        <- params[ which(names_params=="TREEDENS0(1)") ]
      dT2        <- params[ which(names_params=="TREEDENS0(2)") ]
      dT3        <- params[ which(names_params=="TREEDENS0(3)") ]
      if( dT1==0 ) paramsUsed[ipT1] <- NA
      if( dT2==0 ) paramsUsed[ipT2] <- NA
      if( dT3==0 ) paramsUsed[ipT3] <- NA
      
      mat_parF[iF,1+(1:length(names_params))] <- paramsUsed
      mat_outF[iF,1+(1:length(vars_Summary))] <- outputSummary( outF )
    }
    list_parF_G[[fi]] <- mat_parF
    list_outF_G[[fi]] <- mat_outF
  }
```

```{r exG, fig.height=3, fig.cap="\\label{fig:exG}Example simulation: Guatemala farm 79."}
  plot_output( outF, vars= c( paste0("At(",1:3,")"),
                              "harvDM_f_hay",
                              paste0("h_t(",1:3,")"),
                              "Shade_f",
                              paste0("CAtree_t(",1:3,")")) )
```

```{r}
  df_G.f_sim <- df_G.f %>%
    dplyr::select ( code ) %>%
    arrange( code ) %>%
    mutate ( parF = list_parF_G ) %>%
    mutate ( outF = list_outF_G )
```

```{r}
  oF1_G <- dfoutFSummary( df_G.f_sim, Fi=1 )
  pF1_G <- dfparFSummary( df_G.f_sim, Fi=1 )
```

```{r}
  tableY_G <- ( rbind(
    c( "Obs." , "18/19", summary( df_G.f$yield1819         , digits=3 ) ),
    c( ""     , "19/20", summary( df_G.f$yield1920         , digits=3 ) ),
    rep( "", 8 ),
    c( "Sim.1", "18/19", summary( oF1_G[,"harvDM_f_ha1819"], digits=3 ) ),
    c( ""     , "19/20", summary( oF1_G[,"harvDM_f_ha1920"], digits=3 ) ) ) )
  colnames(tableY_G)[1] <- "G: Yield (kg ha-1)"
  knitr::kable( tableY_G )
```

```{r}
  tableCA_G1 <- ( rbind(
    c( "Inga"     , summary( oF1_G[if_G.1I,"CAtree_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF1_G[if_G.2B,"CAtree_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF1_G[if_G.2A,"CAtree_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF1_G[if_G.3G,"CAtree_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF1_G[if_G.3C,"CAtree_t_3b"], digits=3 ) ) ) )
  colnames(tableCA_G1)[1] <- "G1: CAtree (m2)"
  knitr::kable( tableCA_G1 )

  tableH_G1 <- ( rbind(
    c( "Inga"     , summary( oF1_G[if_G.1I,"H_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF1_G[if_G.2B,"H_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF1_G[if_G.2A,"H_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF1_G[if_G.3G,"H_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF1_G[if_G.3C,"H_t_3b"], digits=3 ) ) ) )
  colnames(tableH_G1)[1] <- "G1: H (m)"
  knitr::kable( tableH_G1 )
```

\clearpage

```{r soilG, fig.height=3, fig.cap="\\label{fig:soilG}Soil carbon observations vs. simulations in Guatemala."}
  par( mfrow=c(1,2), mar=c(4,4,3,1) )

  plot( oF1_G[,"Csoil_fa"], df_G.f$C.soil, main="C_soil Guatemala\n(kg m-2)",
        xlab="Initial Csoil (sim.)", ylab="Csoil (obs.)" )
    abline(a=0,b=1,lty=2)
  plot( oF1_G[,"Csoil_fb"], df_G.f$C.soil, main="C_soil Guatemala\n(kg m-2)",
        xlab="Final Csoil (sim.)", ylab="Csoil (obs.)" )
    abline(a=0,b=1,lty=2)
```

```{r shadeG, fig.height=3, fig.cap="\\label{fig:shadeG}Soil carbon observations vs. simulations in Guatemala."}
  par( mfrow=c(1,3), mar=c(4,4,4,1) )

  plot( oF1_G[,"Shade_fa"], df_G.f$shade, main="Shade Guatemala\n(-)",
        xlab="Initial shade (sim.)", ylab="Shade (obs.)" )
    abline(a=0,b=1,lty=2)
  plot( oF1_G[,"Shade_f"], df_G.f$shade, main="Shade Guatemala\n(-)",
        xlab="Average shade (sim.)", ylab="Shade (obs.)" )
    abline(a=0,b=1,lty=2)
  plot( oF1_G[,"Shade_fb"], df_G.f$shade, main="Shade Guatemala\n(-)",
        xlab="Final shade (sim.)", ylab="Shade (obs.)" )
    abline(a=0,b=1,lty=2)
```

```{r XX14G, fig.height=3, fig.cap="\\label{fig:XX14G}Observed vs. simulated yields in 2018-19 and 2019-20 at the farms in Guatemala."}
  par( mfrow=c(1,3), mar=c(4,3,2,2), mgp=c(2,1,0) )

  x=oF1_G[,"harvDM_f_ha1819"] ; y=df_G.f$yield1819
    plotxylm("Yields Guatemala 18/19" , orig=F)

  x=oF1_G[,"harvDM_f_ha1920"] ; y=df_G.f$yield1920
    plotxylm("Yields Guatemala 19/20" , orig=F)

  x=c( oF1_G[,"harvDM_f_ha1819"], oF1_G[,"harvDM_f_ha1920"] )
  y=c( df_G.f$yield1819         , df_G.f$yield1920          )
    plotxylm("Yields Guatemala 2 yrs" , orig=F)
```

```{r}
  plotimpacts_CG <- function( FC=oF1_C, FG=oF1_G, xvar="Nfert", yvar="y.sim" ){
    xC=df_C.f[,xvar] ; xG=df_G.f[,xvar]
    yC=FC    [,yvar] ; yG=FG    [,yvar]
    plot  ( xC, yC,
      xlab=xvar, ylab="",
      main=paste0(substr(deparse(substitute(FC)),1,2),": ",yvar),
      pch=1,
      # xlim=c( 0, max(xC,xG) ),
      # ylim=c( min(0,yC,yG,na.rm=T), max(0,yC,yG,na.rm=T)) )
      xlim=c( min(xC,xG        ), max(xC,xG        )),
      ylim=c( min(yC,yG,na.rm=T), max(yC,yG,na.rm=T)) )
    points( xG, yG, pch=20, col="red"  )
    
    y.lm_C <- lm( yC ~ xC ) ; y.lm_G <- lm( yG ~ xG )
    r2_C   <- round( summary(y.lm_C)$r.squared, 2 )
    r2_G   <- round( summary(y.lm_G)$r.squared, 2 )
    abline( y.lm_C$coefficients[1], y.lm_C$coefficients[2], col="black" )
    abline( y.lm_G$coefficients[1], y.lm_G$coefficients[2], col="red" )
    legend( "bottomright", title="r2",
            legend=c( paste("C:",as.character(r2_C)),
                      paste("G:",as.character(r2_G)) ),
            col=c("black","red"), lty=c(1), cex=0.5, bg="transparent" )
  }
```

```{r XX21, fig.height=5, fig.cap="\\label{fig:XX21}Final water limitation of the three tree classes vs. N-fertilisation (top row) and vs. distance from the easternmost farm (bottom row). Black: Costa Rica. Red: Guatemala."}
  par( mfrow=c(2,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  yv <- "fTranT_t_1b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
  yv <- "fTranT_t_2b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
  yv <- "fTranT_t_3b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )

  yv <- "fTranT_t_1b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
  yv <- "fTranT_t_2b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
  yv <- "fTranT_t_3b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
```

```{r XX22, fig.height=5, fig.cap="\\label{fig:XX22}Final N-limitation of the three tree classes vs. N-fertilisation (top row) and vs. distance from the easternmost farm (bottom row). Black: Costa Rica. Red: Guatemala."}
  par( mfrow=c(2,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  yv <- "fNgrowth_t_1b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
  yv <- "fNgrowth_t_2b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
  yv <- "fNgrowth_t_3b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )

  yv <- "fNgrowth_t_1b"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
  yv <- "fNgrowth_t_2b"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
  yv <- "fNgrowth_t_3b"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
```

```{r XX24, fig.height=5, fig.cap="\\label{fig:XX24}Costa Rica: Tree height vs. N-fertilisation (top row) and distance from easternmost farm (bottom row). Black: Costa Rica. Red: Guatemala."}
  par( mfrow=c(2,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  yv <- "H_t_1b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
  yv <- "H_t_2b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
  yv <- "H_t_3b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )

  yv <- "H_t_1b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
  yv <- "H_t_2b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
  yv <- "H_t_3b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
```

When we run the following code, we see that Guatemala has:

- Lower Csoil
- Lower Nsoil
- Lower Nfert

These settings make coffee and trees in Guatemala in the model - and likely in reality too if the data are reliable - often severely water- and N-limited. Still, observed yields in Guatemala are not strongly correlated with N-fertilisation rate, which is puzzling. 

```{r XX13, fig.height=3, fig.cap="\\label{fig:XX13}Yields in 2019-20 vs. yield in 2018-19."}
  par( mfrow=c(1,2), mar=c(3,3,3,2) )

  x_C <- df_C.f$yield1819 ; y_C <- df_C.f$yield1920
  x_G <- df_G.f$yield1819 ; y_G <- df_G.f$yield1920
  plot  ( x_C, y_C, main="Observed yields\n(kg DM ha-1 y-1)",
          xlab="2018-19", ylab="2019-20")
  points( x_G, y_G, col="red" )
  y.lm_C <- lm( y_C ~ x_C ) ; r2_C <- round( summary(y.lm_C)$r.squared, 2 )
  y.lm_G <- lm( y_G ~ x_G ) ; r2_G <- round( summary(y.lm_G)$r.squared, 2 )
  abline( y.lm_C$coefficients[1], y.lm_C$coefficients[2], col="black" )
  abline( y.lm_G$coefficients[1], y.lm_G$coefficients[2], col="red" )
  abline( 1, 1, lty=2 )
  legend( "bottomright",
          legend=c(paste0("C (r2=",r2_C,")"),paste0("G (r2=",r2_G,")")),
          lty=c(1,1), col=c("black","red"), bg="transparent", cex=0.5 )
  
  x_C <- oF1_C[,"harvDM_f_ha1819"] ; y_C <- oF1_C[,"harvDM_f_ha1920"]
  x_G <- oF1_G[,"harvDM_f_ha1819"] ; y_G <- oF1_G[,"harvDM_f_ha1920"]
  plot  ( x_C, y_C, main="Simulated yields\n(kg DM ha-1 y-1)",
          xlab="2018-19", ylab="2019-20")
  points( x_G, y_G, col="red" )
  y.lm_C <- lm( y_C ~ x_C ) ; r2_C <- round( summary(y.lm_C)$r.squared, 2 )
  y.lm_G <- lm( y_G ~ x_G ) ; r2_G <- round( summary(y.lm_G)$r.squared, 2 )
  abline( y.lm_C$coefficients[1], y.lm_C$coefficients[2], col="black" )
  abline( y.lm_G$coefficients[1], y.lm_G$coefficients[2], col="red" )
  abline( 1, 1, lty=2 )
  legend( "bottomright",
          legend=c(paste0("C (r2=",r2_C,")"),paste0("G (r2=",r2_G,")")),
          lty=c(1,1), col=c("black","red"), bg="transparent", cex=0.5 )
```

Results of simulations are shown in Figs \ref{fig:XX14C}, \ref{fig:XX14G}, \ref{fig:XX15}, and \ref{fig:XX16}. Fig. \ref{fig:XX15} shows, for farms in Costa Rica, observations and simulations of multiple variables, all plotted against each farm's N-fertilisation rate. Farms are grouped by number of shade tree species but no clear differences between the groups are visible. Apart from shade, all variables show a positive or negative correlation with fertilisation. The negative correlation in the case of soil carbon loss in runoff is likely due to fertilisation enhancing vegetation LAI, which in the model reduces erosion. The same variables are shown in Fig. \ref{fig:XX16} for Guatemala.

Figs \ref{fig:XX15b} and \ref{fig:XX16b} plot the same variables against distance from each country's easternmost farm.

```{r}
  int1_C <- which(df_C.f$nt <2) ; int1_G <- which(df_G.f$nt <2)
  int2_C <- which(df_C.f$nt==2) ; int2_G <- which(df_G.f$nt==2)
  int3_C <- which(df_C.f$nt >2) ; int3_G <- which(df_G.f$nt >2)
  
  nnt1_C <- length(int1_C)      ; nnt1_G <- length(int1_G)
  nnt2_C <- length(int2_C)      ; nnt2_G <- length(int2_G)
  nnt3_C <- length(int3_C)      ; nnt3_G <- length(int3_G)
  
  listmat_nt_C <- listmat_nt_G <- vector( "list", 3 )
  varnames.listmat <- c( "code","dist","slope","Nfert","nt","shade",
    "y1819","y1920",  "y1819.sim","y1920.sim","y.sim",
    "D_Csoil.sim","shade.sim","Nleach.sim","Crunoff.sim","Csoil.sim" )
```

```{r}
  iF <- 1
```

```{r}
  listmat_nt_C[[1]] <- t( sapply( 1:nnt1_C, function(i){ cbind(
    df_C.f    [int1_C,]$code     [[i]],
    df_C.f    [int1_C,]$dist     [[i]],
    df_C.f    [int1_C,]$slope    [[i]],
    df_C.f    [int1_C,]$Nfert    [[i]],
    df_C.f    [int1_C,]$nt       [[i]],
    df_C.f    [int1_C,]$shade    [[i]],
    df_C.f    [int1_C,]$yield1819[[i]],
    df_C.f    [int1_C,]$yield1920[[i]],
    df_C.f_sim[int1_C,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"Shade_f"        ][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_C[[1]]) <- varnames.listmat

  listmat_nt_C[[2]] <- t( sapply( 1:nnt2_C, function(i){ cbind(
    df_C.f    [int2_C,]$code     [[i]],
    df_C.f    [int2_C,]$dist     [[i]],
    df_C.f    [int2_C,]$slope    [[i]],
    df_C.f    [int2_C,]$Nfert    [[i]],
    df_C.f    [int2_C,]$nt       [[i]],
    df_C.f    [int2_C,]$shade    [[i]],
    df_C.f    [int2_C,]$yield1819[[i]],
    df_C.f    [int2_C,]$yield1920[[i]],
    df_C.f_sim[int2_C,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"Shade_f"        ][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_C[[2]]) <- varnames.listmat

  listmat_nt_C[[3]] <- t( sapply( 1:nnt3_C, function(i){ cbind(
    df_C.f    [int3_C,]$code     [[i]],
    df_C.f    [int3_C,]$dist     [[i]],
    df_C.f    [int3_C,]$slope    [[i]],
    df_C.f    [int3_C,]$Nfert    [[i]],
    df_C.f    [int3_C,]$nt       [[i]],
    df_C.f    [int3_C,]$shade    [[i]],
    df_C.f    [int3_C,]$yield1819[[i]],
    df_C.f    [int3_C,]$yield1920[[i]],
    df_C.f_sim[int3_C,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"Shade_f"        ][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_C[[3]]) <- varnames.listmat
```

```{r}
  listmat_nt_G[[1]] <- t( sapply( 1:nnt1_G, function(i){ cbind(
    df_G.f    [int1_G,]$code     [[i]],
    df_G.f    [int1_G,]$dist     [[i]],
    df_G.f    [int1_G,]$slope    [[i]],
    df_G.f    [int1_G,]$Nfert    [[i]],
    df_G.f    [int1_G,]$nt       [[i]],
    df_G.f    [int1_G,]$shade    [[i]],
    df_G.f    [int1_G,]$yield1819[[i]],
    df_G.f    [int1_G,]$yield1920[[i]],
    df_G.f_sim[int1_G,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"Shade_f"        ][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_G[[1]]) <- varnames.listmat

  listmat_nt_G[[2]] <- t( sapply( 1:nnt2_G, function(i){ cbind(
    df_G.f    [int2_G,]$code     [[i]],
    df_G.f    [int2_G,]$dist     [[i]],
    df_G.f    [int2_G,]$slope    [[i]],
    df_G.f    [int2_G,]$Nfert    [[i]],
    df_G.f    [int2_G,]$nt       [[i]],
    df_G.f    [int2_G,]$shade    [[i]],
    df_G.f    [int2_G,]$yield1819[[i]],
    df_G.f    [int2_G,]$yield1920[[i]],
    df_G.f_sim[int2_G,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"Shade_f"        ][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_G[[2]]) <- varnames.listmat

  listmat_nt_G[[3]] <- t( sapply( 1:nnt3_G, function(i){ cbind(
    df_G.f    [int3_G,]$code     [[i]],
    df_G.f    [int3_G,]$dist     [[i]],
    df_G.f    [int3_G,]$slope    [[i]],
    df_G.f    [int3_G,]$Nfert    [[i]],
    df_G.f    [int3_G,]$nt       [[i]],
    df_G.f    [int3_G,]$shade    [[i]],
    df_G.f    [int3_G,]$yield1819[[i]],
    df_G.f    [int3_G,]$yield1920[[i]],
    df_G.f_sim[int3_G,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"Shade_f"        ][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_G[[3]]) <- varnames.listmat
```

```{r}
  plotimpacts_nt <- function( listmat=listmat_nt_C, xvar="Nfert", yvar="y.sim" ){
    plot  ( listmat[[1]][,xvar], listmat[[1]][,yvar],
      xlab=xvar, ylab="",main=yvar, pch=1,
      xlim=c(0,max(listmat[[1]][,xvar],listmat[[2]][,xvar],
                   listmat[[3]][,xvar])),
      ylim=c(min(0,listmat[[1]][,yvar],listmat[[2]][,yvar],listmat[[3]][,yvar],
                 na.rm=T),
             max(  listmat[[1]][,yvar],listmat[[2]][,yvar],listmat[[3]][,yvar],
                 na.rm=T)) )
    points( listmat[[2]][,xvar], listmat[[2]][,yvar], pch=20, col="red"  )
    points( listmat[[3]][,xvar], listmat[[3]][,yvar], pch=6, col="blue" )
    
    y.lm.nt1 <- lm( listmat[[1]][,yvar] ~ listmat[[1]][,xvar] )
    y.lm.nt2 <- lm( listmat[[2]][,yvar] ~ listmat[[2]][,xvar] )
    y.lm.nt3 <- lm( listmat[[3]][,yvar] ~ listmat[[3]][,xvar] )
    r2.nt1   <- round( summary(y.lm.nt1)$r.squared, 2 )
    r2.nt2   <- round( summary(y.lm.nt2)$r.squared, 2 )
    r2.nt3   <- round( summary(y.lm.nt3)$r.squared, 2 )
    abline( y.lm.nt1$coefficients[1], y.lm.nt1$coefficients[2], col="black" )
    abline( y.lm.nt2$coefficients[1], y.lm.nt2$coefficients[2], col="red" )
    abline( y.lm.nt3$coefficients[1], y.lm.nt3$coefficients[2], col="blue" )
    legend( "bottomright", title="r2",
            legend=c( paste("n<2:",as.character(r2.nt1)),
              paste("n=2:",as.character(r2.nt2)),
              paste("n>2:",as.character(r2.nt3)) ),
            col=c("black","red","blue"), lty=c(1), cex=0.5 )
  }
```

```{r XX15, fig.height=7.5, fig.cap="\\label{fig:XX15}Observations (top row) and simulations (middle row) of shade and yield for farms in Costa Rica plus (bottom row) simulations of change in soil carbon, final year nitrogen leaching and final year carbon loss in run-off. All plots are against N-fertilisation level (kg N ha-1 y-1)."}
  par(mfrow=c(3,3),mar=c(4,2,2,2), mgp=c(2,1,0))

  plotimpacts_nt( listmat_nt_C, "Nfert", "shade"        )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "y1819"       )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "y1920"       )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "shade.sim"   )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "y1819.sim"   )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "y1920.sim"   )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "D_Csoil.sim" )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "Nleach.sim"  )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "Crunoff.sim" )
```

```{r XX16, fig.height=7.5, fig.cap="\\label{fig:XX16}Shade- and yield-observations for farms in Guatemala plus simulations. All plots are against N-fertilisation level (kg N ha-1 y-1). See previous figure for explanation of variables."}
  par(mfrow=c(3,3),mar=c(4,2,2,2), mgp=c(2,1,0))

  plotimpacts_nt( listmat_nt_G, "Nfert", "shade"       )
  plotimpacts_nt( listmat_nt_G, "Nfert", "y1819"       )
  plotimpacts_nt( listmat_nt_G, "Nfert", "y1920"       )
  plotimpacts_nt( listmat_nt_G, "Nfert", "shade.sim"   )
  plotimpacts_nt( listmat_nt_G, "Nfert", "y1819.sim"   )
  plotimpacts_nt( listmat_nt_G, "Nfert", "y1920.sim"   )
  plotimpacts_nt( listmat_nt_G, "Nfert", "D_Csoil.sim" )
  plotimpacts_nt( listmat_nt_G, "Nfert", "Nleach.sim"  )
  plotimpacts_nt( listmat_nt_G, "Nfert", "Crunoff.sim" )
```

```{r XX15b, fig.height=7.5, fig.cap="\\label{fig:XX15b}Observations (top row) and simulations (middle row) of shade and yield for farms in Costa Rica plus (bottom row) simulations of change in soil carbon, final year nitrogen leaching and final year carbon loss in run-off. All plots are against distance from the eastermost farm (km)."}
  par(mfrow=c(3,3),mar=c(4,2,2,2), mgp=c(2,1,0))

  plotimpacts_nt( listmat_nt_C, "dist", "shade"        )
  plotimpacts_nt( listmat_nt_C, "dist",  "y1819"       )
  plotimpacts_nt( listmat_nt_C, "dist",  "y1920"       )
  plotimpacts_nt( listmat_nt_C, "dist",  "shade.sim"   )
  plotimpacts_nt( listmat_nt_C, "dist",  "y1819.sim"   )
  plotimpacts_nt( listmat_nt_C, "dist",  "y1920.sim"   )
  plotimpacts_nt( listmat_nt_C, "dist",  "D_Csoil.sim" )
  plotimpacts_nt( listmat_nt_C, "dist",  "Nleach.sim"  )
  plotimpacts_nt( listmat_nt_C, "dist",  "Crunoff.sim" )
```

```{r XX16b, fig.height=7.5, fig.cap="\\label{fig:XX16b}Shade- and yield-observations for farms in Guatemala plus simulations. All plots are against distance from the eastermost farm (km). See previous figure for explanation of variables."}
  par(mfrow=c(3,3),mar=c(4,2,2,2), mgp=c(2,1,0))

  plotimpacts_nt( listmat_nt_G, "dist", "shade"       )
  plotimpacts_nt( listmat_nt_G, "dist", "y1819"       )
  plotimpacts_nt( listmat_nt_G, "dist", "y1920"       )
  plotimpacts_nt( listmat_nt_G, "dist", "shade.sim"   )
  plotimpacts_nt( listmat_nt_G, "dist", "y1819.sim"   )
  plotimpacts_nt( listmat_nt_G, "dist", "y1920.sim"   )
  plotimpacts_nt( listmat_nt_G, "dist", "D_Csoil.sim" )
  plotimpacts_nt( listmat_nt_G, "dist", "Nleach.sim"  )
  plotimpacts_nt( listmat_nt_G, "dist", "Crunoff.sim" )
```



\clearpage

# Analysis of model-data mismatch

```{r}
  mRAIN_C <- rep(NA,n_C.f)
  mRAIN_G <- rep(NA,n_G.f)

  for(i in 1:n_C.f) { mRAIN_C[i] <- mean(df_C.f$weather.WC[[i]][,"RAIN"]) }
  for(i in 1:n_G.f) { mRAIN_G[i] <- mean(df_G.f$weather.WC[[i]][,"RAIN"]) }
```

```{r, eval=F}
  # All farms
  knitr::kable( c(summary( mRAIN_C )) )
  knitr::kable( c(summary( mRAIN_G )) )

  # Twenty driest farms  
  knitr::kable( c(summary( sort(mRAIN_C)[1:20] )) )
  knitr::kable( c(summary( sort(mRAIN_G)[1:20] )) )
```

```{r}
  y1819.err_C <- oF1_C[,"harvDM_f_ha1819"] - df_C.f$yield1819
  y1920.err_C <- oF1_C[,"harvDM_f_ha1920"] - df_C.f$yield1920
  y1819.err_G <- oF1_G[,"harvDM_f_ha1819"] - df_G.f$yield1819
  y1920.err_G <- oF1_G[,"harvDM_f_ha1920"] - df_G.f$yield1920
```

```{r}
  par(mfrow=c(1,2))
  
  y=y1920.err_C ; x=y1819.err_C
    plotxylm("C: e1920 ~ e1819", orig=F) ; abline(a=0,b=1,lty=2)
  y=y1920.err_G ; x=y1819.err_G
    plotxylm("G: e1920 ~ e1819", orig=F) ; abline(a=0,b=1,lty=2)
```

```{r, eval=T}
  par(mfrow=c(4,5), mar=c(2,2,2,1))

  y=y1819.err_C

  x=mRAIN_C               ; plotxylm("C: e1819 ~ Rain"     )
  x=df_C.f$dist           ; plotxylm("C: e1819 ~ dist"     )
  x=df_C.f$slope          ; plotxylm("C: e1819 ~ slope"    )
  x=df_C.f$altitude       ; plotxylm("C: e1819 ~ alt"      )
  x=df_C.f$DM.soil        ; plotxylm("C: e1819 ~ DM.soil"  )
  x=df_C.f$CN.soil        ; plotxylm("C: e1819 ~ CN.soil"  )
  x=df_C.f$C.soil         ; plotxylm("C: e1819 ~ C.soil"   )
  x=df_C.f$N.soil         ; plotxylm("C: e1819 ~ N.soil"   )
  x=df_C.f$Nfert          ; plotxylm("C: e1819 ~ Nfert"    )
  x=df_C.f$WP             ; plotxylm("C: e1819 ~ WP"       )
  x=df_C.f$FC             ; plotxylm("C: e1819 ~ FC"       )
  x=df_C.f$nt             ; plotxylm("C: e1819 ~ nt"       )
  x=df_C.f$shade          ; plotxylm("C: e1819 ~ shade"    )
  x=df_C.f$dens_Erythrina ; plotxylm("C: e1819 ~ Erythrina")
  x=df_C.f$dens_Inga      ; plotxylm("C: e1819 ~ Inga"     )
  x=df_C.f$dens_Banana    ; plotxylm("C: e1819 ~ Banana"   )
  x=df_C.f$dens_Inga      ; plotxylm("C: e1819 ~ Avocado"  )
  x=df_C.f$dens_Grevillea ; plotxylm("C: e1819 ~ Grevillea")
  x=df_C.f$dens_Cordia    ; plotxylm("C: e1819 ~ Cordia"   )
```

```{r, eval=T}
  par(mfrow=c(4,5), mar=c(2,2,2,1))

  y=y1920.err_C

  x=mRAIN_C               ; plotxylm("C: e1920 ~ Rain"     )
  x=df_C.f$dist           ; plotxylm("C: e1920 ~ dist"     )
  x=df_C.f$slope          ; plotxylm("C: e1920 ~ slope"    )
  x=df_C.f$altitude       ; plotxylm("C: e1920 ~ alt"      )
  x=df_C.f$DM.soil        ; plotxylm("C: e1920 ~ DM.soil"  )
  x=df_C.f$CN.soil        ; plotxylm("C: e1920 ~ CN.soil"  )
  x=df_C.f$C.soil         ; plotxylm("C: e1920 ~ C.soil"   )
  x=df_C.f$N.soil         ; plotxylm("C: e1920 ~ N.soil"   )
  x=df_C.f$Nfert          ; plotxylm("C: e1920 ~ Nfert"    )
  x=df_C.f$WP             ; plotxylm("C: e1920 ~ WP"       )
  x=df_C.f$FC             ; plotxylm("C: e1920 ~ FC"       )
  x=df_C.f$nt             ; plotxylm("C: e1920 ~ nt"       )
  x=df_C.f$shade          ; plotxylm("C: e1920 ~ shade"    )
  x=df_C.f$dens_Erythrina ; plotxylm("C: e1920 ~ Erythrina")
  x=df_C.f$dens_Inga      ; plotxylm("C: e1920 ~ Inga"     )
  x=df_C.f$dens_Banana    ; plotxylm("C: e1920 ~ Banana"   )
  x=df_C.f$dens_Inga      ; plotxylm("C: e1920 ~ Avocado"  )
  x=df_C.f$dens_Grevillea ; plotxylm("C: e1920 ~ Grevillea")
  x=df_C.f$dens_Cordia    ; plotxylm("C: e1920 ~ Cordia"   )
```

```{r, eval=F}
  par(mfrow=c(1,2), mar=c(2,2,2,1))

  y=y1819.err_C
  x=oF1_C[,"Shade_fb"] ; plotxylm("C: e1819 ~ Shade_fb")
  y=y1920.err_C
  x=oF1_C[,"Shade_fb"] ; plotxylm("C: e1920 ~ Shade_fb")
```

```{r, eval=T}
  par(mfrow=c(4,5), mar=c(2,2,2,1))

  y=y1819.err_G

  x=mRAIN_G               ; plotxylm("G: e1819 ~ Rain"     )
  x=df_G.f$dist           ; plotxylm("G: e1819 ~ dist"     )
  x=df_G.f$slope          ; plotxylm("G: e1819 ~ slope"    )
  x=df_G.f$altitude       ; plotxylm("G: e1819 ~ alt"      )
  x=df_G.f$DM.soil        ; plotxylm("G: e1819 ~ DM.soil"  )
  x=df_G.f$CN.soil        ; plotxylm("G: e1819 ~ CN.soil"  )
  x=df_G.f$C.soil         ; plotxylm("G: e1819 ~ C.soil"   )
  x=df_G.f$N.soil         ; plotxylm("G: e1819 ~ N.soil"   )
  x=df_G.f$Nfert          ; plotxylm("G: e1819 ~ Nfert"    )
  x=df_G.f$WP             ; plotxylm("G: e1819 ~ WP"       )
  x=df_G.f$FC             ; plotxylm("G: e1819 ~ FC"       )
  x=df_G.f$nt             ; plotxylm("G: e1819 ~ nt"       )
  x=df_G.f$shade          ; plotxylm("G: e1819 ~ shade"    )
  plot.new()
  x=df_G.f$dens_Inga      ; plotxylm("G: e1819 ~ Inga"     )
  x=df_G.f$dens_Banana    ; plotxylm("G: e1819 ~ Banana"   )
  x=df_G.f$dens_Inga      ; plotxylm("G: e1819 ~ Avocado"  )
  x=df_G.f$dens_Grevillea ; plotxylm("G: e1819 ~ Grevillea")
  x=df_G.f$dens_Cordia    ; plotxylm("G: e1819 ~ Cordia"   )
```

```{r, eval=T}
  par(mfrow=c(4,5), mar=c(2,2,2,1))

  y=y1920.err_G

  x=mRAIN_G               ; plotxylm("G: e1920 ~ Rain"     )
  x=df_G.f$dist           ; plotxylm("G: e1920 ~ dist"     )
  x=df_G.f$slope          ; plotxylm("G: e1920 ~ slope"    )
  x=df_G.f$altitude       ; plotxylm("G: e1920 ~ alt"      )
  x=df_G.f$DM.soil        ; plotxylm("G: e1920 ~ DM.soil"  )
  x=df_G.f$CN.soil        ; plotxylm("G: e1920 ~ CN.soil"  )
  x=df_G.f$C.soil         ; plotxylm("G: e1920 ~ C.soil"   )
  x=df_G.f$N.soil         ; plotxylm("G: e1920 ~ N.soil"   )
  x=df_G.f$Nfert          ; plotxylm("G: e1920 ~ Nfert"    )
  x=df_G.f$WP             ; plotxylm("G: e1920 ~ WP"       )
  x=df_G.f$FC             ; plotxylm("G: e1920 ~ FC"       )
  x=df_G.f$nt             ; plotxylm("G: e1920 ~ nt"       )
  x=df_G.f$shade          ; plotxylm("G: e1920 ~ shade"    )
  plot.new()
  x=df_G.f$dens_Inga      ; plotxylm("G: e1920 ~ Inga"     )
  x=df_G.f$dens_Banana    ; plotxylm("G: e1920 ~ Banana"   )
  x=df_G.f$dens_Inga      ; plotxylm("G: e1920 ~ Avocado"  )
  x=df_G.f$dens_Grevillea ; plotxylm("G: e1920 ~ Grevillea")
  x=df_G.f$dens_Cordia    ; plotxylm("G: e1920 ~ Cordia"   )
```

```{r, eval=F}
  par(mfrow=c(1,2), mar=c(2,2,2,1))

  y=y1819.err_G
  x=oF1_G[,"Shade_fb"] ; plotxylm("G: e1819 ~ Shade_fb")
  y=y1920.err_G
  x=oF1_G[,"Shade_fb"] ; plotxylm("G: e1920 ~ Shade_fb")
```

```{r, eval=T}
  par(mfrow=c(4,3), mar=c(2,2,2,1))

  y=y1819.err_C
  x=oF1_C[,"fTranT_t_1b"  ] ; plotxylm("C: e1819 ~ fTranT_1b"     )
  x=oF1_C[,"fTranT_t_2b"  ] ; plotxylm("C: e1819 ~ fTranT_2b"     )
  x=oF1_C[,"fTranT_t_3b"  ] ; plotxylm("C: e1819 ~ fTranT_3b"     )
  x=oF1_C[,"fNgrowth_t_1b"] ; plotxylm("C: e1819 ~ fNgrowth_t_1b" )
  x=oF1_C[,"fNgrowth_t_2b"] ; plotxylm("C: e1819 ~ fNgrowth_t_2b" )
  x=oF1_C[,"fNgrowth_t_3b"] ; plotxylm("C: e1819 ~ fNgrowth_t_3b" )

  y=y1920.err_C
  x=oF1_C[,"fTranT_t_1b"  ] ; plotxylm("C: e1920 ~ fTranT_1b"     )
  x=oF1_C[,"fTranT_t_2b"  ] ; plotxylm("C: e1920 ~ fTranT_2b"     )
  x=oF1_C[,"fTranT_t_3b"  ] ; plotxylm("C: e1920 ~ fTranT_3b"     )
  x=oF1_C[,"fNgrowth_t_1b"] ; plotxylm("C: e1920 ~ fNgrowth_t_1b" )
  x=oF1_C[,"fNgrowth_t_2b"] ; plotxylm("C: e1920 ~ fNgrowth_t_2b" )
  x=oF1_C[,"fNgrowth_t_3b"] ; plotxylm("C: e1920 ~ fNgrowth_t_3b" )
```

```{r, eval=T}
  par(mfrow=c(4,3), mar=c(2,2,2,1))

  y=y1819.err_G
  x=oF1_G[,"fTranT_t_1b"  ] ; plotxylm("G: e1819 ~ fTranT_1b"     )
  x=oF1_G[,"fTranT_t_2b"  ] ; plotxylm("G: e1819 ~ fTranT_2b"     )
  x=oF1_G[,"fTranT_t_3b"  ] ; plotxylm("G: e1819 ~ fTranT_3b"     )
  x=oF1_G[,"fNgrowth_t_1b"] ; plotxylm("G: e1819 ~ fNgrowth_t_1b" )
  x=oF1_G[,"fNgrowth_t_2b"] ; plotxylm("G: e1819 ~ fNgrowth_t_2b" )
  x=oF1_G[,"fNgrowth_t_3b"] ; plotxylm("G: e1819 ~ fNgrowth_t_3b" )

  y=y1920.err_G
  x=oF1_G[,"fTranT_t_1b"  ] ; plotxylm("G: e1920 ~ fTranT_1b"     )
  x=oF1_G[,"fTranT_t_2b"  ] ; plotxylm("G: e1920 ~ fTranT_2b"     )
  x=oF1_G[,"fTranT_t_3b"  ] ; plotxylm("G: e1920 ~ fTranT_3b"     )
  x=oF1_G[,"fNgrowth_t_1b"] ; plotxylm("G: e1920 ~ fNgrowth_t_1b" )
  x=oF1_G[,"fNgrowth_t_2b"] ; plotxylm("G: e1920 ~ fNgrowth_t_2b" )
  x=oF1_G[,"fNgrowth_t_3b"] ; plotxylm("G: e1920 ~ fNgrowth_t_3b" )
```



# References
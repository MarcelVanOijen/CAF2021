---
title: 'Modelling Coffee Agroforestry in Central America with CAF2021'
subtitle: 'Progress report II for project SEACAF, sub-contract B0554x4'
author:
- Marcel van Oijen^[Independent researcher, Edinburgh, UK - VanOijenMarcel@gmail.com]
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
csl: environmental-modelling-and-software.csl
bibliography: [Avocado.bib,Banana.bib,MvO.bib]
---

```{r, include=FALSE}
  file_BC_Turrialba.RData <- 'BC_06_02_Turrialba.RData'
  # file_BC_Masatepe.RData  <- 'BC___Masatepe.RData'
```

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=F,results="asis",warning=FALSE,message=FALSE)
```

```{r}
  plot_NbalanceSoil <- function( sim=output, title1="", title2=title1,
                                 ymax=NULL, verify=F ) {
    NinNames  <- c("Nfert_f", "NfixT_f", "NsenprunT_f", "Nsenprun_f")
    NoutNames <- c("Nleaching_f", "Nemission_f", "Nrunoff_f", "Nupt_f", "NuptT_f")
    nNin      <- length(NinNames) ; nNout  <- length(NoutNames)
    i.Nin     <- rep(NA,nNin)     ; i.Nout <- rep(NA,nNout)
    for(i in 1:nNin ) {i.Nin [i] <- which( outputNames==NinNames [i] ) }
    for(i in 1:nNout) {i.Nout[i] <- which( outputNames==NoutNames[i] ) }
    NinMean   <- colMeans(sim[,i.Nin])  * 1.e4 * 365 # kgN ha-1 y-1
    NoutMean  <- colMeans(sim[,i.Nout]) * 1.e4 * 365 # kgN ha-1 y-1
    if(is.null(ymax)) {
      y.max <- max( sum(NinMean), sum(NoutMean) )
    } else {
      y.max = ymax
    }
    leg <- NinNames
    barplot( as.matrix(NinMean),
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Inputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title1,adj=1)
    par(mar=c(3,0,3,3))
    leg <- NoutNames
    barplot( as.matrix(NoutMean),
             yaxt="n",
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Outputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title2,adj=0)
    if(verify) {
      Nsoil_f      <- sim[ , which( outputNames=="Nsoil_f") ] # kgN m-2
      D_Nsoil_f    <- Nsoil_f[NDAYS] - Nsoil_f[1]                # kgN m-2
      NinSum       <- colSums(sim[2:NDAYS,i.Nin ])            # kgN m-2
      NoutSum      <- colSums(sim[2:NDAYS,i.Nout])            # kgN m-2
      NinMinusNout <- sum(NinSum) - sum(NoutSum)
      cat( "VERIFYING THE N-BALANCE FOR THE SOIL (kgN m-2):",
           "\nState variable change: ", D_Nsoil_f,
           "\nInputs minus outputs : ", NinMinusNout )
    }
  }
```

```{r}
  plot_CbalanceSoil <- function( sim=output, title1="", title2=title1,
                                 ymax=NULL, verify=F ) {
    CinNames  <- c("CsenprunT_f", "Csenprun_f")
    CoutNames <- c("Rsoil_f", "Crunoff_f")
    nCin      <- length(CinNames) ; nCout  <- length(CoutNames)
    i.Cin     <- rep(NA,nCin)     ; i.Cout <- rep(NA,nCout)
    for(i in 1:nCin ) {i.Cin [i] <- which( outputNames==CinNames [i] ) }
    for(i in 1:nCout) {i.Cout[i] <- which( outputNames==CoutNames[i] ) }
    CinMean   <- colMeans(sim[,i.Cin])  * 1.e4 * 365 # kgC ha-1 y-1
    CoutMean  <- colMeans(sim[,i.Cout]) * 1.e4 * 365 # kgC ha-1 y-1
    if(is.null(ymax)) {
      y.max <- max( sum(CinMean), sum(CoutMean) )
    } else {
      y.max = ymax
    }
    leg <- CinNames
    barplot( as.matrix(CinMean),
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Inputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title1,adj=1)
    par(mar=c(3,0,3,3))
    leg <- CoutNames
    barplot( as.matrix(CoutMean),
             yaxt="n",
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Outputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title2,adj=0)
    if(verify) {
      Csoil_f   <- sim[ , which( outputNames=="Csoil_f") ] # kgC m-2 
      D_Csoil_f <- Csoil_f[NDAYS] - Csoil_f[1]             # kgC m-2
      CinSum        <- colSums(sim[2:NDAYS,i.Cin ])        # kgC m-2
      CoutSum       <- colSums(sim[2:NDAYS,i.Cout])        # kgC m-2
      CinMinusCout  <- sum(CinSum) - sum(CoutSum)
      cat( "VERIFYING THE C-BALANCE FOR THE SOIL (kgC m-2):",
           "\nState variable change: ", D_Csoil_f,
           "\nInputs minus outputs : ", CinMinusCout )
    }
  }
```

```{r}
  plot_H2ObalanceSoil <- function( sim=output, title1="", title2=title1,
                                   ymax=NULL, verify=F ) {
    WinNames  <- c("Rain_f")
    WoutNames <- c("Drain_f", "Runoff_f" , "Evap_f"    ,"Tran_f" , 
                   "TranT_f", "Rainint_f", "RainintT_f")
    nWin      <- length(WinNames) ; nWout  <- length(WoutNames)
    i.Win     <- rep(NA,nWin)     ; i.Wout <- rep(NA,nWout)
    for(i in 1:nWin ) {i.Win [i] <- which( outputNames==WinNames [i] ) }
    for(i in 1:nWout) {i.Wout[i] <- which( outputNames==WoutNames[i] ) }
    WinMean   <-    mean (sim[,i.Win])  # mm d-1
    WoutMean  <- colMeans(sim[,i.Wout]) # mm d-1
    if(is.null(ymax)) {
      y.max <- max( sum(WinMean), sum(WoutMean) )
    } else {
      y.max = ymax
    }
    leg <- WinNames
    barplot( as.matrix(WinMean),
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Inputs (mm d-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title1,adj=1)
    par(mar=c(3,0,3,3))
    leg <- WoutNames
    barplot( as.matrix(WoutMean),
             yaxt="n",
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Outputs (mm d-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title2,adj=0)
    if(verify) {
      WA_f   <- sim[ , which( outputNames=="WA_f") ] # mm
      D_WA_f <- WA_f[NDAYS] - WA_f[1]                   # mm
      WinSum        <-    sum (sim[2:NDAYS,i.Win ])  # mm
      WoutSum       <- colSums(sim[2:NDAYS,i.Wout])  # mm
      WinMinusWout  <- sum(WinSum) - sum(WoutSum)
      cat( "VERIFYING THE H2O-BALANCE FOR THE SOIL (mm):",
           "\nState variable change: ", D_WA_f,
           "\nInputs minus outputs : ", WinMinusWout )
    }
  }
```

```{r}
  plot_CbalanceCoffee <- function( sim=output, title1="", title2=title1,
                                   ymax=NULL, verify=F ) {
    CinNames  <- "gC_f"
    CoutNames <- c("dC_f", "prunC_f", "harvCP_f")
    nCin      <- length(CinNames) ; nCout  <- length(CoutNames)
    i.Cin     <- rep(NA,nCin)     ; i.Cout <- rep(NA,nCout)
    for(i in 1:nCin ) {i.Cin [i] <- which( outputNames==CinNames [i] ) }
    for(i in 1:nCout) {i.Cout[i] <- which( outputNames==CoutNames[i] ) }
    CinMean   <-    mean (sim[,i.Cin])  * 1.e4 * 365 # kgC ha-1 y-1
    CoutMean  <- colMeans(sim[,i.Cout]) * 1.e4 * 365 # kgC ha-1 y-1
    if(is.null(ymax)) {
      y.max <- max( sum(CinMean), sum(CoutMean) )
    } else {
      y.max = ymax
    }
    leg <- CinNames
    barplot( CinMean,
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Inputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title1,adj=1)
    par(mar=c(3,0,3,3))
    leg <- CoutNames
    barplot( as.matrix(CoutMean),
             yaxt="n",
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Outputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title2,adj=0)
    if(verify) {
      C_f          <- sim[ , which( outputNames=="C_f" ) ] # kgC m-2
      D_C_f        <- C_f[NDAYS] - C_f[1]                     # kgC m-2
      CinSum       <-    sum (sim[2:NDAYS,i.Cin ])         # kgC m-2
      CoutSum      <- colSums(sim[2:NDAYS,i.Cout])         # kgC m-2
      CinMinusCout <- sum(CinSum) - sum(CoutSum)
      cat( "VERIFYING THE C-BALANCE OF COFFEE (kgC m-2):",
           "\nState variable change: ", D_C_f,
           "\nInputs minus outputs : ", CinMinusCout )
    }
  }
```

```{r}
  plot_CbalanceSystem <- function( sim=output, title1="", title2=title1,
                                   ymax=NULL, verify=F ) {
    CinNames  <- c("gC_f"   , "gCT_f")
    CoutNames <- c("Rsoil_f", "Crunoff_f",
                   "harvCP_f", "harvCPT_f", "harvCBT_f", "harvCST_f")
    nCin      <- length(CinNames) ; nCout  <- length(CoutNames)
    i.Cin     <- rep(NA,nCin)     ; i.Cout <- rep(NA,nCout)
    for(i in 1:nCin ) {i.Cin [i] <- which( outputNames==CinNames [i] ) }
    for(i in 1:nCout) {i.Cout[i] <- which( outputNames==CoutNames[i] ) }
    CinMean   <- colMeans(sim[,i.Cin])  * 1.e4 * 365 # kgC ha-1 y-1
    CoutMean  <- colMeans(sim[,i.Cout]) * 1.e4 * 365 # kgC ha-1 y-1
    if(is.null(ymax)) {
      y.max <- max( sum(CinMean), sum(CoutMean) )
    } else {
      y.max = ymax
    }
    leg <- CinNames
    barplot( as.matrix(CinMean),
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Inputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title1,adj=1)
    par(mar=c(3,0,3,3))
    leg <- CoutNames
    barplot( as.matrix(CoutMean),
             yaxt="n",
             beside=F, ylim=c(0,y.max), col=1:length(leg),
             legend.text=leg,
             args.legend=list( title="Outputs (kg ha-1 y-1)", cex=0.8,
                               x="bottom", bg="white", inset=c(-0.3,0) ) )
    title(title2,adj=0)
    if(verify) {
      C_f      <- sim[ , which( outputNames=="C_f" )    ] # kgC m-2
      CT_f     <- sim[ , which( outputNames=="CT_f")    ] # kgC m-2
      Csoil_f  <- sim[ , which( outputNames=="Csoil_f") ] # kgC m-2 
      Csys_f   <- C_f + CT_f + Csoil_f                    # kgC m-2
      D_Csys_f <- Csys_f[NDAYS] - Csys_f[1]               # kgC m-2
      CinSum       <- colSums(sim[2:NDAYS,i.Cin ])        # kgC m-2
      CoutSum      <- colSums(sim[2:NDAYS,i.Cout])        # kgC m-2
      CinMinusCout <- sum(CinSum) - sum(CoutSum)
      cat( "VERIFYING THE C-BALANCE FOR THE SYSTEM (kgC m-2):",
           "\nState variable change: ", D_Csys_f,
           "\nInputs minus outputs : ", CinMinusCout )
    }
  }
```

```{r}
  plot_CdistributionCoffee <- function( sim=output ) {
    Time <- sim[,1]
    i.CP <- which( outputNames=="CP_f" ) ; CP <- sim[,i.CP]
    i.CL <- which( outputNames=="CL_f" ) ; CL <- sim[,i.CL]
    i.CW <- which( outputNames=="CW_f" ) ; CW <- sim[,i.CW]
    i.CR <- which( outputNames=="CR_f" ) ; CR <- sim[,i.CR]
    plot( Time, CR+CW+CL+CP,
          main="Carbon in coffee (kg C m-2)",
          xlab="", ylab="", type="l", ylim=c(0,max(CR+CW+CL+CP)) )
    points( Time, CR+CW+CL, type="l", col="yellow" )
    points( Time, CR+CW   , type="l", col="green" )
    points( Time, CR      , type="l", col="red" )
    legend( "bottom", cex=0.7, lty=1, bg="white",
            col=c("black","yellow","green","red"),
            legend=c("+ CP: Beans",
                     "+ CL: Leaves",
                     "+ CW: Wood",
                     "   CR: Roots" ) )
  }
```

```{r}
  plot_CdistributionTrees <- function( sim=output, it=1:3 ) {
    Time <- sim[,1]
    i.CPT <- sapply( 1:3, function(i){which( outputNames==paste0("CPT_t(",i,")"))} )
    i.CLT <- sapply( 1:3, function(i){which( outputNames==paste0("CLT_t(",i,")"))} )
    i.CBT <- sapply( 1:3, function(i){which( outputNames==paste0("CBT_t(",i,")"))} )
    i.CST <- sapply( 1:3, function(i){which( outputNames==paste0("CST_t(",i,")"))} )
    i.CRT <- sapply( 1:3, function(i){which( outputNames==paste0("CRT_t(",i,")"))} )
    for(t in it) {
      CPT   <- sim[,i.CPT[t]] ; CLT <- sim[,i.CLT[t]] ; CBT <- sim[,i.CBT[t]]
      CST   <- sim[,i.CST[t]] ; CRT <- sim[,i.CRT[t]]
      y.max <- max(CRT+CST+CBT+CLT+CPT)
      plot( Time, CRT+CST+CBT+CLT+CPT, ylim=c(0,y.max),
            main=paste0("Carbon in tree sp. ",it," (kg C m-2)"),
            xlab="", ylab="", type="l" )
      points( Time, CRT+CST+CBT+CLT, type="l", col="yellow" )
      points( Time, CRT+CST+CBT    , type="l", col="green"  )
      points( Time, CRT+CST        , type="l", col="red"    )
      points( Time, CRT            , type="l", col="blue"   )
      legend( "bottom", cex=0.7, lty=1, bg="white",
              col=c("black","yellow","green","red","blue"),
              legend=c("+ CPT: Fruits",
                       "+ CLT: Leaves",
                       "+ CBT: Branches",
                       "+ CST: Stems",
                       "   CRT: Roots" ) )
    }
  }
```

```{r}
  params.MAP.s <- function(s) {
    params_BC_MAP   <- scparMAP_BC  * sc
    params          <- list_params        [[s]]
    ip_BC_s         <- ip_BC_site         [[s]]
    icol_pChain_s   <- icol_pChain_site   [[s]]
    params[ip_BC_s] <- params_BC_MAP      [icol_pChain_s]
    return( params )
  }
```

# AGENDA 1: Improving the Masatepe-BC May-June 2021

- Tree data
  - Careful: Thinned trees are typically not representative of the stand.
  - When data are in FWT, perhaps assume that 25% of tree woody *volume* is water (Cermak et al. 2007). We would then still need wood density (kg DM m-3) to be able to convert from FWT to DM.
  - Tree biomass reported for ABG only or whole-tree including roots?
  - Ignore 'Biomasa  de rebrotes a 3 metros de inga 2009.xls': extremely light pruning, providing no measure of branch biomass etc. Better data in 'Biomasa arboles  primer raleo por especie A S 2008.xls' which was an intensive pollarding (perhaps 90% of branch pruned), so those data provide a better estimate of the amount of leaves and branches on an Inga tree.
- Data Martin Noponen
- Fertilisation timing
  - CI & CM 2 applications: 15 June, 15 Sep
  - OI & OM 1 application: 30 April (end of dry season)
- Include TCSOM parameters and aim for near-balance of sources and sinks?
- When there are two timber species they will not overlap much, perhaps each could reach 60% of ground cover.
- Inga is not a shade-plot like coffee and will suffer if fully overshadowed by timber trees. But coffee production would then suffer as well. Good management therefore aims to keep timber tree shade below 60%. 

# AGENDA 2: Redoing the Turrialba-BC June 2021 (experiment and fruit trees)

- Use latest model version
- Use all data:
  - Martin Noponen: soil, GHG balance, etc.
  - Less SOM than in Masatepe (60%?)
  - Higher CN ratio in soil than in Masatepe (15 instead of 10?)
  - Roland Cerda: banana & citrus
    - From Rolando's file: choose farms with high fruit tree density and simulate them as extra treatments in the Turrialba experiment (for soil, weather etc.): EMu = poro + banana, ECi = poro + citrus.
  - Fertilisation levels from Haggar et al. (2011)
  - Fertilisation timings as in file Oriana or as in Masatepe?
  - Assumptions about non-leaching at zero-fertilisation
  - Better weather data for final years?
- Include TCSOM parameters and aim for near-balance of sources and sinks?

# AGENDA 3: BC Llano Bonito (and perhaps Aquiares)

- Files from Oriana. LB at 1600+ m, Aquiares at 1000+ m.
- At LB there were Musaceae, but not in the data files (two tree species could then not be handled by CAF2014), but maybe check the paper by Louise Myelan that is referred to in Oriana et al's 2020 paper.
- Aquiares had unusual poro management: no thinning, no pruning.

# Turrialba

Unless otherwise indicated, all results shown in this section are for the Maximum A Posteriori (MAP) paramater vector from calibrating CAF2021 on data from Turrialba

Fig. \ref{fig:YieldsObsSimTurrialba} shows observed and simulated variation of coffee production in the 18 simulated treatments of the Turrialba experiment.

```{r}
  load( file_BC_Turrialba.RData )
  source("initialisation/initialise_CAF2021_Turrialba_15_CE_AC.R")

  params.Prior.15 <- params
  output.Prior.15 <- run_model( p=params.Prior.15 )
  
  params.MAP.15   <- params.MAP.s( 15 )
  output.MAP.15   <- run_model( p=params.MAP.15 )
```

```{r, out.width="100%", fig.cap="\\label{fig:YieldsObsSimMasatepe}Simulated vs. observed annual yields for the 18 treatments in Turrialba. Left: all recorded and simulated yields. Right: average yield for each of the treatments."}
  load( file_BC_Turrialba.RData )
  source('BC/BC_plot_yields.R')
```

```{r}
  plot_output( list_output=list(output.Prior.15),
               vars       =c( "fTran(1)"    , "fNgrowth(1)", "DVS(1)"  ,
                              "SINKP(1)"    , "DayFl(1)"   , "PARMA(1)" ,
                              "harvDM_f_hay", "CT_f" ) )
  plot_output( list_output=list(output.MAP.15),
               vars       =c( "fTran(1)"    , "fNgrowth(1)", "DVS(1)"  ,
                              "SINKP(1)"    , "DayFl(1)"   , "PARMA(1)" ,
                              "harvDM_f_hay", "CT_f" ) )
```

Biogeochemical balances for Turrialba are shown in Fig. \ref{fig:BalancesTurrialba}.

```{r Balances, fig.height=6, fig.cap="\\label{fig:BalancesTurrialba}Biogeochemical balances for nitrogen, carbon and water at Turrialba in treatment 15. Left bar from each pair: gains; right bar: losses. All rates are averages for the whole period of simulation."}
  par( mar=c(3,3,3,0), mfrow=c(2,4) )
  plot_NbalanceSoil  (output.MAP.15, title1="Soil N-balance"  , title2="")
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil  (output.MAP.15, title1="Soil C-balance"  , title2="")
  par( mar=c(3,3,3,0) )
  plot_H2ObalanceSoil(output.MAP.15, title1="Soil H2O-balance", title2="")
  par( mar=c(3,3,3,0) )
  plot_CbalanceSystem(output.MAP.15, title1="System C-balance", title2="")
```

# Masatepe

Unless otherwise indicated, all results shown in this section are for the Maximum A Posteriori (MAP) paramater vector from calibrating CAF2021 on data from Masatepe.

Fig. \ref{fig:YieldsObsSimMasatepe} shows observed and simulated variation of coffee production in the 14 simulated treatments of the Masatepe experiment.

```{r}
  load( file_BC_Masatepe.RData )
  source("initialisation/initialise_CAF2021_Masatepe_05_SGTR_CI.R")

  params.Prior.5 <- params
  output.Prior.5 <- run_model( p=params.Prior.5 )
  
  params.MAP.5   <- params.MAP.s( 5 )
  output.MAP.5   <- run_model( p=params.MAP.5 )
```

```{r}
  load( file_BC_Masatepe.RData )
  source("initialisation/initialise_CAF2021_Masatepe_09_ILSS_CI.R")

  params.Prior.9 <- params
  output.Prior.9 <- run_model( p=params.Prior.9 )
  
  params.MAP.9   <- params.MAP.s( 9 )
  output.MAP.9   <- run_model( p=params.MAP.9 )
```

```{r, out.width="100%", fig.cap="\\label{fig:YieldsObsSimMasatepe}Simulated vs. observed annual yields for the 14 treatments in Masatepe 2005-2014. Left: all 140 recorded and simulated yields. Right: average yield for each of the treatments."}
  load( file_BC_Masatepe.RData )
  source('BC/BC_plot_yields.R')
```

```{r}
  plot_output( list_output=list(output.Prior.9),
               vars       =c( "fTran(1)"    , "fNgrowth(1)", "DVS(1)"  ,
                              "SINKP(1)"    , "DayFl(1)"   , "PARMA(1)" ,
                              "harvDM_f_hay", "CT_f" ) )
  plot_output( list_output=list(output.MAP.9),
               vars       =c( "fTran(1)"    , "fNgrowth(1)", "DVS(1)"  ,
                              "SINKP(1)"    , "DayFl(1)"   , "PARMA(1)" ,
                              "harvDM_f_hay", "CT_f" ) )
```

Biogeochemical balances for Masatepe (Nicaragua) are shown in Fig. \ref{fig:Balances}.

```{r Balances, fig.height=6, fig.cap="\\label{fig:Balances}Biogeochemical balances for nitrogen, carbon and water at Masatepe in the ILSS_CI system (shading by both Inga laurina and Samanea saman; Fertilisation-mode CI). Left bar from each pair: gains; right bar: losses. All rates are averages for the whole period of simulation."}
  par( mar=c(3,3,3,0), mfrow=c(2,4) )
  plot_NbalanceSoil  (output.MAP.9, title1="Soil N-balance"  , title2="")
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil  (output.MAP.9, title1="Soil C-balance"  , title2="")
  par( mar=c(3,3,3,0) )
  plot_H2ObalanceSoil(output.MAP.9, title1="Soil H2O-balance", title2="")
  par( mar=c(3,3,3,0) )
  plot_CbalanceSystem(output.MAP.9, title1="System C-balance", title2="")
```

Comparison of leaving tree branches on the field after thinning and pruning (default) vs. removing them as harvest (customary in NIC and GTM): Fig. \ref{fig:Balances2}.

```{r Balances2, fig.height=6, fig.cap="\\label{fig:Balances2}Soil N- and C-balances at Masatepe in the ILSS_CI system. Top row: tree branches left as litter after pruning and thinning. Bottom row: branches harvested."}
  # load( file_BC_Masatepe.RData )
  source("initialisation/initialise_CAF2021_Masatepe_09_ILSS_CI.R")

  params  <- params.MAP.9
  params1 <- set_par( c("FHARVBT(1)","FHARVBT(2)","FHARVBT(3)"),
                      c( 0          , 0          , 0          ) )
  params2 <- set_par( c("FHARVBT(1)","FHARVBT(2)","FHARVBT(3)"),
                      c( 1          , 1          , 1          ) )
  output1 <- run_model( p=params1 )
  output2 <- run_model( p=params2 )

  par( mar=c(3,3,3,0), mfrow=c(2,4) )
  plot_NbalanceSoil( output1, title1="Soil N-balance 1", title2="" )
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil( output1, title1="Soil C-balance 1", title2="" )
  par( mar=c(3,3,3,0) )
  plot_NbalanceSoil( output2, title1="Soil N-balance 2", title2="" )
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil( output2, title1="Soil C-balance 2", title2="" )
```

Sensitivity of soil balances to parameter settings: Fig. \ref{fig:Balances3}.

```{r Balances3, fig.height=6, fig.cap="\\label{fig:Balances3}Soil N- and C-balances at Masatepe in the ILSS_CI system, with various parameter settings."}
  # load( file_BC.RData )
  source("initialisation/initialise_CAF2021_Masatepe_09_ILSS_CI.R")

  params      <- params.MAP.9
  TCLITT.MAP  <- params[ which(names_params=='TCLITT' ) ]
  TCSOMF.MAP  <- params[ which(names_params=='TCSOMF' ) ]
  TCSOMS.MAP  <- params[ which(names_params=='TCSOMS' ) ]
  RNLEACH.MAP <- params[ which(names_params=='RNLEACH') ]
  
  params0 <- set_par( c("TCLITT"   ,"TCSOMF"   ,"TCSOMS"   ,"RNLEACH"   ),
                      c( TCLITT.MAP, TCSOMF.MAP, TCSOMS.MAP, RNLEACH.MAP) )
  params1 <- set_par( c("TCLITT"   ,"TCSOMF"   ,"TCSOMS"   ,"RNLEACH"   ),
                      c( TCLITT.MAP, TCSOMF.MAP, TCSOMS.MAP, RNLEACH.MAP)*
                      c( 2         , 2         , 2         , 1          ) )
  params2 <- set_par( c("TCLITT"   ,"TCSOMF"   ,"TCSOMS"   ,"RNLEACH"   ),
                      c( TCLITT.MAP, TCSOMF.MAP, TCSOMS.MAP, RNLEACH.MAP)*
                      c( 1         , 1         , 1         , 0.1        ) )
  output0 <- run_model( p=params0 )
  output1 <- run_model( p=params1 )
  output2 <- run_model( p=params2 )

  par( mar=c(3,3,3,0), mfrow=c(3,4) )
  plot_NbalanceSoil( output0, title1="Soil N-balance 0", title2="" )
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil( output0, title1="Soil C-balance 0", title2="" )
  par( mar=c(3,3,3,0) )
  plot_NbalanceSoil( output1, title1="Soil N-balance 1", title2="" )
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil( output1, title1="Soil C-balance 1", title2="" )
  par( mar=c(3,3,3,0) )
  plot_NbalanceSoil( output2, title1="Soil N-balance 2", title2="" )
  par( mar=c(3,3,3,0) )
  plot_CbalanceSoil( output2, title1="Soil C-balance 2", title2="" )
```

Fig. \ref{fig:Nbalance4Nlevels} shows how the soil N-balance is affected by N-fertilisation.

```{r Nbalance4Nlevels, fig.height=6, fig.cap="\\label{fig:Nbalance4Nlevels}Soil nitrogen balances for 4 different treatments at Masatepe in the ILSS system (shading by both Inga laurina and Samanea saman). Gains on the left, losses on the right."}
  par( mfrow=c(2,4) )

  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Masatepe_09_ILSS_CI.R")
  params <- params.MAP.s(9)
  # TCLITT.MAP  <- params[ which(names_params=='TCLITT' ) ]
  # TCSOMF.MAP  <- params[ which(names_params=='TCSOMF' ) ]
  # TCSOMS.MAP  <- params[ which(names_params=='TCSOMS' ) ]
  # RNLEACH.MAP <- params[ which(names_params=='RNLEACH') ]
  # params <- set_par( c("TCLITT"   ,"TCSOMF"   ,"TCSOMS"   ,"RNLEACH"   ),
  #                    c( TCLITT.MAP, TCSOMF.MAP, TCSOMS.MAP, RNLEACH.MAP)*
  #                    c( 2         , 2         , 2         , 0.1        ) )
  output <- run_model()
  plot_NbalanceSoil(output, title1="", title2="CI", ymax=800)
  # plot_NbalanceSoil(output.MAP.9, title1="", title2="CI", ymax=800)
  
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Masatepe_10_ILSS_CM.R")
  params <- params.MAP.s(10)
  # TCLITT.MAP  <- params[ which(names_params=='TCLITT' ) ]
  # TCSOMF.MAP  <- params[ which(names_params=='TCSOMF' ) ]
  # TCSOMS.MAP  <- params[ which(names_params=='TCSOMS' ) ]
  # RNLEACH.MAP <- params[ which(names_params=='RNLEACH') ]
  # params <- set_par( c("TCLITT"   ,"TCSOMF"   ,"TCSOMS"   ,"RNLEACH"   ),
  #                    c( TCLITT.MAP, TCSOMF.MAP, TCSOMS.MAP, RNLEACH.MAP)*
  #                    c( 2         , 2         , 2         , 0.1        ) )
  output <- run_model()
  plot_NbalanceSoil(output, title1="", title2="CM", ymax=800)
  
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Masatepe_11_ILSS_OI.R")
  params <- params.MAP.s(11)
  # TCLITT.MAP  <- params[ which(names_params=='TCLITT' ) ]
  # TCSOMF.MAP  <- params[ which(names_params=='TCSOMF' ) ]
  # TCSOMS.MAP  <- params[ which(names_params=='TCSOMS' ) ]
  # RNLEACH.MAP <- params[ which(names_params=='RNLEACH') ]
  # params <- set_par( c("TCLITT"   ,"TCSOMF"   ,"TCSOMS"   ,"RNLEACH"   ),
  #                    c( TCLITT.MAP, TCSOMF.MAP, TCSOMS.MAP, RNLEACH.MAP)*
  #                    c( 2         , 2         , 2         , 0.1        ) )
  output <- run_model()
  plot_NbalanceSoil(output, title1="", title2="OI", ymax=800)
  
  par(mar=c(3,3,3,0))
  source("initialisation/initialise_CAF2021_Masatepe_12_ILSS_OM.R")
  params <- params.MAP.s(12)
  # TCLITT.MAP  <- params[ which(names_params=='TCLITT' ) ]
  # TCSOMF.MAP  <- params[ which(names_params=='TCSOMF' ) ]
  # TCSOMS.MAP  <- params[ which(names_params=='TCSOMS' ) ]
  # RNLEACH.MAP <- params[ which(names_params=='RNLEACH') ]
  # params <- set_par( c("TCLITT"   ,"TCSOMF"   ,"TCSOMS"   ,"RNLEACH"   ),
  #                    c( TCLITT.MAP, TCSOMF.MAP, TCSOMS.MAP, RNLEACH.MAP)*
  #                    c( 2         , 2         , 2         , 0.1        ) )
  output <- run_model()
  plot_NbalanceSoil(output, title1="", title2="OM", ymax=800)
```

# Deciduousness

```{r}
  plot_output( list_output=list(output.MAP.5),
               vars       =c( "LAIT_t(1)", "LAIT_t(2)", "LAIT_t(3)" ) )

  plot_output( list_output=list(output.MAP.9),
               vars       =c( "LAIT_t(1)", "LAIT_t(2)", "LAIT_t(3)" ) )

```

```{r, fig.height=6, fig.cap="\\label{fig:Deciduousness}Soil N- and C-balances at Masatepe in the ILSS_CI system. Top row: tree branches left as litter after pruning and thinning. Bottom row: branches harvested."}
  params    <- params.MAP.5
  paramsM5a <- set_par( c("FTCLMINT(3)","TCLMAXT(3)"),
                        c( 0.2         , 650        ) )
  paramsM5b <- set_par( c("FTCLMINT(3)","TCLMAXT(3)"),
                        c( 0.05        , 650        ) )
  paramsM5c <- set_par( c("FTCLMINT(3)","TCLMAXT(3)"),
                        c( 0.2         , 365        ) )
  
  source("initialisation/initialise_CAF2021_Masatepe_05_SGTR_CI.R")
  output.MAP.5a <- run_model( p=paramsM5a )
  output.MAP.5b <- run_model( p=paramsM5b )
  output.MAP.5c <- run_model( p=paramsM5c )

  plot_output( list_output=list(output.MAP.5,
                                output.MAP.5a,output.MAP.5b ,output.MAP.5c),
               vars=c( "LAIT_t(3)" ) )

  plot_output( list_output=list(output.MAP.5,
                                output.MAP.5a,output.MAP.5b ,output.MAP.5c),
               vars=c( "fTranT_t(3)" ) )
```

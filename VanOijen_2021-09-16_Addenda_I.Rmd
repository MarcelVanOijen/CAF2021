---
title: 'Modelling Coffee Agroforestry in Central America with CAF2021'
subtitle: 'Progress report III for project SEACAF, sub-contract B0554x4'
author:
- Marcel van Oijen^[Independent researcher, Edinburgh, UK - VanOijenMarcel@gmail.com]
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
csl: environmental-modelling-and-software.csl
bibliography: [Avocado.bib,Banana.bib,SEACAF.bib]
---

```{r, include=FALSE}
  knitr::opts_chunk$set(echo=F,results="asis",warning=FALSE,message=FALSE)
  library( geosphere )
  library( readxl    )
  library( tidyverse )
```

```{r, eval=F}
  filesTM <- file.info(list.files(pattern="^BC_Turrialba_Masatepe.*\\.RData$"))
  filesTM <- filesTM[ with(filesTM,order(as.POSIXct(mtime))), ]
  fileTM  <- tail( rownames(filesTM[1]), 1 )
  load( fileTM )
  
  # filesTM_MAP <- file.info(list.files(pattern="^CAF2021_parMAP.*\\.rds$"))
  # filesTM_MAP <- filesTM_MAP[ with(filesTM_MAP,order(as.POSIXct(mtime))), ]
  # fileTM_MAP  <- tail( rownames(filesTM_MAP[1]), 1 )
  fileTM_MAP  <- "CAF2021_parMAP_08_36.rds"
  parMAP.old  <- readRDS( fileTM_MAP ) ; np.old <- dim(parMAP.old)[1]
  
  # Construct the parMAP (with more parameters than stored in fileTM_MAP)
  source('initialisation/set_CAF2021_Turrialba.R')
  np               <- length( params )
  parMAP           <- matrix( params, nrow=np, ncol=nSites, byrow=F )
  rownames(parMAP) <- names_params
  colnames(parMAP) <- paste0( "s", 1:nSites )
  for(p in 1:np.old) {
    prow          <- which( startsWith( rownames(parMAP),
                                        rownames(parMAP.old)[p] ) )
    for(r in prow) { parMAP[r,] <- parMAP.old[p,] }
  }
```

```{r}
  update_matMAP <- function( matMAP.old=matMAP_C,
                             init.new='initialisation/set_CAF2021_CG.R' ) {
    source( init.new )
    np.old <- dim(matMAP.old)[1] ; ns.old <- dim(matMAP.old)[2]
    np.new <- length( params )   ; ns.new <- ns.old
    matMAP.new           <- matrix( params, nrow=np.new, ncol=ns.new, byrow=F )
    rownames(matMAP.new) <- names_params
    colnames(matMAP.new) <- paste0( "s", 1:ns.new )
    for(p.old in 1:np.old) {
      p.new              <- which( rownames(matMAP.new) ==
                                   rownames(matMAP.old)[p.old] )
      matMAP.new[p.new,] <- matMAP.old[p.old,] }
    return( matMAP.new )
  }
```

```{r, eval=F}
  dir.params   <- "parameters/"
  file_par_def <- paste0( dir.params, "parameters_default_parMAP.txt" )
  file.create( file_par_def )
  
  write.table( parMAP, file=file_par_def, sep="\t", col.names=NA )
```

```{r}
  add.lmleg <- function(orig=FALSE){
    if(orig) { y.lm <- lm( y ~ 0 + x ) }
    else     { y.lm <- lm( y ~ x ) }
    r2   <- round( summary(y.lm)$r.squared, 2 )
    if(orig) {
      abline( 0, y.lm$coefficients[1], col="blue" )
    } else {
      abline( y.lm$coefficients[1], y.lm$coefficients[2], col="blue" )
    }
    legend( "bottomright",
            legend=paste("r2= ",as.character(r2)),
            col=c("blue"), lty=c(1), cex=0.7, bg="transparent" )
  }

  plotxylm <- function(maintxt="Obs. Costa Rica", xtxt="Sim.", orig=FALSE) {
    plot(x,y,xlab=xtxt,ylab="",main=maintxt) ; add.lmleg(orig)
  }
```

```{r}
  load( "df_C.f.rda" )
  load( "df_G.f.rda" )

  n_C.f <- dim(df_C.f)[1] ; n_G.f <- dim(df_G.f)[1]
```



\clearpage

# Correcting errors in df_C.f and df_G.f


## Capping excessive fertilisation rates

```{r, eval=F}
  iN500_C <- which(df_C.f$Nfert > 500 )
  iN500_G <- which(df_G.f$Nfert > 500 )
  
  cbind( df_C.f$code[iN500_C], df_C.f$Nfert[iN500_C] )
  cbind( df_G.f$code[iN500_G], df_G.f$Nfert[iN500_G] )
  
  df_C.f$Nfert[iN500_C] <- 500
  df_G.f$Nfert[iN500_G] <- 500
```

## Correcting inconsistencies in reported tree and shade variables

```{r, eval=F}
  if1104 <- which( df_C.f$code==1104 ) # nt=8 but tree densities all 0
  if1157 <- which( df_C.f$code==1157 ) # nt=0 but shade>0 (VisSky<1)
  
  c( df_C.f$nt[if1104], df_C.f$shade[if1104] )
  c( df_C.f$nt[if1157], df_C.f$shade[if1157] )
  
  df_C.f$nt[if1157] <- 1
```



\clearpage

# New file for farm soils, application of pedotransfer functions and updating df_C|G.f

```{r, eval=F}
  dir.f       <- "data/Farms SEACAF/"
  file_soil.f <- "Soil_general_final.xlsx"
```

```{r, eval=F}
  df_soil1.f0 <- read_excel( paste0(dir.f,file_soil.f),
                             sheet="bulk_density", guess_max=3000, skip=1 )

  df_soil1.f  <- df_soil1.f0 %>%
    mutate( code = ifelse(country=="Costa Rica", 1000,
                   ifelse(country=="Guatemala" , 2000,
                          NA )) ) %>%
    mutate( code = code + farm_number ) %>%
    arrange( code ) %>%
    rename( DM.soil = "bulkDensity_g.cm3" ) %>%
    mutate( DM.soil = as.numeric(DM.soil) ) %>%
    group_by( code ) %>%
    summarise( DM.soil = mean(DM.soil,na.rm=T) ) %>%
    drop_na() %>%
    dplyr::select( code, DM.soil )
```

```{r, eval=F}
  # Pedotransfer function derived by Tomasella et al. (2003)
  # as presented and evaluated by Tomasella et al. (2004)
  # We have no data for "Moisture equivalence (Me)" and set it at Me=0.4.
  # Me also add minimum bounds (WP>=0.05, FC>=WP+0.10)
  fTomasella2003 <- function(DM,SI,CL){
    Me  = 0.4
    x14 = -1.05501 + 0.0650857 * SI
    x15 = -2.07588 + 0.0423954 * CL
    x16 = -6.03402 + 4.80572   * DM
    x17 = -2.18409 + 8.84963   * Me
    z9  =  0.175202 + 1.18513 * x17 - 0.0996042 * x17^2 +
           0.327915 * x16 - 0.0758657 * x16^2
    z10 =  0.929344 * z9 + 0.132519 * x14
    z13 =  0.235084 + 0.33033 * x15 - 0.191838 * x15^2 + 0.0543679 * x15^3 +
           0.977685 * x17 + 0.304174 * x15 * x17 - 0.218857 * x17^2 -
           0.164373 * x15 * x17^2 + 0.0415057 * x17^3 +
           0.373361 * x16 + 0.0811861 * x17 * x16 - 0.0768087 * x15 * x17 * x16
    WP  =  pmax( 0.05  , 0.214008 + 0.0862945 * z13 )
    FC  =  pmax( WP+0.1, 0.339255 + 0.112526  * z10 )
    return( list(WP=WP,FC=FC) ) }

# # Tropical Andosols (Hodnett & Tomasella 2002)
#   VanGenuchten <- function(psi=-1600,a=0.53,n=1.502,thetaR=0.251,thetaS=0.633) {
#     theta <- thetaR + (thetaS-thetaR) / (1 + (a*abs(psi))^n)^(1-1/n)
#     return( theta ) }
# 
#   VanGenuchten( -Inf) # WCAD 0.25
#   VanGenuchten(-1600) # WCWP 0.26
#   VanGenuchten(  -10) # WCFC 0.41
#   VanGenuchten(    0) # WCST 0.63
```

```{r, eval=F}
  df_soil2.f0 <- read_excel( paste0(dir.f,file_soil.f),
                             sheet="physical_chemical" )

  df_soil2.f <- df_soil2.f0 %>%
    mutate( code = ifelse( startsWith(farm_code,"Costa Rica"), 1000,
                   ifelse( startsWith(farm_code,"Guatemala" ), 2000,
                           NA )) ) %>%
    mutate( code = code + farm_number ) %>%
    arrange( code ) %>%
    
    rename( Cperc.soil.00_13 = "pCtot_0-13"  ) %>%
    rename( Cperc.soil.13_26 = "pCtot_13-26" ) %>%
    rename( Nperc.soil.00_13 = "pNtot_0-13"  ) %>%
    rename( Nperc.soil.13_26 = "pNtot_13-26" ) %>%
    mutate( Cperc.soil.00_26 = rowMeans(
      select( ., Cperc.soil.00_13, Cperc.soil.13_26 ) ) ) %>%
    mutate( Nperc.soil.00_26 = rowMeans(
      select( ., Nperc.soil.00_13, Nperc.soil.13_26 ) ) ) %>%

    rename( sand.00_13 = "pSand_0-13"       ) %>%
    rename( sand.13_26 = "pSand_13-26"      ) %>%
    rename( silt.00_13 = "pSilt_0-13"       ) %>%
    rename( silt.13_26 = "pSilt_13-26"      ) %>%
    rename( clay.00_13 = "pClay_0-13"       ) %>%
    rename( clay.13_26 = "pClay_13-26"      ) %>%
    
    mutate( sand = rowMeans(select(., "sand.00_13", "sand.13_26" ),
                            na.rm=TRUE) ) %>%
    mutate( silt = rowMeans(select(., "silt.00_13", "silt.13_26" ),
                            na.rm=TRUE) ) %>%
    mutate( clay = rowMeans(select(., "clay.00_13", "clay.13_26" ),
                            na.rm=TRUE) ) %>%
    
    dplyr::select( code, Cperc.soil.00_26, Nperc.soil.00_26, sand, silt, clay )
```

```{r, eval=F}
  df_soil.f <- df_soil1.f %>%
    inner_join( df_soil2.f, by="code" ) %>%
    mutate( C.soil.00_26 = DM.soil * 260 * Cperc.soil.00_26 / 100 ) %>%
    mutate( N.soil.00_26 = DM.soil * 260 * Nperc.soil.00_26 / 100 ) %>%
    mutate( CN.soil = Cperc.soil.00_26 / Nperc.soil.00_26 ) %>%

    mutate( C.soil = C.soil.00_26  * 2 ) %>% # Assuming half of SOM is in top 26 cm
    mutate( N.soil = N.soil.00_26  * 2 ) %>% # Assuming half of SOM is in top 26 cm
    # mutate( C.soil = C.soil.00_26  * 1.5 ) %>% # Assuming 2/3 of SOM is in top 26 cm
    # mutate( N.soil = N.soil.00_26  * 1.5 ) %>% # Assuming 2/3 of SOM is in top 26 cm
  
    mutate ( WP = fTomasella2003(DM.soil,silt,clay)$WP ) %>%
    mutate ( FC = fTomasella2003(DM.soil,silt,clay)$FC ) %>%
  
    dplyr::select( code, DM.soil, CN.soil, C.soil, N.soil,
                   sand, silt, clay, WP, FC )

  df_soil_C.f <- df_soil.f %>% subset( df_soil.f$code <  2000 )
  df_soil_G.f <- df_soil.f %>% subset( df_soil.f$code >= 2000 )
```

```{r, eval=F}
  df_C.f <- df_C.f %>%
    dplyr::select ( ., -c(DM.soil,CN.soil,C.soil,N.soil) ) %>%
    inner_join( df_soil_C.f, by="code" )
    
  df_G.f <- df_G.f %>%
    dplyr::select ( ., -c(DM.soil,CN.soil,C.soil,N.soil) ) %>%
    inner_join( df_soil_G.f, by="code" )
  
  n_C.f  <- dim(df_C.f)[1] ; n_G.f <- dim(df_G.f)[1]
```

```{r, eval=F}
  summary(df_C.f$C.soil)
  summary(df_G.f$C.soil)
  summary(df_C.f$N.soil)
  summary(df_G.f$N.soil)
  
  summary(df_C.f$WP)
  summary(df_G.f$WP)
  summary(df_C.f$FC)
  summary(df_G.f$FC)
  summary( df_C.f$FC - df_C.f$WP )
  summary( df_G.f$FC - df_G.f$WP )
```



\clearpage

# Weather data 2019-2020 and updating df_C|G.f

```{r, eval=T}
  dir_weatherstations <- "weather/Climatic_Data/"
    dir_C_Icafe   <- "CostaRica/Icafe/"
    dir_C_IMN     <- "CostaRica/IMN/"
    dir_G_Anacafe <- "Guatemala/Anacafe/"

  dir_Icafe     <- paste0( dir_weatherstations, dir_C_Icafe   ) 
  dir_IMN       <- paste0( dir_weatherstations, dir_C_IMN     )
  dir_Anacafe   <- paste0( dir_weatherstations, dir_G_Anacafe ) 
  
  file_Icafe    <- "Datos confidenciales CLIMA-ICAFE- Convenio CATIE.xlsx"
  files_IMN.TMIN <- list.files( dir_IMN, pattern="*TMIN_TMAX_RAIN.xlsx" )
  files_IMN.TMAX <- list.files( dir_IMN, pattern="*TMIN_TMAX_RAIN.xlsx" )
  files_IMN.RAIN <- list.files( dir_IMN, pattern="*RAIN.xlsx" )
    n_IMN.TMIN   <- length( files_IMN.TMIN )
    n_IMN.TMAX   <- length( files_IMN.TMAX )
    n_IMN.RAIN   <- length( files_IMN.RAIN )
  files_Anacafe <- list.files( dir_Anacafe )
    n_Anacafe   <- length( files_Anacafe )
```

```{r, eval=T}
  df_Icafe       <- read_excel( paste0(dir_Icafe,file_Icafe) )
  stations_Icafe <- unique(df_Icafe$Estacion) ; n_Icafe <- length(stations_Icafe)

  list_Icafe.a    <- list_Icafe    <- vector( "list", n_Icafe    )
  list_IMN.TMIN.a <- list_IMN.TMIN <- vector( "list", n_IMN.TMIN )
  list_IMN.TMAX.a <- list_IMN.TMAX <- vector( "list", n_IMN.TMAX )
  list_IMN.RAIN.a <- list_IMN.RAIN <- vector( "list", n_IMN.RAIN )
  list_Anacafe.a  <- list_Anacafe  <- vector( "list", n_Anacafe  )

  for( s in 1:n_Icafe ) {
    list_Icafe[[s]]   <- df_Icafe %>% filter( Estacion==stations_Icafe[s] ) }
  for( s in 1:n_IMN.TMIN ) {
    fs <- paste0(dir_IMN,files_IMN.TMIN[s])
    list_IMN.TMIN[[s]] <- read_excel( fs, sheet="TMIN", skip=1,
                                      col_type="numeric" ) }
  for( s in 1:n_IMN.TMAX ) {
    fs <- paste0(dir_IMN,files_IMN.TMAX[s])
    list_IMN.TMAX[[s]] <- read_excel( fs, sheet="TMAX", skip=1,
                                      col_type="numeric" ) }
  for( s in 1:n_IMN.RAIN ) {
    fs <- paste0(dir_IMN,files_IMN.RAIN[s])
    list_IMN.RAIN[[s]] <- read_excel( fs, sheet="RAIN", skip=1,
                                      col_type="numeric" ) }
  for( s in 1:n_Anacafe ) {
    list_Anacafe[[s]] <- read_csv( paste0(dir_Anacafe,files_Anacafe[s]) ) }
```

```{r}
  ny_Icafe <- rep( NA, n_Icafe )
  for( s in 1:n_Icafe)    { r <- range( list_Icafe[[s]]$year )
    ny_Icafe[s]   <- 1 + r[2] - r[1] }

  ny_IMN <- rep( NA, n_IMN.RAIN )
  for( s in 1:n_IMN.RAIN) { r <- range( list_IMN.RAIN[[s]]$Año )
    ny_IMN[s]     <- 1 + r[2] - r[1] }
  
  ny_Anacafe <- rep( NA, n_Anacafe )
  for( s in 1:n_Anacafe)  { r <- range( list_Anacafe[[s]][,"year"] )
    ny_Anacafe[s] <- 1 + r[2] - r[1] }
```


```{r, eval=T}
  for( s in 1:n_Icafe ) {
    list_Icafe.a[[s]] <- list_Icafe[[s]] %>%
      rename( ST = Estacion ) %>%
      rename( TMAX    = "Temperatura máxima °C" ) %>%
      rename( TMIN    = "Temperatura mínima °C" ) %>%
      rename( RAIN    = "Lluvia mm" ) %>%
      dplyr::select( ST, year, month, TMIN, TMAX, RAIN ) %>%
      group_by( ST, year, month ) %>%
      summarize( TMIN = mean(TMIN,na.rm=T),
                 TMAX = mean(TMAX,na.rm=T),
                 RAIN = sum (RAIN,na.rm=T) ) %>%
      group_by ( month ) %>%
      mutate( TMIN.m = mean(TMIN,na.rm=T) ) %>%
      mutate( TMAX.m = mean(TMAX,na.rm=T) ) %>%
      mutate( RAIN.m = mean(RAIN,na.rm=T) ) %>%
      filter( year>=2019 ) %>%
      mutate( TMIN.a = TMIN - TMIN.m ) %>%
      mutate( TMAX.a = TMAX - TMAX.m ) %>%
      mutate( RAIN.a = RAIN - RAIN.m ) %>%
      mutate( lat    = ifelse(ST=="Orosi"      ,  9.78529,
                       ifelse(ST=="Atirro"     ,  9.8612 ,
                       ifelse(ST=="Santa Rosa" ,  9.92852,
                       ifelse(ST=="San Ramón"  , 10.06455,
                       ifelse(ST=="Naranjo"    , 10.10778,
                       ifelse(ST=="Frailes"    ,  9.75   ,
                       ifelse(ST=="San Carlos" ,  9.62661,
                       ifelse(ST=="San Lorenzo",  9.6414 ,
                       ifelse(ST=="Dota"       ,  9.65056,
                              NA ))))))))) ) %>%
      mutate( lon    = ifelse(ST=="Orosi"      , -83.84652,
                       ifelse(ST=="Atirro"     , -83.6358 ,
                       ifelse(ST=="Santa Rosa" , -83.69964,
                       ifelse(ST=="San Ramón"  , -84.47379,
                       ifelse(ST=="Naranjo"    , -84.38361,
                       ifelse(ST=="Frailes"    , -84.05306,
                       ifelse(ST=="San Carlos" , -84.09163,
                       ifelse(ST=="San Lorenzo", -84.02354,
                       ifelse(ST=="Dota"       , -83.9575 ,
                              NA ))))))))) ) %>%
      dplyr::select( ST, lat, lon, year, month, TMIN.a, TMAX.a, RAIN.a )
  }
  # for( s in 1:n_Icafe ) { list_Icafe.a[[s]] %>% print(n = 1) }
```

```{r, eval=T}
  for(s in 1:n_IMN.TMIN) {
    list_IMN.TMIN.a[[s]] <- list_IMN.TMIN[[s]] %>%
      rename( month = Mes ) %>%
      rename( year = Año ) %>%
      mutate( TMIN = rowMeans( select(.,starts_with("D")), na.rm=T) ) %>%
      dplyr::select( year, month, TMIN ) %>%
      group_by ( month ) %>%
      mutate( TMIN.m = mean(TMIN,na.rm=T) ) %>%
      filter( year>=2019 ) %>%
      mutate( TMIN.a = TMIN - TMIN.m ) %>%
      mutate( ST = substr(files_IMN.TMAX[s],1,5) ) %>%
      dplyr::select( ST, year, month, TMIN.a ) }

  for(s in 1:n_IMN.TMAX) {
    list_IMN.TMAX.a[[s]] <- list_IMN.TMAX[[s]] %>%
      rename( month = Mes ) %>%
      rename( year = Año ) %>%
      mutate( TMAX = rowMeans( select(.,starts_with("D")), na.rm=T) ) %>%
      dplyr::select( year, month, TMAX ) %>%
      group_by ( month ) %>%
      mutate( TMAX.m = mean(TMAX,na.rm=T) ) %>%
      filter( year>=2019 ) %>%
      mutate( TMAX.a = TMAX - TMAX.m ) %>%
      mutate( ST = substr(files_IMN.TMAX[s],1,5) ) %>%
      dplyr::select( ST, year, month, TMAX.a ) }

  for(s in 1:n_IMN.RAIN) {
    list_IMN.RAIN.a[[s]] <- list_IMN.RAIN[[s]] %>%
      rename( month = Mes ) %>%
      rename( year = Año ) %>%
      mutate( RAIN = rowSums( select(.,starts_with("D")), na.rm=T) ) %>%
      dplyr::select( year, month, RAIN ) %>%
      group_by ( month ) %>%
      mutate( RAIN.m = mean(RAIN,na.rm=T) ) %>%
      filter( year>=2019 ) %>%
      mutate( RAIN.a = RAIN - RAIN.m ) %>%
      mutate( ST = substr(files_IMN.RAIN[s],1,5) ) %>%
      dplyr::select( ST, year, month, RAIN.a ) }

  list_IMN.a <- list_IMN.RAIN.a
  for(s in 1:n_IMN.RAIN) {
    list_IMN.a[[s]] <- list_IMN.a[[s]] %>%
      mutate( lat = ifelse(ST==73048,  9.838611,
                    ifelse(ST==73123,  9.852222,
                    ifelse(ST==84187, 10.005   ,
                    ifelse(ST==84189, 10.13733 ,
                    ifelse(ST==88039,  9.766667,
                    ifelse(ST==88047,  9.736667,
                           NA )))))) ) %>%
      mutate( lon = ifelse(ST==73048, -83.90722,
                    ifelse(ST==73123, -83.90861,
                    ifelse(ST==84187, -84.26556,
                    ifelse(ST==84189, -84.1935 ,
                    ifelse(ST==88039, -84.09056,
                    ifelse(ST==88047, -84.00056,
                           NA )))))) ) %>%
      dplyr::select( ST, lat, lon, year, month, RAIN.a )
    }
  for(s in 1:n_IMN.RAIN) {
    sTMIN <- which( files_IMN.RAIN[s] == files_IMN.TMIN )
    if (length(sTMIN>0)) {
      list_IMN.a[[s]] <- list_IMN.a[[s]] %>%
        inner_join( list_IMN.TMIN.a[[sTMIN]], by=c("ST","year","month") ) %>%
        dplyr::select(ST,lat,lon,year,month,TMIN.a,RAIN.a)
    }
    sTMAX <- which( files_IMN.RAIN[s] == files_IMN.TMAX )
    if (length(sTMAX>0)) {
      list_IMN.a[[s]] <- list_IMN.a[[s]] %>%
        inner_join( list_IMN.TMAX.a[[sTMAX]], by=c("ST","year","month") ) %>%
        dplyr::select(ST,lat,lon,year,month,TMIN.a,TMAX.a,RAIN.a)
    }
  }
```

```{r, eval=T}
  for( s in 1:n_Anacafe ) {
    list_Anacafe.a[[s]] <- list_Anacafe[[s]] %>%
      rename( ST    = ID_ESTACION ) %>%
      rename( lat   = LATITUD     ) %>%
      rename( lon   = LONGITUD    ) %>%
      rename( TMEAN = "TMP" ) %>%
      rename( RAIN  = "RNF" ) %>%
      select( ST, lat, lon, year, month, TMEAN, RAIN ) %>%
      group_by( ST, lat, lon, year, month ) %>%
      summarize( TMEAN = mean(TMEAN,na.rm=T),
                 RAIN  = sum (RAIN ,na.rm=T) ) %>%
      group_by ( month ) %>%
      mutate( TMEAN.m = mean(TMEAN,na.rm=T) ) %>%
      mutate( RAIN.m  = mean(RAIN ,na.rm=T) ) %>%
      filter( year>=2019 ) %>%
      mutate( TMEAN.a = TMEAN - TMEAN.m ) %>%
      mutate( RAIN.a  = RAIN  - RAIN.m  ) %>%
      dplyr::select( ST, lat, lon, year, month, TMEAN.a, RAIN.a )
  }
  # for( s in 1:n_Anacafe ) { list_Anacafe.a[[s]] %>% print(n = 20, width=Inf) }
```

```{r, eval=T}
  Icafe.a <- list_Icafe.a[[1]]
  for(s in 2:n_Icafe   ) { Icafe.a <- rbind(Icafe.a,list_Icafe.a[[s]]) }
  IMN.a   <- list_IMN.a  [[1]]
  for(s in 2:n_IMN.RAIN) { IMN.a <- rbind( IMN.a, list_IMN.a[[s]] ) }

  C.a     <- rbind( Icafe.a, IMN.a )
  # C.a %>% print(width=Inf,n=Inf)
  
  G.a     <- list_Anacafe.a[[1]]
  for(s in 2:n_Anacafe) { G.a <- rbind( G.a, list_Anacafe.a[[s]] ) }
  ioutlier.TMEAN_G <- which( abs(G.a$TMEAN.a)>5 )
  G.a$TMEAN.a[ioutlier.TMEAN_G] <- NA

  # G.a %>% print(width=Inf,n=Inf)
```

```{r, eval=T}
  df.ym <- function(df,y,m) {df %>% filter(year==y) %>% filter(month==m)}
```

```{r, eval=T}
  # Weather stations Costa Rica and their distance from Turrialba
  df=C.a

  lonlat_C.ST <- df[ c("lon","lat") ]
  coordsT     <- c( -83.68,  9.89  ) # Longitude, Latitude
  dist.T      <- as.vector( distm( coordsT, lonlat_C.ST ) ) / 1000
  df          <- df %>% add_column( dist=dist.T )

  par( mfrow=c(3,4), mar=c(3,3,3,1), mgp=c(2,1,0) )

  country="C" ; xvar="dist"
  
  yvar="TMIN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
  
  yvar="TMAX.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
  
  yvar="RAIN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
```

```{r, eval=T}
  # Weather stations Guatemala and their distance from farm 170
  df=G.a

  lonlat_G.ST <- df[ c("lon","lat") ]
  coordsG170  <- c( -90.44, 14.429 ) # Longitude, Latitude
  dist.170    <- as.vector( distm( coordsG170, lonlat_G.ST ) ) / 1000
  df          <- df %>% add_column( dist=dist.170 )

  par( mfrow=c(3,4), mar=c(3,3,3,1), mgp=c(2,1,0) )

  country="G" ; xvar="dist"
  
  yvar="TMEAN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
  
  yvar="RAIN.a" ; yrange <- range( df[[yvar]], na.rm=T )
  for(m in 1:12) {
    df.m <- df.ym(df,2019,m) ; x = df.m[[xvar]] ; y = df.m[[yvar]]
    plot( x, y, main=paste0(country,":",yvar," ",m),
          xlab=xvar, ylab="", ylim=yrange )
    abline(h=0,col="black")
    lm <- lm( y ~ x )
    abline( lm$coefficients[1], lm$coefficients[2], col="blue" )
  }
```

```{r, eval=T}
  C.a.mean2019mon <- C.a %>%
    filter( year == 2019 ) %>%
    group_by( month ) %>%
    summarize( TMIN.a = mean(TMIN.a,na.rm=T),
               TMAX.a = mean(TMAX.a,na.rm=T),
               RAIN.a = mean(RAIN.a,na.rm=T) ) %>%
    as.matrix()
  
  knitr::kable( C.a.mean2019mon )
```

```{r, eval=T}
  G.a.mean2019mon <- G.a %>%
    filter( year == 2019 ) %>%
    group_by( month ) %>%
    summarize( TMEAN.a = mean(TMEAN.a,na.rm=T),
               RAIN.a  = mean(RAIN.a ,na.rm=T) ) %>%
    as.matrix()
  
  knitr::kable( G.a.mean2019mon )
```

## Extending farm weather files by two years (2019, 2020)

For 2019 we use the country-average monthly anomalies, for 2020 the climatic average.

```{r, eval=T}
  monl   <- c( 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 )
  monend <- cumsum( monl ) ; monstart <- c( 1, head(monend+1,-1) )
  mon    <- function(doy) { which((doy>=monstart) & (doy<=monend)) }
```

```{r, eval=T}
  nf <- length( df_C.f$code )

  for(f in 1:nf) {
    w.f                <- df_C.f$weather.WC[[f]]
    ncol               <- dim(w.f)[2]
    meanyear           <- matrix( NA, 365, ncol )
    colnames(meanyear) <- colnames(w.f)
    for(d in 1:365) {
      meanyear[d,] <- colMeans( w.f[ which(w.f[,"doy"]==d), ] )
    }
    anom2019 <- matrix(0,365,ncol) ; colnames(anom2019) <- colnames(w.f)
    for(d in 1:365) {
      anom2019[d,"TMIN"] <- C.a.mean2019mon[ mon(d), "TMIN.a" ]
      anom2019[d,"TMAX"] <- C.a.mean2019mon[ mon(d), "TMAX.a" ]
      anom2019[d,"RAIN"] <- C.a.mean2019mon[ mon(d), "RAIN.a" ] / monl[mon(d)]
    }
    year2020          <- meanyear            ; year2020[,"year"] <- 2020
    year2019          <- meanyear + anom2019 ; year2019[,"year"] <- 2019
    year2019[,"RAIN"] <- pmax( year2019[,"RAIN"], 0 )
    w.f               <- rbind( w.f, year2019, year2020 )
    df_C.f$weather.WC[[f]] <- w.f
    # y20    <- year2020[,"RAIN"] ; y19 <- year2019[,"RAIN"]
    # yrange <- range(y20,y19)
    # plot( y20, main=paste0("RAIN(",f,")"), ylim=yrange, xlab="", ylab="" )
    # points( y19,col="red" )
  }
```

```{r, eval=T}
  nf <- length( df_G.f$code )

  par( mfrow=c(5,5), mar=c(2,1,1,1) )

  for(f in 1:nf) {
    w.f                <- df_G.f$weather.WC[[f]]
    ncol               <- dim(w.f)[2]
    meanyear           <- matrix( NA, 365, ncol )
    colnames(meanyear) <- colnames(w.f)
    for(d in 1:365) {
      meanyear[d,] <- colMeans( w.f[ which(w.f[,"doy"]==d), ] )
    }
    anom2019 <- matrix(0,365,ncol) ; colnames(anom2019) <- colnames(w.f)
    for(d in 1:365) {
      anom2019[d,"TMIN"] <- G.a.mean2019mon[ mon(d), "TMEAN.a" ]
      anom2019[d,"TMAX"] <- G.a.mean2019mon[ mon(d), "TMEAN.a" ]
      anom2019[d,"RAIN"] <- G.a.mean2019mon[ mon(d), "RAIN.a"  ] / monl[mon(d)]
    }
    year2020          <- meanyear            ; year2020[,"year"] <- 2020
    year2019          <- meanyear + anom2019 ; year2019[,"year"] <- 2019
    year2019[,"RAIN"] <- pmax( year2019[,"RAIN"], 0 )
    w.f               <- rbind( w.f, year2019, year2020 )
    df_G.f$weather.WC[[f]] <- w.f
    # y20    <- year2020[,"TMIN"] ; y19 <- year2019[,"TMIN"]
    # yrange <- range(y20,y19)
    # plot( y20, main=paste0("TMIN(",f,")"), ylim=yrange, xlab="", ylab="" )
    # points( y19,col="red" )
  }
```



\clearpage

# Yields from second harvest season (2019-2020), conversion factor, and updating df_C|G.f

```{r, eval=F}
  dir.f            <- "data/Farms SEACAF/"
  file_yield1920.f <- "Database SEACAF - Net income.xlsx"
```

```{r, eval=F}
  df_yield1920.f <- read_excel( paste0(dir.f,file_yield1920.f) )

  df_yield1920.f <- df_yield1920.f %>%
    mutate ( code      = ifelse(country=="Costa Rica", 1000,
                         ifelse(country=="Guatemala" , 2000,
                                NA )) ) %>%
    mutate ( code_farm = as.numeric( substring(code_farm,first=3) ) ) %>%
    mutate ( code      = code + code_farm ) %>%
    arrange( code ) %>%
    mutate ( yield1920 = prodcafe_ha / 3 ) %>%
    dplyr::select( code, yield1920 )
```

```{r, eval=F}
  df_yield1920_C.f <- df_yield1920.f %>%
    subset ( df_yield1920.f$code < 2000 ) %>%
    arrange( code )
  df_yield1920_G.f <- df_yield1920.f %>%
    subset( df_yield1920.f$code >= 2000 ) %>%
    arrange( code )
```

```{r, eval=F}
  lonlat_C.f  <- df_C.f[ c("lon","lat") ]
  lonlat_G.f  <- df_G.f[ c("lon","lat") ]
  coords.T    <- c( -83.68,  9.89  ) # Longitude, Latitude
  coords.2170 <- c( -90.44, 14.429 ) # Longitude, Latitude
  dist_C.T    <- as.vector( distm( coords.T   , lonlat_C.f ) ) / 1000
  dist_G.2170 <- as.vector( distm( coords.2170, lonlat_G.f ) ) / 1000
```

To compare model output with data, we needed to convert the fresh coffee bean yield data (as reported in the SEACAF files under the heading 'kg_ha') to dry yield (the CAF2021 variable). Previously we had assumed that fresh yield was 3 times as high as dry yield. However, in the Nicaragua experiment, the "factor de conversión de café cereza a café oro" was on average 7.74 [@Sepulveda_2016_Efecto]. Assuming that dry yield is twice the value of 'oro', we find a conversion factor of 7.74/2 = 3.87.

So we multiply the yield data in our databases df_C.f and df_G.f by 3/3.87.

```{r, eval=F}
  df_C.f <- df_C.f %>%
    rename( yield1819=yield ) %>%
    inner_join( df_yield1920_C.f, by=c("code") ) %>%
    mutate( yield1819 = yield1819 * 3/3.87) %>%
    mutate( yield1920 = yield1920 * 3/3.87) %>%
    mutate( dist=dist_C.T ) %>%
    dplyr::select( code, lat, lon, dist, slope, altitude, alt.WC, weather.WC,
                   DM.soil, CN.soil, C.soil, N.soil, Nfert, WP, FC,
                   nt, shade, yield1819, yield1920 ) %>%
    arrange( code )
    
  df_G.f <- df_G.f %>%
    rename( yield1819=yield ) %>%
    inner_join( df_yield1920_G.f, by=c("code") ) %>%
    mutate( yield1819 = yield1819 * 3/3.87) %>%
    mutate( yield1920 = yield1920 * 3/3.87) %>%
    mutate( dist=dist_G.2170) %>%
    dplyr::select( code, lat, lon, dist, slope, altitude, alt.WC, weather.WC,
                   DM.soil, CN.soil, C.soil, N.soil, Nfert, WP, FC,
                   nt, shade, yield1819, yield1920 ) %>%
    arrange( code )
  
  n_C.f <- dim(df_C.f)[1] ; n_G.f <- dim(df_G.f)[1]
```

```{r, eval=F}
  par( mfrow=c(2,2), mar=c(2,2,3,2) )

  x = df_C.f$yield1819 ; y = df_C.f$yield1920
  plotxylm( "Yields 19/20 vs. 18/19\nCosta Rica", ""  )

  x = df_G.f$yield1819 ; y = df_G.f$yield1920
  plotxylm( "Yields 19/20 vs. 18/19\nGuatemala", ""  )

  x = df_C.f$dist      ; y = df_C.f$yield1920 - df_C.f$yield1819
  ynna <- which(!is.na(y))
  x <- x[ynna] ; y <- y[ynna]
  plotxylm( "Yield-change vs. dist. Turrialba", ""  )

  x = df_G.f$dist      ; y = df_G.f$yield1920 - df_G.f$yield1819
  ynna <- which(!is.na(y))
  x <- x[ynna] ; y <- y[ynna]
  plotxylm( "Yield-change vs. dist. G170", ""  )
```



\clearpage

# Data on tree densities and updating df_C|G.f

```{r, eval=F}
  dir.f        <- "data/Farms SEACAF/"
  file_trees.f <- "Copy of class_marcel JH.xlsx"
```

```{r, eval=F}
  df_trees.f <- read_excel( paste0(dir.f,file_trees.f) )

  df_trees.f <- df_trees.f %>%
    mutate ( code = ifelse(cod_country=="Costa Rica", 1000,
                    ifelse(cod_country=="Guatemala" , 2000,
                           NA )) ) %>%
    mutate ( code = code + num_farm    ) %>%
    arrange( code ) %>%
    mutate ( dens_Erythrina = Erythina2     ) %>%
    mutate ( dens_Inga      = Legume2       ) %>%
    mutate ( dens_Banana    = Musacea2      ) %>%
    mutate ( dens_Avocado   = Fruit2        ) %>%
    mutate ( dens_Grevillea = `non-Legume2` ) %>%
    mutate ( dens_Cordia    = Timber2       ) %>%
    mutate ( dens_timber    = dens_Grevillea + dens_Cordia ) %>%
    mutate ( dens_Grevillea = ifelse(dens_Grevillea>dens_Cordia,dens_timber,0) ) %>%
    mutate ( dens_Cordia    = ifelse(dens_Grevillea>dens_Cordia,0,dens_timber) ) %>%
    dplyr::select( code, dens_Erythrina, dens_Inga,
                         dens_Banana   , dens_Avocado, 
                         dens_Grevillea, dens_Cordia )
  # df_trees.f %>% print( n=Inf, width=Inf)
```

```{r, eval=F}
  df_trees_C.f <- df_trees.f %>%
    subset ( df_trees.f$code <  2000 ) %>%
    arrange( code )
  df_trees_G.f <- df_trees.f %>%
    subset ( df_trees.f$code >= 2000 ) %>%
    arrange( code )
```

```{r, eval=F}
  df_C.f <- df_C.f %>%
    inner_join( df_trees_C.f, by=c("code") ) %>%
    dplyr::select( code, lat, lon, dist, slope, altitude, alt.WC, weather.WC,
                   DM.soil, CN.soil, C.soil, N.soil, Nfert, WP, FC, nt, shade,
                   dens_Erythrina, dens_Inga, dens_Banana, dens_Avocado,
                   dens_Grevillea, dens_Cordia, yield1819, yield1920 ) %>%
    arrange( code )
    
  df_G.f <- df_G.f %>%
    inner_join( df_trees_G.f, by=c("code") ) %>%
    dplyr::select( code, lat, lon, dist, slope, altitude, alt.WC, weather.WC,
                   DM.soil, CN.soil, C.soil, N.soil, Nfert, WP, FC, nt, shade,
                   dens_Erythrina, dens_Inga, dens_Banana, dens_Avocado,
                   dens_Grevillea, dens_Cordia, yield1819, yield1920 ) %>%
    arrange( code )
  
  n_C.f <- dim(df_C.f)[1] ; n_G.f <- dim(df_G.f)[1]
```

```{r, eval=F}
  par( mfrow=c(2,3), mar=c(4,2,3,2) )

  y1a_C = df_C.f$dens_Erythrina ; y1b_C = df_C.f$dens_Inga
  y1a_G = df_G.f$dens_Erythrina ; y1b_G = df_G.f$dens_Inga
  ymax1 = max( y1a_C, y1b_C, y1a_G, y1b_G )
  
  y2a_C = df_C.f$dens_Banana   ; y2b_C = df_C.f$dens_Avocado
  y2a_G = df_G.f$dens_Banana   ; y2b_G = df_G.f$dens_Avocado
  ymax2 = max( y2a_C, y2b_C, y2a_G, y2b_G )
  
  y3a_C = df_C.f$dens_Grevillea ; y3b_C = df_C.f$dens_Cordia
  y3a_G = df_G.f$dens_Grevillea ; y3b_G = df_G.f$dens_Cordia
  ymax3 = max( y3a_C, y3b_C, y3a_G, y3b_G )
  
  plot  ( y1a_C, main="Costa Rica trees [1]",
          xlab="farm index", ylab="", ylim=c(0,1.25*ymax1))
  points( y1b_C, col="red" )
  legend( "top",legend=c("Erythrina","Inga"),
          horiz=T, pch=1, col=c("black","red"), bg="transparent" )

  plot  ( y2a_C, main="Costa Rica trees [2]",
          xlab="farm index", ylab="", ylim=c(0,1.25*ymax2))
  points( y2b_C, col="red" )
  legend( "top",legend=c("Banana","Avocado"),
          horiz=T, pch=1, col=c("black","red"), bg="transparent" )

  plot  ( y3a_C, main="Costa Rica trees [3]",
          xlab="farm index", ylab="", ylim=c(0,1.25*ymax3))
  points( y3b_C, col="red" )
  legend( "top",legend=c("Grevillea","Cordia"),
          horiz=T, pch=1, col=c("black","red"), bg="transparent" )

  plot  ( y1a_G, main="Guatemala trees [1]",
          xlab="farm index", ylab="", ylim=c(0,1.25*ymax1))
  points( y1b_G, col="red" )
  legend( "top",legend=c("Erythrina","Inga"),
          horiz=T, pch=1, col=c("black","red"), bg="transparent" )

  plot  ( y2a_G, main="Guatemala trees [2]",
          xlab="farm index", ylab="", ylim=c(0,1.25*ymax2))
  points( y2b_G, col="red" )
  legend( "top",legend=c("Banana","Avocado"),
          horiz=T, pch=1, col=c("black","red"), bg="transparent" )

  plot  ( y3a_G, main="Guatemala trees [3]",
          xlab="farm index", ylab="", ylim=c(0,1.25*ymax3))
  points( y3b_G, col="red" )
  legend( "top",legend=c("Grevillea","Cordia"),
          horiz=T, pch=1, col=c("black","red"), bg="transparent" )
```



\clearpage

# Trees

## Tree management

```{r, eval=F}
  inamesdfscalars <- names(df_C.f)[ !(names(df_C.f) %in% "weather.WC") ]
  
  i.s <- which( df_C.f$dens_Erythrina > 0 & df_C.f$dens_Inga    > 0 )
  i.f <- which( df_C.f$dens_Banana    > 0 & df_C.f$dens_Avocado > 0 )
  i.t <- which( df_C.f$dens_Grevillea > 0 & df_C.f$dens_Cordia  > 0 )
  df_C.f[c(i.s,i.f,i.t),inamesdfscalars]

  i.s <- which( df_G.f$dens_Erythrina > 0 & df_G.f$dens_Inga    > 0 )
  i.f <- which( df_G.f$dens_Banana    > 0 & df_G.f$dens_Avocado > 0 )
  i.t <- which( df_G.f$dens_Grevillea > 0 & df_G.f$dens_Cordia  > 0 )
  df_G.f[c(i.s,i.f,i.t),inamesdfscalars]
```

### Erythrina
- Pruning, no thinning
- Prescribed pruning intensity of 90% twice a year (at coffee flowering and pre-harvest). Say doy 140 and 350.
- Pruned material always stays on site

### Inga
- Pruning, no thinning
- Pruning once a year (at flowering or just before). Say doy 140.
- Pruning intensity for shade-target
- Pruned branches stay on site in CRI but are removed in GTM

### Banana
- No pruning or thinning
- Annual senescence modelled through TC-parameters
- Dead material always stays on site

### Avocado
- Pruning, no thinning
- Prescribed pruning intensity ?

### Grevillea
- Pruning, no thinning
- Pruning once a year (at flowering or just before). Say doy 140.
- Pruning intensity for shade-target
- Pruned branches stay on site in CRI but are removed in GTM

### Cordia
- Thinning, no pruning. Say once every five years.
- Thinning intensity for shade-target
- Thinned trunks always removed
- Branches from thinned trees stay on site in CRI but are removed in GTM !!


## Tree allometry & other parameters

### Erythrina
- Calibration Turrialba
- N-fixing

### Inga
- Calibration Masatepe
- Edwin's report, Table 8 on p. 19
- N-fixing

### Banana
- My progress report

### Avocado
- My progress report

### Grevillea
- Edwin's report, Table 10 on p. 21

### Cordia
- My report of ~2007


\clearpage

# Saving the amended files df_C.f and df_G.f

```{r, eval=F}
  save( df_C.f, file="df_C.f_final.rda" )
  save( df_G.f, file="df_G.f_final.rda" )
```

```{r}
  load( "df_C.f_final.rda" )
  load( "df_G.f_final.rda" )

  n_C.f <- dim(df_C.f)[1] ; n_G.f <- dim(df_G.f)[1]
```



\clearpage

# Simulating farms in Costa Rica and Guatemala

We run the model for each of the farm locations in Costa Rica and Guatemala, using a variety of parameterisations.

```{r}
  vars_Summary <- c(
    "harvDM_f_hay", "harvCPT_f", "harvCPT_2", "harvCST_f", "harvCST_3",
    "D_Nsoil"     , "D_Csoil"  , "D_C"      , "D_CT"     , "D_Csys"   ,
    "Shade_f"        , "Shade_fa"       , "Shade_fb"     ,
    "NfixT_fb"       , "Nleaching_fb"   , "Crunoff_fb"   ,
    "Csoil_fa"       , "Csoil_fb"       ,
    "harvDM_f_ha1819", "harvDM_f_ha1920",
    "fTranT_t_1a"    , "fTranT_t_1b"    , "fTranT_t_2a"  , "fTranT_t_2b"  ,
    "fTranT_t_3a"    , "fTranT_t_3b"    , "fNgrowth_t_1a", "fNgrowth_t_1b",
    "fNgrowth_t_2a"  , "fNgrowth_t_2b"  , "fNgrowth_t_3a", "fNgrowth_t_3b",
    "H_t_1a"         , "H_t_1b"         , "H_t_2a"       , "H_t_2b"       ,
    "H_t_3a"         , "H_t_3b"         , "CAtree_t_1a"  , "CAtree_t_1b"  ,
    "CAtree_t_2a"    , "CAtree_t_2b"    , "CAtree_t_3a"  , "CAtree_t_3b"
  )
```

```{r}
  outputSummary <- function( output ) {
    idoy           <- which( outputNames=="doy" )

    fOut           <- matrix( NA, nrow=1, ncol=length(vars_Summary) )
    colnames(fOut) <- vars_Summary

    iyear      <- which( outputNames=="year" )
    idoy       <- which( outputNames=="doy" )
    
    ih_f_hay   <- which( outputNames=="harvDM_f_hay" ) # kg C ha-1 y-1
    ihCPT_f    <- which( outputNames=="harvCPT_f"    ) # kg C m-2 d-1
    ihCPT_2    <- which( outputNames=="harvCPT_t(2)" ) # kg C m-2 d-1
    ihCST_f    <- which( outputNames=="harvCST_f"    ) # kg C m-2 d-1
    ihCST_3    <- which( outputNames=="harvCST_t(3)" ) # kg C m-2 d-1
    iNsoil_f   <- which( outputNames=="Nsoil_f"      ) # kg N m-2
    iCsoil_f   <- which( outputNames=="Csoil_f"      ) # kg C m-2 
    iC_f       <- which( outputNames=="C_f"          ) # kg C m-2
    iCT_f      <- which( outputNames=="CT_f"         ) # kg C m-2
    
    iShade_f   <- which( outputNames=="Shade_f"      ) # m2 m-2
    
    iNfixT     <- which( outputNames=="NfixT_f"      ) # kg N m-2 d-1
    iNleaching <- which( outputNames=="Nleaching_f"  ) # kg N m-2 d-1
    iCrunoff   <- which( outputNames=="Crunoff_f"    ) # kg C m-2 d-1
    
    idayH1     <- which( outputNames=="DayHarv(1)" )
    idayH2     <- which( outputNames=="DayHarv(2)" )
    
    ifTranT1   <- which( outputNames=="fTranT_t(1)")
    ifTranT2   <- which( outputNames=="fTranT_t(2)")
    ifTranT3   <- which( outputNames=="fTranT_t(3)")
    ifNgrwT1   <- which( outputNames=="fNgrowth_t(1)")
    ifNgrwT2   <- which( outputNames=="fNgrowth_t(2)")
    ifNgrwT3   <- which( outputNames=="fNgrowth_t(3)")
    ihT1       <- which( outputNames=="h_t(1)")
    ihT2       <- which( outputNames=="h_t(2)")
    ihT3       <- which( outputNames=="h_t(3)")
    iCAtreeT1  <- which( outputNames=="CAtree_t(1)")
    iCAtreeT2  <- which( outputNames=="CAtree_t(2)")
    iCAtreeT3  <- which( outputNames=="CAtree_t(3)")

    c.DM  <- 1 / 0.47          # 'kg C' -> 'kg DM'
    NDAYS <- dim(output)[1]
    c.hay <- 1e4 * 365 / NDAYS # 'm-2 in sim. period' -> 'ha-1 y-1'
    d181  <- which( output[,idoy]==181 )
    
    T1 <- 0 ; if(output[1,which(outputNames=="treedens_t(1)")]>0) T1 <- 1
    T2 <- 0 ; if(output[1,which(outputNames=="treedens_t(2)")]>0) T2 <- 1
    T3 <- 0 ; if(output[1,which(outputNames=="treedens_t(3)")]>0) T3 <- 1
    
           fOut[,"harvDM_f_hay"] <- mean( output[d181,ih_f_hay] )
           fOut[,"harvCPT_f"]    <- sum ( output[    ,ihCPT_f ] ) * c.DM * c.hay
    if(T2) fOut[,"harvCPT_2"]    <- sum ( output[    ,ihCPT_2 ] ) * c.DM * c.hay
           fOut[,"harvCST_f"]    <- sum ( output[    ,ihCST_f ] ) * c.DM * c.hay
    if(T3) fOut[,"harvCST_3"]    <- sum ( output[    ,ihCST_3 ] ) * c.DM * c.hay
    
    D_output         <- output[NDAYS,] - output[1,]
    fOut[,"D_Nsoil"] <- D_output[iNsoil_f] * c.hay
    fOut[,"D_Csoil"] <- D_output[iCsoil_f] * c.hay
    fOut[,"D_C"    ] <- D_output[iC_f    ] * c.hay
    fOut[,"D_CT"   ] <- D_output[iCT_f   ] * c.hay
    fOut[,"D_Csys" ] <- fOut[,"D_Csoil"] + fOut[,"D_C"] + fOut[,"D_CT"]

    outputFirstYears <- colMeans( output[ 1          :730  , ] )
    outputFinalYears <- colMeans( output[ (NDAYS-730):NDAYS, ] )
    
    fOut[,"Shade_f"     ] <- mean( output          [,iShade_f] )
    fOut[,"Shade_fa"    ] <- mean( outputFirstYears[ iShade_f] )
    fOut[,"Shade_fb"    ] <- mean( outputFinalYears[ iShade_f] )
    
    fOut[,"NfixT_fb"    ] <- outputFinalYears[iNfixT    ] * 1e4 * 365
    fOut[,"Nleaching_fb"] <- outputFinalYears[iNleaching] * 1e4 * 365
    fOut[,"Crunoff_fb"  ] <- outputFinalYears[iCrunoff  ] * 1e4 * 365
    
    fOut[,"Csoil_fa"    ] <- outputFirstYears[iCsoil_f]
    fOut[,"Csoil_fb"    ] <- outputFinalYears[iCsoil_f]

    dHarv1819 <- which( (output[,iyear]==2019) & (output[,idoy]==181) )
    dHarv1920 <- which( (output[,iyear]==2020) & (output[,idoy]==181) )
    
    fOut[,"harvDM_f_ha1819"] <- output[dHarv1819,ih_f_hay]
    fOut[,"harvDM_f_ha1920"] <- output[dHarv1920,ih_f_hay]

    if(T1) { fOut[,"fTranT_t_1a"  ] <- mean( outputFirstYears[ifTranT1] )
             fOut[,"fTranT_t_1b"  ] <- mean( outputFinalYears[ifTranT1] )
             fOut[,"fNgrowth_t_1a"] <- mean( outputFirstYears[ifNgrwT1] )
             fOut[,"fNgrowth_t_1b"] <- mean( outputFinalYears[ifNgrwT1] )
             fOut[,"H_t_1a"       ] <- mean( outputFirstYears[ihT1] )
             fOut[,"H_t_1b"       ] <- mean( outputFinalYears[ihT1] )
             fOut[,"CAtree_t_1a"  ] <- mean( outputFirstYears[iCAtreeT1] )
             fOut[,"CAtree_t_1b"  ] <- mean( outputFinalYears[iCAtreeT1] )
           }
    if(T2) { fOut[,"fTranT_t_2a"  ] <- mean( outputFirstYears[ifTranT2] )
             fOut[,"fTranT_t_2b"  ] <- mean( outputFinalYears[ifTranT2] )
             fOut[,"fNgrowth_t_2a"] <- mean( outputFirstYears[ifNgrwT2] )
             fOut[,"fNgrowth_t_2b"] <- mean( outputFinalYears[ifNgrwT2] )
             fOut[,"H_t_2a"       ] <- mean( outputFirstYears[ihT2] )
             fOut[,"H_t_2b"       ] <- mean( outputFinalYears[ihT2] )
             fOut[,"CAtree_t_2a"  ] <- mean( outputFirstYears[iCAtreeT2] )
             fOut[,"CAtree_t_2b"  ] <- mean( outputFinalYears[iCAtreeT2] )
           }
    if(T3) { fOut[,"fTranT_t_3a"  ] <- mean( outputFirstYears[ifTranT3] )
             fOut[,"fTranT_t_3b"  ] <- mean( outputFinalYears[ifTranT3] )
             fOut[,"fNgrowth_t_3a"] <- mean( outputFirstYears[ifNgrwT3] )
             fOut[,"fNgrowth_t_3b"] <- mean( outputFinalYears[ifNgrwT3] )
             fOut[,"H_t_3a"       ] <- mean( outputFirstYears[ihT3] )
             fOut[,"H_t_3b"       ] <- mean( outputFinalYears[ihT3] )
             fOut[,"CAtree_t_3a"  ] <- mean( outputFirstYears[iCAtreeT3] )
             fOut[,"CAtree_t_3b"  ] <- mean( outputFinalYears[iCAtreeT3] )
           }

    return( fOut )
  }
```


## Creating farm-specific initialisation files

```{r}
  dir.init <- "initialisation/CG/"
```

```{r}
  cf <- function(text) {
    cat( "\n", file=file.f, append=TRUE )
    cat( paste0("  ",text), file=file.f, append=TRUE )
  }
```

```{r, eval=F}
  sapply( paste0(dir.init,"inititialise_CAF2021_C_f",1:n_C.f,".R"),
          file.create)

  for(fi in 1:n_C.f) {
    file.f <- paste0( dir.init, "inititialise_CAF2021_C_f", fi, ".R" )
    cat( paste0("# ",file.f,"\n"), file=file.f )
    cf(paste0("fi <- ",fi))
    cf("source('initialisation/set_CAF2021_CG.R')")
    cf("matrix_weather <- read_listweather_CAF( list_w=df_C.f$weather.WC,")
    cf("  f=fi, y1=year_start, d1=doy_start, nd=NDAYS )")
    cf("params         <- set_par_CG  ( df_C.f, fi, params, 'C' )")
    cf("calendar_fert  <- set_fert_CG ( df_C.f, fi )")
    cf("calendar_prunT <- set_prunT_CG( df_C.f, fi )")
    cf("calendar_thinT <- set_thinT_CG( df_C.f, fi )")
  }
```

```{r, eval=F}
  sapply( paste0(dir.init,"inititialise_CAF2021_G_f",1:n_G.f,".R"),
          file.create)

  for(fi in 1:n_G.f) {
    file.f <- paste0( dir.init, "inititialise_CAF2021_G_f", fi, ".R" )
    cat( paste0("# ",file.f,"\n"), file=file.f )
    cf(paste0("fi <- ",fi))
    cf("source('initialisation/set_CAF2021_CG.R')")
    cf("matrix_weather <- read_listweather_CAF( list_w=df_G.f$weather.WC,")
    cf("  f=fi, y1=year_start, d1=doy_start, nd=NDAYS )")
    cf("params         <- set_par_CG  ( df_G.f, fi, params, 'G' )")
    cf("calendar_fert  <- set_fert_CG ( df_G.f, fi )")
    cf("calendar_prunT <- set_prunT_CG( df_G.f, fi )")
    cf("calendar_thinT <- set_thinT_CG( df_G.f, fi )")
```

```{r}
  source('initialisation/initialise_CAF2021_general.R')

  Tnames_C <- Tdens_C <- NULL
  for(fi in 1:n_C.f) {
    densE    <- df_C.f$dens_Erythrina[fi]
    densI    <- df_C.f$dens_Inga     [fi]
    densB    <- df_C.f$dens_Banana   [fi]
    densA    <- df_C.f$dens_Avocado  [fi]
    densG    <- df_C.f$dens_Grevillea[fi]
    densC    <- df_C.f$dens_Cordia   [fi]
    T_fi     <- Tinventory_CG( densE, densI, densB, densA, densG, densC )
    Tnames_C <- rbind( Tnames_C, T_fi$Tnames )
    Tdens_C  <- rbind( Tdens_C , T_fi$Tdens  )
  }

  Tnames_G <- Tdens_G <- NULL
  for(fi in 1:n_G.f) {
    densE    <- df_G.f$dens_Erythrina[fi]
    densI    <- df_G.f$dens_Inga     [fi]
    densB    <- df_G.f$dens_Banana   [fi]
    densA    <- df_G.f$dens_Avocado  [fi]
    densG    <- df_G.f$dens_Grevillea[fi]
    densC    <- df_G.f$dens_Cordia   [fi]
    T_fi     <- Tinventory_CG( densE, densI, densB, densA, densG, densC )
    Tnames_G <- rbind( Tnames_G, T_fi$Tnames )
    Tdens_G  <- rbind( Tdens_G , T_fi$Tdens  )
  }
```

```{r}
  knitr::kable( cbind( 1:n_C.f, Tnames_C, Tdens_C),
                col.names=c("Costa Rica",paste0("T",1:3),paste0("T",1:3)) )
  knitr::kable( cbind( 1:n_G.f, Tnames_G, Tdens_G),
                col.names=c("Guatemala" ,paste0("T",1:3),paste0("T",1:3)) )
```

```{r}
  dir.init <- "initialisation/CG/"
  dir.par  <- "parameters/"
```

```{r}
  if_C.1E <- which(Tnames_C[,1]=="E") ; if_C.1I <- which(Tnames_C[,1]=="I")
  if_C.2B <- which(Tnames_C[,2]=="B") ; if_C.2A <- which(Tnames_C[,2]=="A")
  if_C.3G <- which(Tnames_C[,3]=="G") ; if_C.3C <- which(Tnames_C[,3]=="C")

  if_G.1I <- which(Tnames_G[,1]=="I")
  if_G.2B <- which(Tnames_G[,2]=="B") ; if_G.2A <- which(Tnames_G[,2]=="A")
  if_G.3G <- which(Tnames_G[,3]=="G") ; if_G.3C <- which(Tnames_G[,3]=="C")
  
  file.init_C    <- paste0(dir.init,"inititialise_CAF2021_C_f", 1         , ".R")
  file.init_C.1E <- paste0(dir.init,"inititialise_CAF2021_C_f", if_C.1E[1], ".R")
  file.init_C.1I <- paste0(dir.init,"inititialise_CAF2021_C_f", if_C.1I[1], ".R")
  file.init_C.2B <- paste0(dir.init,"inititialise_CAF2021_C_f", if_C.2B[1], ".R")
  file.init_C.2A <- paste0(dir.init,"inititialise_CAF2021_C_f", if_C.2A[1], ".R")
  file.init_C.3G <- paste0(dir.init,"inititialise_CAF2021_C_f", if_C.3G[1], ".R")
  file.init_C.3C <- paste0(dir.init,"inititialise_CAF2021_C_f", if_C.3C[1], ".R")

  file.init_G    <- paste0(dir.init,"inititialise_CAF2021_G_f", 1         , ".R")
  file.init_G.1I <- paste0(dir.init,"inititialise_CAF2021_G_f", if_G.1I[1], ".R")
  file.init_G.2B <- paste0(dir.init,"inititialise_CAF2021_G_f", if_G.2B[1], ".R")
  file.init_G.2A <- paste0(dir.init,"inititialise_CAF2021_G_f", if_G.2A[1], ".R")
  file.init_G.3G <- paste0(dir.init,"inititialise_CAF2021_G_f", if_G.3G[1], ".R")
  file.init_G.3C <- paste0(dir.init,"inititialise_CAF2021_G_f", if_G.3C[1], ".R")
```


## Creating country-specific parameter-distribution files for BC

```{r, eval=F}
  source( file.init_C.1E ) ; par_C.1E <- params
  source( file.init_C.1I ) ; par_C.1I <- params
  source( file.init_C.2B ) ; par_C.2B <- params
  source( file.init_C.2A ) ; par_C.2A <- params
  source( file.init_C.3G ) ; par_C.3G <- params
  source( file.init_C.3C ) ; par_C.3C <- params

  source( file.init_G.1I ) ; par_G.1I <- params
  source( file.init_G.2B ) ; par_G.2B <- params
  source( file.init_G.2A ) ; par_G.2A <- params
  source( file.init_G.3G ) ; par_G.3G <- params
  source( file.init_G.3C ) ; par_G.3C <- params
```


```{r, eval=F}
  source( file.init_C )

  pAll     <- c("TCSOMF","TCSOMS","CSOM0MULT")
  npAll    <- length(pAll) ; ipAll <- rep(NA,npAll)
  for(p in 1:npAll) { ipAll[p]     <- which( names_params==pAll[p] ) }

  pT       <- c("FLTMAX","FST","FWT", "LAIMAXT","LUEMAX","SLAT")
  npT      <- length(pT) ; list_ipT <- vector("list",npT)
  for(p in 1:npT) { list_ipT[[p]] <- which( startsWith( names_params,
                                                        paste0(pT[p],"(") ) ) }
  
  df_par_BC_C <- data.frame( ip = c( ipAll, unlist(list_ipT) ) )
  vecstr <- function( vec ) { paste0("c(",paste(vec,collapse=","),")") }
  df_par_BC_C <- df_par_BC_C %>%
    mutate ( name   = names_params[ip] ) %>%
    mutate ( val.1E = par_C.1E    [ip] ) %>%
    mutate ( val.1I = par_C.1I    [ip] ) %>%
    mutate ( val.2B = par_C.2B    [ip] ) %>%
    mutate ( val.2A = par_C.2A    [ip] ) %>%
    mutate ( val.3G = par_C.3G    [ip] ) %>%
    mutate ( val.3C = par_C.3C    [ip] ) %>%
    mutate ( rep    = ifelse( endsWith(name,")"), 2, 1 ) ) %>%
    uncount( rep, .id="species" ) %>%
    mutate ( val = ifelse( (species==1 & endsWith(name,"1)") ), val.1E,
                   ifelse( (species==2 & endsWith(name,"1)") ), val.1I,
                   ifelse( (species==1 & endsWith(name,"2)") ), val.2B,
                   ifelse( (species==2 & endsWith(name,"2)") ), val.2A,
                   ifelse( (species==1 & endsWith(name,"3)") ), val.3G,
                   ifelse( (species==2 & endsWith(name,"3)") ), val.3C,
                           val.1E )))))) ) %>%
    mutate( val     = round( val      , 4 ) ) %>%
    mutate( val.min = round( val * 0.7, 4 ) ) %>%
    mutate( val.max = round( val * 1.3, 4 ) ) %>%
    dplyr::select( ip, name, species, val.min, val, val.max ) %>%
    mutate ( farms = ifelse( (species==1 & endsWith(name,"1)") ), "if_C.1E",
                     ifelse( (species==2 & endsWith(name,"1)") ), "if_C.1I",
                     ifelse( (species==1 & endsWith(name,"2)") ), "if_C.2B",
                     ifelse( (species==2 & endsWith(name,"2)") ), "if_C.2A",
                     ifelse( (species==1 & endsWith(name,"3)") ), "if_C.3G",
                     ifelse( (species==2 & endsWith(name,"3)") ), "if_C.3C",
                              "1:nSites" )))))) )
```

```{r, eval=F}
  source( file.init_G )

  pAll     <- c("TCSOMF","TCSOMS","CSOM0MULT")
  npAll    <- length(pAll) ; ipAll <- rep(NA,npAll)
  for(p in 1:npAll) { ipAll[p]     <- which( names_params==pAll[p] ) }

  pT       <- c("FLTMAX","FST","FWT", "LAIMAXT","LUEMAX","SLAT")
  npT      <- length(pT) ; list_ipT <- vector("list",npT)
  for(p in 1:npT) { list_ipT[[p]] <- which( startsWith( names_params,
                                                        paste0(pT[p],"(") ) ) }
  
  df_par_BC_G <- data.frame( ip = c( ipAll, unlist(list_ipT) ) )
  vecstr <- function( vec ) { paste0("c(",paste(vec,collapse=","),")") }
  df_par_BC_G <- df_par_BC_G %>%
    mutate ( name   = names_params[ip] ) %>%
    mutate ( val.1I = par_G.1I    [ip] ) %>%
    mutate ( val.2B = par_G.2B    [ip] ) %>%
    mutate ( val.2A = par_G.2A    [ip] ) %>%
    mutate ( val.3G = par_G.3G    [ip] ) %>%
    mutate ( val.3C = par_G.3C    [ip] ) %>%
    mutate ( rep    = ifelse( endsWith(name,"2)") | endsWith(name,"3)"), 2, 1 ) ) %>%
    uncount( rep, .id="species" ) %>%
    mutate ( val = ifelse( (species==1 & endsWith(name,"2)") ), val.2B,
                   ifelse( (species==2 & endsWith(name,"2)") ), val.2A,
                   ifelse( (species==1 & endsWith(name,"3)") ), val.3G,
                   ifelse( (species==2 & endsWith(name,"3)") ), val.3C,
                           val.1I )))) ) %>%
    mutate( val     = round( val      , 4 ) ) %>%
    mutate( val.min = round( val * 0.7, 4 ) ) %>%
    mutate( val.max = round( val * 1.3, 4 ) ) %>%
    dplyr::select( ip, name, species, val.min, val, val.max ) %>%
    mutate ( farms = ifelse( (             endsWith(name,"1)") ), "if_G.1I",
                     ifelse( (species==1 & endsWith(name,"2)") ), "if_G.2B",
                     ifelse( (species==2 & endsWith(name,"2)") ), "if_G.2A",
                     ifelse( (species==1 & endsWith(name,"3)") ), "if_G.3G",
                     ifelse( (species==2 & endsWith(name,"3)") ), "if_G.3C",
                              "1:nSites" ))))) )
```

```{r, eval=F}
  file.parBC_C <- paste0( dir.par, "parameters_BC_C.txt" ) 
  df_par_BC_C %>%
    dplyr::select( name, val.min, val, val.max, farms ) %>%
    write.table( file.parBC_C, sep="\t", row.names=F, col.names=F )
  
  file.parBC_G <- paste0( dir.par, "parameters_BC_G.txt" ) 
  df_par_BC_G %>%
    dplyr::select( name, val.min, val, val.max, farms ) %>%
    write.table( file.parBC_G, sep="\t", row.names=F, col.names=F )
```


## Creating farm-specific data files for BC

```{r}
  dir.dataBC <- "data/CG/"
```

```{r, eval=F}
  sapply( paste0(dir.dataBC,"data_C_f",1:n_C.f,".txt"), file.create)

  cv.yield <- 0.2
  cv.shade <- 0.4
  cv.trees <- 0.8

  for(fi in 1:n_C.f) {
    file.f <- paste0( dir.dataBC, "data_C_f", fi, ".txt" )
    y1819  <- round( df_C.f$yield1819[fi] )
    y1920  <- round( df_C.f$yield1920[fi] )
    shade  <-        df_G.f$shade    [fi]
    if((!is.na(y1819))) {
      cat( paste0("harvDM_f_hay\t2019\t181\t",y1819,"\t",cv.yield,"\n"),
           file=file.f ) }
    if((!is.na(y1920))) {
      cat( paste0("harvDM_f_hay\t2020\t181\t",y1920,"\t",cv.yield,"\n"),
           file=file.f, append=TRUE ) }
    if((!is.na(shade))) {
      cat( paste0("Shade_f\t2019\t300\t"     ,shade,"\t",cv.shade,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_C.1E) {
      cat( paste0("h_t(1)\t2020\t139\t"      ,  8  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(1)\t2020\t139\t" , 25  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_C.1I) {
      cat( paste0("h_t(1)\t2020\t139\t"      ,  8  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(1)\t2020\t139\t" , 50  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_C.2B) {
      cat( paste0("h_t(2)\t2020\t139\t"      ,  8  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(2)\t2020\t139\t" , 25  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_C.2A) {
      cat( paste0("h_t(2)\t2020\t139\t"      ,  8  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(2)\t2020\t139\t" , 25  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_C.3G) {
      cat( paste0("h_t(3)\t2020\t139\t"      , 15  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(3)\t2020\t139\t" ,100  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_C.3C) {
      cat( paste0("h_t(3)\t2020\t139\t"      , 30  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(3)\t2020\t139\t" ,200  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
  }
```

```{r, eval=F}
  sapply( paste0(dir.dataBC,"data_G_f",1:n_G.f,".txt"), file.create)

  cv.yield <- 0.2
  cv.shade <- 0.4
  cv.trees <- 0.8

  for(fi in 1:n_G.f) {
    file.f <- paste0( dir.dataBC, "data_G_f", fi, ".txt" )
    y1819  <- round( df_G.f$yield1819[fi] )
    y1920  <- round( df_G.f$yield1920[fi] )
    shade  <-        df_G.f$shade    [fi]
    if((!is.na(y1819))) {
      cat( paste0("harvDM_f_hay\t2019\t181\t",y1819,"\t",cv.yield,"\n"),
           file=file.f ) }
    if((!is.na(y1920))) {
      cat( paste0("harvDM_f_hay\t2020\t181\t",y1920,"\t",cv.yield,"\n"),
           file=file.f, append=TRUE ) }
    if((!is.na(shade))) {
      cat( paste0("Shade_f\t2019\t300\t"     ,shade,"\t",cv.shade,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_G.1I) {
      cat( paste0("h_t(1)\t2020\t139\t"      ,  8  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(1)\t2020\t139\t" , 50  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_G.2B) {
      cat( paste0("h_t(2)\t2020\t139\t"      ,  8  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(2)\t2020\t139\t" , 25  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_G.2A) {
      cat( paste0("h_t(2)\t2020\t139\t"      ,  8  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(2)\t2020\t139\t" , 25  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_G.3G) {
      cat( paste0("h_t(3)\t2020\t139\t"      , 15  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(3)\t2020\t139\t" ,100  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
    if(fi %in% if_G.3C) {
      cat( paste0("h_t(3)\t2020\t139\t"      , 30  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE )
      cat( paste0("CAtree_t(3)\t2020\t139\t" ,200  ,"\t",cv.trees,"\n"),
           file=file.f, append=TRUE ) }
  }
```


## BC

```{r}
  # matMAP_C.old <- readRDS( "CAF2021_parMAP_23_39.rds" )
  # matMAP_C     <- update_matMAP( matMAP_C.old,
  #                                'initialisation/set_CAF2021_CG.R' )
  # matMAP_G.old <- readRDS( "CAF2021_parMAP_04_23.rds" )
  # matMAP_G     <- update_matMAP( matMAP_G.old,
  #                                'initialisation/set_CAF2021_CG.R' )

  # source('BC_CAF2021_C.R') ; matMAP_C <- matMAP
  # source('BC_CAF2021_G.R') ; matMAP_G <- matMAP

  matMAP_C <- readRDS( "BC/BC_RESULTS_CG/CAF2021_parMAP_01_24.rds" )
  matMAP_G <- readRDS( "BC/BC_RESULTS_CG/CAF2021_parMAP_10_49.rds" )
```


## Verifying posterior distributions for tree-specific parameters

```{r}
  # KAC
  range( matMAP_C["KAC(1)",if_C.1E] )    ; range( matMAP_C["KAC(1)",if_C.1I] )
  range( matMAP_C["KAC(2)",if_C.2B] )    ; range( matMAP_C["KAC(2)",if_C.2A] )
  range( matMAP_C["KAC(3)",if_C.3G] )    ; range( matMAP_C["KAC(3)",if_C.3C] )
  
  # KACEXP
  range( matMAP_C["KACEXP(1)",if_C.1E] ) ; range( matMAP_C["KACEXP(1)",if_C.1I] )
  range( matMAP_C["KACEXP(2)",if_C.2B] ) ; range( matMAP_C["KACEXP(2)",if_C.2A] )
  range( matMAP_C["KACEXP(3)",if_C.3G] ) ; range( matMAP_C["KACEXP(3)",if_C.3C] )

  # KH
  range( matMAP_C["KH(1)",if_C.1E] )     ; range( matMAP_C["KH(1)",if_C.1I] )
  range( matMAP_C["KH(2)",if_C.2B] )     ; range( matMAP_C["KH(2)",if_C.2A] )
  range( matMAP_C["KH(3)",if_C.3G] )     ; range( matMAP_C["KH(3)",if_C.3C] )

  # KHEXP
  range( matMAP_C["KHEXP(1)",if_C.1E] )  ; range( matMAP_C["KHEXP(1)",if_C.1I] )
  range( matMAP_C["KHEXP(2)",if_C.2B] )  ; range( matMAP_C["KHEXP(2)",if_C.2A] )
  range( matMAP_C["KHEXP(3)",if_C.3G] )  ; range( matMAP_C["KHEXP(3)",if_C.3C] )
```

```{r}
  # KAC
                                           range( matMAP_G["KAC(1)",if_G.1I] )
  range( matMAP_G["KAC(2)",if_G.2B] )    ; range( matMAP_G["KAC(2)",if_G.2A] )
  range( matMAP_G["KAC(3)",if_G.3G] )    ; range( matMAP_G["KAC(3)",if_G.3C] )
  
  # KACEXP
                                           range( matMAP_G["KACEXP(1)",if_G.1I] )
  range( matMAP_G["KACEXP(2)",if_G.2B] ) ; range( matMAP_G["KACEXP(2)",if_G.2A] )
  range( matMAP_G["KACEXP(3)",if_G.3G] ) ; range( matMAP_G["KACEXP(3)",if_G.3C] )

  # KH
                                           range( matMAP_G["KH(1)",if_G.1I] )
  range( matMAP_G["KH(2)",if_G.2B] )     ; range( matMAP_G["KH(2)",if_G.2A] )
  range( matMAP_G["KH(3)",if_G.3G] )     ; range( matMAP_G["KH(3)",if_G.3C] )

  # KHEXP
                                           range( matMAP_G["KHEXP(1)",if_G.1I] )
  range( matMAP_G["KHEXP(2)",if_G.2B] )  ; range( matMAP_G["KHEXP(2)",if_G.2A] )
  range( matMAP_G["KHEXP(3)",if_G.3G] )  ; range( matMAP_G["KHEXP(3)",if_G.3C] )
```


## Running all farms with MAP parameter vector

```{r list_outF_C}
  list_outF_C <- list_parF_C <- vector( "list", n_C.f )
  # source('initialisation/set_CAF2021_CG.R')

  for(fi in 1:n_C.f) {
    # matrix_weather <- read_listweather_CAF( list_w=df_C.f$weather.WC,
    #   f=fi, y1=year_start, d1=doy_start, nd=NDAYS )
    # params         <- set_par_CG  ( df_C.f, fi, params, 'C' )
    # calendar_fert  <- set_fert_CG ( df_C.f, fi )
    # calendar_prunT <- set_prunT_CG( df_C.f, fi )
    # calendar_thinT <- set_thinT_CG( df_C.f, fi )
    file_init <- paste0( "initialisation/CG/inititialise_CAF2021_C_f", fi, ".R" )
    source( file_init )
    
    nF_C                     <- 3
    mat_parF                 <- matrix( NA, nF_C, 1+length(names_params) )
    mat_outF                 <- matrix( NA, nF_C, 1+length(vars_Summary) )
    colnames( mat_parF )     <- c( "FarmSetting", names_params )
    colnames( mat_outF )     <- c( "FarmSetting", vars_Summary )
    mat_parF[,"FarmSetting"] <- 1:nF_C
    mat_outF[,"FarmSetting"] <- 1:nF_C
    
    for(iF in 1:nF_C) {
      if( iF==2 ) {
        params <- matMAP_C[,fi]
      }
      if( iF==3 ) {
        params <- matMAP_C[,fi]
        params <- set_par( c("TCSOMF","TCSOMS","CSOM0MULT","FCSOMF0" ),
                           c( 7300   , 73000  , 1         , 0.5      ) )
        # if( fi %in% if_C.2B ) { params <- set_par(
        #     c("CBtree0(2)","CLtree0(2)","CRtree0(2)","CStree0(2)"),
        #     c( 1          , 1          , 1          , 1          ) )
        #   params <- set_par( c("KAC(2)","KACEXP(2)","KH(2)","KHEXP(2)"),
        #                      c( 7      , 0.6       , 4.5   , 0.42     ) ) }
        # if( fi %in% if_C.3G ) { params <- set_par(
        #     c("FLTMAX(3)","FST(3)","FWT(3)","LAIMAXT(3)","SLAT(3)"),
        #     c( 0.27      , 0.25   , 0.43   , 5          , 25      ) ) }
        # if( fi %in% if_C.3C ) { params <- set_par(
        #     c("FLTMAX(3)","FST(3)","FWT(3)","LAIMAXT(3)","SLAT(3)"),
        #     c( 0.24      , 0.3    , 0.55   , 5          , 25      ) ) }
      }
      outF <- run_model( params, matrix_weather, calendar_fert,
        calendar_prunC, calendar_prunT, calendar_thinT, NDAYS )
      
      paramsUsed <- params
      ipT1       <- which( endsWith(names_params,"(1)") ) 
      ipT2       <- which( endsWith(names_params,"(2)") ) 
      ipT3       <- which( endsWith(names_params,"(3)") )
      dT1        <- params[ which(names_params=="TREEDENS0(1)") ]
      dT2        <- params[ which(names_params=="TREEDENS0(2)") ]
      dT3        <- params[ which(names_params=="TREEDENS0(3)") ]
      if( dT1==0 ) paramsUsed[ipT1] <- NA
      if( dT2==0 ) paramsUsed[ipT2] <- NA
      if( dT3==0 ) paramsUsed[ipT3] <- NA
      
      mat_parF[iF,1+(1:length(names_params))] <- paramsUsed
      mat_outF[iF,1+(1:length(vars_Summary))] <- outputSummary( outF )
    }
    list_parF_C[[fi]] <- mat_parF
    list_outF_C[[fi]] <- mat_outF
  }
```

```{r}
  plot_output( outF, vars= c( paste0("At(",1:3,")"),
                              "harvDM_f_hay",
                              paste0("h_t(",1:3,")"),
                              "Shade_f",
                              paste0("CAtree_t(",1:3,")")) )
```

```{r}
  df_C.f_sim <- df_C.f %>%
    dplyr::select ( code ) %>%
    arrange( code ) %>%
    mutate ( parF = list_parF_C ) %>%
    mutate ( outF = list_outF_C )
```

Verifying the list of farm-specific summary outputs:

```{r}
  dfoutFSummary <- function( df=df_C.f_sim, Fi=1 ){
    nf     <- dim( df )[1]
    vnames <- colnames( df$outF[[1]] ) ; nv <- length(vnames)
    matres <- matrix( NA, nf, nv ) ; colnames( matres) <- vnames
    F.v    <- matres
    for(fi in 1:nf){
      F.v[fi,] <- df$outF[[fi]][Fi,]
    }
    return( F.v )
  }
```

```{r}
  dfparFSummary <- function( df=df_C.f_sim, Fi=1 ){
    nf     <- dim( df )[1]
    vnames <- colnames( df$parF[[1]] ) ; nv <- length(vnames)
    matres <- matrix( NA, nf, nv ) ; colnames( matres) <- vnames
    F.v    <- matres
    for(fi in 1:nf){
      F.v[fi,] <- df$parF[[fi]][Fi,]
    }
    return( F.v )
  }
```

```{r}
  oF1_C <- dfoutFSummary( df_C.f_sim, Fi=1 )
  oF2_C <- dfoutFSummary( df_C.f_sim, Fi=2 )
  oF3_C <- dfoutFSummary( df_C.f_sim, Fi=3 )
  pF1_C <- dfparFSummary( df_C.f_sim, Fi=1 )
  pF2_C <- dfparFSummary( df_C.f_sim, Fi=2 )
  pF3_C <- dfparFSummary( df_C.f_sim, Fi=3 )
```

```{r}
  tableY_C <- ( rbind(
    c( "Obs." , "18/19", summary( df_C.f$yield1819         , digits=3 ) ),
    c( ""     , "19/20", summary( df_C.f$yield1920         , digits=3 ) ),
    rep( "", 8 ),
    c( "Sim.2", "18/19", summary( oF2_C[,"harvDM_f_ha1819"], digits=3 ) ),
    c( ""     , "19/20", summary( oF2_C[,"harvDM_f_ha1920"], digits=3 ) ),
    rep( "", 8 ),
    c( "Sim.1", "18/19", summary( oF1_C[,"harvDM_f_ha1819"], digits=3 ) ),
    c( ""     , "19/20", summary( oF1_C[,"harvDM_f_ha1920"], digits=3 ) ),
    c( "Sim.3", "18/19", summary( oF3_C[,"harvDM_f_ha1819"], digits=3 ) ),
    c( ""     , "19/20", summary( oF3_C[,"harvDM_f_ha1920"], digits=3 ) ) ) )
  colnames(tableY_C)[1] <- "C: Yield (kg ha-1)"
  knitr::kable( tableY_C )
```

```{r}
  tableCA_C1 <- ( rbind(
    c( "Erythina" , summary( oF1_C[if_C.1E,"CAtree_t_1b"], digits=3 ) ),
    c( "Inga"     , summary( oF1_C[if_C.1I,"CAtree_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF1_C[if_C.2B,"CAtree_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF1_C[if_C.2A,"CAtree_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF1_C[if_C.3G,"CAtree_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF1_C[if_C.3C,"CAtree_t_3b"], digits=3 ) ) ) )
  colnames(tableCA_C1)[1] <- "C1: CAtree (m2)"
  knitr::kable( tableCA_C1 )

  tableH_C1 <- ( rbind(
    c( "Erythina" , summary( oF1_C[if_C.1E,"H_t_1b"], digits=3 ) ),
    c( "Inga"     , summary( oF1_C[if_C.1I,"H_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF1_C[if_C.2B,"H_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF1_C[if_C.2A,"H_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF1_C[if_C.3G,"H_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF1_C[if_C.3C,"H_t_3b"], digits=3 ) ) ) )
  colnames(tableH_C1)[1] <- "C1: H (m)"
  knitr::kable( tableH_C1 )
```

```{r}
  tableCA_C2 <- ( rbind(
    c( "Erythina" , summary( oF2_C[if_C.1E,"CAtree_t_1b"], digits=3 ) ),
    c( "Inga"     , summary( oF2_C[if_C.1I,"CAtree_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF2_C[if_C.2B,"CAtree_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF2_C[if_C.2A,"CAtree_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF2_C[if_C.3G,"CAtree_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF2_C[if_C.3C,"CAtree_t_3b"], digits=3 ) ) ) )
  colnames(tableCA_C2)[1] <- "C2: CAtree (m2)"
  knitr::kable( tableCA_C2 )

  tableH_C2 <- ( rbind(
    c( "Erythina" , summary( oF2_C[if_C.1E,"H_t_1b"], digits=3 ) ),
    c( "Inga"     , summary( oF2_C[if_C.1I,"H_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF2_C[if_C.2B,"H_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF2_C[if_C.2A,"H_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF2_C[if_C.3G,"H_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF2_C[if_C.3C,"H_t_3b"], digits=3 ) ) ) )
  colnames(tableH_C2)[1] <- "C2: H (m)"
  knitr::kable( tableH_C2 )
```

```{r}
  tableCA_C3 <- ( rbind(
    c( "Erythina" , summary( oF3_C[if_C.1E,"CAtree_t_1b"], digits=3 ) ),
    c( "Inga"     , summary( oF3_C[if_C.1I,"CAtree_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF3_C[if_C.2B,"CAtree_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF3_C[if_C.2A,"CAtree_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF3_C[if_C.3G,"CAtree_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF3_C[if_C.3C,"CAtree_t_3b"], digits=3 ) ) ) )
  colnames(tableCA_C3)[1] <- "C3: CAtree (m2)"
  knitr::kable( tableCA_C3 )

  tableH_C3 <- ( rbind(
    c( "Erythina" , summary( oF3_C[if_C.1E,"H_t_1b"], digits=3 ) ),
    c( "Inga"     , summary( oF3_C[if_C.1I,"H_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF3_C[if_C.2B,"H_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF3_C[if_C.2A,"H_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF3_C[if_C.3G,"H_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF3_C[if_C.3C,"H_t_3b"], digits=3 ) ) ) )
  colnames(tableH_C3)[1] <- "C3: H (m)"
  knitr::kable( tableH_C3 )
```

```{r}
  par( mfrow=c(2,3), mar=c(4,4,1,1) )

  plot( oF1_C[,"Csoil_fa"], df_C.f$C.soil ) ; abline(a=0,b=1,lty=2)
  plot( oF2_C[,"Csoil_fa"], df_C.f$C.soil ) ; abline(a=0,b=1,lty=2)
  plot( oF3_C[,"Csoil_fa"], df_C.f$C.soil ) ; abline(a=0,b=1,lty=2)

  plot( oF1_C[,"Csoil_fb"], df_C.f$C.soil ) ; abline(a=0,b=1,lty=2)
  plot( oF2_C[,"Csoil_fb"], df_C.f$C.soil ) ; abline(a=0,b=1,lty=2)
  plot( oF3_C[,"Csoil_fb"], df_C.f$C.soil ) ; abline(a=0,b=1,lty=2)
```

```{r}
  par( mfrow=c(3,3), mar=c(4,4,1,1) )

  plot( oF1_C[,"Shade_fa"], df_C.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF2_C[,"Shade_fa"], df_C.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF3_C[,"Shade_fa"], df_C.f$shade  ) ; abline(a=0,b=1,lty=2)

  plot( oF1_C[,"Shade_f"], df_C.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF2_C[,"Shade_f"], df_C.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF3_C[,"Shade_f"], df_C.f$shade  ) ; abline(a=0,b=1,lty=2)

  plot( oF1_C[,"Shade_fb"], df_C.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF2_C[,"Shade_fb"], df_C.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF3_C[,"Shade_fb"], df_C.f$shade  ) ; abline(a=0,b=1,lty=2)
```

```{r XX14C, fig.height=6, fig.cap="\\label{fig:XX14C}Observed vs. simulated yields in 2018-19 and 2019-20 at the farms in Costa Rica."}
  par( mfrow=c(3,3), mar=c(4,3,2,2), mgp=c(2,1,0) )

  x=oF1_C[,"harvDM_f_ha1819"] ; y=df_C.f$yield1819
    plotxylm("Yields Costa Rica 18/19", orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=oF2_C[,"harvDM_f_ha1819"] ; y=df_C.f$yield1819
    plotxylm("Yields Costa Rica 18/19", orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=oF3_C[,"harvDM_f_ha1819"] ; y=df_C.f$yield1819
    plotxylm("Yields Costa Rica 18/19", orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
    
  x=oF1_C[,"harvDM_f_ha1920"] ; y=df_C.f$yield1920
    plotxylm("Yields Costa Rica 19/20", orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=oF2_C[,"harvDM_f_ha1920"] ; y=df_C.f$yield1920
    plotxylm("Yields Costa Rica 19/20", orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=oF3_C[,"harvDM_f_ha1920"] ; y=df_C.f$yield1920
    plotxylm("Yields Costa Rica 19/20", orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red")
    
  x=c( oF1_C[,"harvDM_f_ha1819"], oF1_C[,"harvDM_f_ha1920"] )
  y=c( df_C.f$yield1819         , df_C.f$yield1920          )
    plotxylm("Yields Costa Rica 2 yrs", orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=c( oF2_C[,"harvDM_f_ha1819"], oF2_C[,"harvDM_f_ha1920"] )
  y=c( df_C.f$yield1819         , df_C.f$yield1920          )
    plotxylm("Yields Costa Rica 2 yrs", orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=c( oF3_C[,"harvDM_f_ha1819"], oF3_C[,"harvDM_f_ha1920"] )
  y=c( df_C.f$yield1819         , df_C.f$yield1920          )
    plotxylm("Yields Costa Rica 2 yrs", orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red")
```

```{r, eval=F}
  iscalars <- which( names(df_C.f) != "weather.WC")

  knitr::kable( t(df_C.f[fi,iscalars]) )
```

```{r, eval=F}
  iEnv   <- c( 4:24, 55) ; iCoffee   <-  25: 38
  iTrees <- c(39:54,155) ; iCBT_t    <- 138:140
  # plot_output( outF, vars=outputNames[ iEnv   ] )
  # plot_output( outF, vars=outputNames[ iCoffee ] )
  # plot_output( outF, vars=outputNames[ iTrees  ] )
  # plot_output( outF, vars=outputNames[ iCBT_t  ] )
```

Farm 1073, with 80 avocado trees per hectare, has a simulated shade level of about 0.05 despite a measured value of about 0.24. In the model, the short branch turnover time TCBT_t(2) of 1000 days keeps the crowns small. If this is a systematic error, we need to increase the longevity of avocado branches (and perhaps leaves).

```{r}
  # ierr <- which( df_C.f$shade > 0.2 & oF1_C[,"Shade_f"] < 0.1 )
  # 
  # ierr
  # df_C.f[ierr,iscalars]
  # oF1_C  [ierr,        ]
```

```{r, eval=F}
matMAP_CG <- matMAP_C
  unique( matMAP_CG["KEXT"     ,       ] )
  unique( matMAP_CG["RUBISC"   ,       ] )
  unique( matMAP_CG["TRANCO"   ,       ] )
  unique( matMAP_CG["YG"       ,       ] )

  unique( matMAP_CG["KAC(1)"   ,if_G.1E] )
  unique( matMAP_CG["KACEXP(1)",if_G.1E] )
  unique( matMAP_CG["KH(1)"    ,if_G.1E] )
  unique( matMAP_CG["KHEXP(1)" ,if_G.1E] )
  unique( matMAP_CG["KAC(1)"   ,if_G.1I] )
  unique( matMAP_CG["KACEXP(1)",if_G.1I] )
  unique( matMAP_CG["KH(1)"    ,if_G.1I] )
  unique( matMAP_CG["KHEXP(1)" ,if_G.1I] )
  unique( matMAP_CG["KAC(2)"   ,if_G.2B] )
  unique( matMAP_CG["KACEXP(2)",if_G.2B] )
  unique( matMAP_CG["KH(2)"    ,if_G.2B] )
  unique( matMAP_CG["KHEXP(2)" ,if_G.2B] )
  unique( matMAP_CG["KAC(2)"   ,if_G.2A] )
  unique( matMAP_CG["KACEXP(2)",if_G.2A] )
  unique( matMAP_CG["KH(2)"    ,if_G.2A] )
  unique( matMAP_CG["KHEXP(2)" ,if_G.2A] )
  unique( matMAP_CG["KAC(3)"   ,if_G.3G] )
  unique( matMAP_CG["KACEXP(3)",if_G.3G] )
  unique( matMAP_CG["KH(3)"    ,if_G.3G] )
  unique( matMAP_CG["KHEXP(3)" ,if_G.3G] )
  unique( matMAP_CG["KAC(3)"   ,if_G.3C] )
  unique( matMAP_CG["KACEXP(3)",if_G.3C] )
  unique( matMAP_CG["KH(3)"    ,if_G.3C] )
  unique( matMAP_CG["KHEXP(3)" ,if_G.3C] )
```


```{r list_outF_G}
  list_outF_G <- list_parF_G <- vector( "list", n_G.f )
  for(fi in 1:n_G.f) {
    file_init <- paste0( "initialisation/CG/inititialise_CAF2021_G_f", fi, ".R" )
    source( file_init )

    nF_G                     <- 3
    mat_parF                 <- matrix( NA, nF_G, 1+length(names_params) )
    mat_outF                 <- matrix( NA, nF_G, 1+length(vars_Summary) )
    colnames( mat_parF )     <- c( "FarmSetting", names_params )
    colnames( mat_outF )     <- c( "FarmSetting", vars_Summary )
    mat_parF[,"FarmSetting"] <- 1:nF_G
    mat_outF[,"FarmSetting"] <- 1:nF_G
    
    for(iF in 1:nF_G) {
      if( iF==2 ) {
        params <- matMAP_G[,fi]
      }
      if( iF==3 ) {
        params <- matMAP_G[,fi]
        params <- set_par( c("TCSOMF","TCSOMS","CSOM0MULT","FCSOMF0" ),
                           c( 7300   , 73000  , 1         , 0.5      ) )
        # if( fi %in% if_G.2B ) { params <- set_par(
        #     c("CBtree0(2)","CLtree0(2)","CRtree0(2)","CStree0(2)"),
        #     c( 1          , 1          , 1          , 1          ) )
        #   params <- set_par( c("KAC(2)","KACEXP(2)","KH(2)","KHEXP(2)"),
        #                      c( 7      , 0.6       , 4.5   , 0.42     ) ) }
        # if( fi %in% if_G.3G ) { params <- set_par(
        #     c("FLTMAX(3)","FST(3)","FWT(3)","LAIMAXT(3)","SLAT(3)"),
        #     c( 0.27      , 0.25   , 0.43   , 5          , 25      ) ) }
        # if( fi %in% if_G.3C ) { params <- set_par(
        #     c("FLTMAX(3)","FST(3)","FWT(3)","LAIMAXT(3)","SLAT(3)"),
        #     c( 0.24      , 0.3    , 0.55   , 5          , 25      ) ) }
      }
      outF <- run_model( params, matrix_weather, calendar_fert,
        calendar_prunC, calendar_prunT, calendar_thinT, NDAYS )
      
      paramsUsed <- params
      ipT1       <- which( endsWith(names_params,"(1)") ) 
      ipT2       <- which( endsWith(names_params,"(2)") ) 
      ipT3       <- which( endsWith(names_params,"(3)") )
      dT1        <- params[ which(names_params=="TREEDENS0(1)") ]
      dT2        <- params[ which(names_params=="TREEDENS0(2)") ]
      dT3        <- params[ which(names_params=="TREEDENS0(3)") ]
      if( dT1==0 ) paramsUsed[ipT1] <- NA
      if( dT2==0 ) paramsUsed[ipT2] <- NA
      if( dT3==0 ) paramsUsed[ipT3] <- NA
      
      mat_parF[iF,1+(1:length(names_params))] <- paramsUsed
      mat_outF[iF,1+(1:length(vars_Summary))] <- outputSummary( outF )
    }
    list_parF_G[[fi]] <- mat_parF
    list_outF_G[[fi]] <- mat_outF
  }
```

```{r}
  plot_output( outF, vars= c( paste0("At(",1:3,")"),
                              "harvDM_f_hay",
                              paste0("h_t(",1:3,")"),
                              "Shade_f",
                              paste0("CAtree_t(",1:3,")")) )
```

```{r}
  df_G.f_sim <- df_G.f %>%
    dplyr::select ( code ) %>%
    arrange( code ) %>%
    mutate ( parF = list_parF_G ) %>%
    mutate ( outF = list_outF_G )
```

```{r}
  oF1_G <- dfoutFSummary( df_G.f_sim, Fi=1 )
  oF2_G <- dfoutFSummary( df_G.f_sim, Fi=2 )
  oF3_G <- dfoutFSummary( df_G.f_sim, Fi=3 )
  pF1_G <- dfparFSummary( df_G.f_sim, Fi=1 )
  pF2_G <- dfparFSummary( df_G.f_sim, Fi=2 )
  pF3_G <- dfparFSummary( df_G.f_sim, Fi=3 )
```

```{r}
  tableY_G <- ( rbind(
    c( "Obs." , "18/19", summary( df_G.f$yield1819         , digits=3 ) ),
    c( ""     , "19/20", summary( df_G.f$yield1920         , digits=3 ) ),
    rep( "", 8 ),
    c( "Sim.2", "18/19", summary( oF2_G[,"harvDM_f_ha1819"], digits=3 ) ),
    c( ""     , "19/20", summary( oF2_G[,"harvDM_f_ha1920"], digits=3 ) ),
    rep( "", 8 ),
    c( "Sim.1", "18/19", summary( oF1_G[,"harvDM_f_ha1819"], digits=3 ) ),
    c( ""     , "19/20", summary( oF1_G[,"harvDM_f_ha1920"], digits=3 ) ),
    c( "Sim.3", "18/19", summary( oF3_G[,"harvDM_f_ha1819"], digits=3 ) ),
    c( ""     , "19/20", summary( oF3_G[,"harvDM_f_ha1920"], digits=3 ) ) ) )
  colnames(tableY_G)[1] <- "G: Yield (kg ha-1)"
  knitr::kable( tableY_G )
```

```{r}
  tableCA_G1 <- ( rbind(
    c( "Inga"     , summary( oF1_G[if_G.1I,"CAtree_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF1_G[if_G.2B,"CAtree_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF1_G[if_G.2A,"CAtree_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF1_G[if_G.3G,"CAtree_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF1_G[if_G.3C,"CAtree_t_3b"], digits=3 ) ) ) )
  colnames(tableCA_G1)[1] <- "G1: CAtree (m2)"
  knitr::kable( tableCA_G1 )

  tableH_G1 <- ( rbind(
    c( "Inga"     , summary( oF1_G[if_G.1I,"H_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF1_G[if_G.2B,"H_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF1_G[if_G.2A,"H_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF1_G[if_G.3G,"H_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF1_G[if_G.3C,"H_t_3b"], digits=3 ) ) ) )
  colnames(tableH_G1)[1] <- "G1: H (m)"
  knitr::kable( tableH_G1 )
```

```{r}
  tableCA_G2 <- ( rbind(
    c( "Inga"     , summary( oF2_G[if_G.1I,"CAtree_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF2_G[if_G.2B,"CAtree_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF2_G[if_G.2A,"CAtree_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF2_G[if_G.3G,"CAtree_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF2_G[if_G.3C,"CAtree_t_3b"], digits=3 ) ) ) )
  colnames(tableCA_G2)[1] <- "G2: CAtree (m2)"
  knitr::kable( tableCA_G2 )

  tableH_G2 <- ( rbind(
    c( "Inga"     , summary( oF2_G[if_G.1I,"H_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF2_G[if_G.2B,"H_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF2_G[if_G.2A,"H_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF2_G[if_G.3G,"H_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF2_G[if_G.3C,"H_t_3b"], digits=3 ) ) ) )
  colnames(tableH_G2)[1] <- "G2: H (m)"
  knitr::kable( tableH_G2 )
```

```{r}
  tableCA_G3 <- ( rbind(
    c( "Inga"     , summary( oF3_G[if_G.1I,"CAtree_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF3_G[if_G.2B,"CAtree_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF3_G[if_G.2A,"CAtree_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF3_G[if_G.3G,"CAtree_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF3_G[if_G.3C,"CAtree_t_3b"], digits=3 ) ) ) )
  colnames(tableCA_G3)[1] <- "G3: CAtree (m2)"
  knitr::kable( tableCA_G3 )

  tableH_G3 <- ( rbind(
    c( "Inga"     , summary( oF3_G[if_G.1I,"H_t_1b"], digits=3 ) ),
    c( "Banana"   , summary( oF3_G[if_G.2B,"H_t_2b"], digits=3 ) ),
    c( "Avocado"  , summary( oF3_G[if_G.2A,"H_t_2b"], digits=3 ) ),
    c( "Grevillea", summary( oF3_G[if_G.3G,"H_t_3b"], digits=3 ) ),
    c( "Cordia"   , summary( oF3_G[if_G.3C,"H_t_3b"], digits=3 ) ) ) )
  colnames(tableH_G3)[1] <- "G3: H (m)"
  knitr::kable( tableH_G3 )
```

```{r}
  par( mfrow=c(2,3), mar=c(4,4,1,1) )

  plot( oF1_G[,"Csoil_fa"], df_G.f$C.soil ) ; abline(a=0,b=1,lty=2)
  plot( oF2_G[,"Csoil_fa"], df_G.f$C.soil ) ; abline(a=0,b=1,lty=2)
  plot( oF3_G[,"Csoil_fa"], df_G.f$C.soil ) ; abline(a=0,b=1,lty=2)

  plot( oF1_G[,"Csoil_fb"], df_G.f$C.soil ) ; abline(a=0,b=1,lty=2)
  plot( oF2_G[,"Csoil_fb"], df_G.f$C.soil ) ; abline(a=0,b=1,lty=2)
  plot( oF3_G[,"Csoil_fb"], df_G.f$C.soil ) ; abline(a=0,b=1,lty=2)
```

```{r}
  par( mfrow=c(3,3), mar=c(4,4,1,1) )

  plot( oF1_G[,"Shade_fa"], df_G.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF2_G[,"Shade_fa"], df_G.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF3_G[,"Shade_fa"], df_G.f$shade  ) ; abline(a=0,b=1,lty=2)

  plot( oF1_G[,"Shade_f" ], df_G.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF2_G[,"Shade_f" ], df_G.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF3_G[,"Shade_f" ], df_G.f$shade  ) ; abline(a=0,b=1,lty=2)

  plot( oF1_G[,"Shade_fb"], df_G.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF2_G[,"Shade_fb"], df_G.f$shade  ) ; abline(a=0,b=1,lty=2)
  plot( oF3_G[,"Shade_fb"], df_G.f$shade  ) ; abline(a=0,b=1,lty=2)
```

```{r XX14G, fig.height=6, fig.cap="\\label{fig:XX14G}Observed vs. simulated yields in 2018-19 and 2019-20 at the farms in Guatemala."}
  par( mfrow=c(3,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  x=oF1_G[,"harvDM_f_ha1819"] ; y=df_G.f$yield1819
    plotxylm("Yields Guatemala 18/19" , orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=oF2_G[,"harvDM_f_ha1819"] ; y=df_G.f$yield1819
    plotxylm("Yields Guatemala 18/19" , orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=oF3_G[,"harvDM_f_ha1819"] ; y=df_G.f$yield1819
    plotxylm("Yields Guatemala 18/19" , orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
    
  x=oF1_G[,"harvDM_f_ha1920"] ; y=df_G.f$yield1920
    plotxylm("Yields Guatemala 19/20" , orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=oF2_G[,"harvDM_f_ha1920"] ; y=df_G.f$yield1920
    plotxylm("Yields Guatemala 19/20" , orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=oF3_G[,"harvDM_f_ha1920"] ; y=df_G.f$yield1920
    plotxylm("Yields Guatemala 19/20" , orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
    
  x=c( oF1_G[,"harvDM_f_ha1819"], oF1_G[,"harvDM_f_ha1920"] )
  y=c( df_G.f$yield1819         , df_G.f$yield1920          )
    plotxylm("Yields Guatemala 2 yrs" , orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=c( oF2_G[,"harvDM_f_ha1819"], oF2_G[,"harvDM_f_ha1920"] )
  y=c( df_G.f$yield1819         , df_G.f$yield1920          )
    plotxylm("Yields Guatemala 2 yrs" , orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
  x=c( oF3_G[,"harvDM_f_ha1819"], oF3_G[,"harvDM_f_ha1920"] )
  y=c( df_G.f$yield1819         , df_G.f$yield1920          )
    plotxylm("Yields Guatemala 2 yrs" , orig=F) ; abline(a=0,b=1,lty=2)
    abline(h=mean(y,na.rm=T),lty=2,col="red") ; abline(v=mean(x),lty=2,col="red") 
```

```{r}
  plotimpacts_CG <- function( FC=oF1_C, FG=oF1_G, xvar="Nfert", yvar="y.sim" ){
    xC=df_C.f[,xvar] ; xG=df_G.f[,xvar]
    yC=FC    [,yvar] ; yG=FG    [,yvar]
    plot  ( xC, yC,
      xlab=xvar, ylab="",
      main=paste0(substr(deparse(substitute(FC)),1,2),": ",yvar),
      pch=1,
      # xlim=c( 0, max(xC,xG) ),
      # ylim=c( min(0,yC,yG,na.rm=T), max(0,yC,yG,na.rm=T)) )
      xlim=c( min(xC,xG        ), max(xC,xG        )),
      ylim=c( min(yC,yG,na.rm=T), max(yC,yG,na.rm=T)) )
    points( xG, yG, pch=20, col="red"  )
    
    y.lm_C <- lm( yC ~ xC ) ; y.lm_G <- lm( yG ~ xG )
    r2_C   <- round( summary(y.lm_C)$r.squared, 2 )
    r2_G   <- round( summary(y.lm_G)$r.squared, 2 )
    abline( y.lm_C$coefficients[1], y.lm_C$coefficients[2], col="black" )
    abline( y.lm_G$coefficients[1], y.lm_G$coefficients[2], col="red" )
    legend( "bottomright", title="r2",
            legend=c( paste("C:",as.character(r2_C)),
                      paste("G:",as.character(r2_G)) ),
            col=c("black","red"), lty=c(1), cex=0.5, bg="transparent" )
  }
```

See Fig. \ref{fig:XX31}.

```{r XX31, fig.height=7.5, fig.cap="\\label{fig:XX31}XX31."}
  par( mfrow=c(3,4), mar=c(4,2,1,2), mgp=c(2,1,0) )

  yp <- "KH(1)"     ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
  yp <- "KHEXP(1)"  ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
  yp <- "KAC(1)"    ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
  yp <- "KACEXP(1)" ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
  
  yp <- "KH(2)"     ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
  yp <- "KHEXP(2)"  ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
  yp <- "KAC(2)"    ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
  yp <- "KACEXP(2)" ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )

  yp <- "KH(3)"     ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
  yp <- "KHEXP(3)"  ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
  yp <- "KAC(3)"    ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
  yp <- "KACEXP(3)" ; plotimpacts_CG( FC=pF2_C, FG=pF2_G, yvar=yp )
```

See Fig. \ref{fig:XX21}.

```{r XX21, fig.height=7.5, fig.cap="\\label{fig:XX21}XX21."}
  par( mfrow=c(3,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  yv <- "fTranT_t_1b"   ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                          plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                          plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
  yv <- "fTranT_t_2b"   ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                          plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                          plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
  yv <- "fTranT_t_3b"   ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                          plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                          plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
```

```{r XX21b, fig.height=7.5, fig.cap="\\label{fig:XX21b}XX21b."}
  par( mfrow=c(3,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  yv <- "fTranT_t_1b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
                        plotimpacts_CG( FC=oF2_C, FG=oF2_G, xvar="dist", yvar=yv )
                        plotimpacts_CG( FC=oF3_C, FG=oF3_G, xvar="dist", yvar=yv )
  yv <- "fTranT_t_2b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
                        plotimpacts_CG( FC=oF2_C, FG=oF2_G, xvar="dist", yvar=yv )
                        plotimpacts_CG( FC=oF3_C, FG=oF3_G, xvar="dist", yvar=yv )
  yv <- "fTranT_t_3b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
                        plotimpacts_CG( FC=oF2_C, FG=oF2_G, xvar="dist", yvar=yv )
                        plotimpacts_CG( FC=oF3_C, FG=oF3_G, xvar="dist", yvar=yv )
```

See Fig. \ref{fig:XX22}.

```{r XX22, fig.height=7.5, fig.cap="\\label{fig:XX22}XX22."}
  par( mfrow=c(3,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  yv <- "fNgrowth_t_1b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                          plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                          plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
  yv <- "fNgrowth_t_2b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                          plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                          plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
  yv <- "fNgrowth_t_3b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                          plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                          plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
```

```{r XX22b, fig.height=7.5, fig.cap="\\label{fig:XX22b}XX22b."}
  par( mfrow=c(3,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  yv <- "fNgrowth_t_1b"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
  plotimpacts_CG( FC=oF2_C, FG=oF2_G, xvar="dist", yvar=yv )
  plotimpacts_CG( FC=oF3_C, FG=oF3_G, xvar="dist", yvar=yv )
  yv <- "fNgrowth_t_2b"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
  plotimpacts_CG( FC=oF2_C, FG=oF2_G, xvar="dist", yvar=yv )
  plotimpacts_CG( FC=oF3_C, FG=oF3_G, xvar="dist", yvar=yv )
  yv <- "fNgrowth_t_3b"
  plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
  plotimpacts_CG( FC=oF2_C, FG=oF2_G, xvar="dist", yvar=yv )
  plotimpacts_CG( FC=oF3_C, FG=oF3_G, xvar="dist", yvar=yv )
```

See Fig. \ref{fig:XX24}.

```{r XX24, fig.height=7.5, fig.cap="\\label{fig:XX24}XX24."}
  par( mfrow=c(3,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  yv <- "H_t_1b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                   plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                   plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
  yv <- "H_t_2b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                   plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                   plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
  yv <- "H_t_3b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                   plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                   plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
```

See Fig. \ref{fig:XX24b}.

```{r XX24b, fig.height=7.5, fig.cap="\\label{fig:XX24b}XX24b."}
  par( mfrow=c(3,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  yv <- "H_t_1b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
                   plotimpacts_CG( FC=oF2_C, FG=oF2_G, xvar="dist", yvar=yv )
                   plotimpacts_CG( FC=oF3_C, FG=oF3_G, xvar="dist", yvar=yv )
  yv <- "H_t_2b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
                   plotimpacts_CG( FC=oF2_C, FG=oF2_G, xvar="dist", yvar=yv )
                   plotimpacts_CG( FC=oF3_C, FG=oF3_G, xvar="dist", yvar=yv )
  yv <- "H_t_3b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, xvar="dist", yvar=yv )
                   plotimpacts_CG( FC=oF2_C, FG=oF2_G, xvar="dist", yvar=yv )
                   plotimpacts_CG( FC=oF3_C, FG=oF3_G, xvar="dist", yvar=yv )
```

See Fig. \ref{fig:XX25}.

```{r XX25, fig.height=7.5, fig.cap="\\label{fig:XX25}XX25."}
  par( mfrow=c(3,3), mar=c(4,2,2,2), mgp=c(2,1,0) )

  yv <- "CAtree_t_1b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                        plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                        plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
  yv <- "CAtree_t_2b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                        plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                        plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
  yv <- "CAtree_t_3b" ; plotimpacts_CG( FC=oF1_C, FG=oF1_G, yvar=yv )
                        plotimpacts_CG( FC=oF2_C, FG=oF2_G, yvar=yv )
                        plotimpacts_CG( FC=oF3_C, FG=oF3_G, yvar=yv )
```

```{r, eval=F}
  iscalars <- which( names(df_G.f) != "weather.WC")

  knitr::kable( t(df_G.f[fi,iscalars]) )
```

The model underestimates shade in Guatemala for almost all farms. Possible explanations:

- Inconsistent data for tree densities and shade.
- Prevalence in Guatemala of Inga coupled with erroneous Inga parameterisation.
- Excessive drought stress because of underestimated soil water holding capacity, as a result of using wrong pedotransfer functions.

We examine a farm where measured shade is very high and simulated shade is very low.

```{r, eval=F}
  # ierr <- which( df_G.f$shade > 0.8 & oF1_G[,"Shade_f"] < 0.05 )
  # 
  # params[ip_WCST] * params[ c(ip_FWCWP,ip_FWCFC) ] # Farm 79: 0.207,0.364
  # 
  # ierr
  # df_G.f[ierr,iscalars]
  # oF1_G  [ierr,        ]
```

Further analysis of the differences between Costa Rica and Guatemala, to find out why shade and coffee yields were especially in Guatemala poorly simulated and generally underestimated.

When we run the following code, we see that Guatemala has:

- Lower Csoil
- Lower Nsoil
- Lower Nfert

We also see that our initial parameterisation parMAP[,31] sets the SOM mineralisation rate very low: it assigns only a small fraction (FCSOMF0=0.2936, copied from the Masatepe experiment) to fast turnover. Compare the higher value in the Turrialba experiment (e.g. parMAP[,11]): FCSOMF0=0.7185.

These settings make coffee and trees in Guatemala in the model - and likely in reality too if the data are reliable - often severely water- and N-limited. Still, observed yields in Guatemala are not strongly correlated with N-fertilisation rate, which is puzzling. 

```{r, eval=F}
  knitr::kable( cbind( names_params,
                       round(parMAP[,11],4),
                       round(parMAP[,31],4),
                       round(params,4) ) )

  knitr::kable( rbind( c("C",round(summary(df_C.f$C.soil),3)),
                       c("G",round(summary(df_G.f$C.soil),3)) ) )

  knitr::kable( rbind( c("C",round(summary(df_C.f$N.soil),3)),
                       c("G",round(summary(df_G.f$N.soil),3)) ) )

  knitr::kable( rbind( c("C",round(summary(df_C.f$Nfert),3)),
                       c("G",round(summary(df_G.f$Nfert),3)) ) )

  knitr::kable( rbind( c("C",round(summary(df_C.f$FC),3)),
                       c("G",round(summary(df_G.f$FC),3)) ) )

  knitr::kable( rbind( c("C",round(summary(df_C.f$WP),3)),
                       c("G",round(summary(df_G.f$WP),3)) ) )
  
  knitr::kable( rbind( c("C",round(summary(df_C.f$FC-df_C.f$WP),3)),
                       c("G",round(summary(df_G.f$FC-df_G.f$WP),3)) ) )
```

Fig. \ref{fig:XX13} shows that, in the simulations, the annual yields in 2018-19 and 2019-20 varied more between farms than the long-term average yields did.

```{r XX13, fig.height=3, fig.cap="\\label{fig:XX13}Yields in 2019-20 vs. yield in 2018-19."}
  par( mfrow=c(1,2), mar=c(3,3,3,2) )

  x_C <- df_C.f$yield1819 ; y_C <- df_C.f$yield1920
  x_G <- df_G.f$yield1819 ; y_G <- df_G.f$yield1920
  plot  ( x_C, y_C, main="Observed yields\n(kg DM ha-1 y-1)",
          xlab="2018-19", ylab="2019-20")
  points( x_G, y_G, col="red" )
  y.lm_C <- lm( y_C ~ x_C ) ; r2_C <- round( summary(y.lm_C)$r.squared, 2 )
  y.lm_G <- lm( y_G ~ x_G ) ; r2_G <- round( summary(y.lm_G)$r.squared, 2 )
  abline( y.lm_C$coefficients[1], y.lm_C$coefficients[2], col="black" )
  abline( y.lm_G$coefficients[1], y.lm_G$coefficients[2], col="red" )
  abline( 1, 1, lty=2 )
  legend( "bottomright",
          legend=c(paste0("C (r2=",r2_C,")"),paste0("G (r2=",r2_G,")")),
          lty=c(1,1), col=c("black","red"), bg="transparent", cex=0.5 )
  
  x_C <- oF2_C[,"harvDM_f_ha1819"] ; y_C <- oF2_C[,"harvDM_f_ha1920"]
  x_G <- oF2_G[,"harvDM_f_ha1819"] ; y_G <- oF2_G[,"harvDM_f_ha1920"]
  plot  ( x_C, y_C, main="Simulated yields\n(kg DM ha-1 y-1)",
          xlab="2018-19", ylab="2019-20")
  points( x_G, y_G, col="red" )
  y.lm_C <- lm( y_C ~ x_C ) ; r2_C <- round( summary(y.lm_C)$r.squared, 2 )
  y.lm_G <- lm( y_G ~ x_G ) ; r2_G <- round( summary(y.lm_G)$r.squared, 2 )
  abline( y.lm_C$coefficients[1], y.lm_C$coefficients[2], col="black" )
  abline( y.lm_G$coefficients[1], y.lm_G$coefficients[2], col="red" )
  abline( 1, 1, lty=2 )
  legend( "bottomright",
          legend=c(paste0("C (r2=",r2_C,")"),paste0("G (r2=",r2_G,")")),
          lty=c(1,1), col=c("black","red"), bg="transparent", cex=0.5 )
```

We now come to the simulations for all farms that used farm-specific information on weather, soil, nitrogen fertilisation rate, tree species and shade-level.

Results of these simulations are shown in Figs \ref{fig:XX14C}, \ref{fig:XX14G}, \ref{fig:XX15}, and \ref{fig:XX16}. Fig. \ref{fig:XX15} shows, for farms in Costa Rica, observations and simulations of multiple variables, all plotted against each farm's N-fertilisation rate. Farms are grouped by number of shade tree species but no clear differences between the groups are visible. Apart from shade, all variables show a positive or negative correlation with fertilisation. The negative correlation in the case of soil carbon loss in runoff is likely due to fertilisation enhancing vegetation LAI, which in the model reduces erosion. The same variables are shown in Fig. \ref{fig:XX16} for Guatemala.

```{r}
  int1_C <- which(df_C.f$nt <2) ; int1_G <- which(df_G.f$nt <2)
  int2_C <- which(df_C.f$nt==2) ; int2_G <- which(df_G.f$nt==2)
  int3_C <- which(df_C.f$nt >2) ; int3_G <- which(df_G.f$nt >2)
  
  nnt1_C <- length(int1_C)      ; nnt1_G <- length(int1_G)
  nnt2_C <- length(int2_C)      ; nnt2_G <- length(int2_G)
  nnt3_C <- length(int3_C)      ; nnt3_G <- length(int3_G)
  
  listmat_nt_C <- listmat_nt_G <- vector( "list", 3 )
  varnames.listmat <- c( "code","dist","slope","Nfert","nt","shade",
    "y1819","y1920",  "y1819.sim","y1920.sim","y.sim",
    "D_Csoil.sim","shade.sim","Nleach.sim","Crunoff.sim","Csoil.sim" )
```

```{r}
  iF <- 2
```

```{r}
  listmat_nt_C[[1]] <- t( sapply( 1:nnt1_C, function(i){ cbind(
    df_C.f    [int1_C,]$code     [[i]],
    df_C.f    [int1_C,]$dist     [[i]],
    df_C.f    [int1_C,]$slope    [[i]],
    df_C.f    [int1_C,]$Nfert    [[i]],
    df_C.f    [int1_C,]$nt       [[i]],
    df_C.f    [int1_C,]$shade    [[i]],
    df_C.f    [int1_C,]$yield1819[[i]],
    df_C.f    [int1_C,]$yield1920[[i]],
    df_C.f_sim[int1_C,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"Shade_f"        ][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_C.f_sim[int1_C,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_C[[1]]) <- varnames.listmat

  listmat_nt_C[[2]] <- t( sapply( 1:nnt2_C, function(i){ cbind(
    df_C.f    [int2_C,]$code     [[i]],
    df_C.f    [int2_C,]$dist     [[i]],
    df_C.f    [int2_C,]$slope    [[i]],
    df_C.f    [int2_C,]$Nfert    [[i]],
    df_C.f    [int2_C,]$nt       [[i]],
    df_C.f    [int2_C,]$shade    [[i]],
    df_C.f    [int2_C,]$yield1819[[i]],
    df_C.f    [int2_C,]$yield1920[[i]],
    df_C.f_sim[int2_C,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"Shade_f"        ][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_C.f_sim[int2_C,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_C[[2]]) <- varnames.listmat

  listmat_nt_C[[3]] <- t( sapply( 1:nnt3_C, function(i){ cbind(
    df_C.f    [int3_C,]$code     [[i]],
    df_C.f    [int3_C,]$dist     [[i]],
    df_C.f    [int3_C,]$slope    [[i]],
    df_C.f    [int3_C,]$Nfert    [[i]],
    df_C.f    [int3_C,]$nt       [[i]],
    df_C.f    [int3_C,]$shade    [[i]],
    df_C.f    [int3_C,]$yield1819[[i]],
    df_C.f    [int3_C,]$yield1920[[i]],
    df_C.f_sim[int3_C,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"Shade_f"        ][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_C.f_sim[int3_C,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_C[[3]]) <- varnames.listmat
```

```{r}
  listmat_nt_G[[1]] <- t( sapply( 1:nnt1_G, function(i){ cbind(
    df_G.f    [int1_G,]$code     [[i]],
    df_G.f    [int1_G,]$dist     [[i]],
    df_G.f    [int1_G,]$slope    [[i]],
    df_G.f    [int1_G,]$Nfert    [[i]],
    df_G.f    [int1_G,]$nt       [[i]],
    df_G.f    [int1_G,]$shade    [[i]],
    df_G.f    [int1_G,]$yield1819[[i]],
    df_G.f    [int1_G,]$yield1920[[i]],
    df_G.f_sim[int1_G,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"Shade_f"        ][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_G.f_sim[int1_G,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_G[[1]]) <- varnames.listmat

  listmat_nt_G[[2]] <- t( sapply( 1:nnt2_G, function(i){ cbind(
    df_G.f    [int2_G,]$code     [[i]],
    df_G.f    [int2_G,]$dist     [[i]],
    df_G.f    [int2_G,]$slope    [[i]],
    df_G.f    [int2_G,]$Nfert    [[i]],
    df_G.f    [int2_G,]$nt       [[i]],
    df_G.f    [int2_G,]$shade    [[i]],
    df_G.f    [int2_G,]$yield1819[[i]],
    df_G.f    [int2_G,]$yield1920[[i]],
    df_G.f_sim[int2_G,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"Shade_f"        ][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_G.f_sim[int2_G,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_G[[2]]) <- varnames.listmat

  listmat_nt_G[[3]] <- t( sapply( 1:nnt3_G, function(i){ cbind(
    df_G.f    [int3_G,]$code     [[i]],
    df_G.f    [int3_G,]$dist     [[i]],
    df_G.f    [int3_G,]$slope    [[i]],
    df_G.f    [int3_G,]$Nfert    [[i]],
    df_G.f    [int3_G,]$nt       [[i]],
    df_G.f    [int3_G,]$shade    [[i]],
    df_G.f    [int3_G,]$yield1819[[i]],
    df_G.f    [int3_G,]$yield1920[[i]],
    df_G.f_sim[int3_G,]$outF     [[i]][,"harvDM_f_ha1819"][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"harvDM_f_ha1920"][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"harvDM_f_hay"   ][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"D_Csoil"        ][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"Shade_f"        ][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"Nleaching_fb"   ][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"Crunoff_fb"     ][iF],
    df_G.f_sim[int3_G,]$outF     [[i]][,"Csoil_fb"       ][iF]
  ) } ) )
  colnames(listmat_nt_G[[3]]) <- varnames.listmat
```

```{r}
  plotimpacts_nt <- function( listmat=listmat_nt_C, xvar="Nfert", yvar="y.sim" ){
    plot  ( listmat[[1]][,xvar], listmat[[1]][,yvar],
      xlab=xvar, ylab="",main=yvar, pch=1,
      xlim=c(0,max(listmat[[1]][,xvar],listmat[[2]][,xvar],
                   listmat[[3]][,xvar])),
      ylim=c(min(0,listmat[[1]][,yvar],listmat[[2]][,yvar],listmat[[3]][,yvar],
                 na.rm=T),
             max(  listmat[[1]][,yvar],listmat[[2]][,yvar],listmat[[3]][,yvar],
                 na.rm=T)) )
    points( listmat[[2]][,xvar], listmat[[2]][,yvar], pch=20, col="red"  )
    points( listmat[[3]][,xvar], listmat[[3]][,yvar], pch=6, col="blue" )
    
    y.lm.nt1 <- lm( listmat[[1]][,yvar] ~ listmat[[1]][,xvar] )
    y.lm.nt2 <- lm( listmat[[2]][,yvar] ~ listmat[[2]][,xvar] )
    y.lm.nt3 <- lm( listmat[[3]][,yvar] ~ listmat[[3]][,xvar] )
    r2.nt1   <- round( summary(y.lm.nt1)$r.squared, 2 )
    r2.nt2   <- round( summary(y.lm.nt2)$r.squared, 2 )
    r2.nt3   <- round( summary(y.lm.nt3)$r.squared, 2 )
    abline( y.lm.nt1$coefficients[1], y.lm.nt1$coefficients[2], col="black" )
    abline( y.lm.nt2$coefficients[1], y.lm.nt2$coefficients[2], col="red" )
    abline( y.lm.nt3$coefficients[1], y.lm.nt3$coefficients[2], col="blue" )
    legend( "bottomright", title="r2",
            legend=c( paste("n<2:",as.character(r2.nt1)),
              paste("n=2:",as.character(r2.nt2)),
              paste("n>2:",as.character(r2.nt3)) ),
            col=c("black","red","blue"), lty=c(1), cex=0.5 )
  }
```

```{r XX15, fig.height=7.5, fig.cap="\\label{fig:XX15}Observations (top row) and simulations (middle row) of shade and yield for farms in Costa Rica plus (bottom row) simulations of change in soil carbon, final year nitrogen leaching and final year carbon loss in run-off. All plots are against N-fertilisation level (kg N ha-1 y-1)."}
  par(mfrow=c(3,3),mar=c(4,2,2,2), mgp=c(2,1,0))

  plotimpacts_nt( listmat_nt_C, "Nfert", "shade"        )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "y1819"       )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "y1920"       )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "shade.sim"   )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "y1819.sim"   )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "y1920.sim"   )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "D_Csoil.sim" )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "Nleach.sim"  )
  plotimpacts_nt( listmat_nt_C, "Nfert",  "Crunoff.sim" )
```

```{r XX16, fig.height=7.5, fig.cap="\\label{fig:XX16}Shade- and yield-observations for farms in Guatemala plus simulations: see previous figure for explanation of variables."}
  par(mfrow=c(3,3),mar=c(4,2,2,2), mgp=c(2,1,0))

  plotimpacts_nt( listmat_nt_G, "Nfert", "shade"       )
  plotimpacts_nt( listmat_nt_G, "Nfert", "y1819"       )
  plotimpacts_nt( listmat_nt_G, "Nfert", "y1920"       )
  plotimpacts_nt( listmat_nt_G, "Nfert", "shade.sim"   )
  plotimpacts_nt( listmat_nt_G, "Nfert", "y1819.sim"   )
  plotimpacts_nt( listmat_nt_G, "Nfert", "y1920.sim"   )
  plotimpacts_nt( listmat_nt_G, "Nfert", "D_Csoil.sim" )
  plotimpacts_nt( listmat_nt_G, "Nfert", "Nleach.sim"  )
  plotimpacts_nt( listmat_nt_G, "Nfert", "Crunoff.sim" )
```

```{r, fig.height=7.5}
  par(mfrow=c(3,3),mar=c(4,2,2,2), mgp=c(2,1,0))

  plotimpacts_nt( listmat_nt_C, "dist", "shade"        )
  plotimpacts_nt( listmat_nt_C, "dist",  "y1819"       )
  plotimpacts_nt( listmat_nt_C, "dist",  "y1920"       )
  plotimpacts_nt( listmat_nt_C, "dist",  "shade.sim"   )
  plotimpacts_nt( listmat_nt_C, "dist",  "y1819.sim"   )
  plotimpacts_nt( listmat_nt_C, "dist",  "y1920.sim"   )
  plotimpacts_nt( listmat_nt_C, "dist",  "D_Csoil.sim" )
  plotimpacts_nt( listmat_nt_C, "dist",  "Nleach.sim"  )
  plotimpacts_nt( listmat_nt_C, "dist",  "Crunoff.sim" )
```

```{r, fig.height=7.5}
  par(mfrow=c(3,3),mar=c(4,2,2,2), mgp=c(2,1,0))

  plotimpacts_nt( listmat_nt_G, "dist", "shade"       )
  plotimpacts_nt( listmat_nt_G, "dist", "y1819"       )
  plotimpacts_nt( listmat_nt_G, "dist", "y1920"       )
  plotimpacts_nt( listmat_nt_G, "dist", "shade.sim"   )
  plotimpacts_nt( listmat_nt_G, "dist", "y1819.sim"   )
  plotimpacts_nt( listmat_nt_G, "dist", "y1920.sim"   )
  plotimpacts_nt( listmat_nt_G, "dist", "D_Csoil.sim" )
  plotimpacts_nt( listmat_nt_G, "dist", "Nleach.sim"  )
  plotimpacts_nt( listmat_nt_G, "dist", "Crunoff.sim" )
```

# Analysis of model-data mismatch

```{r}
  mRAIN_C <- rep(NA,n_C.f)
  mRAIN_G <- rep(NA,n_G.f)

  for(i in 1:n_C.f) { mRAIN_C[i] <- mean(df_C.f$weather.WC[[i]][,"RAIN"]) }
  for(i in 1:n_G.f) { mRAIN_G[i] <- mean(df_G.f$weather.WC[[i]][,"RAIN"]) }
  
  # All farms
  summary( mRAIN_C )
  summary( mRAIN_G )

  # Twenty driest farms  
  summary( sort(mRAIN_C)[1:20] )
  summary( sort(mRAIN_G)[1:20] )
```

```{r}
  y1819.err_C <- oF2_C[,"harvDM_f_ha1819"] - df_C.f$yield1819
  y1920.err_C <- oF2_C[,"harvDM_f_ha1920"] - df_C.f$yield1920
  y1819.err_G <- oF2_G[,"harvDM_f_ha1819"] - df_G.f$yield1819
  y1920.err_G <- oF2_G[,"harvDM_f_ha1920"] - df_G.f$yield1920
```

```{r}
  par(mfrow=c(1,2))
  
  y=y1920.err_C ; x=y1819.err_C
    plotxylm("C: e1920 ~ e1819", orig=F) ; abline(a=0,b=1,lty=2)
  y=y1920.err_G ; x=y1819.err_G
    plotxylm("G: e1920 ~ e1819", orig=F) ; abline(a=0,b=1,lty=2)
```

```{r, eval=F}
  par(mfrow=c(4,5), mar=c(2,2,2,1))

  y=y1819.err_C

  x=mRAIN_C               ; plotxylm("C: e1819 ~ Rain"     )
  x=df_C.f$dist           ; plotxylm("C: e1819 ~ dist"     )
  x=df_C.f$slope          ; plotxylm("C: e1819 ~ slope"    )
  x=df_C.f$altitude       ; plotxylm("C: e1819 ~ alt"      )
  x=df_C.f$DM.soil        ; plotxylm("C: e1819 ~ DM.soil"  )
  x=df_C.f$CN.soil        ; plotxylm("C: e1819 ~ CN.soil"  )
  x=df_C.f$C.soil         ; plotxylm("C: e1819 ~ C.soil"   )
  x=df_C.f$N.soil         ; plotxylm("C: e1819 ~ N.soil"   )
  x=df_C.f$Nfert          ; plotxylm("C: e1819 ~ Nfert"    )
  x=df_C.f$WP             ; plotxylm("C: e1819 ~ WP"       )
  x=df_C.f$FC             ; plotxylm("C: e1819 ~ FC"       )
  x=df_C.f$nt             ; plotxylm("C: e1819 ~ nt"       )
  x=df_C.f$shade          ; plotxylm("C: e1819 ~ shade"    )
  x=df_C.f$dens_Erythrina ; plotxylm("C: e1819 ~ Erythrina")
  x=df_C.f$dens_Inga      ; plotxylm("C: e1819 ~ Inga"     )
  x=df_C.f$dens_Banana    ; plotxylm("C: e1819 ~ Banana"   )
  x=df_C.f$dens_Inga      ; plotxylm("C: e1819 ~ Avocado"  )
  x=df_C.f$dens_Grevillea ; plotxylm("C: e1819 ~ Grevillea")
  x=df_C.f$dens_Cordia    ; plotxylm("C: e1819 ~ Cordia"   )
```

```{r, eval=F}
  par(mfrow=c(4,5), mar=c(2,2,2,1))

  y=y1920.err_C

  x=mRAIN_C               ; plotxylm("C: e1920 ~ Rain"     )
  x=df_C.f$dist           ; plotxylm("C: e1920 ~ dist"     )
  x=df_C.f$slope          ; plotxylm("C: e1920 ~ slope"    )
  x=df_C.f$altitude       ; plotxylm("C: e1920 ~ alt"      )
  x=df_C.f$DM.soil        ; plotxylm("C: e1920 ~ DM.soil"  )
  x=df_C.f$CN.soil        ; plotxylm("C: e1920 ~ CN.soil"  )
  x=df_C.f$C.soil         ; plotxylm("C: e1920 ~ C.soil"   )
  x=df_C.f$N.soil         ; plotxylm("C: e1920 ~ N.soil"   )
  x=df_C.f$Nfert          ; plotxylm("C: e1920 ~ Nfert"    )
  x=df_C.f$WP             ; plotxylm("C: e1920 ~ WP"       )
  x=df_C.f$FC             ; plotxylm("C: e1920 ~ FC"       )
  x=df_C.f$nt             ; plotxylm("C: e1920 ~ nt"       )
  x=df_C.f$shade          ; plotxylm("C: e1920 ~ shade"    )
  x=df_C.f$dens_Erythrina ; plotxylm("C: e1920 ~ Erythrina")
  x=df_C.f$dens_Inga      ; plotxylm("C: e1920 ~ Inga"     )
  x=df_C.f$dens_Banana    ; plotxylm("C: e1920 ~ Banana"   )
  x=df_C.f$dens_Inga      ; plotxylm("C: e1920 ~ Avocado"  )
  x=df_C.f$dens_Grevillea ; plotxylm("C: e1920 ~ Grevillea")
  x=df_C.f$dens_Cordia    ; plotxylm("C: e1920 ~ Cordia"   )
```

```{r, eval=F}
  par(mfrow=c(4,5), mar=c(2,2,2,1))

  y=y1819.err_G

  x=mRAIN_G               ; plotxylm("G: e1819 ~ Rain"     )
  x=df_G.f$dist           ; plotxylm("G: e1819 ~ dist"     )
  x=df_G.f$slope          ; plotxylm("G: e1819 ~ slope"    )
  x=df_G.f$altitude       ; plotxylm("G: e1819 ~ alt"      )
  x=df_G.f$DM.soil        ; plotxylm("G: e1819 ~ DM.soil"  )
  x=df_G.f$CN.soil        ; plotxylm("G: e1819 ~ CN.soil"  )
  x=df_G.f$C.soil         ; plotxylm("G: e1819 ~ C.soil"   )
  x=df_G.f$N.soil         ; plotxylm("G: e1819 ~ N.soil"   )
  x=df_G.f$Nfert          ; plotxylm("G: e1819 ~ Nfert"    )
  x=df_G.f$WP             ; plotxylm("G: e1819 ~ WP"       )
  x=df_G.f$FC             ; plotxylm("G: e1819 ~ FC"       )
  x=df_G.f$nt             ; plotxylm("G: e1819 ~ nt"       )
  x=df_G.f$shade          ; plotxylm("G: e1819 ~ shade"    )
  plot.new()
  x=df_G.f$dens_Inga      ; plotxylm("G: e1819 ~ Inga"     )
  x=df_G.f$dens_Banana    ; plotxylm("G: e1819 ~ Banana"   )
  x=df_G.f$dens_Inga      ; plotxylm("G: e1819 ~ Avocado"  )
  x=df_G.f$dens_Grevillea ; plotxylm("G: e1819 ~ Grevillea")
  x=df_G.f$dens_Cordia    ; plotxylm("G: e1819 ~ Cordia"   )
```

```{r, eval=F}
  par(mfrow=c(4,5), mar=c(2,2,2,1))

  y=y1920.err_G

  x=mRAIN_G               ; plotxylm("G: e1920 ~ Rain"     )
  x=df_G.f$dist           ; plotxylm("G: e1920 ~ dist"     )
  x=df_G.f$slope          ; plotxylm("G: e1920 ~ slope"    )
  x=df_G.f$altitude       ; plotxylm("G: e1920 ~ alt"      )
  x=df_G.f$DM.soil        ; plotxylm("G: e1920 ~ DM.soil"  )
  x=df_G.f$CN.soil        ; plotxylm("G: e1920 ~ CN.soil"  )
  x=df_G.f$C.soil         ; plotxylm("G: e1920 ~ C.soil"   )
  x=df_G.f$N.soil         ; plotxylm("G: e1920 ~ N.soil"   )
  x=df_G.f$Nfert          ; plotxylm("G: e1920 ~ Nfert"    )
  x=df_G.f$WP             ; plotxylm("G: e1920 ~ WP"       )
  x=df_G.f$FC             ; plotxylm("G: e1920 ~ FC"       )
  x=df_G.f$nt             ; plotxylm("G: e1920 ~ nt"       )
  x=df_G.f$shade          ; plotxylm("G: e1920 ~ shade"    )
  plot.new()
  x=df_G.f$dens_Inga      ; plotxylm("G: e1920 ~ Inga"     )
  x=df_G.f$dens_Banana    ; plotxylm("G: e1920 ~ Banana"   )
  x=df_G.f$dens_Inga      ; plotxylm("G: e1920 ~ Avocado"  )
  x=df_G.f$dens_Grevillea ; plotxylm("G: e1920 ~ Grevillea")
  x=df_G.f$dens_Cordia    ; plotxylm("G: e1920 ~ Cordia"   )
```

```{r, eval=F}
  par(mfrow=c(2,2), mar=c(2,2,2,1))

  y=y1819.err_C
  x=oF2_C[,"harvDM_f_hay" ] ; plotxylm("C: e1819 ~ harvDM_f_hay" )
  x=oF2_C[,"Shade_fb"     ] ; plotxylm("C: e1819 ~ Shade_fb"     )
  y=y1920.err_C
  x=oF2_C[,"harvDM_f_hay" ] ; plotxylm("C: e1920 ~ harvDM_f_hay" )
  x=oF2_C[,"Shade_fb"     ] ; plotxylm("C: e1920 ~ Shade_fb"     )

  y=y1819.err_G
  x=oF2_G[,"harvDM_f_hay" ] ; plotxylm("G: e1819 ~ harvDM_f_hay" )
  x=oF2_G[,"Shade_fb"     ] ; plotxylm("G: e1819 ~ Shade_fb"     )
  y=y1920.err_G
  x=oF2_G[,"harvDM_f_hay" ] ; plotxylm("G: e1920 ~ harvDM_f_hay" )
  x=oF2_G[,"Shade_fb"     ] ; plotxylm("G: e1920 ~ Shade_fb"     )
```

```{r, eval=F}
  par(mfrow=c(4,3), mar=c(2,2,2,1))

  y=y1819.err_C
  x=oF2_C[,"fTranT_t_1b"  ] ; plotxylm("C: e1819 ~ fTranT_1b"     )
  x=oF2_C[,"fTranT_t_2b"  ] ; plotxylm("C: e1819 ~ fTranT_2b"     )
  x=oF2_C[,"fTranT_t_3b"  ] ; plotxylm("C: e1819 ~ fTranT_3b"     )
  x=oF2_C[,"fNgrowth_t_1b"] ; plotxylm("C: e1819 ~ fNgrowth_t_1b" )
  x=oF2_C[,"fNgrowth_t_2b"] ; plotxylm("C: e1819 ~ fNgrowth_t_2b" )
  x=oF2_C[,"fNgrowth_t_3b"] ; plotxylm("C: e1819 ~ fNgrowth_t_3b" )

  y=y1920.err_C
  x=oF2_C[,"fTranT_t_1b"  ] ; plotxylm("C: e1920 ~ fTranT_1b"     )
  x=oF2_C[,"fTranT_t_2b"  ] ; plotxylm("C: e1920 ~ fTranT_2b"     )
  x=oF2_C[,"fTranT_t_3b"  ] ; plotxylm("C: e1920 ~ fTranT_3b"     )
  x=oF2_C[,"fNgrowth_t_1b"] ; plotxylm("C: e1920 ~ fNgrowth_t_1b" )
  x=oF2_C[,"fNgrowth_t_2b"] ; plotxylm("C: e1920 ~ fNgrowth_t_2b" )
  x=oF2_C[,"fNgrowth_t_3b"] ; plotxylm("C: e1920 ~ fNgrowth_t_3b" )
```

```{r, eval=F}
  par(mfrow=c(4,3), mar=c(2,2,2,1))

  y=y1819.err_G
  x=oF2_G[,"fTranT_t_1b"  ] ; plotxylm("G: e1819 ~ fTranT_1b"     )
  x=oF2_G[,"fTranT_t_2b"  ] ; plotxylm("G: e1819 ~ fTranT_2b"     )
  x=oF2_G[,"fTranT_t_3b"  ] ; plotxylm("G: e1819 ~ fTranT_3b"     )
  x=oF2_G[,"fNgrowth_t_1b"] ; plotxylm("G: e1819 ~ fNgrowth_t_1b" )
  x=oF2_G[,"fNgrowth_t_2b"] ; plotxylm("G: e1819 ~ fNgrowth_t_2b" )
  x=oF2_G[,"fNgrowth_t_3b"] ; plotxylm("G: e1819 ~ fNgrowth_t_3b" )

  y=y1920.err_G
  x=oF2_G[,"fTranT_t_1b"  ] ; plotxylm("G: e1920 ~ fTranT_1b"     )
  x=oF2_G[,"fTranT_t_2b"  ] ; plotxylm("G: e1920 ~ fTranT_2b"     )
  x=oF2_G[,"fTranT_t_3b"  ] ; plotxylm("G: e1920 ~ fTranT_3b"     )
  x=oF2_G[,"fNgrowth_t_1b"] ; plotxylm("G: e1920 ~ fNgrowth_t_1b" )
  x=oF2_G[,"fNgrowth_t_2b"] ; plotxylm("G: e1920 ~ fNgrowth_t_2b" )
  x=oF2_G[,"fNgrowth_t_3b"] ; plotxylm("G: e1920 ~ fNgrowth_t_3b" )
```


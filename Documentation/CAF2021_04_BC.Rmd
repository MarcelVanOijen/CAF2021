---
title: 'CAF2021: Bayesian calibration of CAF2021'
subtitle: 'Data from the CATIE long-term experiment in Turrialba, Costa Rica'
author:
- Marcel van Oijen; VanOijenMarcel@gmail.com
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_crop: false
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: yes
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document: default
fontsize: 11pt
geometry: margin=1in
---



# Introduction

We report here on progress with calibration of CAF2021. 

Calibration consisted of the following activities:
1. Assemble, from various sources, calibration data on coffee and tree growth.
2. Identify CAF2021 parameters that we wanted to calibrate, and assign to them a prior probability distribution to represent our uncertainty about the values of the parameters.
3. Carry out Bayesian calibration (BC) using Markov Chain Monte Carlo sampling (MCMC), to derive a posterior distribution for the parameters. We used an MCMC chain length of $n$ iterations, which means that the model was run with $n$ different parameter vectors. Each parameter vector was applied to each of the 18 treatments, so the total number of CAF2021 runs for this calibration was $18 \times n$ model runs.
4. Analyse the results from the BC to identify any remaining problems with data and model.

## Caveats for BC

- BC on height parameters only makes sense when (1) there are height measurements in the data set, (2) height has an impact. Currently in CAF2021 height is irrelevant: t3 always overshadows t1 and t2 completely irrespective of their heights.


# BC Turrialba

## The experiment

From the SEACAF proposal: "A long-term coffee agroforestry experiment was established in Costa Rica in 2000 comparing different agroforestry shade trees and coffee monoculture under different levels of agronomic inputs. Provisioning, supporting and indicators of regulating ecosystem services will be evaluated in this experiment."

There are 20 treatments, which are always reported in the same order:

-  1- 4 = Erythrina (E): AC, MC, MO, BO
-  5- 8 = Terminalia (T): AC, MC, MO, BO
-  9-10 = Casha (C): MC, MO
- 11-12 = T+C: MC, MO
- 13-14 = T+E: MC, MO
- 15-18 = C+E: AC, MC, MO, BO
- 19-20 = Full sun: AC, MC

The model was calibrated on data from 18 out of the 20 treatments at the long-term coffee agroforestry experiment in Turrialba. Two of the treatments had two upper-stratum timber tree species (11-12: Terminalia + Casha), and that combination cannot be simulated with CAF2021: the model can simulate at most one "upper" tree species (and at most two lower ones).

For more details on the Turrialba experiment and the data, see 'SEACAF.Rmd'.

### Use of Turrialba data by Oriana Ovalle

- Oriana used data from treatments 1-2 (E), 5-6 (T), 19-20 (Full sun).
- Her six data files had their own numbering:
    - Oriana-1 = CATIE-5 (Terminalia-AC)
    - Oriana-2 = CATIE-6 (Terminalia-MC)
    - Oriana-3 = CATIE-1 (Erythrina-AC)
    - Oriana-4 = CATIE-2 (Erythrina-MC)
    - Oriana-5 = CATIE-19 (FullSun-AC)
    - Oriana-6 = CATIE-20 (FullSun-MC)

## Results & Discussion

### Data: coffee and tree growth

- We used the most recent files received from Elias (18 June 2020). Annual coffee yields in fanegas/ha were converted to dry matter yields by multiplying with 86 kg/fanega.
- For coffee yields, the values were mostly closely correlated with the data sets used earlier by Oriana Ovalle.
- It would be good to have data on tree biomass.
- For most variables we quantified the uncertainty of each measurement as a coefficient of variation of 30%, with slightly lower values for coffee yield.

### Prior probability distribution

- In the calibration, we included parameters for coffee, soil and the three tree species (Erythrina, Terminalia, Chloroleucon).
- We only used a subset of the model's parameters for the calibration, and used a fairly uninformative (not too constraining) prior.

### MCMC and Posterior probability distribution

```{r, eval=TRUE}
## 1. INITIALISE MCMC ##
   nChain <- as.integer(1e2)
   source('BC/BC_CAF2021_MCMC_init_Turrialba_01-10_13-20.R')

## 2. RUNNING THE MCMC ##
   source('BC/BC_CAF2021_MCMC.R')

## 3. PRINTING AND PLOTTING ##
   source('BC/BC_export_parModes.R')
   source('BC/BC_plot_parameters_traceplots.R')
   source('BC/BC_plot_parameters_priorbeta_histograms.R')
   source('BC/BC_plot_outputs_data.R')
```

- For the marginal posterior parameter distributions, see the pdf-file
  - 'BC_parameters_priorbeta_histograms[].pdf'.
- For the posterior fit to all the data at each site, see the pdf-file
  - 'BC_outputs_data[].pdf'.

### Analysis

- Coffee production in the experiment had a biennial pattern the first ten years, then stable production during four years, and then the bienniality started again. CAF2021 does not simulate the interannual variability well. It is able to simulate some initial bienniality, but it does not simulate the late resumption of biennial growth.
- The average coffee production levels across the 18 treatments are simulated quite well, albeit with some underestimation (see following figure).

```{r, echo=TRUE, out.width="100%", fig.cap="\\label{FigYields}Simulated vs. observed coffee yields over the period 2003-2017. The simulations were carried out using the Maximum A Posteriori (i.e. most probable) parameter vector. Every point represents a different treatment."}

  Rfile <- paste0('BC_',format(Sys.time(),"%H_%M.RData"))
  save.image( Rfile )
  # source('BC/BC_CAF2021_MCMC_init_Turrialba_01-10_13-20.R')
  # load( Rfile )

  source('BC/BC_averageYields.R')
```

## Improving BC Turrialba

- Correct the values used for Nfert in the MO and BO treatments, using Table 2 of Haggar et al. (2011).
- Ignore bienniality in final 4 years 2014-2017 because that was linked to rust outbreaks which the model does not simulate.
- But do try to improve i.e. increase the magnitude of the simulated bienniality in the first 10 years.
- For Turrialba use for Chloroleucon KNFIX(3) > 0.
- New measurement data: Fernando Casanoves (6/2020) mentioned that the field measurement team would partly be redirected to do extra measurements in the LT experiment: coffee density and yield components, tree dasometry.
- And perhaps there are more data from CR (Rolando has data on 60 plots in the Turrialba region)?

\clearpage



# BC on data from NIC

- We want to calibrate on the NIC experiment data, despite it being atypically dry and at low altitude:
    - Clear dry season (in contrast to CATIE Turrialba, but similar to GTM and West-CRI)
    - Inga (albeit always together with another tree spp.)
    
    

# BC on data from GTM

- Edwin checks data
